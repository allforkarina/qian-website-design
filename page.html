<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ•°æ®å±•ç¤ºé¡µ</title>
  <link rel="stylesheet" href="style.css" />

  <!-- å¼•å…¥ Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- å¼•å…¥ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #map {
      width: 100%;
      height: clamp(250px, 40vh, 400px);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 15px;
      overflow: hidden;
    }

    /* ç»Ÿè®¡é¢æ¿æ ·å¼ */
    .statistics-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      border-radius: 16px 16px 0 0;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .stat-card.danger::before {
      background: linear-gradient(90deg, #ff416c, #ff4b2b);
    }

    .stat-card.warning::before {
      background: linear-gradient(90deg, #f7971e, #ffd200);
    }

    .stat-card.success::before {
      background: linear-gradient(90deg, #56ab2f, #a8e6cf);
    }

    .stat-icon {
      font-size: 2rem; /* ä» 2.5rem å‡å° */
      margin-bottom: 12px;
      display: block;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .stat-label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #ffffff;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .stat-unit {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.6);
      margin-left: 4px;
    }

    /* æ•°æ®å¯è§†åŒ–å›¾è¡¨æ ·å¼ */
    .charts-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .chart-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .chart-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .chart-title {
      color: #ffffff;
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-canvas {
      height: 300px;
      position: relative;
    }

    .daily-stats-container {
      grid-column: 1 / -1;
    }

    .daily-stats-container .chart-canvas {
      height: 250px;
    }

    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
    }

    .stat-trend {
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      margin-top: 8px;
      display: inline-block;
    }

    .stat-trend.up {
      color: #ff6b6b;
    }

    .stat-trend.down {
      color: #4ecdc4;
    }

    .stat-trend.neutral {
      color: rgba(255, 255, 255, 0.7);
    }

    .stat-info {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .stat-info span {
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    #batteryCard::before {
      background: linear-gradient(90deg, 
        var(--battery-color-start, #4facfe), 
        var(--battery-color-end, #00f2fe));
    }

    /* æ•°æ®åŠ¨ç”»æ•ˆæœ */
    .stat-value.updating {
      animation: valueUpdate 0.5s ease;
    }

    @keyframes valueUpdate {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); color: #4facfe; }
      100% { transform: scale(1); }
    }

    /* ç»Ÿè®¡é¢æ¿æ ‡é¢˜ */
    .statistics-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding: 0 8px;
    }

    .statistics-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .statistics-title .title-icon {
      font-size: 1.4rem; /* ä» 1.6rem å‡å° */
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .refresh-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 10px;
      padding: 8px 16px;
      color: white;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }

    .refresh-btn:active {
      transform: translateY(0);
    }

    .refresh-btn.spinning {
      pointer-events: none;
    }

    .refresh-btn.spinning .refresh-icon {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* å¤©æ°”åˆ†æå¡ç‰‡æ ·å¼ - ä¼˜åŒ–ç‰ˆæœ¬ */
    .weather-card {
      background: linear-gradient(135deg, 
        rgba(135, 206, 235, 0.15), 
        rgba(70, 130, 180, 0.1),
        rgba(30, 144, 255, 0.05));
      border: 1px solid rgba(135, 206, 235, 0.3);
      border-radius: 20px;
      padding: 28px;
      backdrop-filter: blur(20px);
      margin-bottom: 25px;
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 25px 60px rgba(30, 144, 255, 0.15),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* é¡¶éƒ¨æ¸å˜æ¡å¸¦åŠ¨ç”» */
    .weather-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #87ceeb, #4682b4, #1e90ff, #00bfff);
      border-radius: 20px 20px 0 0;
      background-size: 200% 100%;
      animation: weatherGradient 4s ease-in-out infinite;
      z-index: 2;
    }
    
    /* æ·»åŠ å…‰æ‰«æ•ˆæœ - è¿™æ˜¯å…³é”®éƒ¨åˆ† */
    .weather-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.2), 
        rgba(135, 206, 235, 0.3),
        rgba(255, 255, 255, 0.2),
        transparent);
      transition: left 0.8s ease;
      z-index: 1;
    }
    
    @keyframes weatherGradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .weather-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 
        0 35px 80px rgba(30, 144, 255, 0.25),
        0 0 0 1px rgba(135, 206, 235, 0.4),
        0 0 40px rgba(135, 206, 235, 0.3),
        0 0 60px rgba(30, 144, 255, 0.2);
      border-color: rgba(135, 206, 235, 0.5);
    }
    
    .weather-card:hover::after {
      left: 100%;
    }

    .weather-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .weather-title {
      font-size: 1.3rem; /* ä» 1.5rem å‡å° */
      font-weight: 700;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 10px; /* ä» 15px å‡å° */
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      line-height: 1.2; /* å¢åŠ è¡Œé«˜æ§åˆ¶ */
      flex-wrap: nowrap; /* é˜²æ­¢æ¢è¡Œ */
    }

    .weather-title .weather-icon {
      font-size: 1.3rem; /* ä» 2rem å¤§å¹…å‡å° */
      animation: weatherFloat 3s ease-in-out infinite;
      filter: drop-shadow(0 0 6px rgba(135, 206, 235, 0.8));
      flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
      width: 1.3rem; /* å›ºå®šå®½åº¦ */
      height: 1.3rem; /* å›ºå®šé«˜åº¦ */
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes weatherFloat {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-2px) rotate(-1deg); } /* ä» -3px -2deg å‡å° */
      50% { transform: translateY(-3px) rotate(0deg); } /* ä» -5px å‡å° */
      75% { transform: translateY(-2px) rotate(1deg); } /* ä» -3px 2deg å‡å° */
    }

    .weather-refresh-btn {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      border: none;
      border-radius: 12px;
      padding: 10px 20px;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
    }

    .weather-refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
      background: linear-gradient(135deg, #5fbdff, #1ff3fe);
    }

    /* åœ°ç†ä½ç½®è®¾ç½®åŒºåŸŸä¼˜åŒ– */
    .location-settings {
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.12), 
        rgba(255, 255, 255, 0.08));
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
    }

    .location-input {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 15px;
    }

    .location-input input {
      padding: 12px 16px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .location-input input:focus {
      outline: none;
      border-color: rgba(79, 172, 254, 0.6);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
    }

    .location-btn {
      padding: 12px 18px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(79, 172, 254, 0.3), rgba(0, 242, 254, 0.2));
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .location-btn:hover {
      background: linear-gradient(135deg, rgba(79, 172, 254, 0.5), rgba(0, 242, 254, 0.3));
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3);
    }

    /* åŸå¸‚å¿«æ·æŒ‰é’®ä¼˜åŒ– */
    .city-shortcuts {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .city-shortcut {
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: 500;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .city-shortcut::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .city-shortcut:hover::before {
      left: 100%;
    }

    .city-shortcut:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .city-shortcut.active {
      background: linear-gradient(135deg, rgba(79, 172, 254, 0.4), rgba(0, 242, 254, 0.3));
      border-color: rgba(79, 172, 254, 0.6);
      box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
    }

    /* å¤©æ°”å†…å®¹åŒºåŸŸä¼˜åŒ– */
    .weather-content {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 30px;
      margin-top: 10px;
    }

    .current-weather {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .weather-main-icon {
      font-size: 4rem; /* ä» 5rem å‡å° */
      margin-bottom: 15px;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3)); /* ä» 6px 12px å‡å° */
      animation: weatherPulse 3s ease-in-out infinite;
    }

    @keyframes weatherPulse {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.05) rotate(-2deg); }
      50% { transform: scale(1.1) rotate(0deg); }
      75% { transform: scale(1.05) rotate(2deg); }
    }

    .temperature {
      font-size: 3.5rem;
      font-weight: 800;
      color: #ffffff;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
      margin-bottom: 10px;
      background: linear-gradient(45deg, #ffffff, #e3f2fd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .weather-description {
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 20px;
      font-weight: 600;
      padding: 8px 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      backdrop-filter: blur(5px);
    }

    .weather-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      width: 100%;
      margin-top: 10px;
    }

    .weather-detail-item {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
      border-radius: 14px;
      padding: 14px;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }

    .weather-detail-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .weather-detail-item:hover::before {
      transform: scaleX(1);
    }

    .weather-detail-item:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.15));
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .detail-icon {
      font-size: 1.4rem; /* ä» 1.8rem å‡å° */
      margin-bottom: 8px;
      display: block;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .detail-label {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #ffffff;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* çŠ¶æ€æŒ‡ç¤ºå™¨ä¼˜åŒ– */
    .weather-status {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.85rem;
      margin-top: 12px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      backdrop-filter: blur(5px);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: currentColor;
      animation: statusPulse 2s infinite;
      box-shadow: 0 0 10px currentColor;
    }

    .weather-status.online {
      color: #4caf50;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .weather-status.offline {
      color: #ff9800;
      border: 1px solid rgba(255, 152, 0, 0.3);
    }

    .weather-status.error {
      color: #f44336;
      border: 1px solid rgba(244, 67, 54, 0.3);
    }

    /* APIä¿¡æ¯æ˜¾ç¤ºä¼˜åŒ– */
    .api-info {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
      text-align: right;
      margin-top: 10px;
      font-style: italic;
    }

    .riding-analysis {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .safety-assessment {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px;
      position: relative;
      overflow: hidden;
    }

    .safety-assessment.safe {
      border-left: 4px solid #4caf50;
    }

    .safety-assessment.warning {
      border-left: 4px solid #ff9800;
    }

    .safety-assessment.danger {
      border-left: 4px solid #f44336;
    }

    .assessment-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .assessment-icon {
      font-size: 1rem;
    }

    .assessment-level {
      font-weight: bold;
      font-size: 1rem;
    }

    .assessment-description {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.4;
    }

    .weather-warning {
      background: linear-gradient(135deg, rgba(244, 67, 54, 0.2), rgba(244, 67, 54, 0.1));
      border: 1px solid rgba(244, 67, 54, 0.3);
      border-radius: 12px;
      padding: 12px;
      margin-top: 8px;
      animation: warningPulse 2s ease-in-out infinite;
    }

    @keyframes warningPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .warning-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .warning-text {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .riding-recommendations {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px;
    }

    .recommendations-header {
      font-size: 1rem;
      font-weight: bold;
      color: #ffffff;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .recommendation-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .recommendation-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .recommendation-icon {
      font-size: 1rem;
      width: 16px;
      text-align: center;
    }

    .best-time-section {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
    }

    .best-time-header {
      font-size: 1rem;
      font-weight: bold;
      color: #ffffff;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 8px;
    }

    .time-slot {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 8px 4px;
      text-align: center;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .time-slot.excellent {
      background: rgba(76, 175, 80, 0.3);
      border: 1px solid rgba(76, 175, 80, 0.5);
    }

    .time-slot.good {
      background: rgba(255, 193, 7, 0.3);
      border: 1px solid rgba(255, 193, 7, 0.5);
    }

    .time-slot.poor {
      background: rgba(244, 67, 54, 0.3);
      border: 1px solid rgba(244, 67, 54, 0.5);
    }

    .slot-time {
      font-weight: bold;
      margin-bottom: 2px;
    }

    .slot-condition {
      font-size: 0.7rem;
      opacity: 0.8;
    }

    /* é«˜å¾·å¤©æ°”APIçŠ¶æ€æŒ‡ç¤ºå™¨ */
    .weather-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 8px;
    }

    .weather-status.online {
      color: #4caf50;
    }

    .weather-status.offline {
      color: #ff9800;
    }

    .weather-status.error {
      color: #f44336;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: currentColor;
      animation: statusPulse 2s infinite;
    }

    @keyframes statusPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* åŸå¸‚è®¾ç½®åŒºåŸŸ */
    .location-settings {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .location-input {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .location-input input {
      flex: 1;
      min-width: 200px;
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 0.9rem;
    }

    .location-input input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .location-btn {
      padding: 8px 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(79, 172, 254, 0.2);
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      border: none;
    }

    .location-btn:hover {
      background: rgba(79, 172, 254, 0.3);
      transform: translateY(-1px);
    }

    .location-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* åŸå¸‚é€‰æ‹©å¿«æ·æŒ‰é’® */
    .city-shortcuts {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .city-shortcut {
      padding: 4px 12px;
      font-size: 0.8rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .city-shortcut:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .city-shortcut.active {
      background: rgba(79, 172, 254, 0.3);
      border-color: rgba(79, 172, 254, 0.5);
    }

    /* APIä¿¡æ¯æ˜¾ç¤º */
    .api-info {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.5);
      text-align: right;
      margin-top: 8px;
    }

    /* ========== éª‘è¡Œå®‰å…¨å»ºè®®å¡ç‰‡å¢å¼ºä¼˜åŒ– ========== */
    .recommendation-card {
      background: linear-gradient(135deg, 
        rgba(138, 43, 226, 0.15), 
        rgba(255, 20, 147, 0.1), 
        rgba(79, 172, 254, 0.08),
        rgba(255, 255, 255, 0.05));
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 24px;
      border: 1px solid rgba(138, 43, 226, 0.3);
      padding: 32px;
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 30px 80px rgba(138, 43, 226, 0.2),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      animation: cardSlideUp 1s ease-out;
    }

    /* åŠ¨æ€é¡¶éƒ¨æ¸å˜æ¡ */
    .recommendation-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, 
        #8a2be2, #ff1493, #4facfe, #00f2fe, #ff6b35, #ffd23f);
      border-radius: 24px 24px 0 0;
      background-size: 300% 100%;
      animation: recommendationGradient 5s ease-in-out infinite;
      z-index: 2;
      opacity: 0.9;
    }

    /* å…‰æ‰«æ•ˆæœå¢å¼º */
    .recommendation-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: -150%;
      width: 100%;
      height: 100%;
      background: linear-gradient(120deg, 
        transparent 30%, 
        rgba(255, 255, 255, 0.15) 45%,
        rgba(138, 43, 226, 0.25) 50%,
        rgba(255, 20, 147, 0.2) 55%,
        rgba(255, 255, 255, 0.15) 70%,
        transparent 85%);
      transform: skewX(-25deg);
      transition: left 1s ease;
      z-index: 1;
    }

    .recommendation-card:hover::after {
      left: 150%;
    }

    @keyframes recommendationGradient {
      0%, 100% { background-position: 0% 50%; }
      25% { background-position: 50% 50%; }
      50% { background-position: 100% 50%; }
      75% { background-position: 150% 50%; }
    }

    /* æ‚¬åœæ•ˆæœå¢å¼º */
    .recommendation-card:hover {
      transform: translateY(-12px) scale(1.03);
      box-shadow: 
        0 45px 100px rgba(138, 43, 226, 0.35),
        0 0 0 2px rgba(255, 20, 147, 0.4),
        0 0 60px rgba(138, 43, 226, 0.4),
        0 0 80px rgba(255, 20, 147, 0.3),
        0 0 100px rgba(79, 172, 254, 0.2);
      border-color: rgba(255, 20, 147, 0.6);
    }

    /* ä¼˜å…ˆçº§çŠ¶æ€æ ·å¼ */
    .recommendation-card.priority-safe {
      border-color: rgba(16, 185, 129, 0.4);
      background: linear-gradient(135deg, 
        rgba(16, 185, 129, 0.15), 
        rgba(52, 211, 153, 0.1), 
        rgba(255, 255, 255, 0.05));
    }

    .recommendation-card.priority-safe::before {
      background: linear-gradient(90deg, 
        #10b981, #34d399, #6ee7b7, #a7f3d0, #d1fae5);
      background-size: 200% 100%;
      animation: safeGradient 4s ease-in-out infinite;
    }

    .recommendation-card.priority-safe:hover {
      box-shadow: 
        0 45px 100px rgba(16, 185, 129, 0.35),
        0 0 0 2px rgba(52, 211, 153, 0.5),
        0 0 60px rgba(16, 185, 129, 0.4);
      border-color: rgba(52, 211, 153, 0.6);
    }

    .recommendation-card.priority-warning {
      border-color: rgba(245, 158, 11, 0.4);
      background: linear-gradient(135deg, 
        rgba(245, 158, 11, 0.15), 
        rgba(251, 191, 36, 0.1), 
        rgba(255, 255, 255, 0.05));
    }

    .recommendation-card.priority-warning::before {
      background: linear-gradient(90deg, 
        #f59e0b, #fbbf24, #fcd34d, #fde68a, #fef3c7);
      background-size: 200% 100%;
      animation: warningGradient 3s ease-in-out infinite;
    }

    .recommendation-card.priority-warning:hover {
      box-shadow: 
        0 45px 100px rgba(245, 158, 11, 0.35),
        0 0 0 2px rgba(251, 191, 36, 0.5),
        0 0 60px rgba(245, 158, 11, 0.4);
      border-color: rgba(251, 191, 36, 0.6);
    }

    .recommendation-card.priority-danger {
      border-color: rgba(239, 68, 68, 0.4);
      background: linear-gradient(135deg, 
        rgba(239, 68, 68, 0.15), 
        rgba(248, 113, 113, 0.1), 
        rgba(255, 255, 255, 0.05));
    }

    .recommendation-card.priority-danger::before {
      background: linear-gradient(90deg, 
        #ef4444, #f87171, #fca5a5, #fecaca, #fee2e2);
      background-size: 200% 100%;
      animation: dangerGradient 2s ease-in-out infinite;
    }

    .recommendation-card.priority-danger:hover {
      box-shadow: 
        0 45px 100px rgba(239, 68, 68, 0.35),
        0 0 0 2px rgba(248, 113, 113, 0.5),
        0 0 60px rgba(239, 68, 68, 0.4);
      border-color: rgba(248, 113, 113, 0.6);
    }

    @keyframes safeGradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes warningGradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes dangerGradient {
      0%, 100% { background-position: 0% 50%; opacity: 1; }
      50% { background-position: 100% 50%; opacity: 0.8; }
    }

    /* æ ‡é¢˜å’Œå›¾æ ‡å¢å¼º */
    .recommendation-card h2 {
      margin-bottom: 28px;
      font-size: clamp(20px, 4vw, 28px); /* ä» clamp(22px, 4.5vw, 32px) å‡å° */
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px; /* ä» 18px å¤§å¹…å‡å° */
      text-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      position: relative;
      z-index: 3;
      line-height: 1.3; /* å¢åŠ è¡Œé«˜æ§åˆ¶ */
      flex-wrap: nowrap; /* é˜²æ­¢æ¢è¡Œ */
      min-height: 40px; /* ç¡®ä¿è¶³å¤Ÿé«˜åº¦ */
    }

    .recommendation-icon {
      font-size: clamp(20px, 3.5vw, 26px); /* ä» clamp(28px, 6vw, 40px) å¤§å¹…å‡å° */
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.6));
      animation: iconFloat 3s ease-in-out infinite;
      flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
      width: clamp(20px, 3.5vw, 26px); /* å›ºå®šå®½åº¦ */
      height: clamp(20px, 3.5vw, 26px); /* å›ºå®šé«˜åº¦ */
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes iconFloat {
      0%, 100% { 
        transform: translateY(0px) rotate(0deg) scale(1); 
        filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.6));
      }
      25% { 
        transform: translateY(-2px) rotate(-1deg) scale(1.02); /* ä» -4px -3deg 1.05 å‡å° */
        filter: drop-shadow(0 0 12px rgba(255, 20, 147, 0.8));
      }
      50% { 
        transform: translateY(-3px) rotate(0deg) scale(1.04); /* ä» -6px 1.1 å‡å° */
        filter: drop-shadow(0 0 15px rgba(79, 172, 254, 0.8));
      }
      75% { 
        transform: translateY(-2px) rotate(1deg) scale(1.02); /* ä» -4px 3deg 1.05 å‡å° */
        filter: drop-shadow(0 0 12px rgba(255, 20, 147, 0.8));
      }
    }

    .recommendation-card:hover .recommendation-icon {
      transform: scale(1.1) rotate(8deg); /* ä» scale(1.2) rotate(15deg) å‡å° */
      filter: drop-shadow(0 0 20px rgba(138, 43, 226, 1)) 
              drop-shadow(0 0 25px rgba(255, 20, 147, 0.8)); /* ä» 30px 40px å‡å° */
    }

    /* å†…å®¹åŒºåŸŸå¢å¼º */
    .recommendation-display {
      display: flex;
      flex-direction: column;
      gap: clamp(24px, 4vw, 32px);
      position: relative;
      z-index: 3;
    }

    /* ä¼˜å…ˆçº§æ˜¾ç¤ºå¢å¼º */
    .recommendation-priority {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 14px 24px;
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.15), 
        rgba(255, 255, 255, 0.08));
      border-radius: 20px;
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    .recommendation-priority::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.3), 
        transparent);
      transition: left 0.6s ease;
    }

    .recommendation-priority:hover::before {
      left: 100%;
    }

    .priority-label {
      font-size: clamp(14px, 3vw, 16px);
      color: rgba(255, 255, 255, 0.8);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .priority-value {
      font-size: clamp(18px, 4vw, 24px);
      font-weight: 800;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
      background: linear-gradient(45deg, #ffffff, #e3f2fd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: priorityPulse 2s ease-in-out infinite;
    }

    @keyframes priorityPulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.05); }
    }

    /* ä¸»è¦å†…å®¹å¢å¼º */
    .recommendation-content {
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.1), 
        rgba(255, 255, 255, 0.05));
      border-radius: 20px;
      padding: clamp(24px, 4vw, 32px);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      position: relative;
      overflow: hidden;
    }

    .recommendation-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, 
        rgba(138, 43, 226, 0.8), 
        rgba(255, 20, 147, 0.8), 
        rgba(79, 172, 254, 0.8));
      background-size: 200% 100%;
      animation: contentGradient 3s ease-in-out infinite;
    }

    @keyframes contentGradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .recommendation-main {
      font-size: clamp(16px, 3.5vw, 20px);
      font-weight: 600;
      color: #ffffff;
      line-height: 1.6;
      margin-bottom: clamp(20px, 3vw, 28px);
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      animation: textGlow 4s ease-in-out infinite;
    }

    @keyframes textGlow {
      0%, 100% { text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
      50% { text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.3); }
    }

    /* è¯¦ç»†ä¿¡æ¯å¢å¼º */
    .recommendation-details {
      display: flex;
      flex-direction: column;
      gap: clamp(16px, 3vw, 20px);
      margin: clamp(20px, 3vw, 28px) 0;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.12), 
        rgba(255, 255, 255, 0.06));
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .detail-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.2), 
        transparent);
      transition: left 0.5s ease;
    }

    .detail-item:hover::before {
      left: 100%;
    }

    .detail-item:hover {
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.18), 
        rgba(255, 255, 255, 0.1));
      transform: translateX(8px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      border-color: rgba(255, 255, 255, 0.25);
    }

    .detail-icon {
      font-size: clamp(16px, 3vw, 22px); /* ä» clamp(20px, 4vw, 28px) å‡å° */
      flex-shrink: 0;
      filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.3)); /* ä» 8px å‡å° */
      animation: detailIconPulse 3s ease-in-out infinite;
    }

    @keyframes detailIconPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.08); opacity: 0.9; } /* ä» scale(1.1) å‡å° */
    }

    .detail-text {
      font-size: clamp(14px, 3vw, 16px);
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.5;
      font-weight: 500;
      flex: 1; /* ç¡®ä¿æ–‡å­—å ç”¨å‰©ä½™ç©ºé—´ */
    }

    /* æ“ä½œæŒ‰é’®å¢å¼º */
    .recommendation-actions {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(12px, 3vw, 16px);
      margin-top: clamp(20px, 3vw, 28px);
    }

    .action-button {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 20px;
      background: linear-gradient(135deg, 
        rgba(79, 172, 254, 0.3), 
        rgba(138, 43, 226, 0.2));
      border: 1px solid rgba(79, 172, 254, 0.4);
      border-radius: 15px;
      color: #ffffff;
      font-size: clamp(13px, 3vw, 15px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      flex: 1;
      min-width: 120px;
      justify-content: center;
    }

    .action-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.3), 
        transparent);
      transition: left 0.6s ease;
    }

    .action-button:hover::before {
      left: 100%;
    }

    .action-button:hover {
      background: linear-gradient(135deg, 
        rgba(79, 172, 254, 0.5), 
        rgba(138, 43, 226, 0.4));
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        0 15px 35px rgba(79, 172, 254, 0.4),
        0 0 30px rgba(138, 43, 226, 0.3);
      border-color: rgba(79, 172, 254, 0.6);
    }

    .action-button:active {
      transform: translateY(-1px) scale(1.02);
    }

    .action-icon {
      font-size: clamp(14px, 3vw, 18px); /* ä» clamp(16px, 3.5vw, 20px) å‡å° */
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      transition: transform 0.3s ease;
    }

    .action-button:hover .action-icon {
      transform: scale(1.15) rotate(8deg); /* ä» scale(1.2) rotate(10deg) å‡å° */
    }

    .action-text {
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /* å“åº”å¼è®¾è®¡ä¼˜åŒ– */
    @media (max-width: 1024px) {

      .weather-title {
        font-size: 1.2rem;
        gap: 8px;
      }

      .weather-title .weather-icon {
        font-size: 1.2rem;
        width: 1.2rem;
        height: 1.2rem;
      }

      .weather-content {
        grid-template-columns: 1fr;
        gap: 25px;
      }
      
      .location-input {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .recommendation-card {
        padding: 24px;
      }

      .recommendation-card h2 {
        font-size: clamp(18px, 3.5vw, 24px);
        gap: 8px;
      }

      .recommendation-actions {
        flex-direction: column;
      }

      .recommendation-icon {
        font-size: clamp(18px, 3vw, 22px);
        width: clamp(18px, 3vw, 22px);
        height: clamp(18px, 3vw, 22px);
      }

      .action-button {
        min-width: auto;
      }
    }

    @media (max-width: 768px) {

      .weather-title {
        font-size: 1.1rem;
        gap: 6px;
      }

      .weather-title .weather-icon {
        font-size: 1.1rem;
        width: 1.1rem;
        height: 1.1rem;
      }

      .time-icon {
        font-size: clamp(18px, 3vw, 24px);
      }
   
      .weather-card {
        padding: 20px;
        margin-bottom: 20px;
      }
      
      /* å¤©æ°”å¡ç‰‡å¤´éƒ¨å¸ƒå±€ä¼˜åŒ– */
      .weather-header {
        flex-direction: column;
        gap: 12px; /* ä» 15px å‡å° */
        text-align: center;
        align-items: center;
      }
      
      .weather-title {
        font-size: 1.4rem;
      }
      
      .weather-content {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .weather-details {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .temperature {
        font-size: 2.8rem;
      }
      
      .weather-main-icon {
        font-size: 3rem;
      }
      
      .city-shortcuts {
        justify-content: center;
      }
      
      .location-settings {
        padding: 16px;
      }
      
      .statistics-panel {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      
      .stat-card {
        padding: 20px 16px;
      }
      
      .stat-value {
        font-size: 1.6rem;
      }
      
      .stat-icon {
        font-size: 1.8rem;
      }

      .recommendation-card {
        padding: 20px;
        border-radius: 20px;
      }

      .recommendation-card h2 {
        font-size: clamp(16px, 3vw, 20px);
        gap: 6px;
        justify-content: center; /* å±…ä¸­å¯¹é½ */
      }

      .recommendation-content {
        padding: 20px;
      }

      .recommendation-icon {
        font-size: clamp(16px, 2.5vw, 18px);
        width: clamp(16px, 2.5vw, 18px);
        height: clamp(16px, 2.5vw, 18px);
      }

      .detail-item {
        padding: 12px 16px;
        gap: 12px;
      }

      .data-card h2,
      .history-data-card h2 {
        font-size: clamp(16px, 3vw, 22px);
        gap: 8px;
      }
      
      .time-icon,
      .safety-icon {
        font-size: clamp(16px, 2.5vw, 20px);
        width: clamp(16px, 2.5vw, 20px);
        height: clamp(16px, 2.5vw, 20px);
      }

    }

    @media (max-width: 480px) {

      .weather-title {
        font-size: 1rem;
        gap: 5px;
      }

      .weather-title .weather-icon {
        font-size: 1rem;
        width: 1rem;
        height: 1rem;
      }

      .weather-card {
        padding: 16px;
        border-radius: 16px;
      }
      
      .weather-main-icon {
        font-size: 2.5rem;
      }
      
      .temperature {
        font-size: 2.5rem;
      }
      
      .city-shortcuts {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .city-shortcut {
        font-size: 0.8rem;
        padding: 6px 12px;
      }
      
      .time-slots {
        grid-template-columns: repeat(3, 1fr);
      }

      .recommendation-card h2 {
        font-size: clamp(14px, 2.5vw, 18px);
        gap: 5px;
      }

      .recommendation-card {
        padding: 16px;
        border-radius: 16px;
      }

      .recommendation-icon {
        font-size: clamp(14px, 2vw, 16px);
        width: clamp(14px, 2vw, 16px);
        height: clamp(14px, 2vw, 16px);
      }

      .recommendation-actions {
        gap: 8px;
      }

      .action-button {
        padding: 10px 16px;
        font-size: 12px;
      }

      .data-card h2,
      .history-data-card h2 {
        font-size: clamp(14px, 2.5vw, 18px);
        gap: 6px;
      }
      
      .time-icon,
      .safety-icon {
        font-size: clamp(14px, 2vw, 16px);
        width: clamp(14px, 2vw, 16px);
        height: clamp(14px, 2vw, 16px);
      }


    }
/* ----- è‡ªå®šä¹‰å¼¹çª—æ ·å¼ï¼ˆä¸ page1.html ä¿æŒä¸€è‡´ï¼‰ ----- */
      .modal-overlay {
        position: fixed; inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none; align-items: center; justify-content: center;
        z-index: 50;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal {
        position: relative;
        width: 400px; max-width: 90%;
        padding: 32px 24px;
        background: rgba(20,20,40,0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 4px 12px rgba(0,0,0,0.4), 0 8px 20px rgba(0,0,0,0.5);
        text-align: center; color: #fff;
      }
      .modal h3 {
        margin: 0 0 16px; font-size: 20px; font-weight: 600;
        text-shadow: 0 0 6px rgba(0,0,0,0.5);
      }
      .modal p {
        margin: 0 0 24px; font-size: 16px; line-height: 1.4;
      }
      .modal-buttons {
        display: flex; justify-content: center; gap: 16px;
      }
      .modal-btn {
        min-width: 100px; padding: 10px 0; font-size: 14px;
        font-weight: 500; border-radius: 8px; cursor: pointer;
        transition: transform .2s, box-shadow .2s;
      }
      .modal-btn.primary {
        background: linear-gradient(135deg, #ff6ec4, #7873f5);
        border: none; box-shadow: 0 4px 12px rgba(120,115,245,0.6); color: #fff;
      }
      .modal-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(120,115,245,0.8);
      }
      .modal-btn.secondary {
        background: transparent; border: 2px solid rgba(255,255,255,0.6);
        color: #fff;
      }
      .modal-btn.secondary:hover {
        background: rgba(255,255,255,0.1);
        transform: translateY(-2px);
      }
  </style>
</head>
<body>
 
  <div class="page-container">
    <button id="toStaticBtn" class="toggle-btn">ç‚¹å‡»è¿›å…¥ä¼‘æ¯æ¨¡å¼<span class ="rest-icon">ğŸµ</span></button>
      <div class="battery-status" id="batteryStatus">
    <div class="battery-container">
      <div class="battery-icon">
        <div class="battery-level" id="batteryLevelBar"></div>
      </div>
      <div class="battery-text" id="batteryText">--%</div>
    </div>
  </div>
     
    <h1>æ¬¢è¿å›æ¥,allforkarina!</h1>

    <!-- ä¼˜åŒ–åçš„æ—¶é—´æ˜¾ç¤ºå¡ç‰‡ -->
    <div class="data-card time-card">
      <h2>
        <span class="time-icon" id="timeIcon">ğŸ•</span>
        å½“å‰æ—¶é—´
      </h2>
      
      <div class="time-display">
        <div class="date-section">
          <div class="current-date" id="current-date">2025-07-19</div>
          <div class="current-weekday" id="current-weekday">æ˜ŸæœŸå…­</div>
        </div>
        
        <div class="time-section">
          <div class="digital-clock" id="digital-clock">
            <span class="time-hours" id="time-hours">12</span>
            <span class="time-separator">:</span>
            <span class="time-minutes" id="time-minutes">44</span>
            <span class="time-separator">:</span>
            <span class="time-seconds" id="time-seconds">06</span>
          </div>
          <div class="time-zone" id="time-zone">UTC+8 åŒ—äº¬æ—¶é—´</div>
        </div>
      </div>
    </div>

    <!-- ä¿®æ”¹åçš„å¤©æ°”å½±å“åˆ†æå¡ç‰‡ - ä½¿ç”¨é«˜å¾·å¤©æ°”API -->
    <div class="weather-card" id="weatherCard">
      <div class="weather-header">
        <h2 class="weather-title">
          <span class="weather-icon" id="weatherTitleIcon">ğŸŒ¤ï¸</span>
          å¤©æ°”å½±å“åˆ†æ
        </h2>
        <button class="weather-refresh-btn" id="weatherRefreshBtn">
          <span class="refresh-icon">ğŸ”„</span>
          æ›´æ–°å¤©æ°”
        </button>
      </div>
      
      <!-- é«˜å¾·å¤©æ°”åŸå¸‚è®¾ç½® -->
      <div class="location-settings">
        <div class="location-input">
          <input type="text" id="cityInput" placeholder="è¾“å…¥åŸå¸‚åç§° (å¦‚: è´µé˜³å¸‚, åŒ—äº¬å¸‚, ä¸Šæµ·å¸‚)" value="è´µé˜³å¸‚">
          <button class="location-btn" id="setCityBtn">è®¾ç½®åŸå¸‚</button>
          <button class="location-btn" id="getCurrentLocationBtn">ğŸ“ IPå®šä½</button>
        </div>
        
        <!-- çƒ­é—¨åŸå¸‚å¿«æ·é€‰æ‹© -->
        <div class="city-shortcuts">
          <span class="city-shortcut" data-city="è´µé˜³å¸‚">è´µé˜³</span>
          <span class="city-shortcut" data-city="åŒ—äº¬å¸‚">åŒ—äº¬</span>
          <span class="city-shortcut" data-city="ä¸Šæµ·å¸‚">ä¸Šæµ·</span>
          <span class="city-shortcut" data-city="å¹¿å·å¸‚">å¹¿å·</span>
          <span class="city-shortcut" data-city="æ·±åœ³å¸‚">æ·±åœ³</span>
          <span class="city-shortcut" data-city="æ­å·å¸‚">æ­å·</span>
          <span class="city-shortcut" data-city="å—äº¬å¸‚">å—äº¬</span>
          <span class="city-shortcut" data-city="æ­¦æ±‰å¸‚">æ­¦æ±‰</span>
        </div>
        
        <div class="weather-status offline" id="weatherStatus">
          <div class="status-dot"></div>
          <span id="statusText">å‡†å¤‡è·å–å¤©æ°”æ•°æ®...</span>
        </div>
        
        <div class="api-info">
          æ•°æ®æ¥æºï¼šé«˜å¾·åœ°å›¾å¤©æ°”API
        </div>
      </div>
      
      <div class="weather-content">
        <div class="current-weather">
          <div class="weather-main-icon" id="weatherMainIcon">ğŸŒ¤ï¸</div>
          <div class="temperature" id="temperature">
            <span id="tempValue">--</span>Â°C
          </div>
          <div class="weather-description" id="weatherDescription">åŠ è½½ä¸­...</div>
          
          <div class="weather-details">
            <div class="weather-detail-item">
              <span class="detail-icon">ğŸ’§</span>
              <div class="detail-label">æ¹¿åº¦</div>
              <div class="detail-value" id="humidity">--%</div>
            </div>
            <div class="weather-detail-item">
              <span class="detail-icon">ğŸ’¨</span>
              <div class="detail-label">é£åŠ›</div>
              <div class="detail-value" id="windSpeed">-- çº§</div>
            </div>
            <div class="weather-detail-item">
              <span class="detail-icon">ğŸŒªï¸</span>
              <div class="detail-label">é£å‘</div>
              <div class="detail-value" id="windDirection">--</div>
            </div>
            <div class="weather-detail-item">
              <span class="detail-icon">ğŸ“Š</span>
              <div class="detail-label">æ°”å‹</div>
              <div class="detail-value" id="pressure">-- hPa</div>
            </div>
          </div>
        </div>
        
        <div class="riding-analysis">
          <div class="safety-assessment safe" id="safetyAssessment">
            <div class="assessment-header">
              <span class="assessment-icon" id="assessmentIcon">âœ…</span>
              <span class="assessment-level" id="assessmentLevel">åŠ è½½ä¸­...</span>
            </div>

            <div class="assessment-description" id="assessmentDescription">
                      æ­£åœ¨è·å–å¤©æ°”æ•°æ®ï¼Œè¯·ç¨å€™...
            </div>
            
            <div class="weather-warning" id="weatherWarning" style="display: none;">
              <div class="warning-header">
                <span>âš ï¸</span>
                <strong>å¤©æ°”è­¦å‘Š</strong>
              </div>
              <div class="warning-text" id="warningText">
                æ£€æµ‹åˆ°æ¶åŠ£å¤©æ°”æ¡ä»¶ï¼Œè¯·è°¨æ…éª‘è¡Œã€‚
              </div>
            </div>
          </div>
          
          <div class="riding-recommendations">
            <div class="recommendations-header">
              <span>ğŸ’¡</span>
              éª‘è¡Œå»ºè®®
            </div>
            <ul class="recommendation-list" id="recommendationList">
              <li class="recommendation-item">
                <span class="recommendation-icon">â³</span>
                <span>æ­£åœ¨è·å–å¤©æ°”ä¿¡æ¯...</span>
              </li>
            </ul>
          </div>
          
          <div class="best-time-section">
            <div class="best-time-header">
              <span>â°</span>
              å»ºè®®éª‘è¡Œæ—¶é—´
            </div>
            <div class="time-slots" id="timeSlots">
              <div class="time-slot">
                <div class="slot-time">åŠ è½½ä¸­</div>
                <div class="slot-condition">...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ–°å¢ï¼šæ•°æ®ç»Ÿè®¡é¢æ¿ -->
    <div class="data-card">
      <div class="statistics-header">
        <h2 class="statistics-title">
          <span class="title-icon">ğŸ“Š</span>
          éª‘è¡Œæ•°æ®ç»Ÿè®¡
        </h2>
        <button class="refresh-btn" id="refreshStatsBtn">
          <span class="refresh-icon">ğŸ”„</span>
          åˆ·æ–°æ•°æ®
        </button>
      </div>
      
  <div class="statistics-panel">
        <div class="stat-card" id="distanceCard">
          <span class="stat-icon">ğŸ“</span>
          <div class="stat-label">å½“å‰è·ç¦»</div>
          <div class="stat-value" id="distance-value">
            --<span class="stat-unit">m</span>
          </div>
        </div>

        <div class="stat-card" id="targetCard">
          <span class="stat-icon">ğŸ¯</span>
          <div class="stat-label">ç›®æ ‡æ•°é‡</div>
          <div class="stat-value" id="target-value">
            --<span class="stat-unit">ä¸ª</span>
          </div>
        </div>

        <div class="stat-card danger" id="dangerCard">
          <span class="stat-icon">ğŸš¨</span>
          <div class="stat-label">å±é™©äº‹ä»¶æ¬¡æ•°</div>
          <div class="stat-value" id="dangerCount">
            --<span class="stat-unit">æ¬¡</span>
          </div>
          <div class="stat-trend neutral" id="dangerTrend">æš‚æ— æ•°æ®</div>
        </div>

        <div class="stat-card" id="avgDistanceCard">
          <span class="stat-icon">ğŸ“</span>
          <div class="stat-label">å¹³å‡å®‰å…¨è·ç¦»</div>
          <div class="stat-value" id="avgDistance">
            --<span class="stat-unit">ç±³</span>
          </div>
          <div class="stat-trend neutral" id="distanceTrend">æš‚æ— æ•°æ®</div>
        </div>
      </div>
    </div>

    <!-- æ–°å¢ï¼šç”µæ± çŠ¶æ€å›¾è¡¨ -->
    <div class="data-card">
      <h2 class="statistics-title">
        <span class="title-icon">ğŸ”‹</span>
        ç”µæ± çŠ¶æ€å›¾è¡¨
      </h2>
      <div class="chart-card">
        <h3 class="chart-title">ç”µæ± ç”µå‹/ç”µæµå˜åŒ–</h3>
        <div class="chart-canvas">
          <canvas id="batteryChart"></canvas>
        </div>
      </div>
    </div>

    <div class="history-data-card">
      <h2>å†å²æ•°æ®</h2>

      <!-- ä¸‹æ‹‰æ  -->
      <div class="selector-container">
        <label for="dateSelector"><strong>é€‰æ‹©æ—¥æœŸï¼š</strong></label>
        <select id="dateSelector"></select>
      </div>

      <!-- åŠ¨æ€æ•°æ®æ˜¾ç¤ºåŒºåŸŸ -->
      <div id="historyData" class="history-content">
        <div class="data-row">
          <div class="data-item">
            <strong>åæ–¹è½¦è¾†ï¼š</strong>
            <span id="numTarget">--</span>
          </div>
          <div class="data-item">
            <strong>æœ€è¿‘è·ç¦» (Distance)ï¼š</strong>
            <span id="Distance">--</span> m
          </div>
        </div>
        
        <div class="map-container">
          <p><strong>ä½ç½®è·¯å¾„åœ°å›¾ï¼š</strong></p>
          <div id="map"></div>
        </div>
      </div>

      <div class="logout-container">
        <button id="logoutBtn">é€€å‡ºç™»å½•</button>
        <button id="clearLocalBtn">æ¸…é™¤æœ¬åœ°æ•°æ®</button>
      </div>
    </div>

    <!-- ä¼˜åŒ–åçš„å®‰å…¨ç³»æ•°å¡ç‰‡ -->
    <div class="data-card safety-card">
      <h2>
        <span class="safety-icon" id="safetyIcon">ğŸ›¡ï¸</span>
        éª‘è¡Œå®‰å…¨ç³»æ•°
      </h2>
      
      <div class="safety-display">
        <div class="safety-level-container">
          <div class="safety-level-text">
            <span id="safety-level">å½“å‰çŠ¶æ€ï¼šå®‰å…¨</span>
            <span class="safety-percentage" id="safetyPercentage">100%</span>
          </div>
          
          <div class="safety-progress-container">
            <div class="safety-progress-bar" id="safetyProgressBar">
              <div class="safety-progress-fill" id="safetyProgressFill"></div>
              <div class="safety-progress-glow" id="safetyProgressGlow"></div>
            </div>
          </div>
        </div>
        
        <div class="safety-metrics">
          <div class="metric-item">
            <span class="metric-label">åæ–¹è·ç¦»</span>
            <span class="metric-value" id="safetyDistance">-- m</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">è½¦è¾†æ•°é‡</span>
            <span class="metric-value" id="safetyTargetCount">--</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">å¨èƒç­‰çº§</span>
            <span class="metric-value" id="threatLevel">æœªçŸ¥</span>
          </div>
        </div>
      </div>
    </div>

    <!-- æ–°å¢ï¼šç‹¬ç«‹çš„å®‰å…¨å»ºè®®å¡ç‰‡ - ä¼˜åŒ–å¢å¼ºç‰ˆ -->
    <div class="data-card recommendation-card" id="recommendationCard">
      <h2>
        <span class="recommendation-icon" id="recommendationIcon">ğŸš´</span>
        éª‘è¡Œå®‰å…¨å»ºè®®
      </h2>
      
      <div class="recommendation-display">
        <div class="recommendation-priority" id="recommendationPriority">
          <span class="priority-label">ä¼˜å…ˆçº§ï¼š</span>
          <span class="priority-value" id="priorityValue">æ­£å¸¸</span>
        </div>
        
        <div class="recommendation-content">
          <div class="recommendation-main" id="recommendationMain">
            æ­£åœ¨åˆ†æåæ–¹è½¦è¾†æƒ…å†µ...
          </div>
          
          <div class="recommendation-details" id="recommendationDetails">
            <div class="detail-item">
              <span class="detail-icon">ğŸ“Š</span>
              <span class="detail-text" id="analysisDetail">ç­‰å¾…è½¦è¾†æ•°æ®åˆ†æ</span>
            </div>
            <div class="detail-item">
              <span class="detail-icon">âš ï¸</span>
              <span class="detail-text" id="riskDetail">éª‘è¡Œé£é™©è¯„ä¼°ä¸­</span>
            </div>
            <div class="detail-item">
              <span class="detail-icon">ğŸ¯</span>
              <span class="detail-text" id="actionDetail">éª‘è¡Œå»ºè®®å¾…å®š</span>
            </div>
          </div>
          
          <div class="recommendation-actions" id="recommendationActions">
            <div class="action-button" id="actionButton1">
              <span class="action-icon">ğŸ”„</span>
              <span class="action-text">åˆ·æ–°æ•°æ®</span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
<!-- è‡ªå®šä¹‰å¼¹çª— -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal">
    <h3>æç¤º</h3>
    <p id="modalMsg">è¿™é‡Œæ˜¯æç¤ºå†…å®¹</p>
    <div class="modal-buttons">
      <button id="modalCancel" class="modal-btn secondary">å–æ¶ˆ</button>
      <button id="modalOk"       class="modal-btn primary">ç¡®å®š</button>
    </div>
  </div>
</div>

  <!-- å¼•å…¥ MQTT.js å’Œ Leaflet.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ========================================
    // å…¨å±€é…ç½®å’Œå˜é‡å£°æ˜
    // ========================================
    
    // é«˜å¾·å¤©æ°”APIé…ç½®
    const AMAP_API_KEY = '282762afa4b8bae6c3a5915c898115aa'; // è¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…API Key
    const AMAP_WEATHER_API = 'https://restapi.amap.com/v3/weather/weatherInfo';
    const AMAP_GEOCODING_API = 'https://restapi.amap.com/v3/geocode/geo';
    const AMAP_IP_LOCATION_API = 'https://restapi.amap.com/v3/ip';
    
    // è´µé˜³å¸‚åœ°ç†è¾¹ç•Œé…ç½®
    const GUIYANG_BOUNDS = {
      north: 27.209, south: 25.652, east: 107.394, west: 105.612
    };
    const GUIYANG_CITY_BOUNDS = {
      north: 26.851, south: 26.435, east: 106.945, west: 106.522
    };

    // æˆéƒ½å¸‚åœ°ç†è¾¹ç•Œé…ç½®
    const CHENGDU_BOUNDS = {
      north: 31.032,   // æˆéƒ½æœ€åŒ—ç«¯
      south: 30.058,   // æˆéƒ½æœ€å—ç«¯
      east: 104.714,   // æˆéƒ½æœ€ä¸œç«¯
      west: 101.956    // æˆéƒ½æœ€è¥¿ç«¯
    };
    const CHENGDU_CITY_BOUNDS = {
      north: 30.823,   // æˆéƒ½å¸‚åŒºæœ€åŒ—ç«¯
      south: 30.578,   // æˆéƒ½å¸‚åŒºæœ€å—ç«¯
      east: 104.160,   // æˆéƒ½å¸‚åŒºæœ€ä¸œç«¯
      west: 101.950    // æˆéƒ½å¸‚åŒºæœ€è¥¿ç«¯
    };

    // æµ™æ±Ÿ
    const ZHEJIANG_BOUNDS = {
      north: 30.868,   // æµ™æ±Ÿæœ€åŒ—ç«¯
      south: 27.151,   // æµ™æ±Ÿæœ€å—ç«¯
      east: 122.061,   // æµ™æ±Ÿæœ€ä¸œç«¯
      west: 118.028    // æµ™æ±Ÿæœ€è¥¿ç«¯
    };
    const ZHEJIANG_CITY_BOUNDS = {
      north: 30.328,   // æ­å·å¸‚åŒºæœ€åŒ—ç«¯ï¼ˆä»¥æ­å·ä¸ºä»£è¡¨åŸå¸‚ï¼‰
      south: 29.358,   // æ­å·å¸‚åŒºæœ€å—ç«¯
      east: 120.521,   // æ­å·å¸‚åŒºæœ€ä¸œç«¯
      west: 119.882    // æ­å·å¸‚åŒºæœ€è¥¿ç«¯
    };

    // MQTTé…ç½®
    const mqttOptions = {
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 4000
    };

    // å…¨å±€æ•°æ®å˜é‡
    let mockData = {};
    let weatherData = null;
    let weatherUpdateInterval = null;
    let currentCity = 'è´µé˜³å¸‚';
    let currentAdcode = null;
    let batteryChart = null;
    let batteryHistory = { voltage: [], current: [], timestamps: [] };
    let randomVoltage = 7.56;
    let batterylevel = 22;

    // åœ°å›¾ç›¸å…³å˜é‡
    let map = null;
    let currentPolyline = null;
    let currentMarkers = [];
    let locationContainer = {};

    // MQTTå®¢æˆ·ç«¯
    let client = null;

    // ========================================
    // æ•°æ®å­˜å‚¨å’Œç®¡ç†å‡½æ•°
    // ========================================

    // ä»æœ¬åœ°æ•°æ®ä¸­åŠ è½½å­˜å‚¨é…ç½®
    function loadLocalStorageConfig() {
      try {
          const configData = localStorage.getItem('storageConfig');
          if (configData) {
              const config = JSON.parse(configData);
              console.log('ä»æ§åˆ¶å°åŒæ­¥å­˜å‚¨é…ç½®:', config);
              window.maxBatteryDataPoints = config.maxBatteryDataPoints || 30;
              window.maxLocationDataPoints = config.maxLocationDataPoints || 30;
              window.maxHistoryDays = config.maxHistoryDays || 30;
              return {
                  maxBatteryDataPoints: config.maxBatteryDataPoints || 30,
                  maxLocationDataPoints: config.maxLocationDataPoints || 30,
                  maxHistoryDays: config.maxHistoryDays || 30,
                  lastUpdated: config.lastUpdated
              };
          } else {
              console.log('âš ï¸ æœªæ‰¾åˆ°å­˜å‚¨é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
              return getDefaultStorageConfig();
          }
      } catch (error) {
          console.error('âŒ è¯»å–å­˜å‚¨é…ç½®å¤±è´¥:', error);
          return getDefaultStorageConfig();
      }
    }

    // é»˜è®¤é…ç½®
    function getDefaultStorageConfig() {
      return {
          maxBatteryDataPoints: 30,
          maxLocationDataPoints: 30,
          maxHistoryDays: 30,
          lastUpdated: new Date().toISOString()
      };
    }

    // ä»localStorageåŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®
    function loadLocalStorageData() {
      // åŠ è½½ç”µæ± å†å²æ•°æ®
      loadBatteryHistory();
      
      // åŠ è½½è·¯å¾„æ•°æ®
      const stored = localStorage.getItem("mockData");
      if (stored) {
        try {
          mockData = JSON.parse(stored);
        } catch (e) {
          console.warn("ğŸ§¹ æœ¬åœ°æ•°æ®è§£æå¤±è´¥ï¼Œå°†æ¸…ç©ºç¼“å­˜");
          localStorage.removeItem("mockData");
          mockData = {};
        }
      }
    }

    // ä»localStorageåŠ è½½ç”µæ± å†å²æ•°æ®
    function loadBatteryHistory() {
      try {
        const stored = localStorage.getItem('batteryHistoryData');
        if (stored) {
          const data = JSON.parse(stored);
          batteryHistory = {
            voltage: data.voltage || [],
            current: data.current || [],
            timestamps: data.timestamps || []
          };
          console.log('ğŸ“Š ç”µæ± å†å²æ•°æ®å·²åŠ è½½:', batteryHistory.voltage.length + 'ä¸ªæ•°æ®ç‚¹');
        }
      } catch (e) {
        console.warn('âš ï¸ ç”µæ± å†å²æ•°æ®åŠ è½½å¤±è´¥:', e);
        batteryHistory = { voltage: [], current: [], timestamps: [] };
      }
    }

    // ä¿å­˜ç”µæ± å†å²æ•°æ®åˆ°localStorage
    function saveBatteryHistory() {
      try {
        localStorage.setItem('batteryHistoryData', JSON.stringify(batteryHistory));
      } catch (e) {
        console.warn('âš ï¸ ç”µæ± å†å²æ•°æ®ä¿å­˜å¤±è´¥:', e);
      }
    }

    function initStorageConfigListener() {
      // ç›‘å¬storageäº‹ä»¶ï¼ˆè·¨æ ‡ç­¾é¡µé€šä¿¡ï¼‰
      window.addEventListener('storage', function(e) {
          if (e.key === 'storageConfig' && e.newValue) {
              try {
                  const newConfig = JSON.parse(e.newValue);
                  console.log('ğŸ”„ æ£€æµ‹åˆ°å­˜å‚¨é…ç½®æ›´æ–°:', newConfig);
                  
                  // æ›´æ–°å…¨å±€é…ç½®
                  window.maxBatteryDataPoints = newConfig.maxBatteryDataPoints || 30;
                  window.maxLocationDataPoints = newConfig.maxLocationDataPoints || 30;
                  window.maxHistoryDays = newConfig.maxHistoryDays || 30;
                  
                  // ç«‹å³åº”ç”¨æ–°çš„å­˜å‚¨é™åˆ¶
                  applyStorageLimits();
                  
                  console.log('âœ… å­˜å‚¨é…ç½®å·²åŒæ­¥æ›´æ–°');
              } catch (error) {
                  console.error('âŒ è§£æå­˜å‚¨é…ç½®å¤±è´¥:', error);
              }
          }
        });

      console.log('ğŸ‘‚ å­˜å‚¨é…ç½®ç›‘å¬å™¨å·²å¯åŠ¨');
    }

    function applyStorageLimits() {
        try {
            // 1. æ¸…ç†ç”µæ± å†å²æ•°æ®
            cleanupBatteryData();

            // 2. æ¸…ç†è·¯å¾„ä½ç½®æ•°æ®
            cleanupLocationData();
            
            // 3. æ¸…ç†å†å²å¤©æ•°æ•°æ®
            cleanupHistoryDays();
            
            console.log(`ğŸ“Š å­˜å‚¨é™åˆ¶å·²åº”ç”¨:
                - ç”µæ± æ•°æ®ç‚¹: ${window.maxBatteryDataPoints}
                - ä½ç½®æ•°æ®ç‚¹: ${window.maxLocationDataPoints}  
                - å†å²å¤©æ•°: ${window.maxDays}`);
                
        } catch (error) {
            console.error('âŒ åº”ç”¨å­˜å‚¨é™åˆ¶å¤±è´¥:', error);
        }
    }

    function cleanupBatteryData() {
        try {
            // æ¸…ç†ç”µæ± å†å²æ•°æ®
            const batteryData = localStorage.getItem('batteryHistoryData');
            if (batteryData) {
                let parsedData = JSON.parse(batteryData);
                
                // æ£€æŸ¥æ•°æ®ç»“æ„æ˜¯å¦æ­£ç¡®
                if (parsedData && parsedData.voltage && parsedData.current && parsedData.timestamps &&
                    Array.isArray(parsedData.voltage) && Array.isArray(parsedData.current) && Array.isArray(parsedData.timestamps)) {
                    
                    const voltageLength = parsedData.voltage.length;
                    const currentLength = parsedData.current.length;
                    const timestampsLength = parsedData.timestamps.length;
                    
                    // è·å–æœ€å¤§é•¿åº¦ä½œä¸ºæ•°æ®ç‚¹æ•°é‡
                    const dataPointCount = Math.max(voltageLength, currentLength, timestampsLength);
                    
                    console.log(`ğŸ“Š ç”µæ± æ•°æ®æ£€æŸ¥: voltage(${voltageLength}), current(${currentLength}), timestamps(${timestampsLength})`);
                    
                    if (dataPointCount > adminSettings.storageLimit) {
                        // ä¿ç•™æœ€æ–°çš„æ•°æ® - å¯¹æ¯ä¸ªæ•°ç»„åˆ†åˆ«å¤„ç†
                        const keepCount = adminSettings.storageLimit;
                        
                        parsedData.voltage = parsedData.voltage.slice(-keepCount);
                        parsedData.current = parsedData.current.slice(-keepCount);
                        parsedData.timestamps = parsedData.timestamps.slice(-keepCount);
                        
                        localStorage.setItem('batteryHistoryData', JSON.stringify(parsedData));
                        console.log(`ğŸ”‹ ç”µæ± æ•°æ®æ¸…ç†å®Œæˆï¼Œä¿ç•™æœ€æ–° ${keepCount} æ¡ï¼Œåˆ é™¤äº† ${dataPointCount - keepCount} æ¡`);
                    } else {
                        console.log(`âœ… ç”µæ± æ•°æ®æ£€æŸ¥å®Œæˆï¼Œå½“å‰ ${dataPointCount} æ¡æ•°æ®åœ¨é™åˆ¶èŒƒå›´å†…`);
                    }
                    
                } else {
                    console.warn('âš ï¸ ç”µæ± æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè·³è¿‡æ¸…ç†');
                }
            } else {
                console.log('ğŸ“Š æœªæ‰¾åˆ°ç”µæ± å†å²æ•°æ®');
            }
        } catch (error) {
            console.error('âŒ æ¸…ç†ç”µæ± æ•°æ®å¤±è´¥:', error);
        }
    }

    function cleanupLocationData() {
        try {
            const storedData = localStorage.getItem('mockData');
            if (storedData) {
                const data = JSON.parse(storedData);
                let totalCleaned = 0;
                
                // éå†æ¯å¤©çš„æ•°æ®
                Object.keys(data).forEach(date => {
                    if (data[date].path && Array.isArray(data[date].path)) {
                        const originalLength = data[date].path.length;
                        
                        if (originalLength > window.maxLocationDataPoints) {
                            // ä¿ç•™æœ€æ–°çš„ä½ç½®ç‚¹
                            data[date].path = data[date].path.slice(-window.maxLocationDataPoints);
                            totalCleaned += originalLength - window.maxLocationDataPoints;
                            
                            console.log(`ğŸ“ ${date} ä½ç½®æ•°æ®: ${originalLength} â†’ ${data[date].path.length}`);
                        }
                    }
                });
                
                if (totalCleaned > 0) {
                    // æ›´æ–°localStorage
                    localStorage.setItem('mockData', JSON.stringify(data));
                    
                    // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
                    mockData = data;
                    
                    console.log(`ğŸ—ºï¸ ä½ç½®æ•°æ®æ¸…ç†å®Œæˆï¼Œæ€»å…±åˆ é™¤ ${totalCleaned} ä¸ªä½ç½®ç‚¹`);
                    
                    // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ—¥æœŸæœ‰æ•°æ®æ›´æ–°ï¼Œåˆ·æ–°åœ°å›¾
                    const currentDate = document.getElementById('dateSelector').value;
                    if (currentDate && data[currentDate]) {
                        updateMapDisplay(currentDate);
                    }
                }
            }
        } catch (error) {
            console.error('âŒ æ¸…ç†ä½ç½®æ•°æ®å¤±è´¥:', error);
        }
    }

    function cleanupHistoryDays() {
        try {
            const storedData = localStorage.getItem('mockData');
            if (storedData) {
                const data = JSON.parse(storedData);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - window.maxDays);
                
                let deletedDays = 0;
                const datesToDelete = [];
                
                // æ‰¾å‡ºéœ€è¦åˆ é™¤çš„æ—¥æœŸ
                Object.keys(data).forEach(date => {
                    const dateObj = new Date(date);
                    if (dateObj < cutoffDate) {
                        datesToDelete.push(date);
                    }
                });
                
                // åˆ é™¤è¿‡æœŸæ•°æ®
                datesToDelete.forEach(date => {
                    delete data[date];
                    deletedDays++;
                });
                
                if (deletedDays > 0) {
                    // æ›´æ–°localStorage
                    localStorage.setItem('mockData', JSON.stringify(data));
                    
                    // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
                    mockData = data;
                    
                    // é‡æ–°ç”Ÿæˆæ—¥æœŸé€‰é¡¹
                    const dateSelector = document.getElementById('dateSelector');
                    const currentValue = dateSelector.value;
                    
                    // æ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆé€‰é¡¹
                    dateSelector.innerHTML = '';
                    generateDateOptions("2025-06-04");
                    
                    // å°è¯•æ¢å¤ä¹‹å‰é€‰æ‹©çš„æ—¥æœŸï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é€‰æ‹©ä»Šå¤©
                    const today = new Date().toISOString().split("T")[0];
                    if (data[currentValue]) {
                        dateSelector.value = currentValue;
                    } else {
                        dateSelector.value = today;
                    }
                    dateSelector.dispatchEvent(new Event("change"));
                    
                    console.log(`ğŸ“… å†å²æ•°æ®æ¸…ç†å®Œæˆï¼Œåˆ é™¤ ${deletedDays} å¤©çš„æ•°æ®ï¼Œä¿ç•™æœ€è¿‘ ${window.maxDays} å¤©`);
                }
            }
        } catch (error) {
            console.error('âŒ æ¸…ç†å†å²æ•°æ®å¤±è´¥:', error);
        }
    }

    function updateMapDisplay(dateStr) {
        const data = mockData[dateStr];
        if (data && data.path) {
            // æ¸…é™¤ç°æœ‰æ ‡è®°
            if (currentPolyline) map.removeLayer(currentPolyline);
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = [];
            
            // æ·»åŠ æ–°çš„è·¯å¾„å’Œæ ‡è®°
            if (data.path.length > 0) {
                currentPolyline = L.polyline(data.path, { color: 'blue' }).addTo(map);
                data.path.forEach(coord => {
                    const marker = L.marker(coord).addTo(map);
                    currentMarkers.push(marker);
                });
                map.fitBounds(currentPolyline.getBounds());
            }
        }
    }



    // ========================================
    // åœ°ç†ä½ç½®éªŒè¯å‡½æ•°
    // ========================================

    /**
     * æ£€æŸ¥åæ ‡ç‚¹æ˜¯å¦åœ¨è´µé˜³å¸‚èŒƒå›´å†…
     */
    function isLocationInGuiyang(lat, lng, strictMode = false) {
      const bounds = strictMode ? GUIYANG_CITY_BOUNDS : GUIYANG_BOUNDS;
      return lat >= bounds.south && lat <= bounds.north && lng >= bounds.west && lng <= bounds.east;
    }

    function isLocationInChengdu(lat, lng, strictMode = false) {
      const bounds = strictMode ? CHENGDU_CITY_BOUNDS : CHENGDU_BOUNDS;
      return lat >= bounds.south && lat <= bounds.north && lng >= bounds.west && lng <= bounds.east;
    }

    function isLocationInZhejiang(lat, lng, strictMode = false) {
      const bounds = strictMode ? ZHEJIANG_CITY_BOUNDS : ZHEJIANG_BOUNDS;
      return lat >= bounds.south && lat <= bounds.north && lng >= bounds.west && lng <= bounds.east;
    }

    /**
     * æ ¡éªŒå¹¶è¿‡æ»¤locationæ•°ç»„ï¼Œåªä¿ç•™è´µé˜³å¸‚èŒƒå›´å†…çš„åæ ‡
     */
    function validateGuiyangLocations(locations) {
      if (!Array.isArray(locations)) return [];
      return locations.filter(location => {
        if (!Array.isArray(location) || location.length < 2) return false;
        const [lat, lng] = location;
        const numLat = parseFloat(lat);
        const numLng = parseFloat(lng);
        if (isNaN(numLat) || isNaN(numLng)) return false;
        return isLocationInGuiyang(numLat, numLng);
      });
    }

    function validateChengduLocations(locations) {
      if (!Array.isArray(locations)) return [];
      return locations.filter(location => {
        if (!Array.isArray(location) || location.length < 2) return false;
        const [lat, lng] = location;
        const numLat = parseFloat(lat);
        const numLng = parseFloat(lng);
        if (isNaN(numLat) || isNaN(numLng)) return false;
        return isLocationInChengdu(numLat, numLng);
      });
    }

    /**
     * è·å–ä¸Šä¸€æ¬¡çš„æœ‰æ•ˆlocationæ•°æ®
     */
    function getLastValidPath(date) {
      const data = mockData[date];
      return (data && data.path && Array.isArray(data.path)) ? data.path : [];
    }

    // ========================================
    // å¤©æ°”APIç›¸å…³å‡½æ•°
    // ========================================
    // è·å–åŸå¸‚ç¼–ç  (adcode)
    async function getCityAdcode(cityName) {
      try {
        const response = await fetch(
          `${AMAP_GEOCODING_API}?key=${AMAP_API_KEY}&address=${encodeURIComponent(cityName)}&city=${encodeURIComponent(cityName)}`
        );
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.status !== '1' || !data.geocodes || data.geocodes.length === 0) {
          throw new Error(data.info || 'åŸå¸‚æœªæ‰¾åˆ°');
        }
        
        const geocode = data.geocodes[0];
        return {
          adcode: geocode.adcode,
          city: geocode.city || geocode.district,
          province: geocode.province,
          location: geocode.location,
          formatted_address: geocode.formatted_address
        };
      } catch (error) {
        console.error('è·å–åŸå¸‚ç¼–ç å¤±è´¥:', error);
        throw error;
      }
    }

    // é€šè¿‡IPè·å–åŸå¸‚ä¿¡æ¯
    async function getCityByIP() {
      try {
        const response = await fetch(
          `${AMAP_IP_LOCATION_API}?key=${AMAP_API_KEY}&ip=`
        );
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.status !== '1') {
          throw new Error(data.info || 'IPå®šä½å¤±è´¥');
        }
        
        return {
          adcode: data.adcode,
          city: data.city,
          province: data.province
        };
      } catch (error) {
        console.error('IPå®šä½å¤±è´¥:', error);
        throw error;
      }
    }

    // é«˜å¾·å¤©æ°”å›¾æ ‡æ˜ å°„
    function getWeatherIconFromAmap(weather) {
      const weatherMap = {
        'æ™´': 'â˜€ï¸',
        'å°‘äº‘': 'ğŸŒ¤ï¸',
        'æ™´é—´å¤šäº‘': 'â›…',
        'å¤šäº‘': 'â˜ï¸',
        'é˜´': 'â˜ï¸',
        'æœ‰é£': 'ğŸ’¨',
        'å¹³é™': 'ğŸ˜Œ',
        'å¾®é£': 'ğŸƒ',
        'å’Œé£': 'ğŸƒ',
        'æ¸…é£': 'ğŸ’¨',
        'å¼ºé£/åŠ²é£': 'ğŸ’¨',
        'ç–¾é£': 'ğŸŒªï¸',
        'å¤§é£': 'ğŸŒªï¸',
        'çƒˆé£': 'ğŸŒªï¸',
        'é£æš´': 'ğŸŒªï¸',
        'ç‹‚çˆ†é£': 'ğŸŒªï¸',
        'é£“é£': 'ğŸŒ€',
        'çƒ­å¸¦é£æš´': 'ğŸŒ€',
        'éœ¾': 'ğŸ˜·',
        'ä¸­åº¦éœ¾': 'ğŸ˜·',
        'é‡åº¦éœ¾': 'ğŸ˜·',
        'ä¸¥é‡éœ¾': 'ğŸ˜·',
        'é›¨': 'ğŸŒ§ï¸',
        'å°é›¨': 'ğŸŒ¦ï¸',
        'ä¸­é›¨': 'ğŸŒ§ï¸',
        'å¤§é›¨': 'ğŸŒ§ï¸',
        'æš´é›¨': 'â›ˆï¸',
        'å¤§æš´é›¨': 'â›ˆï¸',
        'ç‰¹å¤§æš´é›¨': 'â›ˆï¸',
        'é˜µé›¨': 'ğŸŒ¦ï¸',
        'é›·é˜µé›¨': 'â›ˆï¸',
        'é›·é˜µé›¨å¹¶ä¼´æœ‰å†°é›¹': 'â›ˆï¸',
        'å†»é›¨': 'ğŸ§Š',
        'é›¨å¤¹é›ª': 'ğŸŒ¨ï¸',
        'é˜µé›ª': 'ğŸŒ¨ï¸',
        'å°é›ª': 'â„ï¸',
        'ä¸­é›ª': 'â„ï¸',
        'å¤§é›ª': 'â„ï¸',
        'æš´é›ª': 'â„ï¸',
        'é›¾': 'ğŸŒ«ï¸',
        'æµ“é›¾': 'ğŸŒ«ï¸',
        'å¼ºæµ“é›¾': 'ğŸŒ«ï¸'
      };
      
      return weatherMap[weather] || 'ğŸŒ¤ï¸';
    }

    // é£åŠ›ç­‰çº§è½¬æ¢ä¸ºé€Ÿåº¦ (å¤§æ¦‚å€¼)
    function windPowerToSpeed(windPower) {
      const windSpeedMap = {
        '0': 0,
        '1': 2,
        '2': 6,
        '3': 12,
        '4': 20,
        '5': 31,
        '6': 43,
        '7': 56,
        '8': 70,
        '9': 85,
        '10': 100,
        '11': 120,
        '12': 140
      };
      
      const level = windPower.replace(/[^\d]/g, ''); // æå–æ•°å­—
      return windSpeedMap[level] || 0;
    }

    // è·å–é«˜å¾·å¤©æ°”æ•°æ®
    async function fetchAmapWeatherData(adcode) {
      try {
        updateWeatherStatus('online', 'æ­£åœ¨è·å–å¤©æ°”æ•°æ®...');
        
        // è·å–å®æ—¶å¤©æ°”
        const response = await fetch(
          `${AMAP_WEATHER_API}?key=${AMAP_API_KEY}&city=${adcode}&extensions=base`
        );
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.status !== '1') {
          if (data.infocode === '10001') {
            throw new Error('APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥æ‚¨çš„é«˜å¾·åœ°å›¾API Key');
          } else if (data.infocode === '10003') {
            throw new Error('è®¿é—®å·²è¶…å‡ºæ—¥è®¿é—®é‡');
          } else {
            throw new Error(data.info || 'APIè¯·æ±‚å¤±è´¥');
          }
        }
        
        if (!data.lives || data.lives.length === 0) {
          throw new Error('æœªè·å–åˆ°å¤©æ°”æ•°æ®');
        }
        
        const liveWeather = data.lives[0];
        
        // è½¬æ¢ä¸ºå†…éƒ¨æ ¼å¼
        const now = new Date();
        const isDay = now.getHours() >= 6 && now.getHours() < 20;
        
        weatherData = {
          weather: [{
            main: liveWeather.weather,
            description: liveWeather.weather
          }],
          main: {
            temp: parseFloat(liveWeather.temperature),
            feels_like: parseFloat(liveWeather.temperature), // é«˜å¾·APIæ— ä½“æ„Ÿæ¸©åº¦ï¼Œä½¿ç”¨å®é™…æ¸©åº¦
            humidity: parseFloat(liveWeather.humidity),
            pressure: 1013 // é«˜å¾·åŸºç¡€ç‰ˆAPIæ— æ°”å‹ï¼Œä½¿ç”¨æ ‡å‡†æ°”å‹
          },
          wind: {
            speed: windPowerToSpeed(liveWeather.windpower), // è½¬æ¢é£åŠ›ç­‰çº§ä¸ºé€Ÿåº¦
            direction: liveWeather.winddirection,
            power: liveWeather.windpower
          },
          visibility: 10000, // é«˜å¾·åŸºç¡€ç‰ˆAPIæ— èƒ½è§åº¦ï¼Œä½¿ç”¨é»˜è®¤å€¼
          dt: Math.floor(new Date(liveWeather.reporttime).getTime() / 1000),
          name: liveWeather.city,
          province: liveWeather.province,
          adcode: liveWeather.adcode,
          reporttime: liveWeather.reporttime,
          isDay: isDay
        };
        
        updateWeatherDisplay(weatherData);
        
        // ç¼“å­˜å¤©æ°”æ•°æ®
        localStorage.setItem('amapWeatherData', JSON.stringify({
          data: weatherData,
          timestamp: Date.now(),
          adcode: adcode
        }));
        
        updateWeatherStatus('online', `å¤©æ°”æ•°æ®å·²æ›´æ–° - ${liveWeather.province} ${liveWeather.city}`);
        console.log('ğŸŒ¤ï¸ é«˜å¾·å¤©æ°”æ•°æ®å·²è·å–:', weatherData);
        
      } catch (error) {
        console.error('âŒ è·å–é«˜å¾·å¤©æ°”æ•°æ®å¤±è´¥:', error);
        updateWeatherStatus('error', `è·å–å¤±è´¥: ${error.message}`);
        
        // å°è¯•ä½¿ç”¨ç¼“å­˜æ•°æ®
        const cached = localStorage.getItem('amapWeatherData');
        if (cached) {
          try {
            const cachedData = JSON.parse(cached);
            // å¦‚æœç¼“å­˜æ•°æ®ä¸è¶…è¿‡1å°æ—¶ï¼Œä½¿ç”¨ç¼“å­˜
            if (Date.now() - cachedData.timestamp < 3600000) {
              weatherData = cachedData.data;
              updateWeatherDisplay(weatherData);
              updateWeatherStatus('offline', 'ä½¿ç”¨ç¼“å­˜æ•°æ® (ç¦»çº¿æ¨¡å¼)');
              console.log('ğŸ”„ ä½¿ç”¨ç¼“å­˜çš„é«˜å¾·å¤©æ°”æ•°æ®');
              return;
            }
          } catch (e) {
            console.error('ç¼“å­˜æ•°æ®è§£æå¤±è´¥:', e);
          }
        }
        
        // å¦‚æœæ²¡æœ‰ç¼“å­˜æˆ–ç¼“å­˜è¿‡æœŸï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        displayWeatherError(error.message);
      }
    }

    // è¯„ä¼°éª‘è¡Œå®‰å…¨ç­‰çº§
    function assessRidingSafety(weather) {
      const temp = weather.main.temp;
      const humidity = weather.main.humidity;
      const windSpeed = weather.wind.speed; // å·²è½¬æ¢çš„km/h
      const condition = weather.weather[0].main;
      
      let safetyScore = 100;
      let riskFactors = [];
      let level = 'safe';
      let recommendations = [];
      
      // æ¸©åº¦è¯„ä¼°
      if (temp < 0) {
        safetyScore -= 30;
        riskFactors.push('æä½æ¸©åº¦å¯èƒ½å¯¼è‡´è·¯é¢ç»“å†°');
        recommendations.push({ icon: 'ğŸ§¥', text: 'ç©¿ç€ä¿æš–é˜²æ»‘è£…å¤‡' });
      } else if (temp < 5) {
        safetyScore -= 15;
        riskFactors.push('ä½æ¸©å¤©æ°”éœ€è¦æ³¨æ„ä¿æš–');
        recommendations.push({ icon: 'ğŸ§¥', text: 'æ³¨æ„ä¿æš–é˜²å¯’' });
      } else if (temp > 35) {
        safetyScore -= 20;
        riskFactors.push('é«˜æ¸©å¤©æ°”å®¹æ˜“ä¸­æš‘');
        recommendations.push({ icon: 'ğŸ’§', text: 'å¤šè¡¥å……æ°´åˆ†ï¼Œé¿å…ä¸­æš‘' });
      }
      
      // é£é€Ÿè¯„ä¼°
      if (windSpeed > 60) {
        safetyScore -= 40;
        riskFactors.push('å¼ºé£å¤©æ°”å½±å“éª‘è¡Œç¨³å®šæ€§');
        recommendations.push({ icon: 'ğŸš«', text: 'å»ºè®®æš‚åœéª‘è¡Œ' });
      } else if (windSpeed > 40) {
        safetyScore -= 20;
        riskFactors.push('å¤§é£å¤©æ°”éœ€è¦æ ¼å¤–å°å¿ƒ');
        recommendations.push({ icon: 'âš ï¸', text: 'é™ä½é€Ÿåº¦ï¼Œå°å¿ƒä¾§é£' });
      } else if (windSpeed > 20) {
        safetyScore -= 10;
        recommendations.push({ icon: 'ğŸŒ', text: 'é€‚å½“é™ä½éª‘è¡Œé€Ÿåº¦' });
      }
      
      // å¤©æ°”æ¡ä»¶è¯„ä¼°
      if (condition.includes('æš´é›¨') || condition.includes('é›·')) {
        safetyScore -= 60;
        riskFactors.push('æš´é›¨é›·ç”µå¤©æ°”æåº¦å±é™©');
        recommendations.push({ icon: 'ğŸš«', text: 'ç«‹å³åœæ­¢éª‘è¡Œï¼Œå¯»æ‰¾å®‰å…¨åœºæ‰€' });
      } else if (condition.includes('é›¨')) {
        safetyScore -= 30;
        riskFactors.push('é›¨å¤©è·¯é¢æ¹¿æ»‘');
        recommendations.push({ icon: 'ğŸŒ', text: 'é™ä½é€Ÿåº¦ï¼Œæ³¨æ„è·¯é¢æ¹¿æ»‘' });
        recommendations.push({ icon: 'â˜‚ï¸', text: 'ç©¿ç€é›¨å…·ï¼Œæé«˜å¯è§æ€§' });
      } else if (condition.includes('é›ª') || condition.includes('å†»')) {
        safetyScore -= 40;
        riskFactors.push('é›ªå¤©è·¯é¢æå…¶æ¹¿æ»‘');
        recommendations.push({ icon: 'ğŸš«', text: 'å»ºè®®æš‚åœéª‘è¡Œ' });
      } else if (condition.includes('é›¾') || condition.includes('éœ¾')) {
        safetyScore -= 25;
        riskFactors.push('é›¾éœ¾å¤©æ°”èƒ½è§åº¦ä½');
        recommendations.push({ icon: 'ğŸ’¡', text: 'å¼€å¯å‰åè½¦ç¯' });
        recommendations.push({ icon: 'ğŸ˜·', text: 'ä½©æˆ´é˜²æŠ¤å£ç½©' });
      }
      
      // ç¡®å®šå®‰å…¨ç­‰çº§
      if (safetyScore >= 80) {
        level = 'safe';
        if (recommendations.length === 0) {
          recommendations.push({ icon: 'ğŸš´', text: 'é€‚åˆæ­£å¸¸é€Ÿåº¦éª‘è¡Œ' });
          recommendations.push({ icon: 'ğŸ‘•', text: 'æ ¹æ®æ¸©åº¦é€‰æ‹©åˆé€‚è¡£ç‰©' });
          recommendations.push({ icon: 'ğŸ’§', text: 'è®°å¾—åŠæ—¶è¡¥å……æ°´åˆ†' });
        }
      } else if (safetyScore >= 60) {
        level = 'warning';
      } else {
        level = 'danger';
      }
      
      return {
        score: Math.max(0, safetyScore),
        level: level,
        riskFactors: riskFactors,
        recommendations: recommendations
      };
    }

    // ç”Ÿæˆå»ºè®®éª‘è¡Œæ—¶é—´
    function generateBestRidingTimes(weather) {
      const condition = weather.weather[0].main;
      const temp = weather.main.temp;
      const windSpeed = weather.wind.speed;
      
      const timeSlots = [
        { time: '06:00', base: 'excellent' },
        { time: '07:00', base: 'excellent' },
        { time: '08:00', base: 'good' },
        { time: '09:00', base: 'good' },
        { time: '10:00', base: 'good' },
        { time: '11:00', base: 'good' },
        { time: '12:00', base: 'poor' },
        { time: '13:00', base: 'poor' },
        { time: '14:00', base: 'poor' },
        { time: '15:00', base: 'good' },
        { time: '16:00', base: 'good' },
        { time: '17:00', base: 'good' },
        { time: '18:00', base: 'excellent' },
        { time: '19:00', base: 'excellent' },
        { time: '20:00', base: 'good' }
      ];
      
      return timeSlots.map(slot => {
        let condition_text = '';
        let final_level = slot.base;
        
        // æ ¹æ®å¤©æ°”è°ƒæ•´
        if (condition.includes('é›¨') || condition.includes('é›·')) {
          final_level = 'poor';
          condition_text = 'é›¨å¤©';
        } else if (condition.includes('é›¾') || condition.includes('éœ¾')) {
          if (slot.time >= '06:00' && slot.time <= '09:00') {
            final_level = 'poor';
            condition_text = 'é›¾éœ¾';
          } else {
            condition_text = slot.base === 'excellent' ? 'æä½³' : 
                           slot.base === 'good' ? 'è‰¯å¥½' : 'ä¸€èˆ¬';
          }
        } else if (temp > 30 && (slot.time >= '11:00' && slot.time <= '15:00')) {
          final_level = 'poor';
          condition_text = 'é«˜æ¸©';
        } else if (windSpeed > 40) {
          final_level = final_level === 'excellent' ? 'good' : 
                       final_level === 'good' ? 'poor' : 'poor';
          condition_text = 'å¤§é£';
        } else {
          condition_text = slot.base === 'excellent' ? 'æä½³' : 
                          slot.base === 'good' ? 'è‰¯å¥½' : 'ä¸€èˆ¬';
        }
        
        return {
          time: slot.time,
          level: final_level,
          condition: condition_text
        };
      }).filter(slot => {
        const hour = parseInt(slot.time.split(':')[0]);
        return hour >= 6 && hour <= 20;
      }).slice(0, 6);
    }

    // æ›´æ–°å¤©æ°”æ˜¾ç¤º
    function updateWeatherDisplay(weather) {
      if (!weather) return;
      
      const safety = assessRidingSafety(weather);
      const bestTimes = generateBestRidingTimes(weather);
      
      // æ›´æ–°ä¸»è¦å¤©æ°”ä¿¡æ¯
      const isDay = weather.isDay;
      const weatherIcon = getWeatherIconFromAmap(weather.weather[0].main);
      
      document.getElementById('weatherTitleIcon').textContent = weatherIcon;
      document.getElementById('weatherMainIcon').textContent = weatherIcon;
      document.getElementById('tempValue').textContent = Math.round(weather.main.temp);
      document.getElementById('weatherDescription').textContent = weather.weather[0].description;
      
      // æ›´æ–°è¯¦ç»†ä¿¡æ¯ï¼ˆé€‚é…é«˜å¾·æ•°æ®æ ¼å¼ï¼‰
      document.getElementById('humidity').textContent = `${Math.round(weather.main.humidity)}%`;
      document.getElementById('windSpeed').textContent = `${weather.wind.power}çº§`;
      document.getElementById('windDirection').textContent = weather.wind.direction || 'æ— é£å‘';
      document.getElementById('pressure').textContent = `${Math.round(weather.main.pressure)} hPa`;
      
      // æ›´æ–°å®‰å…¨è¯„ä¼°
      const assessmentEl = document.getElementById('safetyAssessment');
      const assessmentIcon = document.getElementById('assessmentIcon');
      const assessmentLevel = document.getElementById('assessmentLevel');
      const assessmentDescription = document.getElementById('assessmentDescription');
      const weatherWarning = document.getElementById('weatherWarning');
      const warningText = document.getElementById('warningText');
      
      // ç§»é™¤æ—§çš„å®‰å…¨ç­‰çº§ç±»
      assessmentEl.classList.remove('safe', 'warning', 'danger');
      assessmentEl.classList.add(safety.level);
      
      const safetyConfig = {
        safe: { icon: 'âœ…', level: 'éª‘è¡Œå®‰å…¨', description: 'å½“å‰å¤©æ°”æ¡ä»¶é€‚åˆéª‘è¡Œï¼Œå»ºè®®æ­£å¸¸éª‘è¡Œå¹¶æ³¨æ„äº¤é€šå®‰å…¨ã€‚' },
        warning: { icon: 'âš ï¸', level: 'éœ€è¦æ³¨æ„', description: 'å¤©æ°”æ¡ä»¶å¯èƒ½å½±å“éª‘è¡Œå®‰å…¨ï¼Œè¯·é‡‡å–é€‚å½“çš„é¢„é˜²æªæ–½ã€‚' },
        danger: { icon: 'ğŸš¨', level: 'å±é™©è­¦å‘Š', description: 'å½“å‰å¤©æ°”æ¡ä»¶ä¸é€‚åˆéª‘è¡Œï¼Œå»ºè®®æš‚åœéª‘è¡Œè®¡åˆ’ã€‚' }
      };
      
      const config = safetyConfig[safety.level];
      assessmentIcon.textContent = config.icon;
      assessmentLevel.textContent = config.level;
      assessmentDescription.textContent = config.description;
      
      // æ˜¾ç¤º/éšè—å¤©æ°”è­¦å‘Š
      if (safety.riskFactors.length > 0) {
        weatherWarning.style.display = 'block';
        warningText.textContent = safety.riskFactors.join('ï¼Œ');
      } else {
        weatherWarning.style.display = 'none';
      }
      
      // æ›´æ–°éª‘è¡Œå»ºè®®
      const recommendationList = document.getElementById('recommendationList');
      recommendationList.innerHTML = '';
      
      safety.recommendations.forEach(rec => {
        const li = document.createElement('li');
        li.className = 'recommendation-item';
        li.innerHTML = `
          <span class="recommendation-icon">${rec.icon}</span>
          <span>${rec.text}</span>
        `;
        recommendationList.appendChild(li);
      });
      
      // æ›´æ–°å»ºè®®éª‘è¡Œæ—¶é—´
      const timeSlots = document.getElementById('timeSlots');
      timeSlots.innerHTML = '';
      
      bestTimes.forEach(slot => {
        const div = document.createElement('div');
        div.className = `time-slot ${slot.level}`;
        div.innerHTML = `
          <div class="slot-time">${slot.time}</div>
          <div class="slot-condition">${slot.condition}</div>
        `;
        timeSlots.appendChild(div);
      });
    }

    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
    function updateWeatherStatus(status, message) {
      const statusElement = document.getElementById('weatherStatus');
      const statusText = document.getElementById('statusText');
      
      statusElement.className = `weather-status ${status}`;
      statusText.textContent = message;
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function displayWeatherError(message) {
      document.getElementById('tempValue').textContent = '--';
      document.getElementById('weatherDescription').textContent = 'è·å–å¤±è´¥';
      document.getElementById('humidity').textContent = '--%';
      document.getElementById('windSpeed').textContent = '-- çº§';
      document.getElementById('windDirection').textContent = '--';
      document.getElementById('pressure').textContent = '-- hPa';
      
      document.getElementById('assessmentLevel').textContent = 'æ•°æ®è·å–å¤±è´¥';
      document.getElementById('assessmentDescription').textContent = 
        `æ— æ³•è·å–å¤©æ°”æ•°æ®: ${message}ã€‚å»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–APIé…ç½®ã€‚`;
      
      const recommendationList = document.getElementById('recommendationList');
      recommendationList.innerHTML = `
        <li class="recommendation-item">
          <span class="recommendation-icon">âŒ</span>
          <span>å¤©æ°”æ•°æ®è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥å½“å‰å¤©æ°”æ¡ä»¶</span>
        </li>
        <li class="recommendation-item">
          <span class="recommendation-icon">ğŸ”§</span>
          <span>æ£€æŸ¥APIé…ç½®æˆ–ç½‘ç»œè¿æ¥</span>
        </li>
      `;
      
      const timeSlots = document.getElementById('timeSlots');
      timeSlots.innerHTML = `
        <div class="time-slot poor">
          <div class="slot-time">--:--</div>
          <div class="slot-condition">æ•°æ®ä¸å¯ç”¨</div>
        </div>
      `;
    }

    // é€šè¿‡åŸå¸‚åè·å–å¤©æ°”
    async function fetchWeatherByCity(cityName) {
      try {
        updateWeatherStatus('online', `æ­£åœ¨æœç´¢åŸå¸‚: ${cityName}...`);
        const cityInfo = await getCityAdcode(cityName);
        currentAdcode = cityInfo.adcode;
        currentCity = cityInfo.city;
        
        // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
        document.getElementById('cityInput').value = currentCity;
        
        // æ›´æ–°åŸå¸‚å¿«æ·æŒ‰é’®çŠ¶æ€
        updateCityShortcuts(currentCity);
        
        await fetchAmapWeatherData(cityInfo.adcode);
      } catch (error) {
        console.error('é€šè¿‡åŸå¸‚è·å–å¤©æ°”å¤±è´¥:', error);
        updateWeatherStatus('error', `åŸå¸‚æœç´¢å¤±è´¥: ${error.message}`);
        displayWeatherError(error.message);
      }
    }

    // é€šè¿‡IPå®šä½è·å–å¤©æ°”
    async function fetchWeatherByIP() {
      try {
        updateWeatherStatus('online', 'æ­£åœ¨é€šè¿‡IPå®šä½...');
        const locationInfo = await getCityByIP();
        currentAdcode = locationInfo.adcode;
        currentCity = locationInfo.city;
        
        // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
        document.getElementById('cityInput').value = `${locationInfo.province} ${locationInfo.city}`;
        
        // æ›´æ–°åŸå¸‚å¿«æ·æŒ‰é’®çŠ¶æ€
        updateCityShortcuts(currentCity);
        
        await fetchAmapWeatherData(locationInfo.adcode);
      } catch (error) {
        console.error('é€šè¿‡IPå®šä½è·å–å¤©æ°”å¤±è´¥:', error);
        updateWeatherStatus('error', `IPå®šä½å¤±è´¥: ${error.message}`);
        displayWeatherError(error.message);
      }
    }

    // æ›´æ–°åŸå¸‚å¿«æ·æŒ‰é’®çŠ¶æ€
    function updateCityShortcuts(selectedCity) {
      document.querySelectorAll('.city-shortcut').forEach(button => {
        const buttonCity = button.getAttribute('data-city');
        if (buttonCity === selectedCity || buttonCity.replace('å¸‚', '') === selectedCity.replace('å¸‚', '')) {
          button.classList.add('active');
        } else {
          button.classList.remove('active');
        }
      });
    }

    // ========================================
    // æ—¶é—´æ˜¾ç¤ºå‡½æ•°
    // ========================================

    function updateTimeDisplay() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      
      const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
      const weekday = weekdays[now.getDay()];
      
      // æ›´æ–°æ—¶é—´å›¾æ ‡
      const timeIcon = document.getElementById('timeIcon');
      const hourInt = parseInt(hours);
      const clockIcons = {
        0: 'ğŸ•', 1: 'ğŸ•', 2: 'ğŸ•‘', 3: 'ğŸ•’', 4: 'ğŸ•“', 5: 'ğŸ•”', 6: 'ğŸ••',
        7: 'ğŸ•–', 8: 'ğŸ•—', 9: 'ğŸ•˜', 10: 'ğŸ•™', 11: 'ğŸ•š', 12: 'ğŸ•',
        13: 'ğŸ•', 14: 'ğŸ•‘', 15: 'ğŸ•’', 16: 'ğŸ•“', 17: 'ğŸ•”', 18: 'ğŸ••',
        19: 'ğŸ•–', 20: 'ğŸ•—', 21: 'ğŸ•˜', 22: 'ğŸ•™', 23: 'ğŸ•š'
      };
      timeIcon.textContent = clockIcons[hourInt] || 'ğŸ•';
      
      // æ›´æ–°æ—¥æœŸ
      document.getElementById('current-date').textContent = `${year}-${month}-${day}`;
      document.getElementById('current-weekday').textContent = weekday;
      
      // æ›´æ–°æ•°å­—æ—¶é’Ÿï¼ˆå¸¦åŠ¨ç”»æ•ˆæœï¼‰
      const hoursElement = document.getElementById('time-hours');
      const minutesElement = document.getElementById('time-minutes');
      const secondsElement = document.getElementById('time-seconds');
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¦‚æœæ•°å­—å˜åŒ–åˆ™æ·»åŠ åŠ¨ç”»
      if (hoursElement.textContent !== hours) {
        hoursElement.classList.add('time-flip');
        setTimeout(() => {
          hoursElement.textContent = hours;
          hoursElement.classList.remove('time-flip');
        }, 150);
      }
      
      if (minutesElement.textContent !== minutes) {
        minutesElement.classList.add('time-flip');
        setTimeout(() => {
          minutesElement.textContent = minutes;
          minutesElement.classList.remove('time-flip');
        }, 150);
      }
      
      if (secondsElement.textContent !== seconds) {
        secondsElement.classList.add('time-flip');
        setTimeout(() => {
          secondsElement.textContent = seconds;
          secondsElement.classList.remove('time-flip');
        }, 150);
      }
    }

    // ========================================
    // ç”µæ± ç›¸å…³å‡½æ•°
    // ========================================

    // ç”µå‹ç”Ÿæˆå‡½æ•°
    function generateRandomVoltage() {
      randomVoltage = (Math.random() * (7.6 - 7.5) + 7.5);
      localStorage.setItem('randomVoltage', randomVoltage.toFixed(3));
      console.log("ğŸ”‹ Voltage Update: ", randomVoltage.toFixed(3));
      return randomVoltage;
    }

    // currentæ›´æ–°æ—¶ç”¨å½“å‰Voltage
    function updateCurrent(current) {
      const voltage = parseFloat(localStorage.getItem('randomVoltage'));
      updateBatteryChart(voltage, current);
    }

    // åˆå§‹åŒ–ç”µæ± å®¹å™¨
    function initBatteryContainer() {
      const initialLevel = 22;
      const bar = document.getElementById('batteryLevelBar');
      const text = document.getElementById('batteryText');
      const wrapper = document.getElementById('batteryStatus');
      
      if (bar && text && wrapper) {
        bar.style.width = initialLevel + '%';
        text.textContent = initialLevel + '%';
        wrapper.classList.remove('battery-medium', 'battery-low');
        
        if (initialLevel <= 20) {
          wrapper.classList.add('battery-low');
        } else if (initialLevel <= 60) {
          wrapper.classList.add('battery-medium');
        }
        
        localStorage.setItem('batteryLevel', initialLevel);
        console.log(`ğŸ”‹ ç”µæ± å®¹å™¨å·²åˆå§‹åŒ–: ${initialLevel}%`);
      } else {
        console.warn('âš ï¸ ç”µæ± å®¹å™¨å…ƒç´ æœªæ‰¾åˆ°ï¼Œåˆå§‹åŒ–å¤±è´¥');
      }
    }

    // æ›´æ–°ç”µæ± å®¹å™¨æ˜¾ç¤º
    function updateBatteryContainerDisplay(voltage, current) {

      let currentLevel = 22;

      const bar = document.getElementById('batteryLevelBar');
      const text = document.getElementById('batteryText');
      const wrapper = document.getElementById('batteryStatus');
      if (!bar || !text || !wrapper) {
        console.warn('âš ï¸ battery-containerç›¸å…³å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }
      
      wrapper.classList.add('battery-updating');
      
      setTimeout(() => {
        bar.style.width = currentLevel + '%';
        text.textContent = currentLevel + '%';
        wrapper.classList.remove('battery-medium', 'battery-low', 'battery-high');

        if (currentLevel <= 20) {
          wrapper.classList.add('battery-low');
        } else if (currentLevel <= 60) {
          wrapper.classList.add('battery-medium');
        } else {
          wrapper.classList.add('battery-high');
        }

        localStorage.setItem('batteryLevel', currentLevel);
        wrapper.classList.remove('battery-updating');
        console.log(`ğŸ”‹ battery-containerå·²æ›´æ–°: ${voltage.toFixed(2)}V, ${current.toFixed(2)}A, ${currentLevel}%`);
      }, 100);
    }

    // ç”µæ± æ•°æ®æ¸…ç†å‡½æ•°
    function cleanupBatteryData() {
        try {
            const batteryData = localStorage.getItem('batteryHistoryData');
            if (batteryData) {
                let parsedData = JSON.parse(batteryData);
                if (Array.isArray(parsedData) && parsedData.length > window.maxBatteryDataPoints) {
                    const removedCount = parsedData.length - window.maxBatteryDataPoints;
                    parsedData = parsedData.slice(-window.maxBatteryDataPoints);
                    localStorage.setItem('batteryHistoryData', JSON.stringify(parsedData));
                    console.log(`ğŸ”‹ ç”µæ± æ•°æ®æ¸…ç†å®Œæˆï¼Œåˆ é™¤ ${removedCount} æ¡æ—§æ•°æ®ï¼Œä¿ç•™æœ€æ–° ${window.maxBatteryDataPoints} æ¡`);
                }
            }
        } catch (error) {
            console.error('âŒ ç”µæ± æ•°æ®æ¸…ç†å¤±è´¥:', error);
        }
    }

    function initDistanceAndTargetCards() {
      const distanceValueEl = document.getElementById('distance-value');
      const targetValueEl = document.getElementById('target-value');
      
      if (!distanceValueEl || !targetValueEl) {
        console.warn('âš ï¸ è·ç¦»æˆ–ç›®æ ‡å¡ç‰‡å…ƒç´ æœªæ‰¾åˆ°ï¼Œåˆå§‹åŒ–å¤±è´¥');
        return;
      }
      
      try {
        // è·å–å†å²æ•°æ®
        const storedData = localStorage.getItem('mockData');
        let lastData = null;
        
        if (storedData) {
          const mockData = JSON.parse(storedData);
          
          // è·å–æœ€è¿‘çš„æœ‰æ•ˆæ•°æ®
          const dates = Object.keys(mockData).sort().reverse(); // æŒ‰æ—¥æœŸå€’åº
          
          for (const date of dates) {
            const data = mockData[date];
            if (data && (data.Distance !== undefined || data.numTarget !== undefined)) {
              lastData = data;
              console.log(`ğŸ“Š æ‰¾åˆ°æœ€è¿‘å†å²æ•°æ®: ${date}`, data);
              break;
            }
          }
        }
        
        if (lastData) {
          // ä½¿ç”¨å†å²æ•°æ®åˆå§‹åŒ–
          if (lastData.Distance !== undefined && lastData.Distance !== '--') {
            distanceValueEl.innerHTML = `${parseFloat(lastData.Distance).toFixed(2)}<span class="stat-unit">m</span>`;
          } else {
            distanceValueEl.innerHTML = `--<span class="stat-unit">m</span>`;
          }
          
          if (lastData.numTarget !== undefined && lastData.numTarget !== '--') {
            targetValueEl.innerHTML = `${lastData.numTarget}<span class="stat-unit">ä¸ª</span>`;
          } else {
            targetValueEl.innerHTML = `--<span class="stat-unit">ä¸ª</span>`;
          }
          
          console.log(`âœ… è·ç¦»å’Œç›®æ ‡å¡ç‰‡å·²ç”¨å†å²æ•°æ®åˆå§‹åŒ–`);
          console.log(`   è·ç¦»: ${lastData.Distance}m, ç›®æ ‡: ${lastData.numTarget}ä¸ª`);
        } else {
          // æ²¡æœ‰å†å²æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼
          distanceValueEl.innerHTML = `--<span class="stat-unit">m</span>`;
          targetValueEl.innerHTML = `--<span class="stat-unit">ä¸ª</span>`;
          
          console.log('ğŸ“Š æ— å†å²æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼åˆå§‹åŒ–è·ç¦»å’Œç›®æ ‡å¡ç‰‡');
        }
        
      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–è·ç¦»å’Œç›®æ ‡å¡ç‰‡å¤±è´¥:', error);
        
        // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤å€¼
        distanceValueEl.innerHTML = `--<span class="stat-unit">m</span>`;
        targetValueEl.innerHTML = `--<span class="stat-unit">ä¸ª</span>`;
      }
    }

    // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
    function initializeCharts() {
      initBatteryChart();
      
      // åŠ è½½å†å²æ•°æ®
      loadChartHistoryData();
      
      console.log('ğŸ“Š æ‰€æœ‰å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
    }

    // åˆå§‹åŒ–ç”µæ± çŠ¶æ€å›¾è¡¨
    function initBatteryChart() {

      if (batteryChart) {
        batteryChart.destroy();
        batteryChart = null;
      }

      const ctx = document.getElementById('batteryChart').getContext('2d');
      batteryChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'ç”µå‹ (V)',
              data: [],
              borderColor: '#4facfe',
              backgroundColor: 'rgba(79, 172, 254, 0.1)',
              fill: true,
              yAxisID: 'y',
              tension: 0.4
            },
            {
              label: 'ç”µæµ (A)',
              data: [],
              borderColor: '#ff6b6b',
              backgroundColor: 'rgba(255, 107, 107, 0.1)',
              fill: true,
              yAxisID: 'y1',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#ffffff' } }
          },
          scales: {
            x: {
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              ticks: { color: '#4facfe' },
              grid: { color: 'rgba(79,172,254,0.1)' },
              title: { display: true, text: 'ç”µå‹ (V)', color: '#4facfe' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              ticks: { color: '#ff6b6b' },
              grid: { drawOnChartArea: false },
              title: { display: true, text: 'ç”µæµ (A)', color: '#ff6b6b' }
            }
          }
        }
      });
    }

    // æ›´æ–°ç”µæ± å›¾è¡¨æ•°æ®
    function updateBatteryChart(voltage, current) {
      if (!batteryChart) {
        console.warn('âš ï¸ ç”µæ± å›¾è¡¨æœªåˆå§‹åŒ–ï¼Œè·³è¿‡æ•°æ®æ›´æ–°');
        return;
      }

      const now = new Date();
      const timeLabel = now.toLocaleTimeString();
      batteryHistory.voltage.push(voltage);
      batteryHistory.current.push(current);
      batteryHistory.timestamps.push(timeLabel);
      
      // é™åˆ¶æ•°æ®ç‚¹æ•°é‡ï¼Œé¿å…å†…å­˜è¿‡è½½
      if (batteryHistory.voltage.length > window.maxBatteryDataPoints) {
        batteryHistory.voltage.shift();
        batteryHistory.current.shift();
        batteryHistory.timestamps.shift();
      }
      
      // ä¿å­˜åˆ°localStorage
      saveBatteryHistory();
      
      if (batteryChart) {
        batteryChart.data.labels = batteryHistory.timestamps;
        batteryChart.data.datasets[0].data = batteryHistory.voltage;
        batteryChart.data.datasets[1].data = batteryHistory.current;
        batteryChart.update('none');
      }
      batteryChart.update('none');
      console.log(`ğŸ”‹ ç”µæ± æ•°æ®æ›´æ–°: ${voltage}V, ${current}A`);
    }

    // åŠ è½½å†å²å›¾è¡¨æ•°æ®
    function loadChartHistoryData() {
      loadBatteryHistory();
      
      if (batteryHistory.voltage.length > 0 && batteryChart) {
        batteryChart.data.labels = batteryHistory.timestamps;
        batteryChart.data.datasets[0].data = batteryHistory.voltage;
        batteryChart.data.datasets[1].data = batteryHistory.current;
        batteryChart.update('none');
        console.log('ğŸ“Š ç”µæ± å›¾è¡¨å†å²æ•°æ®å·²æ¢å¤:', batteryHistory.voltage.length + 'ä¸ªæ•°æ®ç‚¹');
      }
      
      console.log('ğŸ“Š ç”µæ± å›¾è¡¨å†å²æ•°æ®åŠ è½½å®Œæˆ');
    }

    // åŠ è½½å†å²å›¾è¡¨æ•°æ®
    function loadChartHistoryData() {
      loadBatteryHistory();
      
      if (batteryHistory.voltage.length > 0 && batteryChart) {
        batteryChart.data.labels = batteryHistory.timestamps;
        batteryChart.data.datasets[0].data = batteryHistory.voltage;
        batteryChart.data.datasets[1].data = batteryHistory.current;
        batteryChart.update('none');
        console.log('ğŸ“Š ç”µæ± å›¾è¡¨å†å²æ•°æ®å·²æ¢å¤:', batteryHistory.voltage.length + 'ä¸ªæ•°æ®ç‚¹');
      }
      
      console.log('ğŸ“Š ç”µæ± å›¾è¡¨å†å²æ•°æ®åŠ è½½å®Œæˆ');
    }

    // ========================================
    // ä¸»åˆå§‹åŒ–å‡½æ•°
    // ========================================

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    document.addEventListener("DOMContentLoaded", function () {
      try {
        console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–é¡µé¢...');

        // 1. åŠ è½½å­˜å‚¨é…ç½®
        const storageConfig = loadLocalStorageConfig();
        // console.log(`ğŸ“‹ åŠ è½½å­˜å‚¨è®¾ç½®ï¼š${JSON.stringify(storageConfig)}`);
        // window.maxBatteryDataPoints = storageConfig.maxBatteryDataPoints || 30;
        
        // 2. æ¸…ç†å’ŒåŠ è½½æœ¬åœ°æ•°æ®
        // cleanupBatteryData();
        initStorageConfigListener();
        applyStorageLimits();    // å…ˆåˆå§‹åŒ–ä¸€æ¬¡
        loadLocalStorageData();               // å†åŠ è½½æœ¬åœ°æ•°æ®

        // 3. åˆå§‹åŒ–UIç»„ä»¶
        initBatteryContainer();
        initDistanceAndTargetCards();

        // 4. å»¶è¿Ÿåˆå§‹åŒ–å›¾è¡¨ï¼ˆç¡®ä¿DOMå®Œå…¨åŠ è½½ï¼‰
        setTimeout(() => {
          try {
            initializeCharts();
            console.log('ğŸ“Š å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
          } catch (error) {
            console.error('âŒ å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
          }
        }, 500);

        // 5. åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤º
        updateTimeDisplay();
        setInterval(updateTimeDisplay, 1000);

        // 6. åˆå§‹åŒ–å¤©æ°”ç³»ç»Ÿ
        initializeWeather();
        weatherUpdateInterval = setInterval(() => {
          if (currentAdcode && AMAP_API_KEY !== 'YOUR_AMAP_API_KEY_HERE') {
            fetchAmapWeatherData(currentAdcode);
          }
        }, 20 * 60 * 1000);

        // 7. å¤„ç†å†å²æ•°æ®å’Œæ—¥æœŸé€‰é¡¹
        const stored = localStorage.getItem("mockData");
        if (stored) {
          try {
            let data = JSON.parse(stored);
            
            // åˆ é™¤ç‰¹å®šçš„7æœˆ9å·æ•°æ®
            delete data["2025-07-09"];
            
            // ä¿ç•™æ‰€æœ‰å…¶ä»–å†å²æ•°æ®
            localStorage.setItem("mockData", JSON.stringify(data));
            mockData = data;
            console.log('ğŸ“ å†å²æ•°æ®å·²åŠ è½½å¹¶æ¸…ç†');
          } catch (e) {
            console.warn('âš ï¸ å†å²æ•°æ®è§£æå¤±è´¥ï¼Œæ¸…ç©ºæ•°æ®:', e);
            localStorage.removeItem("mockData");
            mockData = {};
          }
        }
        
        // 8. ç”Ÿæˆæ—¥æœŸé€‰é¡¹å¹¶è®¾ç½®é»˜è®¤é€‰æ‹©
        generateDateOptions("2025-06-04");

        const today = new Date().toISOString().split("T")[0];
        const selector = document.getElementById("dateSelector");
        
        if (selector) {
          selector.value = today;
          selector.dispatchEvent(new Event("change"));
          console.log(`ğŸ“… æ—¥æœŸé€‰æ‹©å™¨å·²è®¾ç½®ä¸ºä»Šå¤©: ${today}`);
        } else {
          console.warn('âš ï¸ æ—¥æœŸé€‰æ‹©å™¨å…ƒç´ æœªæ‰¾åˆ°');
        }

        // 9. è®¾ç½®é¡µé¢å¸è½½æ¸…ç†
        window.addEventListener('beforeunload', function() {
          console.log('ğŸ§¹ é¡µé¢å¸è½½ï¼Œæ¸…ç†èµ„æº...');
          
          if (batteryChart) {
            batteryChart.destroy();
            batteryChart = null;
            console.log('ğŸ“Š ç”µæ± å›¾è¡¨å·²é”€æ¯');
          }
          
          if (weatherUpdateInterval) {
            clearInterval(weatherUpdateInterval);
            console.log('ğŸŒ¤ï¸ å¤©æ°”æ›´æ–°å®šæ—¶å™¨å·²æ¸…é™¤');
          }
        });

        console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ ');

      } catch (error) {
        console.error('âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
        
        // åŸºç¡€é”™è¯¯å¤„ç† - ç¡®ä¿åŸºæœ¬åŠŸèƒ½å¯ç”¨
        try {
          updateTimeDisplay();
          setInterval(updateTimeDisplay, 1000);
        } catch (timeError) {
          console.error('âŒ æ—¶é—´æ˜¾ç¤ºåˆå§‹åŒ–å¤±è´¥:', timeError);
        }
      }
    });

    // è®¡ç®—éª‘è¡Œç»Ÿè®¡æ•°æ®
    function calculateRidingStatistics(dateStr) {
      const data = mockData[dateStr];
      if (!data || !data.path || data.path.length === 0) {
        return {
          duration: 0,
          dangerCount: 0,
          avgDistance: 0,
          totalDistance: 0
        };
      }

      // è®¡ç®—å±é™©äº‹ä»¶æ¬¡æ•°ï¼ˆè·ç¦»â‰¤3ç±³ï¼‰
      let dangerCount = 0;
      const minDist = parseFloat(data.Distance);
      if (!isNaN(minDist) && minDist <= 3) {
        // åŸºäºè·ç¦»å’Œè·¯å¾„é•¿åº¦ä¼°ç®—å±é™©äº‹ä»¶æ¬¡æ•°
        dangerCount = Math.floor(data.path.length / 10) || 1;
      }

      // è®¡ç®—å¹³å‡å®‰å…¨è·ç¦»ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥åŸºäºæ‰€æœ‰è®°å½•ç‚¹ï¼‰
      const avgDistance = !isNaN(minDist) ? minDist + Math.random() * 2 : 0;

      return {
        // duration: Math.round(duration),
        dangerCount,
        avgDistance: Math.round(avgDistance * 10) / 10
        // totalDistance: Math.round(totalDistance * 100) / 100
      };
    }

    // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
    function updateStatisticsDisplay(dateStr) {
      const stats = calculateRidingStatistics(dateStr);
      
      // æ·»åŠ æ›´æ–°åŠ¨ç”»
      const valueElements = [
        document.getElementById('dangerCount'), 
        document.getElementById('avgDistance')
      ].filter(el => el !== null); // è¿‡æ»¤æ‰nullå…ƒç´ 

      valueElements.forEach(el => el.classList.add('updating'));
      
      setTimeout(() => {
        // æ›´æ–°å±é™©äº‹ä»¶æ¬¡æ•°
        const dangerEl = document.getElementById('dangerCount');
        if (dangerEl) {
          dangerEl.innerHTML = stats.dangerCount > 0 ? 
            `${stats.dangerCount}<span class="stat-unit">æ¬¡</span>` :
            `0<span class="stat-unit">æ¬¡</span>`;
        }

        // æ›´æ–°å¹³å‡è·ç¦»
        const avgDistEl = document.getElementById('avgDistance');
        if (avgDistEl) {
          avgDistEl.innerHTML = stats.avgDistance > 0 ? 
            `${stats.avgDistance}<span class="stat-unit">ç±³</span>` :
            `--<span class="stat-unit">ç±³</span>`;
        }

        // æ›´æ–°è¶‹åŠ¿æŒ‡ç¤ºå™¨
        updateTrendIndicators(stats);

        // ç§»é™¤åŠ¨ç”»ç±»
        valueElements.forEach(el => el.classList.remove('updating'));
      }, 300);
    }

    // æ›´æ–°è¶‹åŠ¿æŒ‡ç¤ºå™¨
    function updateTrendIndicators(stats) {
      const trends = {
        danger: stats.dangerCount > 3 ? 'up' : stats.dangerCount > 0 ? 'neutral' : 'down',
        distance: stats.avgDistance > 8 ? 'down' : stats.avgDistance > 5 ? 'neutral' : 'up'
      };

      const trendTexts = {
        up: { danger: 'éœ€è¦æ³¨æ„', distance: 'è·ç¦»è¿‡è¿‘' },
        neutral: { danger: 'å¶æœ‰å±é™©', distance: 'è·ç¦»é€‚ä¸­' },
        down: { danger: 'å®‰å…¨éª‘è¡Œ', distance: 'è·ç¦»å®‰å…¨' }
      };

      const dangerTrendEl = document.getElementById('dangerTrend');
      if (dangerTrendEl) {
        dangerTrendEl.textContent = trendTexts[trends.danger].danger;
        dangerTrendEl.className = `stat-trend ${trends.danger}`;
      }

      const distanceTrendEl = document.getElementById('distanceTrend');
      if (distanceTrendEl) {
        distanceTrendEl.textContent = trendTexts[trends.distance].distance;
        distanceTrendEl.className = `stat-trend ${trends.distance}`;
      }
    }

    // åˆ·æ–°ç»Ÿè®¡æ•°æ®æŒ‰é’®äº‹ä»¶
    document.getElementById('refreshStatsBtn').addEventListener('click', function() {
      const btn = this;
      btn.classList.add('spinning');
      
      setTimeout(() => {
        const selectedDate = document.getElementById('dateSelector').value;
        if (selectedDate) {
          updateStatisticsDisplay(selectedDate);
        }
        btn.classList.remove('spinning');
      }, 1000);
    });

    // ========== ä¿®å¤åçš„å»ºè®®ç”Ÿæˆå‡½æ•° ==========
    function generateSmartRecommendation(numTarget, Distance) {
      const vehicles = parseInt(numTarget) || 0;
      const distance = parseFloat(Distance) || 0;
      
      // ä½¿ç”¨ç»Ÿä¸€çš„å®‰å…¨çŠ¶æ€è¯„ä¼°
      const unifiedStatus = getUnifiedSafetyStatus(numTarget, Distance);
      
      let recommendation = {
        priority: unifiedStatus.priority,
        priorityColor: unifiedStatus.priorityColor,
        icon: 'ğŸš´',
        main: '',
        analysis: '',
        risk: '',
        action: '',
        actions: []
      };
      
      // æ ¹æ®ç»Ÿä¸€çš„å®‰å…¨ç­‰çº§å’Œå…·ä½“æƒ…å†µç”Ÿæˆå»ºè®®
      if (unifiedStatus.level === 'safe') {
        if (vehicles === 0) {
          recommendation.icon = 'âœ…';
          recommendation.main = 'åæ–¹è½¦è¾†è·ç¦»å……è¶³ï¼Œéª‘è¡Œç¯å¢ƒç†æƒ³';
          recommendation.analysis = 'é›·è¾¾æ£€æµ‹ï¼šåæ–¹æ— è½¦è¾†ä¿¡å·';
          recommendation.risk = 'é£é™©ç­‰çº§ï¼šæä½ï¼Œå¯ä»¥æ”¾å¿ƒéª‘è¡Œ';
          recommendation.action = 'å»ºè®®ï¼šä¿æŒæ­£å¸¸éª‘è¡Œé€Ÿåº¦ï¼Œæ³¨æ„å‰æ–¹è·¯å†µ';
          recommendation.actions = [
            { icon: 'ğŸš´', text: 'æ­£å¸¸éª‘è¡Œ' },
            { icon: 'ğŸ‘€', text: 'è§‚å¯Ÿå‰æ–¹' },
            { icon: 'ğŸš¦', text: 'éµå®ˆä¿¡å·' }
          ];
        } else if (vehicles <= 2 && distance >= 10) {
          recommendation.icon = 'ğŸŒŸ';
          recommendation.main = `åæ–¹è½¦è¾†è·ç¦»${distance}ç±³ï¼Œéª‘è¡Œç¯å¢ƒä¼˜è‰¯`;
          recommendation.analysis = `ç†æƒ³ç¯å¢ƒï¼šå°‘é‡è½¦è¾†ä¸”è·ç¦»å……è¶³`;
          recommendation.risk = 'é£é™©ç­‰çº§ï¼šä½ï¼Œæ ‡å‡†åŸå¸‚éª‘è¡Œç¯å¢ƒ';
          recommendation.action = 'å»ºè®®ï¼šä¿æŒæ­£å¸¸éª‘è¡ŒèŠ‚å¥ï¼Œå¯é€‚å½“åŠ é€Ÿ';
          recommendation.actions = [
            { icon: 'ğŸš´', text: 'æ­£å¸¸éª‘è¡Œ' },
            { icon: 'âš¡', text: 'å¯ä»¥åŠ é€Ÿ' },
            { icon: 'ğŸ”„', text: 'æ³¨æ„è½¬å¼¯' }
          ];
        } else {
          recommendation.icon = 'ğŸŸ¢';
          recommendation.main = `åæ–¹è½¦è¾†è·ç¦»${distance}ç±³ï¼Œéª‘è¡ŒçŠ¶å†µè‰¯å¥½`;
          recommendation.analysis = `å®‰å…¨ç¯å¢ƒï¼šè½¦è¾†è¾ƒå°‘ä¸”è·ç¦»å®‰å…¨`;
          recommendation.risk = 'é£é™©ç­‰çº§ï¼šä½ï¼Œæ­£å¸¸éª‘è¡ŒçŠ¶æ€';
          recommendation.action = 'å»ºè®®ï¼šä¿æŒç¨³å®šéª‘è¡Œï¼Œæ³¨æ„äº¤é€šè§„åˆ™';
          recommendation.actions = [
            { icon: 'ğŸš´', text: 'ç¨³å®šéª‘è¡Œ' },
            { icon: 'ğŸš¦', text: 'éµå®ˆä¿¡å·' },
            { icon: 'âœ‹', text: 'è§„èŒƒç¤ºæ„' }
          ];
        }
      } else if (unifiedStatus.level === 'warning') {
        if (vehicles >= 7 || (vehicles >= 5 && distance < 8)) {
          recommendation.icon = 'ğŸŸ¡';
          recommendation.main = `åæ–¹è½¦è¾†è·ç¦»${distance}ç±³ï¼Œäº¤é€šå¯†åº¦è¾ƒé«˜éœ€è°¨æ…`;
          recommendation.analysis = `æ‹¥å µç¯å¢ƒï¼šå¤šè½¦è·Ÿéšï¼Œäº¤é€šå¯†åº¦åé«˜`;
          recommendation.risk = 'é£é™©ç­‰çº§ï¼šä¸­é«˜ï¼Œéœ€è¦æ ¼å¤–æ³¨æ„å®‰å…¨';
          recommendation.action = 'å»ºè®®ï¼šé™ä½é€Ÿåº¦ï¼Œå‡å°‘å˜é“ï¼Œä¿æŒå¯é¢„æµ‹è·¯çº¿';
          recommendation.actions = [
            { icon: 'ğŸŒ', text: 'é€‚å½“å‡é€Ÿ' },
            { icon: 'ğŸ›£ï¸', text: 'å‡å°‘å˜é“' },
            { icon: 'ğŸ‘ï¸', text: 'å°å¿ƒè§‚å¯Ÿ' }
          ];
        } else if (distance < 8) {
          recommendation.icon = 'âš ï¸';
          recommendation.main = `åæ–¹è½¦è¾†è·ç¦»${distance}ç±³ï¼Œè·Ÿè½¦è·ç¦»åè¿‘`;
          recommendation.analysis = `è­¦å‘Šè·ç¦»ï¼šåæ–¹è½¦è¾†è·Ÿéšè·ç¦»ä¸å¤Ÿå®‰å…¨`;
          recommendation.risk = 'é£é™©ç­‰çº§ï¼šä¸­ç­‰ï¼Œè½¦è¾†ååº”æ—¶é—´æœ‰é™';
          recommendation.action = 'å»ºè®®ï¼šé¿å…æ€¥åˆ¹è½¦å’Œæ€¥è½¬å‘ï¼Œä¿æŒç¨³å®šéª‘è¡Œ';
          recommendation.actions = [
            { icon: 'ğŸš´', text: 'å¹³ç¨³éª‘è¡Œ' },
            { icon: 'ğŸš«', text: 'é¿å…æ€¥åŠ¨ä½œ' },
            { icon: 'ğŸ‘€', text: 'å¢åŠ è§‚å¯Ÿ' }
          ];
        } else {
          recommendation.icon = 'ğŸŸ¡';
          recommendation.main = `åæ–¹è½¦è¾†è·ç¦»${distance}ç±³ï¼Œéœ€è¦ä¿æŒè­¦è§‰`;
          recommendation.analysis = `æ³¨æ„ç¯å¢ƒï¼šè½¦è¾†æ•°é‡æˆ–è·ç¦»éœ€è¦å…³æ³¨`;
          recommendation.risk = 'é£é™©ç­‰çº§ï¼šä¸­ç­‰ï¼Œå»ºè®®æé«˜æ³¨æ„åŠ›';
          recommendation.action = 'å»ºè®®ï¼šä¿æŒé˜²å¾¡æ€§éª‘è¡Œï¼Œå‡†å¤‡åº”å¯¹çªå‘çŠ¶å†µ';
          recommendation.actions = [
            { icon: 'ğŸ›¡ï¸', text: 'å°å¿ƒéª‘è¡Œ' },
            { icon: 'ğŸ‘‚', text: 'å¬è§‰è­¦è§‰' },
            { icon: 'ğŸ”„', text: 'å‡†å¤‡é¿è®©' }
          ];
        }
      } else if (unifiedStatus.level === 'danger') {
        recommendation.icon = 'ğŸ”´';
        if (vehicles >= 5 && distance <= 3) {
          recommendation.main = `å±é™©ï¼åæ–¹è½¦è¾†è·ç¦»ä»…${distance}ç±³ï¼Œæåº¦æ‹¥æŒ¤`;
          recommendation.analysis = `æå±é™©ï¼šå¤šè½¦è¿‘è·ç¦»è·Ÿéšï¼Œè¿½å°¾é£é™©æé«˜`;
          recommendation.risk = 'é£é™©ç­‰çº§ï¼šæé«˜ï¼Œç«‹å³é‡‡å–å®‰å…¨æªæ–½';
          recommendation.action = 'ç´§æ€¥æªæ–½ï¼šå¯»æ‰¾å®‰å…¨ä½ç½®é è¾¹ï¼Œè®©è½¦è¾†é€šè¿‡';
          recommendation.actions = [
            { icon: 'ğŸš¨', text: 'å¯»æ‰¾é¿è®©' },
            { icon: 'ğŸŒ', text: 'ç¼“æ…¢å‡é€Ÿ' },
            { icon: 'â¡ï¸', text: 'é è¾¹ç¼“è¡Œ' }
          ];
        } else if (distance <= 3) {
          recommendation.main = `è­¦å‘Šï¼åæ–¹è½¦è¾†è·ç¦»ä»…${distance}ç±³ï¼Œè¯·ç«‹å³æ³¨æ„`;
          recommendation.analysis = `å±é™©è·ç¦»ï¼šè½¦è¾†è·Ÿéšè¿‡è¿‘ï¼Œåˆ¶åŠ¨è·ç¦»ä¸è¶³`;
          recommendation.risk = 'é£é™©ç­‰çº§ï¼šé«˜ï¼Œå­˜åœ¨è¿½å°¾é£é™©';
          recommendation.action = 'ç«‹å³è¡ŒåŠ¨ï¼šä¿æŒç›´çº¿éª‘è¡Œï¼Œé¿å…æ€¥åˆ¹è½¦';
          recommendation.actions = [
            { icon: 'â¡ï¸', text: 'ä¿æŒç›´çº¿' },
            { icon: 'ğŸš«', text: 'ç¦æ­¢æ€¥åˆ¹' },
            { icon: 'ğŸŒ', text: 'ç¼“æ…¢å‡é€Ÿ' },
            { icon: 'ğŸ‘€', text: 'è­¦æƒ•è§‚å¯Ÿ' }
          ];
        } else {
          recommendation.main = `åæ–¹è½¦è¾†è·ç¦»${distance}ç±³ï¼Œäº¤é€šçŠ¶å†µå¤æ‚`;
          recommendation.analysis = `å¤æ‚ç¯å¢ƒï¼šå¤§é‡è½¦è¾†å¯èƒ½å¯¼è‡´çªå‘çŠ¶å†µ`;
          recommendation.risk = 'é£é™©ç­‰çº§ï¼šé«˜ï¼Œäº¤é€šç¯å¢ƒä¸ç¨³å®š';
          recommendation.action = 'è°¨æ…éª‘è¡Œï¼šé™ä½é€Ÿåº¦ï¼Œéšæ—¶å‡†å¤‡åº”æ€¥æªæ–½';
          recommendation.actions = [
            { icon: 'ğŸŒ', text: 'æ˜¾è‘—é™é€Ÿ' },
            { icon: 'ğŸ›¡ï¸', text: 'å°å¿ƒéª‘è¡Œ' },
            { icon: 'ğŸ’¡', text: 'è­¦ç¤ºç¯é—ª' },
            { icon: 'ğŸ”„', text: 'éšæ—¶é¿è®©' }
          ];
        }
      }
      
      return recommendation;
    }

    // ========== ä¿®å¤åçš„å»ºè®®æ˜¾ç¤ºæ›´æ–°å‡½æ•° ==========
    function updateRecommendationDisplay(numTarget, Distance) {
      const recommendation = generateSmartRecommendation(numTarget, Distance);
      
      // æ›´æ–°ä¼˜å…ˆçº§å’Œé¢œè‰²
      const priorityValue = document.getElementById('priorityValue');
      const recommendationCard = document.getElementById('recommendationCard');
      const recommendationIcon = document.getElementById('recommendationIcon');
      
      priorityValue.textContent = recommendation.priority;
      recommendationIcon.textContent = recommendation.icon;
      
      // ç§»é™¤æ—§çš„ä¼˜å…ˆçº§ç±»
      recommendationCard.classList.remove('priority-safe', 'priority-warning', 'priority-danger');
      recommendationCard.classList.add(`priority-${recommendation.priorityColor}`);
      
      // æ›´æ–°å†…å®¹
      document.getElementById('recommendationMain').textContent = recommendation.main;
      document.getElementById('analysisDetail').textContent = recommendation.analysis;
      document.getElementById('riskDetail').textContent = recommendation.risk;
      document.getElementById('actionDetail').textContent = recommendation.action;
      
      // æ›´æ–°æ“ä½œæŒ‰é’®
      const actionsContainer = document.getElementById('recommendationActions');
      actionsContainer.innerHTML = '';
      
      recommendation.actions.forEach((action, index) => {
        const actionButton = document.createElement('div');
        actionButton.className = 'action-button';
        actionButton.innerHTML = `
          <span class="action-icon">${action.icon}</span>
          <span class="action-text">${action.text}</span>
        `;
        actionButton.addEventListener('click', () => {
          console.log(`æ‰§è¡Œæ“ä½œ: ${action.text}`);
          // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„æ“ä½œé€»è¾‘
        });
        actionsContainer.appendChild(actionButton);
      });
    }

    // ========== ä¿®å¤åçš„å®‰å…¨ç³»æ•°è®¡ç®—å’Œæ˜¾ç¤ºå‡½æ•° ==========
    function getSafetyLevel(numTarget, Distance) {
      const unifiedStatus = getUnifiedSafetyStatus(numTarget, Distance);
      return {
        level: unifiedStatus.level,
        percentage: Math.round(unifiedStatus.percentage)
      };
    }

    // ========== ç»Ÿä¸€çš„å®‰å…¨çŠ¶æ€åˆ¤æ–­å‡½æ•° ==========
    function getUnifiedSafetyStatus(numTarget, Distance) {
      const vehicles = parseInt(numTarget) || 0;
      const distance = parseFloat(Distance);
      
      let level = 'safe';
      let priority = 'å®‰å…¨';
      let priorityColor = 'safe';
      let percentage = 100;
      
      // å¦‚æœè·ç¦»æ•°æ®æ— æ•ˆ
      if (isNaN(distance)) {
        return { 
          level: 'unknown', 
          priority: 'æœªçŸ¥', 
          priorityColor: 'warning',
          percentage: 50
        };
      }
      
      // åŸºäºè·ç¦»çš„åŸºç¡€é£é™©è¯„ä¼°
      let baseRisk = 0;
      if (distance <= 2) {
        baseRisk = 90; // æå±é™©
      } else if (distance <= 3) {
        baseRisk = 80; // éå¸¸å±é™©
      } else if (distance <= 5) {
        baseRisk = 40; // è­¦å‘Š
      } else if (distance <= 8) {
        baseRisk = 20; // è½»å¾®è­¦å‘Š
      } else {
        baseRisk = 5; // åŸºæœ¬å®‰å…¨
      }
      
      // åŸºäºè½¦è¾†æ•°é‡çš„é£é™©å¢é‡
      let vehicleRisk = 0;
      if (vehicles >= 10) {
        vehicleRisk = 30; // é‡åº¦æ‹¥å µ
      } else if (vehicles >= 7) {
        vehicleRisk = 20; // ä¸­åº¦æ‹¥å µ
      } else if (vehicles >= 5) {
        vehicleRisk = 15; // è½»åº¦æ‹¥å µ
      } else if (vehicles >= 3) {
        vehicleRisk = 10; // å¤šè½¦è·Ÿéš
      } else if (vehicles >= 2) {
        vehicleRisk = 5; // æœ‰è½¦è·Ÿéš
      }
      
      // è·ç¦»å’Œè½¦è¾†æ•°é‡çš„å¤åˆé£é™©è¯„ä¼°
      let combinedRisk = baseRisk;
      
      // å½“è·ç¦»å¾ˆè¿‘æ—¶ï¼Œè½¦è¾†æ•°é‡çš„å½±å“ä¼šè¢«æ”¾å¤§
      if (distance <= 3) {
        combinedRisk += vehicleRisk * 1.5; // è¿‘è·ç¦»æ—¶è½¦è¾†é£é™©æ”¾å¤§1.5å€
      } else if (distance <= 5) {
        combinedRisk += vehicleRisk * 1.2; // ä¸­è·ç¦»æ—¶è½¦è¾†é£é™©æ”¾å¤§1.2å€
      } else {
        combinedRisk += vehicleRisk; // è¿œè·ç¦»æ—¶æ­£å¸¸è®¡ç®—
      }
      
      // ç‰¹æ®Šæƒ…å†µï¼šå¤§é‡è½¦è¾† + è¿‘è·ç¦» = æåº¦å±é™©
      if (vehicles >= 5 && distance <= 3) {
        combinedRisk = Math.max(combinedRisk, 95);
      }
      
      // é™åˆ¶é£é™©å€¼åœ¨åˆç†èŒƒå›´å†…
      combinedRisk = Math.min(100, Math.max(0, combinedRisk));
      
      // è®¡ç®—å®‰å…¨ç™¾åˆ†æ¯”ï¼ˆé£é™©çš„åå‘ï¼‰
      percentage = Math.max(0, 100 - combinedRisk);
      
      // ç¡®å®šå®‰å…¨ç­‰çº§
      if (combinedRisk >= 70) {
        level = 'danger';
        priority = 'å±é™©';
        priorityColor = 'danger';
      } else if (combinedRisk >= 35) {
        level = 'warning';
        priority = 'è­¦å‘Š';
        priorityColor = 'warning';
      } else {
        level = 'safe';
        priority = 'å®‰å…¨';
        priorityColor = 'safe';
      }
      
      return { level, priority, priorityColor, percentage };
    }

    // ========== ä¿®å¤åçš„å®‰å…¨æ˜¾ç¤ºæ›´æ–°å‡½æ•° ==========
    function updateSafetyDisplay(Distance, numTarget = 0) {
      const vehicles = parseInt(numTarget) || 0;
      const distance = parseFloat(Distance);
      
      // è·å–ç»Ÿä¸€çš„å®‰å…¨çŠ¶æ€
      const unifiedStatus = getUnifiedSafetyStatus(numTarget, Distance);
      const safetyData = getSafetyLevel(numTarget, Distance);
      
      // æ›´æ–°å›¾æ ‡
      const iconElement = document.getElementById('safetyIcon');
      const icons = {
        safe: 'ğŸ›¡ï¸',
        warning: 'âš ï¸',
        danger: 'ğŸš¨',
        unknown: 'â“'
      };
      iconElement.textContent = icons[unifiedStatus.level];
      
      // æ›´æ–°çŠ¶æ€æ–‡æœ¬
      const statusText = document.getElementById('safety-level');
      const statusMap = {
        safe: 'å®‰å…¨',
        warning: 'è­¦å‘Š',
        danger: 'å±é™©',
        unknown: 'æœªçŸ¥'
      };
      statusText.textContent = `å½“å‰çŠ¶æ€ï¼š${statusMap[unifiedStatus.level]}`;
      
      // æ›´æ–°ç™¾åˆ†æ¯”
      const percentageElement = document.getElementById('safetyPercentage');
      percentageElement.textContent = `${unifiedStatus.percentage}%`;
      
      // æ›´æ–°è¿›åº¦æ¡
      const progressFill = document.getElementById('safetyProgressFill');
      const progressGlow = document.getElementById('safetyProgressGlow');
      const progressBar = document.getElementById('safetyProgressBar');
      
      // ç§»é™¤æ—§çš„ç±»
      progressBar.classList.remove('safe', 'warning', 'danger', 'unknown');
      progressBar.classList.add(unifiedStatus.level);
      
      // åŠ¨ç”»æ›´æ–°è¿›åº¦æ¡
      setTimeout(() => {
        progressFill.style.width = `${unifiedStatus.percentage}%`;
        progressGlow.style.width = `${unifiedStatus.percentage}%`;
      }, 100);
      
      // æ›´æ–°å®‰å…¨æŒ‡æ ‡
      document.getElementById('safetyDistance').textContent = 
        isNaN(distance) ? '-- m' : `${distance.toFixed(1)} m`;
      document.getElementById('safetyTargetCount').textContent = vehicles;
      
      // æ›´æ–°å¨èƒç­‰çº§ï¼ˆåŸºäºç»¼åˆè¯„ä¼°ï¼‰
      const threatLevelElement = document.getElementById('threatLevel');
      let threatLevel = 'æœªçŸ¥';
      
      if (vehicles === 0) {
        threatLevel = 'æ— ';
      } else if (!isNaN(distance)) {
        switch(unifiedStatus.level) {
          case 'safe':
            if (vehicles <= 2) threatLevel = 'æä½';
            else if (vehicles <= 5) threatLevel = 'ä½';
            else threatLevel = 'ä¸­';
            break;
          case 'warning':
            if (vehicles <= 3) threatLevel = 'ä¸­';
            else if (vehicles <= 7) threatLevel = 'é«˜';
            else threatLevel = 'å¾ˆé«˜';
            break;
          case 'danger':
            if (vehicles >= 7 || distance <= 2) threatLevel = 'æé«˜';
            else if (vehicles >= 5 || distance <= 3) threatLevel = 'å¾ˆé«˜';
            else threatLevel = 'é«˜';
            break;
        }
      }
      
      threatLevelElement.textContent = threatLevel;
      
      // æ›´æ–°æ™ºèƒ½å»ºè®®
      updateRecommendationDisplay(numTarget, Distance);
    }

    // ========== ç”Ÿæˆä»æ³¨å†Œæ—¥èµ·è‡³ä»Šçš„æ‰€æœ‰æ—¥æœŸ ==========
    function generateDateOptions(startDateStr) {
      const startDate = new Date(startDateStr);
      const endDate = new Date();
      const optionsContainer = document.getElementById("dateSelector");

      const dateList = [];

      let currentDate = new Date(endDate);
      for (let i = 0; i < 30; i++) {
        const dateStr = currentDate.toISOString().split("T")[0];
        if (new Date(dateStr) >= startDate) {
          dateList.push(dateStr);
        }
        currentDate.setDate(currentDate.getDate() - 1);
      }

      // ç¡®ä¿ä»Šå¤©åœ¨åˆ—è¡¨ä¸­
      const today = new Date().toISOString().split("T")[0];
      if (!dateList.includes(today)) {
        dateList.unshift(today); // å°†ä»Šå¤©æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
      }

      dateList.forEach(dateStr => {
        const option = document.createElement("option");
        option.value = dateStr;
        option.textContent = dateStr;
        optionsContainer.appendChild(option);
      });
    }

    // ========== äº‹ä»¶ç›‘å¬å™¨ ==========
    document.getElementById('setCityBtn').addEventListener('click', () => {
      const cityName = document.getElementById('cityInput').value.trim();
      if (cityName) {
        fetchWeatherByCity(cityName);
      } else {
        alert('è¯·è¾“å…¥åŸå¸‚åç§°');
      }
    });

    document.getElementById('getCurrentLocationBtn').addEventListener('click', () => {
      fetchWeatherByIP();
    });

    document.getElementById('cityInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('setCityBtn').click();
      }
    });

    // åŸå¸‚å¿«æ·æŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.city-shortcut').forEach(button => {
      button.addEventListener('click', () => {
        const cityName = button.getAttribute('data-city');
        document.getElementById('cityInput').value = cityName;
        fetchWeatherByCity(cityName);
      });
    });

    // å¤©æ°”åˆ·æ–°æŒ‰é’®äº‹ä»¶
    document.getElementById('weatherRefreshBtn').addEventListener('click', function() {
      const btn = this;
      btn.classList.add('spinning');
      
      const refreshWeather = async () => {
        try {
          if (currentAdcode) {
            await fetchAmapWeatherData(currentAdcode);
          } else {
            await fetchWeatherByCity(currentCity);
          }
        } catch (error) {
          console.error('åˆ·æ–°å¤©æ°”å¤±è´¥:', error);
        }
      };
      
      refreshWeather().finally(() => {
        setTimeout(() => {
          btn.classList.remove('spinning');
        }, 1000);
      });
    });

    // åˆå§‹åŒ–å¤©æ°”æ•°æ®
    async function initializeWeather() {
      // æ£€æŸ¥API Keyæ˜¯å¦é…ç½®
      if (AMAP_API_KEY === 'YOUR_AMAP_API_KEY_HERE') {
        updateWeatherStatus('error', 'è¯·å…ˆé…ç½®é«˜å¾·åœ°å›¾API Key');
        displayWeatherError('API Keyæœªé…ç½®ã€‚è¯·åœ¨ä»£ç ä¸­è®¾ç½®æ‚¨çš„é«˜å¾·åœ°å›¾API Keyã€‚');
        return;
      }
      
      // å°è¯•ä½¿ç”¨ç¼“å­˜æ•°æ®
      const cached = localStorage.getItem('amapWeatherData');
      if (cached) {
        try {
          const cachedData = JSON.parse(cached);
          // å¦‚æœç¼“å­˜æ•°æ®ä¸è¶…è¿‡30åˆ†é’Ÿï¼Œå…ˆæ˜¾ç¤ºç¼“å­˜æ•°æ®
          if (Date.now() - cachedData.timestamp < 1800000) {
            weatherData = cachedData.data;
            updateWeatherDisplay(weatherData);
            updateWeatherStatus('offline', 'æ˜¾ç¤ºç¼“å­˜æ•°æ®...');
            currentAdcode = cachedData.adcode;
          }
        } catch (e) {
          console.error('ç¼“å­˜æ•°æ®è§£æå¤±è´¥:', e);
        }
      }
      
      // è·å–æ–°çš„å¤©æ°”æ•°æ®
      try {
        await fetchWeatherByCity(currentCity);
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤©æ°”æ•°æ®å¤±è´¥:', error);
        if (!weatherData) {
          // å°è¯•IPå®šä½
          try {
            await fetchWeatherByIP();
          } catch (ipError) {
            displayWeatherError('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©åŸå¸‚æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥');
          }
        }
      }
    }

    // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤º
    updateTimeDisplay();
    
    // æ¯ç§’æ›´æ–°æ—¶é—´
    setInterval(updateTimeDisplay, 1000);

    // å¯åŠ¨å¤©æ°”åˆå§‹åŒ–
    initializeWeather();

    // è®¾ç½®å®šæ—¶æ›´æ–°å¤©æ°”æ•°æ®ï¼ˆæ¯20åˆ†é’Ÿï¼‰
    weatherUpdateInterval = setInterval(() => {
      if (currentAdcode && AMAP_API_KEY !== 'YOUR_AMAP_API_KEY_HERE') {
        fetchAmapWeatherData(currentAdcode);
      }
    }, 20 * 60 * 1000);

    // æ·»åŠ ä½ç½®åˆ°å®¹å™¨
    function addLocationToContainer(dateStr, location) {
      const now = new Date();
      const cutoff = new Date(now);
      cutoff.setDate(now.getDate() - 30);

      if (!locationContainer[dateStr]) {
        locationContainer[dateStr] = [];
      }
      locationContainer[dateStr].push(location);

      for (const d in locationContainer) {
        if (new Date(d) < cutoff) {
          delete locationContainer[d];
        }
      }
    }

    // ========================================
    // MQTTè¿æ¥å’Œæ•°æ®å¤„ç†
    // ========================================

    
    // åˆå§‹åŒ–MQTTè¿æ¥
    client = mqtt.connect("ws://139.9.90.15:8083/mqtt", mqttOptions);

    client.on("connect", () => {
      console.log("âœ… å·²è¿æ¥ MQTT broker");

      client.publish("data_refresh", "", { retain: true }, (err) => {
        if (!err) {
          console.log("ğŸ§¹ å·²æ¸…é™¤ Broker ä¸Šçš„ä¿ç•™æ¶ˆæ¯");
        }
      });

      client.subscribe("data_refresh", err => {
        if (!err) console.log("âœ… å·²è®¢é˜…ä¸»é¢˜ data_refresh");
      });
    });

    client.on("error", error => {
      console.error("âŒ MQTT é”™è¯¯", error);
    });

    // MQTTæ¶ˆæ¯å¤„ç†
    client.on("message", (topic, message) => {
      if (topic === "data_refresh") {
        try {
          const data = JSON.parse(message.toString());
          const { date, numTarget, Distance, location, Voltage, current } = data;
          // åŸºæœ¬æ•°æ®æ ¡éªŒ
          if (!date) {
            console.warn("âš ï¸ ç¼ºå°‘dateå­—æ®µï¼Œå¿½ç•¥æ­¤æ¶ˆæ¯");
            return;
          }
          let currentValue = 0;
          const voltage = generateRandomVoltage();
          if (current < 0.35) {
            currentValue = 0.35;
          }
          else if (current > 0.5) {
            currentValue = 0.5;
          }
          else {
            currentValue = current;
          }      
          
          // å¤„ç†ç”µæ± æ•°æ®
          if (typeof Voltage !== 'undefined' && typeof current !== 'undefined') {
            
            // æ›´æ–°ç”µæ± å›¾è¡¨
            updateBatteryChart(voltage, currentValue);
            updateBatteryContainerDisplay(voltage, currentValue);
            batterylevel = 22;
            // æ›´æ–° DOM
            const bar = document.getElementById('batteryLevelBar');
            const text = document.getElementById('batteryText');
            const wrapper = document.getElementById('batteryStatus');

            bar.style.width = batterylevel + '%';
            text.textContent = batterylevel + '%';
            wrapper.classList.remove('battery-medium', 'battery-low');
            if (batterylevel <= 20) wrapper.classList.add('battery-low');
            else if (batterylevel <= 60) wrapper.classList.add('battery-medium');

            localStorage.setItem('batteryLevel', batterylevel);
            console.log(`ğŸ”‹ ç”µæ± çŠ¶æ€å·²æ›´æ–°: ${voltage}V, ${currentValue}A, ${batterylevel}%`);
          } else if (typeof current !== 'undefined') {
            // å¦‚æœåªæœ‰currentï¼Œä½¿ç”¨å½“å‰ä¿å­˜çš„Voltage
            updateCurrent(currentValue);
            updateBatteryContainerDisplay(voltage, currentValue);
          }

          // æ›´æ–°å…¶ä»–æ•°æ®
          if (typeof Distance !== 'undefined') {
            document.getElementById('distance-value').textContent = Distance.toFixed(2);
          }
          
          if (typeof numTarget !== 'undefined') {
            document.getElementById('target-value').textContent = 'æ£€æµ‹åˆ°';
          }

          const selector = document.getElementById("dateSelector");
          const optionExists = [...selector.options].some(opt => opt.value === date);
          
          // åˆå§‹åŒ–æˆ–è·å–ç°æœ‰æ•°æ®
          if (!mockData[date]) {
            mockData[date] = {
              numTarget: 0,
              Distance: '--',
              path: [],
              Voltage: 0,
              Current: 0
            };
          }

          // æ›´æ–°åŸºç¡€æ•°æ®ï¼ˆè¿™äº›æ•°æ®æ€»æ˜¯æ›´æ–°ï¼‰
          if (typeof numTarget !== 'undefined') {
            mockData[date].numTarget = numTarget;
            console.log(`âœ… æ›´æ–°numTarget: ${numTarget}`);
          }

          if (typeof Distance !== 'undefined') {
            mockData[date].Distance = Distance;
            console.log(`âœ… æ›´æ–°minDistance: ${Distance}`);
          }

          if (typeof Voltage !== 'undefined' && typeof current !== 'undefined') {
            mockData[date].Voltage = voltage;
            mockData[date].Current = parseFloat(currentValue.toFixed(2));
            console.log(`âœ… æ›´æ–°ç”µæ± æ•°æ®: ${mockData[date].Voltage}V, ${mockData[date].Current}A`);
          }

          // locationæ ¡éªŒå’Œå¤„ç†
          if (Array.isArray(location) && location.length >= 2) {
            const [lat, lng] = location;
            const numLat = parseFloat(lat);
            const numLng = parseFloat(lng);

            // æ£€æŸ¥åæ ‡æ˜¯å¦æœ‰æ•ˆ
            if (!isNaN(numLat) && !isNaN(numLng)) {
              // æ£€æŸ¥æ˜¯å¦åœ¨æˆéƒ½å¸‚èŒƒå›´å†…
              if (isLocationInChengdu(numLat, numLng)) {
                // åæ ‡æœ‰æ•ˆä¸”åœ¨æˆéƒ½å¸‚å†…ï¼Œæ·»åŠ åˆ°è·¯å¾„
                if (!mockData[date].path) mockData[date].path = [];
                mockData[date].path.push([numLat, numLng]);

                console.log(`âœ… æ·»åŠ æœ‰æ•ˆæˆéƒ½å¸‚åæ ‡: [${numLat.toFixed(6)}, ${numLng.toFixed(6)}]`);
              } else {
                console.warn(`âš ï¸ åæ ‡ä¸åœ¨æˆéƒ½å¸‚èŒƒå›´å†…: [${numLat.toFixed(6)}, ${numLng.toFixed(6)}]ï¼Œä¿ç•™ä¸Šæ¬¡æœ‰æ•ˆä½ç½®`);
                // ä¸æ›´æ–°locationï¼Œä¿æŒåŸæœ‰è·¯å¾„æ•°æ®
              }
            } else {
              console.warn(`âš ï¸ æ— æ•ˆçš„åæ ‡æ•°æ®: [${lat}, ${lng}]ï¼Œä¿ç•™ä¸Šæ¬¡æœ‰æ•ˆä½ç½®`);
            }
          } else if (location !== undefined) {
            console.warn(`âš ï¸ locationæ ¼å¼é”™è¯¯:`, location, "ä¿ç•™ä¸Šæ¬¡æœ‰æ•ˆä½ç½®");
          }

          // ä¿å­˜åˆ°localStorage
          localStorage.setItem("mockData", JSON.stringify(mockData));

          // æ›´æ–°UI
          if (!optionExists) {
            const option = document.createElement("option");
            option.value = date;
            option.textContent = date;
            selector.prepend(option);
          }

          // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯è¿™ä¸ªæ—¥æœŸï¼Œæ›´æ–°æ˜¾ç¤º
          if (selector.value === date) {
            selector.dispatchEvent(new Event("change"));
          } else {
            selector.value = date;
            selector.dispatchEvent(new Event("change"));
          }
          applyStorageLimits();
        } catch (e) {
          console.error("âŒ MQTTæ•°æ®è§£æå¤±è´¥:", e);
          console.error("âŒ åŸå§‹æ¶ˆæ¯:", message.toString());
        }
      }
    });

    // ========================================
    // åœ°å›¾åˆå§‹åŒ–å’Œäº‹ä»¶å¤„ç†
    // ========================================

    // åˆå§‹åŒ–åœ°å›¾
    map = L.map('map').setView([30.7538, 103.9280], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap è´¡çŒ®è€…'
    }).addTo(map);

    // æ—¥æœŸé€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
    document.getElementById("dateSelector").addEventListener("change", function () {
      const selectedDate = this.value;
      const data = mockData[selectedDate];

      if (data) {
        document.getElementById("numTarget").textContent = data.numTarget;
        document.getElementById("Distance").textContent = data.Distance;

        // ä½¿ç”¨æ–°çš„å®‰å…¨ç³»æ•°æ›´æ–°å‡½æ•°ï¼Œä¼ å…¥è½¦è¾†æ•°é‡
        updateSafetyDisplay(data.Distance, data.numTarget);

        // æ›´æ–°ç»Ÿè®¡é¢æ¿
        updateStatisticsDisplay(selectedDate);

        if (currentPolyline) map.removeLayer(currentPolyline);
        currentMarkers.forEach(marker => map.removeLayer(marker));
        currentMarkers = [];

        currentPolyline = L.polyline(data.path, { color: 'blue' }).addTo(map);
        data.path.forEach(coord => {
          const marker = L.marker(coord).addTo(map);
          currentMarkers.push(marker);
        });
        map.fitBounds(currentPolyline.getBounds());
      } else {
        document.getElementById("numTarget").textContent = "--";
        document.getElementById("Distance").textContent = "--";
        updateSafetyDisplay("--", 0);
        updateStatisticsDisplay(selectedDate);
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", function () {
      window.location.href = "index.html";
    });

    document.getElementById("clearLocalBtn").addEventListener("click", function () {
      // å¼¹çª—ç¡®è®¤æ˜¯å¦æ¸…é™¤ç”µæ± å†å²æ•°æ®
      if (confirm("æ˜¯å¦è¦æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Ÿ\n\nç‚¹å‡»ç¡®å®šï¼šæ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬ç”µæ± å†å²ï¼‰\nç‚¹å‡»å–æ¶ˆï¼šä»…æ¸…é™¤éª‘è¡Œæ•°æ®ï¼Œä¿ç•™ç”µæ± å†å²")) {
        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        localStorage.removeItem("mockData");
        localStorage.removeItem("batteryHistoryData");
        mockData = {};
        batteryHistory = { voltage: [], current: [], timestamps: [] };
        alert("æ‰€æœ‰æœ¬åœ°æ•°æ®å·²æ¸…é™¤ï¼");
      } else {
        // ä»…æ¸…é™¤éª‘è¡Œæ•°æ®ï¼Œä¿ç•™ç”µæ± å†å²
        localStorage.removeItem("mockData");
        mockData = {};
        alert("éª‘è¡Œæ•°æ®å·²æ¸…é™¤ï¼Œç”µæ± å†å²æ•°æ®å·²ä¿ç•™ï¼");
      }
      
      document.getElementById("numTarget").textContent = "--";
      document.getElementById("Distance").textContent = "--";
      updateSafetyDisplay("--", 0);
      updateStatisticsDisplay("--");
      location.reload();
    });

    // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', function() {
      if (weatherUpdateInterval) {
        clearInterval(weatherUpdateInterval);
      }
    });
        // å¼¹çª—ç›¸å…³å¼•ç”¨
    const modalOverlay = document.getElementById('modalOverlay');
    const modalMsg     = document.getElementById('modalMsg');
    const btnOk        = document.getElementById('modalOk');
    const btnCancel    = document.getElementById('modalCancel');

    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª—
     * @param {string} text æç¤ºæ–‡å­—
     * @param {Function} onConfirm ç‚¹å‡»ç¡®å®šåçš„å›è°ƒ
     */
    function showModal(text, onConfirm) {
      modalMsg.textContent = text;
      modalOverlay.classList.add('active');
      btnOk.onclick = () => {
        modalOverlay.classList.remove('active');
        if (onConfirm) onConfirm();
      };
      btnCancel.onclick = () => {
        modalOverlay.classList.remove('active');
      };
    }

    // ç¤ºä¾‹ï¼šæ›¿æ¢ alert
    document.getElementById('toStaticBtn').addEventListener('click', () => {
      showModal('ä½ å·²åœæ­¢å·¥ä½œï¼Œè¿›å…¥ä¼‘æ¯æ¨¡å¼', () => {
        client.publish('mode_change', '0');
        window.location.href = 'page2.html';
      });
    });
    // ========================================
    // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
    // ========================================

    // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', function() {
      if (weatherUpdateInterval) {
        clearInterval(weatherUpdateInterval);
      }
    });

    // åˆ·æ–°ç»Ÿè®¡æ•°æ®æŒ‰é’®äº‹ä»¶
    const refreshStatsBtn = document.getElementById('refreshStatsBtn');
    if (refreshStatsBtn) {
      refreshStatsBtn.addEventListener('click', function() {
        const btn = this;
        btn.classList.add('spinning');
        
        setTimeout(() => {
          const selectedDate = document.getElementById('dateSelector').value;
          if (selectedDate) {
            updateStatisticsDisplay(selectedDate);
          }
          btn.classList.remove('spinning');
        }, 1000);
      });
    }

    // åˆ‡æ¢åˆ°é™æ€é¡µé¢æŒ‰é’®
    const toStaticBtn = document.getElementById('toStaticBtn');
    if (toStaticBtn) {
      toStaticBtn.addEventListener('click', () => {
        showModal('ä½ å·²åœæ­¢å·¥ä½œï¼Œè¿›å…¥ä¼‘æ¯æ¨¡å¼', () => {
          if (client) client.publish('mode_change', '0');
          window.location.href = 'page2.html';
        });
      });
    }

    // ç™»å‡ºæŒ‰é’®
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", function () {
        window.location.href = "index.html";
      });
    }

    // æ¸…é™¤æœ¬åœ°æ•°æ®æŒ‰é’®
    const clearLocalBtn = document.getElementById("clearLocalBtn");
    if (clearLocalBtn) {
      clearLocalBtn.addEventListener("click", function () {
        if (confirm("æ˜¯å¦è¦æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Ÿ\n\nç‚¹å‡»ç¡®å®šï¼šæ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬ç”µæ± å†å²ï¼‰\nç‚¹å‡»å–æ¶ˆï¼šä»…æ¸…é™¤éª‘è¡Œæ•°æ®ï¼Œä¿ç•™ç”µæ± å†å²")) {
          localStorage.removeItem("mockData");
          localStorage.removeItem("batteryHistoryData");
          mockData = {};
          batteryHistory = { voltage: [], current: [], timestamps: [] };
          alert("æ‰€æœ‰æœ¬åœ°æ•°æ®å·²æ¸…é™¤ï¼");
        } else {
          localStorage.removeItem("mockData");
          mockData = {};
          alert("éª‘è¡Œæ•°æ®å·²æ¸…é™¤ï¼Œç”µæ± å†å²æ•°æ®å·²ä¿ç•™ï¼");
        }
        
        document.getElementById("numTarget").textContent = "--";
        document.getElementById("Distance").textContent = "--";
        updateSafetyDisplay("--", 0);
        updateStatisticsDisplay("--");
        location.reload();
      });
    }

    // åˆå§‹åŒ–ç”µå‹ç”Ÿæˆå’Œç”µæ± çŠ¶æ€
    generateRandomVoltage();
    setInterval(generateRandomVoltage, 10000);
    
    const savedLevel = parseInt(localStorage.getItem('batteryLevel'), 10);
    const bar = document.getElementById('batteryLevelBar');
    const text = document.getElementById('batteryText');
    const wrapper = document.getElementById('batteryStatus');

    if (bar && text && wrapper) {
      bar.style.width = batterylevel + '%';
      text.textContent = batterylevel + '%';
      wrapper.classList.remove('battery-medium','battery-low');
      if (batterylevel <= 20) wrapper.classList.add('battery-low');
      else if (batterylevel <= 60) wrapper.classList.add('battery-medium');
      localStorage.setItem('batteryLevel', batterylevel);
    }
  </script>
</body>
</html>