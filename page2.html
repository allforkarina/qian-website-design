<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é™æ€å®‰å…¨é¢„è­¦</title>

  <link rel="stylesheet" href="style.css"/>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <!-- å¼•å…¥ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { position: relative; }

 

    /* é¡¶éƒ¨ç”µé‡æŒ‡ç¤º */
    .battery-status {
      position: absolute; top: 16px; right: 20px; display: flex;
      align-items: center; z-index: 10;
    }
    .battery-icon {
      width:40px; height:18px; border:2px solid rgba(255,255,255,0.8);
      border-radius:4px; background:rgba(255,255,255,0.1);
      overflow:hidden; margin-right:6px; position:relative;
    }
    .battery-icon::after {
      content:""; position:absolute; top:4px; right:-6px;
      width:6px; height:10px; background:rgba(255,255,255,0.8);
      border-radius:2px;
    }
    .battery-level {
      height:100%; width:0;
      background:linear-gradient(90deg,#76FF03,#AEEA00);
      transition:width .5s ease, background .5s;
      position: relative;
    }
    
    .battery-level::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        to bottom,
        rgba(255,255,255,0.3) 0%,
        rgba(255,255,255,0.1) 50%,
        rgba(255,255,255,0) 51%,
        rgba(255,255,255,0.1) 100%
      );
    }
    
    .battery-medium .battery-level {
      background:linear-gradient(90deg,#FFD740,#FFC400);
    }
    .battery-low .battery-level {
      background:linear-gradient(90deg,#FF5252,#FF1744);
      animation: batteryPulse 1.5s infinite;
    }
    
    @keyframes batteryPulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }
    .battery-text {
      color:#fff; font-weight:600;
      font-size:clamp(14px,2.5vw,18px);
      text-shadow:0 0 4px rgba(0,0,0,0.5);
    }

    /* ç”µæ± çŠ¶æ€å¡ç‰‡æ ·å¼ */
    .battery-details {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .battery-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      border-left: 3px solid #4facfe;
    }
    
    .battery-info-row .label {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.8);
      font-weight: 500;
    }
    
    .battery-info-row .value {
      font-size: 1.1rem;
      color: #fff;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    h1 { text-align:center; margin-top:1.5em; }

    /* æŠ¥è­¦å¡ç‰‡ç½‘æ ¼ */
    .alarm-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:clamp(20px,3vw,30px);
      margin:clamp(40px,5vw,60px) 0;
    }
    .alarm-card h2 { margin-bottom:clamp(16px,3vw,24px); }
    .alarm-status {
      font-size:clamp(20px,4vw,28px);
      font-weight:700; text-shadow:0 0 10px rgba(0,0,0,0.3);
    }

    /* æŠ¥è­¦æ¿€æ´»çŠ¶æ€ */
    .alarm-card.alarm-active {
      animation: alarmBlink 1s infinite;
      border: 2px solid #ff4444;
    }
    
    .alarm-card.battery-low {
      border-left: 4px solid #ff4444;
    }
    
    .alarm-card.battery-medium {
      border-left: 4px solid #ffaa00;
    }
    
    .alarm-card.battery-high {
      border-left: 4px solid #44ff44;
    }
    
    @keyframes alarmBlink {
      0% { box-shadow: 0 0 5px rgba(255, 68, 68, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.8); }
      100% { box-shadow: 0 0 5px rgba(255, 68, 68, 0.5); }
    }

    /* å»ºè®®åˆ—è¡¨ */
    .recommendation-list {
      list-style:none; padding:0; margin:0;
      display:flex; flex-direction:column; gap:12px;
    }
    .recommendation-item {
      background:rgba(255,255,255,0.05);
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;
      padding:10px;
      display:flex; align-items:center; gap:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }

    /* ç”µæ± ç›‘æµ‹å›¾è¡¨æ ·å¼ */
    .charts-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .chart-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .chart-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .chart-title {
      color: #ffffff;
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-canvas {
      height: 300px;
      position: relative;
    }

    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
    }

    /* åœ°å›¾å®¹å™¨ */
    #map {
      width:100%; height:clamp(250px,40vh,400px);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.1);
      margin-top:20px;
    }
    
    /* åœ°å›¾æ§åˆ¶åŒºåŸŸ */
    .map-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .map-controls span {
      color: #fff;
      font-size: 0.9rem;
    }
    
    #syncMapBtn {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    #syncMapBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
    }

    /* è‡ªå®šä¹‰å¼¹çª— */
    /* è‡ªå®šä¹‰å¼¹çª—è¦†ç›–å±‚ */
    /* è‡ªå®šä¹‰å¼¹çª—è¦†ç›–å±‚ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-overlay.active {
      display: flex;
    }

    /* å¼¹çª—ä¸»ä½“ï¼ˆç§»é™¤éœ“è™¹æ¸å˜æ¡†ï¼Œæ”¹ä¸ºç®€æ´åŠé€æ˜è¾¹æ¡†ï¼‰ */
    .modal {
      position: relative;
      width: 400px;
      max-width: 90%;
      padding: 32px 24px;
      background: rgba(20, 20, 40, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.4),
        0 8px 20px rgba(0, 0, 0, 0.5);
      text-align: center;
      color: #fff;
    }

    .modal h3 {
      margin: 0 0 16px;
      font-size: 20px;
      font-weight: 600;
      text-shadow: 0 0 6px rgba(0, 0, 0, 0.5);
    }

    .modal p {
      margin: 0 0 24px;
      font-size: 16px;
      line-height: 1.4;
    }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 16px;
    }

    .modal-btn {
      min-width: 100px;
      padding: 10px 0;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .modal-btn.primary {
      background: linear-gradient(135deg, #ff6ec4, #7873f5);
      border: none;
      box-shadow: 0 4px 12px rgba(120, 115, 245, 0.6);
      color: #fff;
    }
    .modal-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(120, 115, 245, 0.8);
    }

    .modal-btn.secondary {
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.6);
      color: #fff;
    }
    .modal-btn.secondary:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

  </style>
</head>
<body>


  <div class="page-container">
   
    <!-- æ¨¡å¼åˆ‡æ¢ -->
  <button id="toCyclingBtn" class="toggle-btn">ç‚¹å‡»è¿›å…¥å·¥ä½œæ¨¡å¼<span class ="work-icon">ğŸ”§</span></button>    
   <!-- ç”µé‡ -->
  <div class="battery-status" id="batteryStatus">
    <div class="battery-icon">
      <div class="battery-level" id="batteryLevelBar"></div>
    </div>
    <div class="battery-text" id="batteryText">--%</div>
  </div>
    <h1>é™æ€å®‰å…¨é¢„è­¦è¿è¡Œä¸­</h1>
      <!-- ä¼˜åŒ–åçš„æ—¶é—´æ˜¾ç¤ºå¡ç‰‡ -->
    <div class="data-card time-card">
      <h2>
        <span class="time-icon" id="timeIcon">ğŸ•</span>
        å½“å‰æ—¶é—´
      </h2>
      <div class="time-display">
        <div class="date-section">
          <div class="current-date" id="current-date">2025-07-19</div>
          <div class="current-weekday" id="current-weekday">æ˜ŸæœŸå…­</div>
        </div>
        
        <div class="time-section">
          <div class="digital-clock" id="digital-clock">
            <span class="time-hours" id="time-hours">12</span>
            <span class="time-separator">:</span>
            <span class="time-minutes" id="time-minutes">44</span>
            <span class="time-separator">:</span>
            <span class="time-seconds" id="time-seconds">06</span>
          </div>
          <div class="time-zone" id="time-zone">UTC+8 åŒ—äº¬æ—¶é—´</div>
        </div>
      </div>
    </div>

    <div class="alarm-grid">
      <div class="data-card alarm-card danger">
        <h2>ğŸ”¥ ç«ç¾æŠ¥è­¦</h2>
        <div id="fireAlarmStatus" class="alarm-status">æ­£å¸¸</div>
      </div>
      <div class="data-card alarm-card warning">
        <h2>âš¡ é˜²ç›—éœ‡åŠ¨æŠ¥è­¦</h2>
        <div id="vibrationAlarmStatus" class="alarm-status">æ­£å¸¸</div>
      </div>
      <div class="data-card alarm-card info">
        <h2>ğŸ”‹ ç”µæ± çŠ¶æ€</h2>
        <div class="battery-details">
          <div class="battery-info-row">
            <span class="label">ç”µå‹:</span>
            <span id="voltageDisplay" class="value">--V</span>
          </div>
          <div class="battery-info-row">
            <span class="label">ç”µæµ:</span>
            <span id="currentDisplay" class="value">--A</span>
          </div>
          <div class="battery-info-row">
            <span class="label">ç”µé‡:</span>
            <span id="batteryPercentageDisplay" class="value">--%</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ç”µæ± ç›‘æµ‹å›¾è¡¨åŒºåŸŸ -->
    <div class="data-card">
      <h2>ğŸ“Š ç”µæ± ç”µå‹/ç”µæµç›‘æµ‹</h2>
      
      <div class="charts-container">
        <!-- å®æ—¶ç”µæ± æ•°æ®å›¾è¡¨ -->
        <div class="chart-card">
          <h3 class="chart-title">
            <span>ğŸ”‹</span>
            ç”µæ± ç”µå‹/ç”µæµå®æ—¶ç›‘æµ‹
          </h3>
          <div class="chart-canvas">
            <canvas id="batteryChart2"></canvas>
          </div>
        </div>
      </div>
    </div>
    
    <div class="data-card">
      <h2>ğŸ’¡ å®‰å…¨æç¤º</h2>
      <ul id="suggestions" class="recommendation-list"></ul>
    </div>
    <div class="data-card">
      <h2>ğŸ—ºï¸ éª‘è¡Œåœ°å›¾</h2>
      <div class="map-controls">
        <span>æ˜¾ç¤ºå†å²éª‘è¡Œè·¯å¾„</span>
        <button id="syncMapBtn" onclick="syncMapData()">ğŸ”„ åŒæ­¥è·¯å¾„</button>
      </div>
      <div id="map"></div>
    </div>
  </div>

  <!-- è‡ªå®šä¹‰å¼¹çª— -->
  <div id="modalOverlay" class="modal-overlay">
  <div class="modal">
    <h3>æç¤º</h3>
    <p id="modalMessage">è¿™é‡Œæ˜¯æç¤ºå†…å®¹</p>
    <div class="modal-buttons">
      <button id="modalCancel" class="modal-btn secondary">å–æ¶ˆ</button>
      <button id="modalOk"     class="modal-btn primary">ç¡®å®š</button>
    </div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // å›¾è¡¨ç›¸å…³å˜é‡
    let batteryChart2 = null;
    let batteryDataHistory = {
      voltage: [],
      current: [],
      timestamps: []
    };

    // åœ°å›¾åˆå§‹åŒ–ä¸è·¯å¾„åŒæ­¥
    const B = {north:27.209,south:25.652,east:107.394,west:105.612};
    const inB = (la,lo)=> la>=B.south && la<=B.north && lo>=B.west && lo<=B.east;
    const map=L.map('map').setView([26.553,106.528],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap'}).addTo(map);
    let poly,marks=[];
    
    // ä»æœ¬åœ°æ•°æ®ä¸­åŠ è½½å­˜å‚¨é…ç½®
    function loadLocalStorageConfig() {
      try {
          const configData = localStorage.getItem('storageConfig');
          if (configData) {
              const config = JSON.parse(configData);
              console.log('ä»æ§åˆ¶å°åŒæ­¥å­˜å‚¨é…ç½®:', config);
              window.maxBatteryDataPoints = config.maxBatteryDataPoints || 30;
              window.maxLocationDataPoints = config.maxLocationDataPoints || 30;
              window.maxHistoryDays = config.maxHistoryDays || 30;
              return {
                  maxBatteryDataPoints: config.maxBatteryDataPoints || 30,
                  maxLocationDataPoints: config.maxLocationDataPoints || 30,
                  maxHistoryDays: config.maxHistoryDays || 30,
                  lastUpdated: config.lastUpdated
              };
          } else {
              console.log('âš ï¸ æœªæ‰¾åˆ°å­˜å‚¨é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
              return getDefaultStorageConfig();
          }
      } catch (error) {
          console.error('âŒ è¯»å–å­˜å‚¨é…ç½®å¤±è´¥:', error);
          return getDefaultStorageConfig();
      }
    }

    function initStorageConfigListener() {
      // ç›‘å¬storageäº‹ä»¶ï¼ˆè·¨æ ‡ç­¾é¡µé€šä¿¡ï¼‰
      window.addEventListener('storage', function(e) {
          if (e.key === 'storageConfig' && e.newValue) {
              try {
                  const newConfig = JSON.parse(e.newValue);
                  console.log('ğŸ”„ æ£€æµ‹åˆ°å­˜å‚¨é…ç½®æ›´æ–°:', newConfig);
                  
                  // æ›´æ–°å…¨å±€é…ç½®
                  window.maxBatteryDataPoints = newConfig.maxBatteryDataPoints || 30;
                  window.maxLocationDataPoints = newConfig.maxLocationDataPoints || 30;
                  window.maxHistoryDays = newConfig.maxHistoryDays || 30;
                  
                  // ç«‹å³åº”ç”¨æ–°çš„å­˜å‚¨é™åˆ¶
                  applyStorageLimits(newConfig);
                  
                  console.log('âœ… å­˜å‚¨é…ç½®å·²åŒæ­¥æ›´æ–°');
              } catch (error) {
                  console.error('âŒ è§£æå­˜å‚¨é…ç½®å¤±è´¥:', error);
              }
          }
        });
        
        console.log('ğŸ‘‚ å­˜å‚¨é…ç½®ç›‘å¬å™¨å·²å¯åŠ¨');
    }

    function applyStorageLimits(config) {
        
        try {
            // 1. æ¸…ç†ç”µæ± å†å²æ•°æ®
            cleanupBatteryData();

            // 2. æ¸…ç†è·¯å¾„ä½ç½®æ•°æ®
            cleanupLocationData();
            
            // 3. æ¸…ç†å†å²å¤©æ•°æ•°æ®
            cleanupHistoryDays();
            
            console.log(`ğŸ“Š å­˜å‚¨é™åˆ¶å·²åº”ç”¨:
                - ç”µæ± æ•°æ®ç‚¹: ${window.maxBatteryDataPoints}
                - ä½ç½®æ•°æ®ç‚¹: ${window.maxLocationDataPoints}  
                - å†å²å¤©æ•°: ${window.maxDays}`);
                
        } catch (error) {
            console.error('âŒ åº”ç”¨å­˜å‚¨é™åˆ¶å¤±è´¥:', error);
        }
    }

    function cleanupBatteryData() {
        try {
            const batteryData = localStorage.getItem('batteryHistoryData');
            if (batteryData) {
                const data = JSON.parse(batteryData);
                
                // æ£€æŸ¥æ•°æ®ç»“æ„
                if (data.voltage && Array.isArray(data.voltage)) {
                    if (data.voltage.length > window.maxBatteryDataPoints) {
                        const removedCount = data.voltage.length - window.maxBatteryDataPoints;

                        // ä¿ç•™æœ€æ–°çš„æ•°æ®ç‚¹
                        data.voltage = data.voltage.slice(-window.maxBatteryDataPoints);
                        data.current = (data.current || []).slice(-window.maxBatteryDataPoints);
                        data.timestamps = (data.timestamps || []).slice(-window.maxBatteryDataPoints);

                        // æ›´æ–°localStorage
                        localStorage.setItem('batteryHistoryData', JSON.stringify(data));
                        
                        // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
                        batteryHistory = {
                            voltage: data.voltage,
                            current: data.current,
                            timestamps: data.timestamps
                        };
                        
                        // æ›´æ–°å›¾è¡¨æ˜¾ç¤º
                        if (batteryChart2) {
                            batteryChart2.data.labels = batteryHistory.timestamps;
                            batteryChart2.data.datasets[0].data = batteryHistory.voltage;
                            batteryChart2.data.datasets[1].data = batteryHistory.current;
                            batteryChart2.update('none');
                        }
                        
                        console.log(`ğŸ”‹ ç”µæ± æ•°æ®æ¸…ç†å®Œæˆï¼Œåˆ é™¤ ${removedCount} æ¡æ—§æ•°æ®ï¼Œä¿ç•™æœ€æ–° ${window.maxBatteryDataPoints} æ¡`);
                    }
                }
            }
        } catch (error) {
            console.error('âŒ æ¸…ç†ç”µæ± æ•°æ®å¤±è´¥:', error);
        }
    }

    function cleanupLocationData() {
        try {
            const storedData = localStorage.getItem('mockData');
            if (storedData) {
                const data = JSON.parse(storedData);
                let totalCleaned = 0;
                
                // éå†æ¯å¤©çš„æ•°æ®
                Object.keys(data).forEach(date => {
                    if (data[date].path && Array.isArray(data[date].path)) {
                        const originalLength = data[date].path.length;
                        
                        if (originalLength > window.maxLocationDataPoints) {
                            // ä¿ç•™æœ€æ–°çš„ä½ç½®ç‚¹
                            data[date].path = data[date].path.slice(-window.maxLocationDataPoints);
                            totalCleaned += originalLength - window.maxLocationDataPoints;
                            
                            console.log(`ğŸ“ ${date} ä½ç½®æ•°æ®: ${originalLength} â†’ ${data[date].path.length}`);
                        }
                    }
                });
                
                if (totalCleaned > 0) {
                    // æ›´æ–°localStorage
                    localStorage.setItem('mockData', JSON.stringify(data));
                    
                    // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
                    mockData = data;
                    
                    console.log(`ğŸ—ºï¸ ä½ç½®æ•°æ®æ¸…ç†å®Œæˆï¼Œæ€»å…±åˆ é™¤ ${totalCleaned} ä¸ªä½ç½®ç‚¹`);
                    
                    // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ—¥æœŸæœ‰æ•°æ®æ›´æ–°ï¼Œåˆ·æ–°åœ°å›¾
                    const currentDate = document.getElementById('dateSelector').value;
                    if (currentDate && data[currentDate]) {
                        updateMapDisplay(currentDate);
                    }
                }
            }
        } catch (error) {
            console.error('âŒ æ¸…ç†ä½ç½®æ•°æ®å¤±è´¥:', error);
        }
    }

    function cleanupHistoryDays() {
        try {
            const storedData = localStorage.getItem('mockData');
            if (storedData) {
                const data = JSON.parse(storedData);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - window.maxDays);
                
                let deletedDays = 0;
                const datesToDelete = [];
                
                // æ‰¾å‡ºéœ€è¦åˆ é™¤çš„æ—¥æœŸ
                Object.keys(data).forEach(date => {
                    const dateObj = new Date(date);
                    if (dateObj < cutoffDate) {
                        datesToDelete.push(date);
                    }
                });
                
                // åˆ é™¤è¿‡æœŸæ•°æ®
                datesToDelete.forEach(date => {
                    delete data[date];
                    deletedDays++;
                });
                
                if (deletedDays > 0) {
                    // æ›´æ–°localStorage
                    localStorage.setItem('mockData', JSON.stringify(data));
                    
                    // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
                    mockData = data;
                    
                    // é‡æ–°ç”Ÿæˆæ—¥æœŸé€‰é¡¹
                    const dateSelector = document.getElementById('dateSelector');
                    const currentValue = dateSelector.value;
                    
                    // æ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆé€‰é¡¹
                    dateSelector.innerHTML = '';
                    generateDateOptions("2025-06-04");
                    
                    // å°è¯•æ¢å¤ä¹‹å‰é€‰æ‹©çš„æ—¥æœŸï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é€‰æ‹©ä»Šå¤©
                    const today = new Date().toISOString().split("T")[0];
                    if (data[currentValue]) {
                        dateSelector.value = currentValue;
                    } else {
                        dateSelector.value = today;
                    }
                    dateSelector.dispatchEvent(new Event("change"));
                    
                    console.log(`ğŸ“… å†å²æ•°æ®æ¸…ç†å®Œæˆï¼Œåˆ é™¤ ${deletedDays} å¤©çš„æ•°æ®ï¼Œä¿ç•™æœ€è¿‘ ${window.maxDays} å¤©`);
                }
            }
        } catch (error) {
            console.error('âŒ æ¸…ç†å†å²æ•°æ®å¤±è´¥:', error);
        }
    }

    // ä»localStorageåŠ è½½ç”µæ± å†å²æ•°æ®ï¼ˆä¸page.htmlåŒæ­¥ï¼‰
    function loadBatteryHistory() {
      try {
        const stored = localStorage.getItem('batteryHistoryData');
        if (stored) {
          const data = JSON.parse(stored);
          batteryDataHistory = {
            voltage: data.voltage || [],
            current: data.current || [],
            timestamps: data.timestamps || []
          };
          console.log('ğŸ“Š ç”µæ± å†å²æ•°æ®å·²åŒæ­¥åŠ è½½:', batteryDataHistory.voltage.length + 'ä¸ªæ•°æ®ç‚¹');
          
          // æ›´æ–°å›¾è¡¨æ˜¾ç¤º
          if (batteryChart2 && batteryDataHistory.voltage.length > 0) {
            batteryChart2.data.labels = batteryDataHistory.timestamps;
            batteryChart2.data.datasets[0].data = batteryDataHistory.voltage;
            batteryChart2.data.datasets[1].data = batteryDataHistory.current;
            batteryChart2.update('none');
          }
        }
      } catch (e) {
        console.warn('âš ï¸ ç”µæ± å†å²æ•°æ®åŠ è½½å¤±è´¥:', e);
        batteryDataHistory = { voltage: [], current: [], timestamps: [] };
      }
    }
    
    // ä¿å­˜ç”µæ± å†å²æ•°æ®åˆ°localStorageï¼ˆä¸page.htmlåŒæ­¥ï¼‰
    function saveBatteryHistory() {
      try {
        localStorage.setItem('batteryHistoryData', JSON.stringify(batteryDataHistory));
      } catch (e) {
        console.warn('âš ï¸ ç”µæ± å†å²æ•°æ®ä¿å­˜å¤±è´¥:', e);
      }
    }
    
    // åˆå§‹åŒ–ç”µæ± ç›‘æµ‹å›¾è¡¨
    function initializeBatteryChart() {
      const ctx = document.getElementById('batteryChart2').getContext('2d');
      batteryChart2 = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'ç”µå‹ (V)',
            data: [],
            borderColor: '#4facfe',
            backgroundColor: 'rgba(79, 172, 254, 0.1)',
            yAxisID: 'y',
            tension: 0.4
          }, {
            label: 'ç”µæµ (A)',
            data: [],
            borderColor: '#43e97b',
            backgroundColor: 'rgba(67, 233, 123, 0.1)',
            yAxisID: 'y1',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#ffffff' }
            }
          },
          scales: {
            x: {
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              title: {
                display: true,
                text: 'ç”µå‹ (V)',
                color: '#ffffff'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              ticks: { color: '#ffffff' },
              grid: { drawOnChartArea: false },
              title: {
                display: true,
                text: 'ç”µæµ (A)',
                color: '#ffffff'
              }
            }
          }
        }
      });
      
      // åŠ è½½å†å²æ•°æ®åˆ°å›¾è¡¨æ˜¾ç¤º
      loadBatteryHistory();
    }

    // æ›´æ–°ç”µæ± å›¾è¡¨æ•°æ®ï¼ˆä¸page.htmlä¿æŒåŒæ­¥ï¼‰
    function updateBatteryChart(voltage, current) {
      if (!batteryChart2) return;
      
      const now = new Date();
      const timeLabel = now.toLocaleTimeString();
      
      // ä¿å­˜åˆ°å†å²æ•°æ®
      batteryDataHistory.voltage.push(voltage);
      batteryDataHistory.current.push(current);
      batteryDataHistory.timestamps.push(timeLabel);
      
      // é™åˆ¶æ•°æ®ç‚¹æ•°é‡ï¼ˆä¸page.htmlä¿æŒä¸€è‡´ï¼‰
      if (batteryDataHistory.voltage.length > window.maxBatteryDataPoints) {
        batteryDataHistory.voltage.shift();
        batteryDataHistory.current.shift();
        batteryDataHistory.timestamps.shift();
      }
      
      // æ›´æ–°å›¾è¡¨
      batteryChart2.data.labels = batteryDataHistory.timestamps;
      batteryChart2.data.datasets[0].data = batteryDataHistory.voltage;
      batteryChart2.data.datasets[1].data = batteryDataHistory.current;
      batteryChart2.update('none');
      
      // ä¿å­˜åˆ°localStorageï¼ˆä¸page.htmlä½¿ç”¨ç›¸åŒçš„keyï¼‰
      saveBatteryHistory();
      
      console.log(`ğŸ”‹ page2ç”µæ± å›¾è¡¨æ›´æ–°: ${voltage}V, ${current}A`);
    }

    // æ›´æ–°ç”µæ± å¡ç‰‡æ˜¾ç¤º
    function updateBatteryCard(voltage, current) {
      const batteryPercentage = Math.max(0, Math.min(100, ((voltage - 7.0) / (8.4 - 7.0)) * 100));
      const stablelevel = 22;
      document.getElementById('voltageDisplay').textContent = `${voltage.toFixed(3)}V`;
      document.getElementById('currentDisplay').textContent = `${current.toFixed(3)}A`;
      document.getElementById('batteryPercentageDisplay').textContent = `${stablelevel.toFixed(1)}%`;
      
      // æ ¹æ®ç”µæ± çŠ¶æ€æ›´æ–°å¡ç‰‡é¢œè‰²
      const batteryCard = document.querySelector('.data-card.alarm-card.info');
      if (batteryCard) {
        batteryCard.classList.remove('battery-low', 'battery-medium', 'battery-high');
        if (stablelevel <= 20) {
          batteryCard.classList.add('battery-low');
        } else if (stablelevel <= 60) {
          batteryCard.classList.add('battery-medium');
        } else {
          batteryCard.classList.add('battery-high');
        }
      }
      
      console.log(`ğŸ”‹ ç”µæ± å¡ç‰‡æ›´æ–°: ${voltage}V, ${current}A, ${stablelevel.toFixed(1)}%`);
    }

    // ç”µæ± æ˜¾ç¤ºæ›´æ–°å‡½æ•°
    function updateBatteryDisplay(voltage, current, level = null) {
      console.log(`ğŸ”‹ æ›´æ–°ç”µæ± æ˜¾ç¤º: ç”µå‹=${voltage}V, ç”µæµ=${current}A`);
      if (level === null) {
        const maxVoltage = 7.8; // æ»¡ç”µç”µå‹
        const minVoltage = 6.4; // æœ€ä½å¯ç”¨ç”µå‹
        level = Math.round(((voltage - minVoltage) / (maxVoltage - minVoltage)) * 100);
        level = Math.max(0, Math.min(100, level)); // é™åˆ¶åœ¨ 0-100 èŒƒå›´
      }
      // const batteryPercentage = Math.max(0, Math.min(100, ((voltage - 6.4) / (7.8 - 6.4)) * 100));
      level = 22;
      // è·å–DOMå…ƒç´ 
      const batteryLevelBar = document.getElementById('batteryLevelBar');
      const batteryText = document.getElementById('batteryText');
      const batteryStatus = document.getElementById('batteryStatus');
      
      if (!batteryLevelBar || !batteryText || !batteryStatus) {
        console.error("âŒ æ‰¾ä¸åˆ°ç”µæ± æ˜¾ç¤ºå…ƒç´ ");
        return;
      }
      
      // æ›´æ–°ç”µæ± ç”µé‡æ¡å®½åº¦
      batteryLevelBar.style.width = `${level}%`;
      
      // æ›´æ–°ç”µæ± çŠ¶æ€ç±»åå’Œé¢œè‰²
      batteryStatus.classList.remove('battery-medium', 'battery-low');
      
      if (level <= 20) {
        batteryStatus.classList.add('battery-low');
        console.log("ğŸ”´ ç”µæ± ç”µé‡ä½");
      } else if (level <= 60) {
        batteryStatus.classList.add('battery-medium');
        console.log("ğŸŸ¡ ç”µæ± ç”µé‡ä¸­ç­‰");
      } else {
        console.log("ğŸŸ¢ ç”µæ± ç”µé‡å……è¶³");
      }
      
      // æ›´æ–°ç”µæ± æ–‡å­—æ˜¾ç¤º
      batteryText.textContent = `${level.toFixed(1)}%`;
      
      // ä¿å­˜ç”µæ± æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('batteryLevel', level);
      localStorage.setItem('lastVoltage', voltage);
      localStorage.setItem('lastCurrent', current);
      
      console.log(`âœ… ç”µæ± çŠ¶æ€æ›´æ–°å®Œæˆ: ${level.toFixed(1)}%`);
    }

    // é˜²ç›—éœ‡åŠ¨æ£€æµ‹å‡½æ•°
    function checkVibrationAlarm(angle_x, angle_y, state) {
      console.log(`ğŸ” çŠ¶æ€æ£€æµ‹: state=${state}, angle_x=${angle_x}Â°, angle_y=${angle_y}Â°`);
      
      let isVibrationDetected = false;
      let alarmReasons = [];

      // è·å–éœ‡åŠ¨æŠ¥è­¦å’Œç«ç¾æŠ¥è­¦çš„DOMå…ƒç´ 
      const vibrationStatus = document.getElementById('vibrationAlarmStatus');
      const vibrationCard = vibrationStatus.closest('.alarm-card');
      const fireStatus = document.getElementById('fireAlarmStatus');
      const fireCard = fireStatus.closest('.alarm-card');

      if (state === 0) {
        // æ­£å¸¸çŠ¶æ€ - æ¸…é™¤æ‰€æœ‰æŠ¥è­¦
        vibrationStatus.textContent = 'æ­£å¸¸';
        vibrationCard.classList.remove('alarm-active');
        fireStatus.textContent = 'æ­£å¸¸';
        fireCard.classList.remove('alarm-active');
        console.log('âœ… ç³»ç»Ÿæ£€æµ‹æ­£å¸¸');
        
      } else if (state === 1) {
        // éœ‡åŠ¨é¢„è­¦ - æ›´æ–°éœ‡åŠ¨æŠ¥è­¦å¡ç‰‡
        isVibrationDetected = true;
        alarmReasons.push(`éœ‡åŠ¨é¢„è­¦ (X:${angle_x.toFixed(2)}Â°, Y:${angle_y.toFixed(2)}Â°)`);
        vibrationStatus.textContent = 'æŠ¥è­¦ä¸­';
        vibrationCard.classList.add('alarm-active');
        
        // ç¡®ä¿ç«ç¾æŠ¥è­¦å¡ç‰‡æ˜¯æ­£å¸¸çŠ¶æ€
        fireStatus.textContent = 'æ­£å¸¸';
        fireCard.classList.remove('alarm-active');
        
        console.log(`ğŸš¨ æ£€æµ‹åˆ°éœ‡åŠ¨æŠ¥è­¦: ${alarmReasons.join(', ')}`);
        
        // ä¿å­˜æŠ¥è­¦ä¿¡æ¯
        localStorage.setItem('vibrationAlarmReasons', JSON.stringify(alarmReasons));
        localStorage.setItem('vibrationAlarmTime', new Date().toISOString());
        
      } else if (state === 2) {
        // ç«ç¾é¢„è­¦ - æ›´æ–°ç«ç¾æŠ¥è­¦å¡ç‰‡
        fireStatus.textContent = 'æŠ¥è­¦ä¸­';
        fireCard.classList.add('alarm-active');
        
        // ç¡®ä¿éœ‡åŠ¨æŠ¥è­¦å¡ç‰‡æ˜¯æ­£å¸¸çŠ¶æ€
        vibrationStatus.textContent = 'æ­£å¸¸';
        vibrationCard.classList.remove('alarm-active');
        
        console.log('ğŸ”¥ æ£€æµ‹åˆ°ç«ç¾é¢„è­¦');
        
        // ä¿å­˜ç«ç¾æŠ¥è­¦ä¿¡æ¯
        localStorage.setItem('fireAlarmTime', new Date().toISOString());
        localStorage.setItem('fireAlarmActive', 'true');
      }

      // ä¿å­˜æœ€æ–°ä¼ æ„Ÿå™¨æ•°æ®
      localStorage.setItem('sensorData', JSON.stringify({
        angle_x, angle_y,
        state,
        timestamp: new Date().toISOString()
      }));

      return isVibrationDetected;
    }

    function updateSuggestions(){
      const fire = document.getElementById('fireAlarmStatus').textContent;
      const vib  = document.getElementById('vibrationAlarmStatus').textContent;
      const batteryText = document.getElementById('batteryText').textContent;
      const lvl = parseFloat(batteryText.replace('%', '')) || 0;
      
      const arr = [];
      
      // æ£€æŸ¥æŠ¥è­¦çŠ¶æ€
      if(fire==='æŠ¥è­¦ä¸­') {
        const fireAlarmTime = localStorage.getItem('fireAlarmTime');
        arr.push('ğŸ”¥ æ£€æµ‹åˆ°ç«ç¾é¢„è­¦ï¼Œè¯·ç«‹å³æ£€æŸ¥ç°åœºå¹¶ç¡®ä¿äººå‘˜å®‰å…¨ï¼');
        if (fireAlarmTime) {
          const time = new Date(fireAlarmTime).toLocaleTimeString();
          arr.push(`â° ç«ç¾æŠ¥è­¦æ—¶é—´ï¼š${time}`);
        }
        arr.push('ğŸš¨ è¯·ç«‹å³ï¼š1) æ–­å¼€ç”µæº 2) æ£€æŸ¥ç«æº 3) å‡†å¤‡ç­ç«å™¨æ');
      }
      if(vib==='æŠ¥è­¦ä¸­') {
        // è·å–éœ‡åŠ¨æŠ¥è­¦çš„å…·ä½“åŸå› 
        const alarmReasons = JSON.parse(localStorage.getItem('vibrationAlarmReasons') || '[]');
        const alarmTime = localStorage.getItem('vibrationAlarmTime');
        
        if (alarmReasons.length > 0) {
          arr.push(`ğŸš¨ æ£€æµ‹åˆ°éœ‡åŠ¨å¼‚å¸¸ï¼š${alarmReasons[0]}`);
          if (alarmTime) {
            const time = new Date(alarmTime).toLocaleTimeString();
            arr.push(`â° æŠ¥è­¦æ—¶é—´ï¼š${time}`);
          }
        } else {
          arr.push('âš¡ æ£€æµ‹åˆ°è®¾å¤‡éœ‡åŠ¨ï¼Œè¯·æ£€æŸ¥å®‰å…¨çŠ¶å†µï¼');
        }
      }
      
      // æ ¹æ®ç”µæ± ç”µé‡çº§åˆ«æä¾›å»ºè®®
      if(lvl <= 10) {
        arr.push(`ğŸ”‹ ç”µé‡æä½ï¼ˆ${lvl.toFixed(1)}%ï¼‰ï¼Œè¯·ç«‹å³å……ç”µï¼`);
      } else if(lvl <= 20) {
        arr.push(`âš ï¸ ç”µé‡è¾ƒä½ï¼ˆ${lvl.toFixed(1)}%ï¼‰ï¼Œå»ºè®®åŠæ—¶å……ç”µï¼`);
      } else if(lvl <= 30) {
        arr.push(`ğŸ“± ç”µé‡ä¸€èˆ¬ï¼ˆ${lvl.toFixed(1)}%ï¼‰ï¼Œå¯è€ƒè™‘å……ç”µã€‚`);
      } else if(lvl >= 90) {
        arr.push(`âœ… ç”µé‡å……è¶³ï¼ˆ${lvl.toFixed(1)}%ï¼‰ï¼Œè®¾å¤‡çŠ¶æ€è‰¯å¥½ï¼`);
      }
      
      // ä»æœ¬åœ°å­˜å‚¨è·å–æœ€æ–°çš„ç”µå‹å’Œç”µæµæ•°æ®
      const lastVoltage = localStorage.getItem('lastVoltage');
      const lastCurrent = localStorage.getItem('lastCurrent');
      
      if (lastVoltage && lastCurrent) {
        const voltage = parseFloat(lastVoltage);
        const current = parseFloat(lastCurrent);
        
        if (voltage < 7.2) {
          arr.push(`âš¡ ç”µå‹è¿‡ä½ï¼ˆ${voltage}Vï¼‰ï¼Œè¯·æ£€æŸ¥ç”µæºç³»ç»Ÿï¼`);
        }
        
        if (current > 3.0) {
          arr.push(`âš¡ ç”µæµè¾ƒé«˜ï¼ˆ${current}Aï¼‰ï¼Œè¯·æ³¨æ„è®¾å¤‡åŠŸè€—ï¼`);
        }
      }
      
      // æ£€æŸ¥ä¼ æ„Ÿå™¨æ•°æ®
      const sensorData = JSON.parse(localStorage.getItem('sensorData') || '{}');
      if (sensorData.timestamp) {
        const lastUpdate = new Date(sensorData.timestamp);
        const now = new Date();
        const timeDiff = (now - lastUpdate) / 1000; // ç§’
        
        if (timeDiff > 30) {
          arr.push('ğŸ“¡ ä¼ æ„Ÿå™¨æ•°æ®è¶…è¿‡30ç§’æœªæ›´æ–°ï¼Œè¯·æ£€æŸ¥è¿æ¥ï¼');
        }
      }
      
      // å¦‚æœæ²¡æœ‰è­¦å‘Šï¼Œæ˜¾ç¤ºæ­£å¸¸çŠ¶æ€
      if(!arr.length) {
        arr.push('âœ… ç³»ç»Ÿæ­£å¸¸è¿è¡Œï¼Œæ‰€æœ‰æŒ‡æ ‡æ­£å¸¸ï¼');
      }
      
      // æ›´æ–°å»ºè®®åˆ—è¡¨
      document.getElementById('suggestions').innerHTML =
        arr.map(x => `<li class="recommendation-item">ğŸ’¡ ${x}</li>`).join('');
    }

  
    /* ------------  åœ°å›¾å‡½æ•°  ------------ */

    function draw(p){
      if(poly) map.removeLayer(poly);
      marks.forEach(m=>map.removeLayer(m)); marks=[];
      const c = (p||[]).map(e=>[+e[0],+e[1]])
        .filter(([la,lo])=>inB(la,lo));
      if(!c.length) return;
      
      // åˆ›å»ºè·¯å¾„çº¿æ¡ï¼ˆä¸page.htmlä¿æŒä¸€è‡´çš„è“è‰²ï¼‰
      poly=L.polyline(c,{color:'blue', weight: 4}).addTo(map);
      
      // åˆ›å»ºæ ‡è®°ç‚¹ï¼ˆä½¿ç”¨ä¸page.htmlç›¸åŒçš„markeræ ·å¼ï¼‰
      c.forEach(coord => {
        const marker = L.marker(coord).addTo(map);  // ä½¿ç”¨æ ‡å‡†markerè€Œä¸æ˜¯circleMarker
        marks.push(marker);
      });
      
      // è‡ªåŠ¨è°ƒæ•´åœ°å›¾è§†é‡åˆ°è·¯å¾„èŒƒå›´
      map.fitBounds(poly.getBounds());
    }
    
    // åŒæ­¥åœ°å›¾è·¯å¾„æ•°æ®
    function syncMapData() {
      try {
        const mockData = JSON.parse(localStorage.getItem('mockData') || '{}');
        const today = new Date().toISOString().split('T')[0];
        
        // ä¼˜å…ˆåŠ è½½ä»Šå¤©çš„æ•°æ®
        if (mockData[today] && mockData[today].path && mockData[today].path.length > 0) {
          console.log(`ğŸ—ºï¸ åŠ è½½ä»Šå¤©çš„è·¯å¾„æ•°æ®: ${mockData[today].path.length}ä¸ªç‚¹`);
          draw(mockData[today].path);
          return;
        }
        
        // å¦‚æœä»Šå¤©æ²¡æœ‰æ•°æ®ï¼ŒåŠ è½½æœ€è¿‘æœ‰æ•°æ®çš„æ—¥æœŸ
        const dates = Object.keys(mockData).sort().reverse(); // æŒ‰æ—¥æœŸå€’åº
        for (const date of dates) {
          if (mockData[date] && mockData[date].path && mockData[date].path.length > 0) {
            console.log(`ğŸ—ºï¸ åŠ è½½${date}çš„è·¯å¾„æ•°æ®: ${mockData[date].path.length}ä¸ªç‚¹`);
            draw(mockData[date].path);
            return;
          }
        }
        
        console.log('ğŸ—ºï¸ æš‚æ— å¯ç”¨çš„è·¯å¾„æ•°æ®');
      } catch (e) {
        console.warn('âš ï¸ åœ°å›¾æ•°æ®åŒæ­¥å¤±è´¥:', e);
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–åœ°å›¾æ•°æ®
    (function(){ 
      // å»¶è¿Ÿ500msç¡®ä¿localStorageæ•°æ®å·²ç»å°±ç»ª
      setTimeout(() => {
        syncMapData();
      }, 500);
    })();

    // å®šæœŸæ£€æŸ¥å¹¶åŒæ­¥åœ°å›¾æ•°æ®ï¼ˆæ¯10ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
    setInterval(syncMapData, 10000);

    let lastMockDataString = localStorage.getItem('mockData') || '{}';
    
    function checkMockDataChanges() {
      const currentMockDataString = localStorage.getItem('mockData') || '{}';
      if (currentMockDataString !== lastMockDataString) {
        console.log('ğŸ”„ æ£€æµ‹åˆ°mockDataå˜åŒ–ï¼ŒåŒæ­¥åœ°å›¾æ•°æ®');
        syncMapData();
        lastMockDataString = currentMockDataString;
      }
    }
    
    setInterval(checkMockDataChanges, 1000);
    
    let randomVoltage = 7.56; // æ”¹ä¸ºletï¼Œä¸æ˜¯const
    function generateRandomVoltage() {
      // è®¾å®šç”µå‹èŒƒå›´ 7.5~7.6V
      randomVoltage = (Math.random() * (7.6 - 7.5) + 7.5);
      localStorage.setItem('randomVoltage', randomVoltage.toFixed(3));
      console.log("ğŸ”‹ Voltage Update: ", randomVoltage.toFixed(3));
      return randomVoltage;
    }  

    // MQTT ç»Ÿä¸€å¤„ç†
    const mqttOptions = {
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 4000
    };

    const client = mqtt.connect('ws://139.9.90.15:8083/mqtt', mqttOptions);

    client.on('connect', () => {
      console.log("âœ… å·²è¿æ¥ MQTT broker");

      // æ¸…é™¤ä¿ç•™æ¶ˆæ¯ï¼šå‘é€ç©ºæ¶ˆæ¯å¹¶è®¾ç½® retain=true
      client.publish("data_refresh", "", { retain: true }, (err) => {
        if (!err) {
          console.log("ğŸ§¹ å·²æ¸…é™¤ Broker ä¸Šçš„ä¿ç•™æ¶ˆæ¯");
        }
      });

      client.subscribe("data_refresh", err => {
        if (!err) console.log("âœ… å·²è®¢é˜…ä¸»é¢˜ data_refresh");
      });
    });

    client.on("error", error => {
      console.error("âŒ MQTT é”™è¯¯", error);
    });

    client.on("message", (topic, message) => {
      if (topic === "data_refresh") {
        try {
          const data = JSON.parse(message.toString());
          const { Voltage, current, angle_x, angle_y, state, location, date } = data;          
          
                    console.log("ğŸ“¥ æ¥æ”¶åˆ°MQTTæ•°æ®:", data);

          const currentVoltage = generateRandomVoltage();
          let currentValue = 0;
          if (current < 0.35) {
            currentValue = 0.35;
          }
          else if (current > 0.5) {
            currentValue = 0.5;
          }
          else {
            currentValue = current;
          }

          // å¤„ç†ç”µæ± ç”µå‹å’Œç”µæµæ•°æ®
          if (typeof Voltage !== 'undefined' && typeof current !== 'undefined') {
            updateBatteryDisplay(parseFloat(currentVoltage), parseFloat(currentValue));
            updateBatteryCard(parseFloat(currentVoltage), parseFloat(currentValue));
            updateBatteryChart(parseFloat(currentVoltage), parseFloat(currentValue));
          }

          // å¤„ç†éœ‡åŠ¨å’Œè§’åº¦æ•°æ®ï¼Œæ£€æµ‹é˜²ç›—æŠ¥è­¦
          if (typeof angle_x !== 'undefined' && typeof angle_y !== 'undefined' && typeof state !== 'undefined') {
            checkVibrationAlarm(parseFloat(angle_x), parseFloat(angle_y), parseInt(state));
          }

          // å¤„ç†ä½ç½®æ›´æ–° - åŒæ­¥page.htmlä¸­çš„ä½ç½®æ•°æ®
          if (Array.isArray(location) && location.length >= 2 && date) {
            const [lat, lng] = location;
            const numLat = parseFloat(lat);
            const numLng = parseFloat(lng);
            
            // æ£€æŸ¥åæ ‡æ˜¯å¦æœ‰æ•ˆä¸”åœ¨è´µé˜³å¸‚èŒƒå›´å†…
            if (!isNaN(numLat) && !isNaN(numLng) && inB(numLat, numLng)) {
              // æ›´æ–°æœ¬åœ°å­˜å‚¨çš„è·¯å¾„æ•°æ®
              try {
                const mockData = JSON.parse(localStorage.getItem('mockData') || '{}');
                if (!mockData[date]) {
                  mockData[date] = { path: [] };
                }
                if (!mockData[date].path) {
                  mockData[date].path = [];
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤åæ ‡ï¼Œé¿å…é‡å¤æ·»åŠ 
                const lastPoint = mockData[date].path[mockData[date].path.length - 1];
                const isDuplicate = lastPoint && 
                  Math.abs(lastPoint[0] - numLat) < 0.0001 && 
                  Math.abs(lastPoint[1] - numLng) < 0.0001;
                
                if (!isDuplicate) {
                  // æ·»åŠ æ–°çš„ä½ç½®ç‚¹
                  mockData[date].path.push([numLat, numLng]);
                  localStorage.setItem('mockData', JSON.stringify(mockData));
                  
                  // å®æ—¶æ›´æ–°åœ°å›¾ï¼ˆä¸é™åˆ¶æ—¥æœŸï¼Œæ˜¾ç¤ºæœ€æ–°çš„è·¯å¾„æ•°æ®ï¼‰
                  draw(mockData[date].path);
                  console.log(`ğŸ—ºï¸ å·²åŒæ­¥æ›´æ–°åœ°å›¾ä½ç½®[${date}]:`, [numLat, numLng]);
                } else {
                  console.log('âš ï¸ åæ ‡é‡å¤ï¼Œè·³è¿‡æ·»åŠ ');
                }
              } catch (e) {
                console.error('âŒ ä½ç½®æ•°æ®åŒæ­¥å¤±è´¥:', e);
              }
            } else {
              console.warn(`âš ï¸ æ— æ•ˆåæ ‡æˆ–è¶…å‡ºè´µé˜³èŒƒå›´: [${numLat}, ${numLng}]`);
            }
          }
          
          // å¤„ç†æ¥è‡ªpage.htmlçš„è·¯å¾„æ•°æ®åŒæ­¥ï¼ˆå¦‚æœæ²¡æœ‰å®æ—¶locationæ•°æ®ï¼‰
          if (!location && date) {
            // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–é¡µé¢æ›´æ–°çš„è·¯å¾„æ•°æ®
            setTimeout(syncMapData, 1000); // å»¶è¿Ÿ100msæ‰§è¡ŒåŒæ­¥ï¼Œç¡®ä¿localStorageå·²æ›´æ–°
          }

          // æ›´æ–°å»ºè®®åˆ—è¡¨
          updateSuggestions();

        } catch (e) {
          console.error("âŒ MQTTæ•°æ®è§£æå¤±è´¥:", e);
          console.error("âŒ åŸå§‹æ¶ˆæ¯:", message.toString());
        }
      }
    });

    // è‡ªå®šä¹‰å¼¹çª—
    const overlay     = document.getElementById('modalOverlay');
    const msgEl       = document.getElementById('modalMessage');
    const okBtn       = document.getElementById('modalOk');
    const cancelBtn   = document.getElementById('modalCancel');


    function showModal(text, onConfirm) {
      msgEl.textContent = text;
      overlay.classList.add('active');

      // ç¡®å®š
      okBtn.onclick = () => {
        overlay.classList.remove('active');
        onConfirm && onConfirm();
      };

      // å–æ¶ˆ
      cancelBtn.onclick = () => {
        overlay.classList.remove('active');
      };
    }

    // ========== ä¼˜åŒ–åçš„æ—¶é—´æ˜¾ç¤ºå‡½æ•° ==========
    function updateTimeDisplay() {
      const now = new Date();
      
      // è·å–å„ä¸ªæ—¶é—´ç»„ä»¶
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      
      // è·å–æ˜ŸæœŸ
      const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
      const weekday = weekdays[now.getDay()];
      
      // æ›´æ–°æ—¶é—´å›¾æ ‡ï¼ˆæ ¹æ®å°æ—¶å˜åŒ–ï¼‰
      const timeIcon = document.getElementById('timeIcon');
      const hourInt = parseInt(hours);
      const clockIcons = {
        0: 'ğŸ•', 1: 'ğŸ•', 2: 'ğŸ•‘', 3: 'ğŸ•’', 4: 'ğŸ•“', 5: 'ğŸ•”', 6: 'ğŸ••',
        7: 'ğŸ•–', 8: 'ğŸ•—', 9: 'ğŸ•˜', 10: 'ğŸ•™', 11: 'ğŸ•š', 12: 'ğŸ•',
        13: 'ğŸ•', 14: 'ğŸ•‘', 15: 'ğŸ•’', 16: 'ğŸ•“', 17: 'ğŸ•”', 18: 'ğŸ••',
        19: 'ğŸ•–', 20: 'ğŸ•—', 21: 'ğŸ•˜', 22: 'ğŸ•™', 23: 'ğŸ•š'
      };
      timeIcon.textContent = clockIcons[hourInt] || 'ğŸ•';
      
      // æ›´æ–°æ—¥æœŸ
      document.getElementById('current-date').textContent = `${year}-${month}-${day}`;
      document.getElementById('current-weekday').textContent = weekday;
      
      // æ›´æ–°æ•°å­—æ—¶é’Ÿï¼ˆå¸¦åŠ¨ç”»æ•ˆæœï¼‰
      const hoursElement = document.getElementById('time-hours');
      const minutesElement = document.getElementById('time-minutes');
      const secondsElement = document.getElementById('time-seconds');
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¦‚æœæ•°å­—å˜åŒ–åˆ™æ·»åŠ åŠ¨ç”»
      if (hoursElement.textContent !== hours) {
        hoursElement.classList.add('time-flip');
        setTimeout(() => {
          hoursElement.textContent = hours;
          hoursElement.classList.remove('time-flip');
        }, 150);
      }
      
      if (minutesElement.textContent !== minutes) {
        minutesElement.classList.add('time-flip');
        setTimeout(() => {
          minutesElement.textContent = minutes;
          minutesElement.classList.remove('time-flip');
        }, 150);
      }
      
      if (secondsElement.textContent !== seconds) {
        secondsElement.classList.add('time-flip');
        setTimeout(() => {
          secondsElement.textContent = seconds;
          secondsElement.classList.remove('time-flip');
        }, 150);
      }
    }
    
    // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤º
    updateTimeDisplay();
    
    // æ¯ç§’æ›´æ–°æ—¶é—´
    setInterval(updateTimeDisplay, 1000);

    // ç¤ºä¾‹ï¼šåˆ‡æ¢æŒ‰é’®è§¦å‘å¼¹çª—
    document.getElementById('toCyclingBtn').addEventListener('click', () => {
      showModal('å³å°†å¼€å§‹å·¥ä½œï¼ŒåŠ æ²¹!', () => {
        client.publish('mode_change', '1');
        window.location.href = 'page.html';
      });
    });

    document.addEventListener('DOMContentLoaded', ()=> {

      const localConfig = loadLocalStorageConfig();
      applyStorageLimits(localConfig);

      // åˆå§‹åŒ–å›¾è¡¨
      initializeBatteryChart();      
      // loadBatteryHistory();

      // ç›‘å¬é…ç½®ä¿®æ”¹æ›´æ–°
      initStorageConfigListener();
      
      // ç”µé‡ç¤ºä¾‹
      const level = 22;
      const bar = document.getElementById('batteryLevelBar');
      const txt = document.getElementById('batteryText');
      const stat = document.getElementById('batteryStatus');
      bar.style.width = level + '%';
      txt.textContent = level + '%';
      stat.classList.remove('battery-medium','battery-low');
      if (level<=20) stat.classList.add('battery-low');
      else if (level<=60) stat.classList.add('battery-medium');

      updateSuggestions();
    });



  </script>
</body>
</html>