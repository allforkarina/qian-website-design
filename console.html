<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊéßÂà∂Âè∞ - Dashboard</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.6;
        }

        /* ÂØºËà™Ê†èÊ†∑Âºè */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }

        .navbar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            height: 100%;
        }

        .navbar-brand {
            font-size: 24px;
            font-weight: bold;
            text-decoration: none;
            color: white;
            display: flex;
            align-items: center;
        }

        .navbar-brand::before {
            margin-right: 10px;
            font-size: 28px;
        }

        .navbar-nav {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Áî®Êà∑‰ø°ÊÅØÂå∫Âüü */
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .user-info:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .user-info:hover .user-avatar {
            transform: scale(1.1);
        }

        .user-name {
            font-weight: 500;
        }

        /* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */
        .main-container {
            margin-top: 60px;
            min-height: calc(100vh - 60px);
            background-color: #f8f9fa;
        }

        /* ‰æßËæπÊ†è */
        .sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            width: 250px;
            height: calc(100vh - 60px);
            background-color: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg, rgba(255, 113, 101, 0.9) 0%, rgba(255, 164, 78, 0.9) 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: subtle-glow 3s ease-in-out infinite alternate;
            pointer-events: none;
        }

        .sidebar-subtitle {
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .sidebar-title {
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .sidebar-subtitle {
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: block;
            padding: 12px 20px;
            color: #495057;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .menu-item:hover {
            background-color: #f8f9fa;
            border-left-color: #667eea;
            color: #667eea;
        }

        .menu-item.active {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
            color: #1976d2;
            font-weight: 500;
        }

        .menu-item::before {
            content: "";
            margin-right: 10px;
        }

        /* .menu-item[data-icon="dashboard"]::before { content: "üìä"; }
        .menu-item[data-icon="analytics"]::before { content: "üìà"; }
        .menu-item[data-icon="users"]::before { content: "üë•"; }
        .menu-item[data-icon="monitoring"]::before { content: "üñ•Ô∏è"; } */

        /* ‰∏ªÂÜÖÂÆπÂå∫Âüü */
        .content {
            margin-left: 250px;
            padding: 30px;
            min-height: calc(100vh - 60px);
        }

        .content-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 300;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: #6c757d;
            font-size: 16px;
        }

        /* Âç°ÁâáÊ†∑Âºè */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3ÂàóÁ≠âÂÆΩÂ∏ÉÂ±Ä */
            gap: 25px; /* Âç°ÁâáÈó¥Ë∑ù */
            margin-bottom: 30px;
            max-width: 1200px; /* ÈôêÂà∂ÊúÄÂ§ßÂÆΩÂ∫¶ */
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 1024px) {
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr); /* ‰∏≠Á≠âÂ±èÂπï2Âàó */
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr; /* Â∞èÂ±èÂπïÂçïÂàó */
                gap: 15px;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .card-content {
            color: #6c757d;
        }

        /* ÁõëÊéßÈ°µÈù¢ÁâπÊÆäÊ†∑Âºè */
        .user-selector-container {
            max-width: 600px;
        }
        
        .user-info-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #667eea;
        }
        
        .user-info-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .user-info-card p {
            margin: 5px 0;
            color: #6c757d;
        }
        
        .battery-stats-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .stat-label {
            display: block;
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .stat-value {
            display: block;
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .tracking-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
        }
        
        /* Áä∂ÊÄÅÂæΩÁ´†Ê†∑Âºè */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-badge.inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 768px) {
            .battery-stats-summary,
            .tracking-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Êï∞ÊçÆÂàÜÊûêÊ†∑Âºè */
        .battery-analysis-summary,
        .path-analysis-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .analysis-stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .analysis-stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .analysis-stat-item .stat-label {
            display: block;
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .analysis-stat-item .stat-value {
            display: block;
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-trend {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .trend-up { background-color: #d4edda; color: #155724; }
        .trend-down { background-color: #f8d7da; color: #721c24; }
        .trend-stable { background-color: #fff3cd; color: #856404; }

        /* Âª∫ËÆÆÂç°ÁâáÊ†∑Âºè */
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 15px;
        }

        .recommendation-card {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .recommendation-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
        }

        .recommendation-icon {
            font-size: 24px;
            margin-right: 15px;
            margin-top: 3px;
        }

        .recommendation-content h5 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .recommendation-content p {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Âú∞ÂõæÊéßÂà∂Ê†∑Âºè */
        .map-controls {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-top: 1px solid #e9ecef;
        }

        .map-controls label {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #495057;
            cursor: pointer;
        }

        .map-controls input[type="checkbox"] {
            margin-right: 8px;
        }

        /* Ê®°ÂºèÂàÜÊûêÊ†∑Âºè */
        .patterns-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .pattern-card {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .pattern-card h5 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .pattern-card div {
            color: #6c757d;
            font-size: 14px;
            line-height: 1.6;
        }

        /* ËØÑ‰º∞Êä•ÂëäÊ†∑Âºè */
        .evaluation-report {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .report-section h4 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 18px;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .score-value {
            font-size: 32px;
            line-height: 1;
        }

        .score-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .score-breakdown {
            flex: 1;
        }

        .score-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .score-name {
            min-width: 80px;
            font-size: 14px;
            color: #495057;
        }

        .score-bar {
            flex: 1;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.8s ease;
        }

        .score-number {
            min-width: 30px;
            text-align: right;
            font-weight: 600;
            color: #2c3e50;
        }

        .evaluation-text {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.6;
            color: #495057;
            border-left: 4px solid #667eea;
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 1200px) {
            .battery-analysis-summary,
            .path-analysis-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .evaluation-report {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .battery-analysis-summary,
            .path-analysis-summary,
            .recommendations-grid,
            .patterns-grid {
                grid-template-columns: 1fr;
            }
            
            .score-display {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Áî®Êà∑ÁÆ°ÁêÜÊ†∑Âºè */
        .role-badge {
            display: inline-block;
        }
        .role-admin { background-color: #f8d7da; color: #c82333;}
        .role-user { background-color: #8699a3bf; color: #ddfff9;}

        .status-btn {
            transition: all 0.3s ease;
        }
        .status-active { background-color: #3b9c95; color: #fff;}
        .status-inactive { background-color: #b0bec5; color: #fff;}
        .status-btn:hover { opacity: 0.85; }

        .btn-sm {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-danger {
            background-color: #f8d7da;
            color: #c82333;
            margin-right: 5px;
        }
        .btn-info {
            background-color: #e2f0fb;
            color: #117a8b;
        }
        .btn-sm:hover { opacity: 0.85; }

        .user-list-item:hover {
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
            transform: translateY(-2px) scale(1.01);
            transition: all 0.3s ease;
        }

        /* ÁÆ°ÁêÜÂëòÈ°µÈù¢Ê†∑Âºè */
        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-form {
            max-width: 600px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #fff;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            margin-right: 10px;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 10px 0;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
        }

        .device-counter {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .counter-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 6px;
            background-color: #667eea;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .counter-btn:hover {
            background-color: #5a67d8;
            transform: scale(1.1);
        }

        .counter-display {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            min-width: 60px;
            text-align: center;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .content {
                margin-left: 0;
                padding: 20px;
            }

            .navbar-nav {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
                background: none;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
            }
        }

        .mobile-menu-btn {
            display: none;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Áä∂ÊÄÅÊåáÁ§∫Âô® */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }

        /* ÈöêËóèÁ±ª */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="#" class="navbar-brand">ÊéßÂà∂Âè∞</a>
            
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard">Ê¶ÇËßà</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="monitoring">ÁõëÊéß</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="analytics">ÂàÜÊûê</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="users">Áî®Êà∑</a>
                </li>
            </ul>

            <div class="user-info" onclick="showAdminPanel()">
                <span class="user-name" id="displayUserName">ÁÆ°ÁêÜÂëò</span>
                <div class="user-avatar" id="displayUserAvatar">A</div>
            </div>

            <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        </div>
    </nav>

    <div class="main-container">
        <!-- ‰æßËæπÊ†è -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">ÊéßÂà∂Èù¢Êùø</div>
                <div class="sidebar-subtitle">Á≥ªÁªüÁÆ°ÁêÜ‰∏≠ÂøÉ</div>
            </div>
            
            <nav class="sidebar-menu">
                <a href="#" class="menu-item active" data-icon="dashboard" data-page="dashboard">‰ª™Ë°®Êùø</a>
                <a href="#" class="menu-item" data-icon="monitoring" data-page="monitoring">Á≥ªÁªüÁõëÊéß</a>
                <a href="#" class="menu-item" data-icon="analytics" data-page="analytics">Êï∞ÊçÆÂàÜÊûê</a>
                <a href="#" class="menu-item" data-icon="users" data-page="users">Áî®Êà∑ÁÆ°ÁêÜ</a>
            </nav>
        </aside>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
        <main class="content">
            <!-- ‰ª™Ë°®ÊùøÈ°µÈù¢ -->
            <div id="dashboard-page" class="page-content">
                <div class="content-header">
                    <h1 class="page-title">Ê¨¢ËøéÊù•Âà∞ÊéßÂà∂Âè∞</h1>
                    <p class="page-subtitle">ËøôÈáåÊòØÊÇ®ÁöÑÁ≥ªÁªüÁÆ°ÁêÜ‰∏≠ÂøÉÔºåÂèØ‰ª•ÁõëÊéßÂíåÁÆ°ÁêÜÊâÄÊúâÂäüËÉΩÊ®°Âùó</p>
                </div>

                <!-- ‰ª™Ë°®ÊùøÂç°Áâá -->
                <div class="dashboard-cards">

                    <div class="card">
                        <div class="card-header">
                            <!-- <span class="card-icon">üìà</span> -->
                            <h3 class="card-title">ËÆæÂ§áÁõëÊéß</h3>
                        </div>
                        <div class="card-content">
                            <p>ÂÆûÊó∂ÁõëÊéßÊé•ÂÖ•ËÆæÂ§áÁöÑÊÄßËÉΩÂíå‰ΩøÁî®ÊÉÖÂÜµ</p>
                            <div style="margin-top: 15px;">
                                <span class="status-indicator status-online"></span>
                                <small>ËÆæÂ§áÊ≠£Â∏∏Êé•ÂÖ•‰ΩøÁî®</small>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <!-- <span class="card-icon">üîß</span> -->
                            <h3 class="card-title">Êï∞ÊçÆÂàÜÊûê</h3>
                        </div>
                        <div class="card-content">
                            <p>ÂàÜÊûêÊé•ÂÖ•ËÆæÂ§áÁöÑ‰ΩøÁî®ÊÉÖÂÜµÂíåÊÄßËÉΩÊï∞ÊçÆ</p>
                            <div style="margin-top: 15px;">
                                <span class="status-indicator status-online"></span>
                                <small>ËÆæÂ§áÊï∞ÊçÆÂèØÁî®</small>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <!-- <span class="card-icon">üîê</span> -->
                            <h3 class="card-title">ËÆæÂ§áÁÆ°ÁêÜ</h3>
                        </div>
                        <div class="card-content">
                            <p>ÁÆ°ÁêÜÂèØÊé•ÂÖ•ÁöÑËÆæÂ§áÊï∞ÈáèÂíåËøûÊé•Áä∂ÊÄÅ</p>
                            <div style="margin-top: 15px;">
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #6c757d; font-size: 14px;">ÂΩìÂâçÊé•ÂÖ•ËÆæÂ§á:</span>
                                        <span style="font-weight: 600; color: #2c3e50;" id="currentConnectedDevices">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #6c757d; font-size: 14px;">ÂêØÁî®ËÆæÂ§á:</span>
                                        <span style="font-weight: 600; color: #28a745;" id="activeDeviceCount">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #6c757d; font-size: 14px;">ÊúÄÂ§ßÂÆπÈáè:</span>
                                        <span style="font-weight: 600; color: #667eea;" id="deviceCountDisplay">5</span>
                                    </div>
                                </div>
                                <div style="margin-top: 12px;">
                                    <span class="status-indicator" id="deviceStatusIndicator"></span>
                                    <small id="deviceStatusText">ËÆæÂ§áÁä∂ÊÄÅÊ≠£Â∏∏</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                 <div class="card">
                    <div class="card-header">
                        <!-- <span class="card-icon">üìã</span> -->
                        <h3 class="card-title">Á≥ªÁªüÁä∂ÊÄÅ</h3>
                    </div>
                    <div class="card-content">
                        <p>ÂΩìÂâçÁ≥ªÁªüËøêË°åÁä∂ÊÄÅËâØÂ•ΩÔºåÊâÄÊúâÊ®°ÂùóÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ</p>
                        <br>
                        <p>ËÆæÂ§á‰ø°ÊÅØÔºö</p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>ÂΩìÂâçÊé•ÂÖ•ËÆæÂ§áÊï∞Èáè: <span id="registeredUserCount">0</span> ‰∫∫</li>
                            <li>ÂêØÁî®ËÆæÂ§áÊï∞Èáè: <span id="onlineDeviceCount">0</span> Âè∞</li>
                            <li>ÊúÄÂ§ßÂèØÊé•ÂÖ•ËÆæÂ§á: <span id="maxDeviceCount">5</span> Âè∞</li>
                            <li>ËÆæÂ§á‰ΩøÁî®Áéá: <span id="deviceUsageRate">0%</span></li>
                        </ul>
                        
                        <!-- ËÆæÂ§á‰ΩøÁî®ÁéáËøõÂ∫¶Êù° -->
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 14px; color: #6c757d;">ËÆæÂ§áÂÆπÈáè‰ΩøÁî®ÊÉÖÂÜµ</span>
                                <span style="font-size: 12px; color: #6c757d;" id="capacityRatio">0/5</span>
                            </div>
                            <div style="background-color: #e9ecef; border-radius: 6px; height: 12px; overflow: hidden;">
                                <div id="dashboardUsageBar" style="height: 100%; width: 0%; background-color: #28a745; border-radius: 6px; transition: all 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÁÆ°ÁêÜÂëòËÆæÁΩÆÈ°µÈù¢ -->
            <div id="admin-page" class="page-content admin-panel">
                <div class="content-header">
                    <h1 class="page-title">ÁÆ°ÁêÜÂëòËÆæÁΩÆ</h1>
                    <p class="page-subtitle">ÈÖçÁΩÆÁÆ°ÁêÜÂëò‰ø°ÊÅØÂíåÁ≥ªÁªüÂèÇÊï∞</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‰∏™‰∫∫‰ø°ÊÅØËÆæÁΩÆ</h3>
                    </div>
                    <div class="card-content">
                        <form class="admin-form" id="adminForm">
                            <div class="form-group">
                                <label class="form-label" for="adminName">ÁÆ°ÁêÜÂëòÂêçÁß∞</label>
                                <input type="text" class="form-input" id="adminName" placeholder="ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÂêçÁß∞" value="ÁÆ°ÁêÜÂëò">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="adminAvatar">Â§¥ÂÉèÂ≠óÊØç</label>
                                <input type="text" class="form-input" id="adminAvatar" placeholder="ËØ∑ËæìÂÖ•Â§¥ÂÉèÊòæÁ§∫Â≠óÊØç" maxlength="2" value="A">
                                <div class="avatar-preview" id="avatarPreview">A</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="adminBio">‰∏™‰∫∫ÁÆÄ‰ªã</label>
                                <textarea class="form-input form-textarea" id="adminBio" placeholder="ËØ∑ËæìÂÖ•‰∏™‰∫∫ÁÆÄ‰ªã">Á≥ªÁªüÁÆ°ÁêÜÂëòÔºåË¥üË¥£Êï¥‰ΩìÁ≥ªÁªüËøêÁª¥ÂíåÁÆ°ÁêÜÂ∑•‰Ωú„ÄÇ</textarea>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Âú®ËÆæÂ§áÊé•ÂÖ•ËÆæÁΩÆÂç°Áâá‰∏≠Ê∑ªÂä†Â≠òÂÇ®ËÆæÁΩÆ -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ËÆæÂ§áÊé•ÂÖ•ËÆæÁΩÆ</h3>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label">ÊúÄÂ§ßÂèØÊé•ÂÖ•ËÆæÂ§áÊï∞Èáè</label>
                            <div class="device-counter">
                                <button type="button" class="counter-btn" onclick="changeDeviceCount(-1)">-</button>
                                <span class="counter-display" id="deviceCount">5</span>
                                <button type="button" class="counter-btn" onclick="changeDeviceCount(1)">+</button>
                            </div>
                            <small style="color: #9dd1ff; margin-top: 8px; display: block;">
                                ËÆæÂ§áÊï∞ÈáèËåÉÂõ¥: 1-20Âè∞
                            </small>
                        </div>

                        <!-- Êñ∞Â¢ûÔºöÂ≠òÂÇ®Êï∞ÊçÆ‰∏äÈôêËÆæÁΩÆ -->
                        <div class="form-group" style="margin-top: 30px;">
                            <label class="form-label">Êú¨Âú∞Â≠òÂÇ®Êï∞ÊçÆ‰∏äÈôê</label>
                            <div class="device-counter">
                                <button type="button" class="counter-btn" onclick="changeStorageLimit(-1)">-</button>
                                <span class="counter-display" id="storageLimit">30</span>
                                <button type="button" class="counter-btn" onclick="changeStorageLimit(1)">+</button>
                            </div>
                            <small style="color: #9dd1ff; margin-top: 8px; display: block;">
                                Êï∞ÊçÆÊù°Êï∞ËåÉÂõ¥: 500-5000Êù° (ÂΩ±ÂìçÁîµÊ±†Êï∞ÊçÆÂíå‰ΩçÁΩÆÊï∞ÊçÆÂ≠òÂÇ®)
                            </small>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‰øùÂ≠òËÆæÁΩÆ</h3>
                    </div>
                    <div class="card-content">
                        <button type="button" class="btn btn-primary" onclick="saveAdminSettings()">‰øùÂ≠òÊâÄÊúâËÆæÁΩÆ</button>
                        <button type="button" class="btn btn-secondary" onclick="resetAdminSettings()">ÈáçÁΩÆ‰∏∫ÈªòËÆ§</button>
                        <button type="button" class="btn btn-secondary" onclick="backToDashboard()">ËøîÂõû‰ª™Ë°®Êùø</button>
                    </div>
                </div>
            </div>

            <!-- ÂÖ∂‰ªñÈ°µÈù¢ÂÜÖÂÆπÔºàÂç†‰ΩçÔºâ -->
            <div id="analytics-page" class="page-content hidden">
                <div class="content-header">
                    <h1 class="page-title">Êï∞ÊçÆÂàÜÊûê</h1>
                    <p class="page-subtitle">Ê∑±Â∫¶ÂàÜÊûêÁî®Êà∑ËÆæÂ§á‰ΩøÁî®ÊÉÖÂÜµÂíåÈ™ëË°åÊ®°Âºè</p>
                </div>

                <!-- Áî®Êà∑ÈÄâÊã©Âô® -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üë§</span>
                        <h3 class="card-title">Áî®Êà∑ÈÄâÊã©</h3>
                    </div>
                    <div class="card-content">
                        <div class="user-selector-container">
                            <label class="form-label" for="analyticsUserSelect">ÈÄâÊã©Ë¶ÅÂàÜÊûêÁöÑÁî®Êà∑Ôºö</label>
                            <select class="form-input" id="analyticsUserSelect" onchange="switchAnalyticsUser()" style="max-width: 300px;">
                                <option value="">ËØ∑ÈÄâÊã©Áî®Êà∑</option>
                            </select>
                            <div class="selected-user-info" id="analyticsSelectedUserInfo" style="margin-top: 15px; display: none;">
                                <div class="user-info-card">
                                    <h4 id="analyticsCurrentUserName">Áî®Êà∑ÂêçÁß∞</h4>
                                    <p><strong>ËßíËâ≤Ôºö</strong><span id="analyticsCurrentUserRole">ÊôÆÈÄöÁî®Êà∑</span></p>
                                    <p><strong>ËÆæÂ§áÁºñÂè∑Ôºö</strong><span id="analyticsCurrentUserDevice">Êú™ÂàÜÈÖç</span></p>
                                    <p><strong>ÂàÜÊûêÂë®ÊúüÔºö</strong><span id="analyticsDateRange">ÊúÄËøë7Â§©</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂàÜÊûêÊï∞ÊçÆÂÆπÂô® -->
                <div id="analyticsDataContainer" style="display: none;">
                    <!-- ÁîµÊ±†‰ΩøÁî®ÂàÜÊûê -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-icon">üîã</span>
                            <h3 class="card-title">ÁîµÊ±†‰ΩøÁî®ÂàÜÊûê</h3>
                            <div style="margin-left: auto;">
                                <button class="btn btn-secondary" onclick="refreshAnalyticsData()" style="padding: 8px 16px; font-size: 12px;">
                                    <span id="analyticsRefreshIcon">üîÑ</span> Âà∑Êñ∞ÂàÜÊûê
                                </button>
                                <button class="btn btn-secondary" onclick="exportAnalyticsReport()" style="padding: 8px 16px; font-size: 12px; margin-left: 8px;">
                                    üìä ÂØºÂá∫Êä•Âëä
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <!-- ÁîµÊ±†ÁªüËÆ°Ê¶ÇËßà -->
                            <div class="battery-analysis-summary">
                                <div class="analysis-stat-item">
                                    <span class="stat-label">Âπ≥ÂùáÁîµÂéã</span>
                                    <span class="stat-value" id="avgVoltage">--V</span>
                                    <span class="stat-trend" id="voltageTrend"></span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">Âπ≥ÂùáÁîµÊµÅ</span>
                                    <span class="stat-value" id="avgCurrent">--A</span>
                                    <span class="stat-trend" id="currentTrend"></span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">ÁîµÊ±†ÂÅ•Â∫∑Â∫¶</span>
                                    <span class="stat-value" id="batteryHealth">--</span>
                                    <span class="stat-trend" id="healthTrend"></span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">‰ΩøÁî®ÊïàÁéá</span>
                                    <span class="stat-value" id="efficiency">--%</span>
                                    <span class="stat-trend" id="efficiencyTrend"></span>
                                </div>
                            </div>

                            <!-- ÁîµÊ±†Ë∂ãÂäøÂõæË°® -->
                            <div class="chart-container" style="position: relative; height: 300px; margin: 20px 0;">
                                <canvas id="batteryTrendChart"></canvas>
                            </div>

                            <!-- ÁîµÊ±†Âª∫ËÆÆÂç°Áâá -->
                            <div class="recommendations-section">
                                <h4 style="margin-bottom: 15px; color: #2c3e50;">üí° ‰ΩøÁî®Âª∫ËÆÆ</h4>
                                <div class="recommendations-grid">
                                    <div class="recommendation-card" id="chargingRecommendation">
                                        <div class="recommendation-icon">‚ö°</div>
                                        <div class="recommendation-content">
                                            <h5>ÂÖÖÁîµÂª∫ËÆÆ</h5>
                                            <p id="chargingAdvice">ÂàÜÊûê‰∏≠...</p>
                                        </div>
                                    </div>
                                    <div class="recommendation-card" id="usageRecommendation">
                                        <div class="recommendation-icon">üîã</div>
                                        <div class="recommendation-content">
                                            <h5>‰ΩøÁî®Âª∫ËÆÆ</h5>
                                            <p id="usageAdvice">ÂàÜÊûê‰∏≠...</p>
                                        </div>
                                    </div>
                                    <div class="recommendation-card" id="maintenanceRecommendation">
                                        <div class="recommendation-icon">üîß</div>
                                        <div class="recommendation-content">
                                            <h5>Áª¥Êä§Âª∫ËÆÆ</h5>
                                            <p id="maintenanceAdvice">ÂàÜÊûê‰∏≠...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- È™ëË°åË∑ØÂæÑÂàÜÊûê -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-icon">üó∫Ô∏è</span>
                            <h3 class="card-title">È™ëË°åË∑ØÂæÑÂàÜÊûê</h3>
                            <div style="margin-left: auto;">
                                <select id="pathAnalysisPeriod" class="form-input" onchange="updatePathAnalysis()" style="width: 120px; padding: 6px 10px;">
                                    <option value="7">ÊúÄËøë7Â§©</option>
                                    <option value="14">ÊúÄËøë14Â§©</option>
                                    <option value="30">ÊúÄËøë30Â§©</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-content">
                            <!-- Ë∑ØÂæÑÁªüËÆ°Ê¶ÇËßà -->
                            <div class="path-analysis-summary">
                                <div class="analysis-stat-item">
                                    <span class="stat-label">ÊÄªÈ™ëË°åË∑ùÁ¶ª</span>
                                    <span class="stat-value" id="totalDistance">-- km</span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">Ê¥ªÂä®Â§©Êï∞</span>
                                    <span class="stat-value" id="activeDays">-- Â§©</span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">Âπ≥ÂùáÊó•Ë∑ùÁ¶ª</span>
                                    <span class="stat-value" id="avgDailyDistance">-- km</span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">Ë¶ÜÁõñËåÉÂõ¥</span>
                                    <span class="stat-value" id="coverageArea">-- km¬≤</span>
                                </div>
                            </div>

                            <!-- Ë∑ØÂæÑË¶ÜÁõñÂú∞Âõæ -->
                            <div class="map-analysis-container">
                                <div id="pathAnalysisMap" style="height: 400px; border-radius: 8px; overflow: hidden; margin: 20px 0;"></div>
                                
                                <!-- Ë∑ØÂæÑÁÉ≠ÂäõÂõæÊéßÂà∂ -->
                                <div class="map-controls">
                                    <label>
                                        <input type="checkbox" id="showHeatmap" onchange="toggleHeatmap()" checked>
                                        ÊòæÁ§∫Ê¥ªÂä®ÁÉ≠ÂäõÂõæ
                                    </label>
                                    <label style="margin-left: 20px;">
                                        <input type="checkbox" id="showCoverage" onchange="toggleCoverage()" checked>
                                        ÊòæÁ§∫Ë¶ÜÁõñÂå∫Âüü
                                    </label>
                                </div>
                            </div>

                            <!-- Ë∑ØÂæÑÊ®°ÂºèÂàÜÊûê -->
                            <div class="path-patterns-section">
                                <h4 style="margin: 20px 0 15px 0; color: #2c3e50;">üìà Ë∑ØÂæÑÊ®°ÂºèÂàÜÊûê</h4>
                                <div class="patterns-grid">
                                    <div class="pattern-card">
                                        <h5>üìç Â∏∏Áî®Âå∫Âüü</h5>
                                        <div id="frequentAreas">ÂàÜÊûê‰∏≠...</div>
                                    </div>
                                    <div class="pattern-card">
                                        <h5>üïí Ê¥ªÂä®Êó∂ÊÆµ</h5>
                                        <div id="activeTimePatterns">ÂàÜÊûê‰∏≠...</div>
                                    </div>
                                    <div class="pattern-card">
                                        <h5>üìä È™ëË°å‰π†ÊÉØ</h5>
                                        <div id="ridingHabits">ÂàÜÊûê‰∏≠...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÁªºÂêàËØÑ‰º∞Êä•Âëä -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-icon">üìã</span>
                            <h3 class="card-title">ÁªºÂêàËØÑ‰º∞Êä•Âëä</h3>
                        </div>
                        <div class="card-content">
                            <div class="evaluation-report">
                                <div class="report-section">
                                    <h4>üéØ ‰ΩøÁî®ËØÑÂàÜ</h4>
                                    <div class="score-display">
                                        <div class="score-circle" id="overallScore">
                                            <span class="score-value">--</span>
                                            <span class="score-label">ÊÄªÂàÜ</span>
                                        </div>
                                        <div class="score-breakdown">
                                            <div class="score-item">
                                                <span class="score-name">ÁîµÊ±†ÁÆ°ÁêÜ</span>
                                                <div class="score-bar">
                                                    <div class="score-fill" id="batteryScore" style="width: 0%"></div>
                                                </div>
                                                <span class="score-number" id="batteryScoreNum">0</span>
                                            </div>
                                            <div class="score-item">
                                                <span class="score-name">È™ëË°åÈ¢ëÁéá</span>
                                                <div class="score-bar">
                                                    <div class="score-fill" id="frequencyScore" style="width: 0%"></div>
                                                </div>
                                                <span class="score-number" id="frequencyScoreNum">0</span>
                                            </div>
                                            <div class="score-item">
                                                <span class="score-name">Ë∑ØÂæÑÊïàÁéá</span>
                                                <div class="score-bar">
                                                    <div class="score-fill" id="pathScore" style="width: 0%"></div>
                                                </div>
                                                <span class="score-number" id="pathScoreNum">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="report-section">
                                    <h4>üìù ÊÄªÁªì‰∏éÂª∫ËÆÆ</h4>
                                    <div id="evaluationSummary" class="evaluation-text">
                                        Ê≠£Âú®ÁîüÊàêÁªºÂêàËØÑ‰º∞Êä•Âëä...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Êó†Êï∞ÊçÆÊèêÁ§∫ -->
                <div id="analyticsNoDataMessage" class="card" style="display: none;">
                    <div class="card-content" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                        <h4>ÊöÇÊó†ÂàÜÊûêÊï∞ÊçÆ</h4>
                        <p style="color: #6c757d;">ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Áî®Êà∑ËøõË°åÊï∞ÊçÆÂàÜÊûê</p>
                    </div>
                </div>
            </div>

            <!-- monitoringÈ°µÈù¢ÂÜÖÂÆπ -->
            <div id="monitoring-page" class="page-content hidden">
                <div class="content-header">
                    <h1 class="page-title">Á≥ªÁªüÁõëÊéß</h1>
                    <p class="page-subtitle">ÂÆûÊó∂ÁõëÊéßÁî®Êà∑ËÆæÂ§áÁä∂ÊÄÅÂíåËΩ®Ëøπ‰ø°ÊÅØ</p>
                </div>

                <!-- Áî®Êà∑ÈÄâÊã©Âô® -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üë§</span>
                        <h3 class="card-title">Áî®Êà∑ÈÄâÊã©</h3>
                    </div>
                    <div class="card-content">
                        <div class="user-selector-container">
                            <label class="form-label" for="monitoringUserSelect">ÈÄâÊã©Ë¶ÅÁõëÊéßÁöÑÁî®Êà∑Ôºö</label>
                            <select class="form-input" id="monitoringUserSelect" onchange="switchMonitoringUser()" style="max-width: 300px;">
                                <option value="">ËØ∑ÈÄâÊã©Áî®Êà∑</option>
                            </select>
                            <div class="selected-user-info" id="selectedUserInfo" style="margin-top: 15px; display: none;">
                                <div class="user-info-card">
                                    <h4 id="currentUserName">Áî®Êà∑ÂêçÁß∞</h4>
                                    <p><strong>ËßíËâ≤Ôºö</strong><span id="currentUserRole">ÊôÆÈÄöÁî®Êà∑</span></p>
                                    <p><strong>ËÆæÂ§áÁºñÂè∑Ôºö</strong><span id="currentUserDevice">Êú™ÂàÜÈÖç</span></p>
                                    <p><strong>Áä∂ÊÄÅÔºö</strong><span id="currentUserStatus" class="status-badge">ÂêØÁî®</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÁõëÊéßÊï∞ÊçÆÂÆπÂô® -->
                <div id="monitoringDataContainer" style="display: none;">
                    <!-- ÁîµÊ±†ÁõëÊéßÂõæË°® -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ÁîµÊ±†ÁõëÊéßÊï∞ÊçÆ</h3>
                            <div style="margin-left: auto;">
                                <button class="btn btn-secondary" onclick="refreshBatteryData()" style="padding: 8px 16px; font-size: 12px;">
                                    <span id="batteryRefreshIcon"></span> Âà∑Êñ∞Êï∞ÊçÆ
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="battery-stats-summary">
                                <div class="stat-item">
                                    <span class="stat-label">ÂΩìÂâçÁîµÂéã</span>
                                    <span class="stat-value" id="currentVoltage">--V</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ÂΩìÂâçÁîµÊµÅ</span>
                                    <span class="stat-value" id="currentCurrent">--A</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Êï∞ÊçÆÁÇπÊï∞</span>
                                    <span class="stat-value" id="dataPointCount">0</span>
                                </div>
                            </div>
                            <div class="chart-container" style="position: relative; height: 400px; margin-top: 20px;">
                                <canvas id="monitoringBatteryChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- ËΩ®ËøπÁõëÊéßÂú∞Âõæ -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ËΩ®ËøπÁõëÊéß</h3>
                            <div style="margin-left: auto;">
                                <label for="dateSelector" style="margin-right: 10px; font-weight: 500;">ÈÄâÊã©Êó•ÊúüÔºö</label>
                                <select id="dateSelector" class="form-input" onchange="switchTrackingDate()" style="width: 150px; padding: 6px 10px;">
                                    <option value="">ÈÄâÊã©Êó•Êúü</option>
                                </select>
                                <button class="btn btn-secondary" onclick="refreshMapData()" style="padding: 8px 16px; font-size: 12px; margin-left: 10px;">
                                    <span id="mapRefreshIcon"></span> Âà∑Êñ∞Âú∞Âõæ
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="tracking-stats" id="trackingStats" style="margin-bottom: 15px; display: none;">
                                <div class="stat-item">
                                    <span class="stat-label">ËΩ®ËøπÁÇπÊï∞</span>
                                    <span class="stat-value" id="trackPointCount">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">ÊÄªË∑ùÁ¶ª</span>
                                    <span class="stat-value" id="totalDistance">0 km</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Ê¥ªÂä®Êó∂Èó¥</span>
                                    <span class="stat-value" id="activityTime">--</span>
                                </div>
                            </div>
                            <div id="monitoringMap" style="height: 500px; border-radius: 8px; overflow: hidden;"></div>
                            <div id="mapLoadingIndicator" style="display: none; text-align: center; padding: 20px; color: #6c757d;">
                                <div class="loading-spinner" style="margin: 0 auto 10px;"></div>
                                <p>Ê≠£Âú®Âä†ËΩΩÂú∞ÂõæÊï∞ÊçÆ...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Êó†Êï∞ÊçÆÊèêÁ§∫ -->
                <div id="noDataMessage" class="card" style="display: none;">
                    <div class="card-content" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                        <h4>ÊöÇÊó†ÁõëÊéßÊï∞ÊçÆ</h4>
                        <p style="color: #6c757d;">ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Áî®Êà∑Êü•ÁúãÂÖ∂ÁõëÊéßÊï∞ÊçÆ</p>
                    </div>
                </div>
            </div>

            <!-- Áî®Êà∑ÁÆ°ÁêÜÈ°µÈù¢ -->
            <div id="users-page" class="page-content hidden">
                <div class="content-header">
                    <h1 class="page-title">Áî®Êà∑ÁÆ°ÁêÜ</h1>
                    <p class="page-subtitle">ÁÆ°ÁêÜÁ≥ªÁªüÁî®Êà∑ÂíåËÆæÂ§áÊé•ÂÖ•</p>
                </div>

                <!-- Áî®Êà∑ÁªüËÆ°Âç°Áâá -->
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Áî®Êà∑ÁªüËÆ°</h3>
                        </div>
                        <div class="card-content">
                            <p>ÂΩìÂâçÂ∑≤Ê≥®ÂÜåÁî®Êà∑: <strong id="currentUserCount">0</strong> ‰∫∫</p>
                            <p>ÊúÄÂ§ßÂèØÊé•ÂÖ•ËÆæÂ§á: <strong id="maxUserDevices">5</strong> Âè∞</p>
                            <div style="margin-top: 15px;">
                                <span class="status-indicator" id="userStatusIndicator"></span>
                                <small id="userStatusText">Á≥ªÁªüÊ≠£Â∏∏</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Áî®Êà∑ÂΩïÂÖ•Ë°®Âçï -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Ê∑ªÂä†Êñ∞Áî®Êà∑</h3>
                    </div>
                    <div class="card-content">
                        <form class="admin-form" id="addUserForm" style="max-width: 500px;">
                            <div class="form-group">
                                <label class="form-label" for="newUserName">Áî®Êà∑ÂßìÂêç</label>
                                <input type="text" class="form-input" id="newUserName" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂßìÂêç" maxlength="20">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="newUserRole">Áî®Êà∑ËßíËâ≤</label>
                                <select class="form-input" id="newUserRole">
                                    <option value="user">ÊôÆÈÄöÁî®Êà∑</option>
                                    <option value="admin">ÁÆ°ÁêÜÂëò</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="newUserDevice">ËÆæÂ§áÁºñÂè∑</label>
                                <input type="text" class="form-input" id="newUserDevice" placeholder="ËØ∑ËæìÂÖ•ËÆæÂ§áÁºñÂè∑ÔºàÂèØÈÄâÔºâ" maxlength="20">
                            </div>

                            <div class="form-group">
                                <button type="button" class="btn btn-primary" onclick="addNewUser()">
                                    <span id="addUserBtnText">Ê∑ªÂä†Áî®Êà∑</span>
                                </button>             
                                <span id="addUserSpinner" class="loading-spinner hidden" style="margin-left: 10px;"></span>
                                <button type="button" class="btn btn-secondary" onclick="clearUserForm()">Ê∏ÖÁ©∫Ë°®Âçï</button>
                            </div>

                            <!-- ÂÆπÈáèË≠¶Âëä -->
                            <div id="capacityWarning" class="hidden" style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px; margin-top: 15px; color: #856404;">
                                <strong>ÂÆπÈáèË≠¶Âëä:</strong> 
                                <span id="warningMessage">ÂΩìÂâçÁî®Êà∑Êï∞ÈáèÂ∑≤Êé•Ëøë‰∏äÈôê</span>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Áî®Êà∑ÂàóË°® -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Â∑≤Ê≥®ÂÜåÁî®Êà∑ÂàóË°®</h3>
                        <div style="margin-left: auto;">
                            <button class="btn btn-secondary" onclick="refreshUserList()" style="padding: 8px 16px; font-size: 12px; background-color: rgba(108,117,125,0.85); color: white; backdrop-filter: blur(10px);">
                                Âà∑Êñ∞
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <!-- ÊêúÁ¥¢ËøáÊª§Âô® -->
                        <div class="form-group" style="margin-bottom: 20px;"></div>
                            <input type="text" class="form-input" id="userSearchInput" placeholder="ÊêúÁ¥¢Áî®Êà∑ÂßìÂêçÊàñËÆæÂ§áÁºñÂè∑..." style="max-width: 300px;" oninput="filterUserList()">
                        </div>

                        <!-- Áî®Êà∑ÂàóË°®ÂÆπÂô® -->
                        <div id="userListContainer">
                            <!-- <div id="emptyUserState" class="text-center" style="color: #6c757d; padding: 40px;"></div>
                                <div style="font-size: 48px; margin-bottom: 16px;">üë§</div>
                                <h4>ÊöÇÊó†Áî®Êà∑Êï∞ÊçÆ</h4>
                                <p>ËØ∑Ê∑ªÂä†Á¨¨‰∏Ä‰∏™Áî®Êà∑ÂºÄÂßã‰ΩøÁî®Á≥ªÁªü</p>
                            </div> -->
                        </div>
                    </div>
                </div>
            </div>


        </main>
    </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let adminSettings = {
            name: 'ÁÆ°ÁêÜÂëò',
            avatar: 'A',
            bio: 'Á≥ªÁªüÁÆ°ÁêÜÂëòÔºåË¥üË¥£Êï¥‰ΩìÁ≥ªÁªüËøêÁª¥ÂíåÁÆ°ÁêÜÂ∑•‰Ωú„ÄÇ',
            maxDevices: 5,
            storageLimit: 30  // Êñ∞Â¢ûÔºöÂ≠òÂÇ®Êï∞ÊçÆ‰∏äÈôê
        };

        // ÁõëÊéßÈ°µÈù¢ÂÖ®Â±ÄÂèòÈáè
        let monitoringBatteryChart = null;
        let monitoringMap = null;
        let currentMonitoringUser = null;
        let currentTrackingDate = null;
        let trackingLayer = null;
        let userDataMapping = {};   // Ê®°ÊãüÁî®Êà∑Êï∞ÊçÆÊò†Â∞Ñ - ‰∏∫ÊØè‰∏™Áî®Êà∑ÂàÜÈÖçÁã¨Á´ãÁöÑÊï∞ÊçÆ

        // Êï∞ÊçÆÂàÜÊûêÈÉ®ÂàÜ
        let analyticsMap = null;
        let currentAnalyticsUser = null;
        let batteryTrendChart = null;
        let heatmapLayer = null;
        let coverageLayer = null;

        // Áî®Êà∑ÁÆ°ÁêÜÂÖ®Â±ÄÂèòÈáè
        let userList = [];
        let filteredUserList = [];

        /* ---------- ‰ª™Ë°®ÁõòËÆæÁΩÆÔºàÂØºËà™‰ª™Ôºâ ---------- */

        /* ---------- ‰∏ªÈ°µÈù¢‰ª™Ë°®ÁõòÂç°Áâá ‰ª•ÂèäÈ°µÈù¢ÊéßÂà∂ÂáΩÊï∞ ---------- */
        // ÂàáÊç¢‰æßËæπÊ†èÊòæÁ§∫/ÈöêËóèÔºàÁßªÂä®Á´ØÔºâ
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // ÊòæÁ§∫ÁÆ°ÁêÜÂëòÈù¢Êùø
        function showAdminPanel() {
            showPage('admin');
        }

        // ËøîÂõû‰ª™Ë°®Êùø
        function backToDashboard() {
            showPage('dashboard');
        }

        // È°µÈù¢ÂàáÊç¢ÂáΩÊï∞
        function showPage(pageId) {
            // ÈöêËóèÊâÄÊúâÈ°µÈù¢
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('active');
            });

            // ÊòæÁ§∫ÊåáÂÆöÈ°µÈù¢
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('active');
            }

            // Êõ¥Êñ∞ËèúÂçïÁä∂ÊÄÅ
            updateMenuState(pageId);
        }

        // Êõ¥Êñ∞ËèúÂçïÁä∂ÊÄÅ
        function updateMenuState(activePageId) {
            // Êõ¥Êñ∞‰æßËæπÊ†èËèúÂçï
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === activePageId) {
                    item.classList.add('active');
                }
            });

            // Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === activePageId) {
                    link.classList.add('active');
                }
            });
        }

        // Êõ¥Êñ∞‰ª™Ë°®ÊùøËÆæÂ§áÁªüËÆ°ÊòæÁ§∫
        function updateDashboardDeviceStats() {
            const totalUsers = userList.length;
            const activeUsers = userList.filter(u => u.status === 'active').length;
            const maxDevices = adminSettings.maxDevices;
            const usagePercent = Math.round((totalUsers / maxDevices) * 100);

            // Êõ¥Êñ∞ËÆæÂ§áÁÆ°ÁêÜÂç°Áâá
            const currentConnectedElement = document.getElementById('currentConnectedDevices');
            const activeDeviceElement = document.getElementById('activeDeviceCount');
            const deviceStatusIndicator = document.getElementById('deviceStatusIndicator');
            const deviceStatusText = document.getElementById('deviceStatusText');

            if (currentConnectedElement) currentConnectedElement.textContent = totalUsers;
            if (activeDeviceElement) activeDeviceElement.textContent = activeUsers;

            // Êõ¥Êñ∞ËÆæÂ§áÁä∂ÊÄÅÊåáÁ§∫Âô®
            if (deviceStatusIndicator && deviceStatusText) {
                if (usagePercent >= 90) {
                    deviceStatusIndicator.className = 'status-indicator status-offline';
                    deviceStatusText.textContent = 'ËÆæÂ§áÂÆπÈáèÂç≥Â∞ÜÊª°ËΩΩ';
                } else if (usagePercent >= 70) {
                    deviceStatusIndicator.className = 'status-indicator status-warning';
                    deviceStatusText.textContent = 'ËÆæÂ§á‰ΩøÁî®ÁéáËæÉÈ´ò';
                } else {
                    deviceStatusIndicator.className = 'status-indicator status-online';
                    deviceStatusText.textContent = 'ËÆæÂ§áÁä∂ÊÄÅÊ≠£Â∏∏';
                }
            }

            // Êõ¥Êñ∞Á≥ªÁªüÁä∂ÊÄÅÂç°Áâá
            const onlineDeviceCount = document.getElementById('onlineDeviceCount');
            const registeredUserCount = document.getElementById('registeredUserCount');
            const maxDeviceCount = document.getElementById('maxDeviceCount');
            const deviceUsageRate = document.getElementById('deviceUsageRate');
            const capacityRatio = document.getElementById('capacityRatio');
            const dashboardUsageBar = document.getElementById('dashboardUsageBar');

            if (onlineDeviceCount) onlineDeviceCount.textContent = activeUsers;
            if (registeredUserCount) registeredUserCount.textContent = totalUsers;
            if (maxDeviceCount) maxDeviceCount.textContent = maxDevices;
            if (deviceUsageRate) deviceUsageRate.textContent = usagePercent + '%';
            if (capacityRatio) capacityRatio.textContent = `${totalUsers}/${maxDevices}`;

            // Êõ¥Êñ∞‰ΩøÁî®ÁéáËøõÂ∫¶Êù°
            if (dashboardUsageBar) {
                dashboardUsageBar.style.width = usagePercent + '%';
                
                // Ê†πÊçÆ‰ΩøÁî®ÁéáËÆæÁΩÆËøõÂ∫¶Êù°È¢úËâ≤
                if (usagePercent >= 90) {
                    dashboardUsageBar.style.backgroundColor = '#dc3545'; // Á∫¢Ëâ≤
                } else if (usagePercent >= 70) {
                    dashboardUsageBar.style.backgroundColor = '#ffc107'; // ÈªÑËâ≤
                } else {
                    dashboardUsageBar.style.backgroundColor = '#28a745'; // ÁªøËâ≤
                }
            }

            // Êõ¥Êñ∞ËÆæÂ§áËÆ°Êï∞ÊòæÁ§∫
            const deviceCountDisplay = document.getElementById('deviceCountDisplay');
            if (deviceCountDisplay) {
                deviceCountDisplay.textContent = maxDevices;
            }

            console.log(`üìä ‰ª™Ë°®ÊùøËÆæÂ§áÁªüËÆ°Â∑≤Êõ¥Êñ∞: ${totalUsers}/${maxDevices} (${usagePercent}%)`);
        }

        // Êï∞ÁªÑÊâì‰π±ÂáΩÊï∞ÔºàFisher-YatesÊ¥óÁâåÁÆóÊ≥ïÔºâ
        function shuffleArray(array) {
            const shuffled = [...array]; // ÂàõÂª∫ÂâØÊú¨
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Ëé∑ÂèñÁî®Êà∑Âú®ÂàóË°®‰∏≠ÁöÑÂ∫èÂè∑ÔºàÁî®‰∫éÂà§Êñ≠ÊòØÂê¶‰∏∫Á¨¨‰∏Ä‰∏™Áî®Êà∑Ôºâ
        function getUserIndex(userId) {
            return userList.findIndex(user => user.id === userId);
        }

        // Ê£ÄÊü•ÊòØÂê¶‰∏∫Á¨¨‰∏Ä‰∏™Áî®Êà∑ÁöÑËæÖÂä©ÂáΩÊï∞
        function isFirstUser(userId) {
            if (userList.length === 0) return false;
            return userList[0].id === userId;
        }


        /* ---------- ÁõëÊéßÊï∞ÊçÆÈ°µÈù¢ÂäüËÉΩ ---------- */
        // ÂàùÂßãÂåñÁõëÊéßÈ°µÈù¢
        function initializeMonitoringPage() {
            loadUserSelector();
            setupMonitoringComponents();
        }

        // Âä†ËΩΩÁî®Êà∑ÈÄâÊã©Âô®
        function loadUserSelector() {
            const selector = document.getElementById('monitoringUserSelect');
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            selector.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Áî®Êà∑</option>';
            
            // Ê∑ªÂä†Â∑≤ÂΩïÂÖ•ÁöÑÁî®Êà∑
            userList.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.device || 'Êó†ËÆæÂ§á'})`;
                selector.appendChild(option);
            });
            
            console.log('üìã Áî®Êà∑ÈÄâÊã©Âô®Â∑≤Êõ¥Êñ∞ÔºåÂÖ±', userList.length, '‰∏™Áî®Êà∑');
        }

        // ÂàáÊç¢ÁõëÊéßÁî®Êà∑
        function switchMonitoringUser() {
            const selector = document.getElementById('monitoringUserSelect');
            const userId = selector.value;
            
            if (!userId) {
                hideMonitoringData();
                return;
            }
            
            const user = userList.find(u => u.id === userId);
            if (!user) {
                console.error('‚ùå Áî®Êà∑Êú™ÊâæÂà∞:', userId);
                return;
            }
            
            currentMonitoringUser = user;
            displayUserInfo(user);
            loadUserMonitoringData(user);
            showMonitoringData();
            
            console.log('üë§ ÂàáÊç¢Âà∞Áî®Êà∑:', user.name);
        }

        // ÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØ
        function displayUserInfo(user) {
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentUserRole').textContent = getRoleDisplayName(user.role);
            document.getElementById('currentUserDevice').textContent = user.device || 'Êú™ÂàÜÈÖç';
            
            const statusElement = document.getElementById('currentUserStatus');
            statusElement.textContent = user.status === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®';
            statusElement.className = `status-badge ${user.status}`;
            
            document.getElementById('selectedUserInfo').style.display = 'block';
        }

        // Âä†ËΩΩÁî®Êà∑ÁõëÊéßÊï∞ÊçÆ
        function loadUserMonitoringData(user) {
            // ‰∏∫Áî®Êà∑ÂàÜÈÖçÊàñËé∑ÂèñÁé∞ÊúâÊï∞ÊçÆ
            if (!userDataMapping[user.id]) {
                // Ê£ÄÊü•ÂΩìÂâçÁî®Êà∑ÊòØÂê¶ÊòØÁ¨¨‰∏Ä‰∏™Áî®Êà∑
                const isFirstUser = userList.length > 0 && userList[0].id === user.id;
                
                let batteryData = generateUserBatteryData(user);
                let trackingData = generateUserTrackingData(user);
                
                // Â¶ÇÊûú‰∏çÊòØÁ¨¨‰∏Ä‰∏™Áî®Êà∑ÔºåÊâì‰π±Êï∞ÊçÆÈ°∫Â∫è
                if (!isFirstUser) {
                    batteryData = shuffleArray([...batteryData]); // ÂàõÂª∫ÂâØÊú¨Âπ∂Êâì‰π±
                    trackingData = shuffleTrackingData(trackingData); // Êâì‰π±ËΩ®ËøπÊï∞ÊçÆ
                    console.log(`üîÄ Áî®Êà∑ ${user.name} ÁöÑÊï∞ÊçÆÂ∑≤Êâì‰π±È°∫Â∫è`);
                } else {
                    console.log(`üìä Áî®Êà∑ ${user.name} ÊòØÁ¨¨‰∏Ä‰∏™Áî®Êà∑Ôºå‰øùÊåÅÂéüÂßãÊï∞ÊçÆÈ°∫Â∫è`);
                }
                
                userDataMapping[user.id] = {
                    batteryData: batteryData,
                    trackingData: trackingData
                };
                console.log('üîã ‰∏∫Áî®Êà∑ÁîüÊàêÁõëÊéßÊï∞ÊçÆ:', user.name);
            }

            // Âä†ËΩΩÁîµÊ±†Êï∞ÊçÆ
            loadBatteryChart(userDataMapping[user.id].batteryData);
            
            // Âä†ËΩΩËΩ®ËøπÊï∞ÊçÆÈÄâÊã©Âô®
            loadDateSelector(userDataMapping[user.id].trackingData);
        }

        // ËΩ®ËøπÊï∞ÊçÆÊâì‰π±ÂáΩÊï∞
        function shuffleTrackingData(trackingData) {
            const shuffledData = {};
            
            // ÂØπÊØè‰∏ÄÂ§©ÁöÑÊï∞ÊçÆËøõË°åÂ§ÑÁêÜ
            Object.keys(trackingData).forEach(date => {
                const dayData = trackingData[date];
                if (dayData && dayData.path && Array.isArray(dayData.path)) {
                    // Êâì‰π±ÂΩìÂ§©ÁöÑË∑ØÂæÑÁÇπÈ°∫Â∫è
                    const shuffledPath = shuffleArray([...dayData.path]);
                    
                    shuffledData[date] = {
                        ...dayData,
                        path: shuffledPath
                    };
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâË∑ØÂæÑÊï∞ÊçÆÔºåÁõ¥Êé•Â§çÂà∂
                    shuffledData[date] = { ...dayData };
                }
            });
            
            return shuffledData;
        }

        // ÁîüÊàêÁî®Êà∑ÁîµÊ±†Êï∞ÊçÆ (Âü∫‰∫éÁé∞ÊúâÊï∞ÊçÆÁöÑÊ®°Êãü)
        function generateUserBatteryData(user) {
            try {
                // Â∞ùËØï‰ªélocalStorageËé∑ÂèñÁúüÂÆûÊï∞ÊçÆ
                const realBatteryData = localStorage.getItem('batteryHistoryData');
                let baseData = [];
                
                if (realBatteryData) {
                    const parsedData = JSON.parse(realBatteryData);
                    
                    // Ê£ÄÊü•Êï∞ÊçÆÁªìÊûÑÊòØÂê¶ÂåÖÂê´voltageÂíåcurrentÊï∞ÁªÑ
                    if (parsedData && parsedData.voltage && parsedData.current && 
                        Array.isArray(parsedData.voltage) && Array.isArray(parsedData.current)) {

                        const voltageArray = parsedData.voltage;
                        const currentArray = parsedData.current;
                        const dataLength = Math.min(voltageArray.length, currentArray.length);
                        
                        // Â∞ÜÊï∞ÁªÑÊï∞ÊçÆËΩ¨Êç¢‰∏∫ÂØπË±°Êï∞ÁªÑÊ†ºÂºè
                        for (let i = 0; i < dataLength; i++) {
                            baseData.push({
                                voltage: voltageArray[i],
                                current: currentArray[i],
                            });
                        }
                        
                        console.log(`üìä ‰ªélocalStorageÂä†ËΩΩ‰∫Ü ${dataLength} Êù°ÁîµÊ±†Êï∞ÊçÆ`);
                    } 
                    else {
                        console.warn('‚ö†Ô∏è batteryHistoryDataÊï∞ÊçÆÁªìÊûÑ‰∏çÊ≠£Á°ÆÔºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ');
                        baseData = generateMockBatteryData(30);
                    }
                } 
                else {
                    console.log('üìä Êú™ÊâæÂà∞localStorage‰∏≠ÁöÑÁîµÊ±†Êï∞ÊçÆÔºåÁîüÊàêÊ®°ÊãüÊï∞ÊçÆ');
                    baseData = generateMockBatteryData(30);
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÊàñÊï∞ÊçÆ‰∏çË∂≥ÔºåÁîüÊàêÊ®°ÊãüÊï∞ÊçÆ
                if (baseData.length === 0) {
                    baseData = generateMockBatteryData(window.maxBatteryDataPoints);
                }
                
                // ‰∏∫ÊØè‰∏™Áî®Êà∑Á®çÂæÆË∞ÉÊï¥Êï∞ÊçÆÔºå‰ΩÜ‰øùÊåÅÂêàÁêÜËåÉÂõ¥
                const userVariation = (user.id.charCodeAt(user.id.length - 1) % 10) * 0.01 - 0.04; // 0-0.09ÁöÑÂèòÂåñ
                
                return baseData.map((item, index) => ({
                    timestamp: item.timestamp || new Date(Date.now() - (baseData.length - index) * 60000).toISOString(),
                    voltage: Math.max(7.4, Math.min(7.6, (item.voltage || 7.5) + userVariation)),
                    current: Math.max(0.35, Math.min(0.5, (item.current || 0.4) + userVariation * 0.5))
                }));
                
            } catch (error) {
                console.error('‚ùå ÁîüÊàêÁî®Êà∑ÁîµÊ±†Êï∞ÊçÆÂ§±Ë¥•:', error);
                console.error('‚ùå ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ:', error.message);
                return generateMockBatteryData(20);
            }
        }

        // ÁîüÊàêÁî®Êà∑ËΩ®ËøπÊï∞ÊçÆ (Âü∫‰∫éÁé∞ÊúâÊï∞ÊçÆÁöÑÊ®°Êãü)
        function generateUserTrackingData(user) {
            try {
                // Â∞ùËØï‰ªélocalStorageËé∑ÂèñÁúüÂÆûÊï∞ÊçÆ
                const realMockData = localStorage.getItem('mockData');
                let baseData = {};
                
                if (realMockData) {
                    const parsedData = JSON.parse(realMockData);
                    
                    // Â§ÑÁêÜÂÆûÈôÖÁöÑÊï∞ÊçÆÁªìÊûÑ
                    Object.keys(parsedData).forEach(date => {
                        const dayData = parsedData[date];
                        
                        // Ê£ÄÊü•Êï∞ÊçÆÁªìÊûÑÂπ∂ËΩ¨Êç¢pathÊ†ºÂºè
                        if (dayData && dayData.path && Array.isArray(dayData.path)) {
                            // ËΩ¨Êç¢pathÊï∞ÁªÑÊ†ºÂºèÔºö‰ªé [[lat, lng], [lat, lng]] ËΩ¨‰∏∫ [{lat, lng}, {lat, lng}]
                            const convertedPath = dayData.path.map((point, index) => {
                                if (Array.isArray(point) && point.length >= 2) {
                                    return {
                                        lat: point[0],
                                        lng: point[1],
                                        timestamp: new Date(Date.now() - (dayData.path.length - index) * 60000).toISOString()
                                    };
                                } else if (typeof point === 'object' && point.lat && point.lng) {
                                    return {
                                        lat: point.lat,
                                        lng: point.lng,
                                        timestamp: point.timestamp || new Date(Date.now() - (dayData.path.length - index) * 60000).toISOString()
                                    };
                                }
                                return null;
                            }).filter(point => point !== null);
                            
                            baseData[date] = {
                                path: convertedPath,
                                totalDistance: dayData.Distance || dayData.distance || Math.round(Math.random() * 50 + 10),
                                numTarget: dayData.numTarget || 0,
                                voltage: dayData.Voltage || dayData.voltage || 0,
                                current: dayData.Current || dayData.current || 0
                            };
                            
                            console.log(`üìÖ Â§ÑÁêÜÊó•Êúü ${date}:`, convertedPath.length, '‰∏™ËΩ®ËøπÁÇπ');
                        }
                    });
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÁúüÂÆûÊï∞ÊçÆÊàñÂ§ÑÁêÜÂêéÊ≤°ÊúâÊï∞ÊçÆÔºåÁîüÊàêÊ®°ÊãüÊï∞ÊçÆ
                if (Object.keys(baseData).length === 0) {
                    console.log('üìç Êú™ÊâæÂà∞ÊúâÊïàËΩ®ËøπÊï∞ÊçÆÔºåÁîüÊàêÊ®°ÊãüÊï∞ÊçÆ');
                    baseData = generateMockTrackingData();
                }
                
                // ‰∏∫ÊØè‰∏™Áî®Êà∑Ë∞ÉÊï¥ËΩ®ËøπÊï∞ÊçÆÔºàÁ®çÂæÆÂÅèÁßªÂùêÊ†áÔºâ
                const userOffset = {
                    lat: ((user.id.charCodeAt(0) % 10) - 5) * 0.001, // -0.005 Âà∞ 0.005
                    lng: ((user.id.charCodeAt(1) % 10) - 5) * 0.001
                };
                
                const userData = {};
                Object.keys(baseData).forEach(date => {
                    if (baseData[date] && baseData[date].path) {
                        userData[date] = {
                            ...baseData[date],
                            path: baseData[date].path.map(point => ({
                                lat: point.lat + userOffset.lat,
                                lng: point.lng + userOffset.lng,
                                timestamp: point.timestamp || new Date().toISOString()
                            }))
                        };
                    }
                });
                
                console.log('üìä ÁîüÊàêÁî®Êà∑ËΩ®ËøπÊï∞ÊçÆÂÆåÊàêÔºåÂÖ±', Object.keys(userData).length, '‰∏™Êó•Êúü');
                return userData;
                
            } catch (error) {
                console.error('‚ùå ÁîüÊàêÁî®Êà∑ËΩ®ËøπÊï∞ÊçÆÂ§±Ë¥•:', error);
                return generateMockTrackingData();
            }
        }

        // ÁîüÊàêÊ®°ÊãüÁîµÊ±†Êï∞ÊçÆ
        function generateMockBatteryData(count) {
            const data = [];
            const now = new Date();
            
            for (let i = 0; i < count; i++) {
                const timestamp = new Date(now.getTime() - (count - i) * 60000);
                data.push({
                    timestamp: timestamp.toISOString(),
                    voltage: 3.3 + Math.random() * 0.8, // 3.3V - 4.1V
                    current: 0.2 + Math.random() * 0.6   // 0.2A - 0.8A
                });
            }
            
            return data;
        }

        // ÁîüÊàêÊ®°ÊãüËΩ®ËøπÊï∞ÊçÆ
        function generateMockTrackingData() {
            const data = {};
            const baseLocation = { lat: 39.9042, lng: 116.4074 }; // Âåó‰∫¨Â§©ÂÆâÈó®
            
            // ÁîüÊàêÊúÄËøë7Â§©ÁöÑÊï∞ÊçÆ
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const path = [];
                for (let j = 0; j < 20; j++) {
                    path.push({
                        lat: baseLocation.lat + (Math.random() - 0.5) * 0.02,
                        lng: baseLocation.lng + (Math.random() - 0.5) * 0.02,
                        timestamp: new Date(date.getTime() + j * 60000).toISOString()
                    });
                }
                
                data[dateStr] = {
                    path: path,
                    totalDistance: Math.round(Math.random() * 50 + 10) // 10-60km
                };
            }
            
            return data;
        }

        // Âä†ËΩΩÁîµÊ±†ÂõæË°®
        function loadBatteryChart(batteryData) {
            // ÈîÄÊØÅÁé∞ÊúâÂõæË°®
            if (monitoringBatteryChart) {
                monitoringBatteryChart.destroy();
                monitoringBatteryChart = null;
            }
            
            const canvas = document.getElementById('monitoringBatteryChart');
            if (!canvas) {
                console.error('‚ùå Êâæ‰∏çÂà∞ÁîµÊ±†ÂõæË°®ÁîªÂ∏É');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // ÂáÜÂ§áÊï∞ÊçÆ
            const labels = batteryData.map(item => 
                new Date(item.timestamp).toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                })
            );
            const voltageData = batteryData.map(item => item.voltage);
            const currentData = batteryData.map(item => item.current);
            
            // ÂàõÂª∫ÂõæË°®
            monitoringBatteryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ÁîµÂéã (V)',
                            data: voltageData,
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            fill: true,
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'ÁîµÊµÅ (A)',
                            data: currentData,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            fill: true,
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#333333' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#666666' },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#4facfe' },
                            grid: { color: 'rgba(79,172,254,0.1)' },
                            title: { display: true, text: 'ÁîµÂéã (V)', color: '#4facfe' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#ff6b6b' },
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'ÁîµÊµÅ (A)', color: '#ff6b6b' }
                        }
                    }
                }
            });
            
            // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
            updateBatteryStats(batteryData);
            
            console.log('üìä ÁîµÊ±†ÁõëÊéßÂõæË°®Â∑≤Âä†ËΩΩÔºåÊï∞ÊçÆÁÇπÊï∞:', batteryData.length);
        }

        // Êõ¥Êñ∞ÁîµÊ±†ÁªüËÆ°‰ø°ÊÅØ
        function updateBatteryStats(batteryData) {
            if (batteryData.length === 0) {
                document.getElementById('currentVoltage').textContent = '--V';
                document.getElementById('currentCurrent').textContent = '--A';
                document.getElementById('dataPointCount').textContent = '0';
                return;
            }
            
            const latest = batteryData[batteryData.length - 1];
            document.getElementById('currentVoltage').textContent = latest.voltage.toFixed(2) + 'V';
            document.getElementById('currentCurrent').textContent = latest.current.toFixed(2) + 'A';
            document.getElementById('dataPointCount').textContent = batteryData.length;
        }

        // Âä†ËΩΩÊó•ÊúüÈÄâÊã©Âô®
        function loadDateSelector(trackingData) {
            const selector = document.getElementById('dateSelector');
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            selector.innerHTML = '<option value="">ÈÄâÊã©Êó•Êúü</option>';
            
            // Ê∑ªÂä†ÂèØÁî®Êó•Êúü
            const dates = Object.keys(trackingData).sort().reverse(); // ÊúÄÊñ∞Êó•ÊúüÂú®Ââç
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = new Date(date).toLocaleDateString('zh-CN');
                selector.appendChild(option);
            });
            
            // ÈªòËÆ§ÈÄâÊã©ÊúÄÊñ∞Êó•Êúü
            if (dates.length > 0) {
                selector.value = dates[0];
                switchTrackingDate();
            }
            
            console.log('üìÖ Êó•ÊúüÈÄâÊã©Âô®Â∑≤Êõ¥Êñ∞ÔºåÂÖ±', dates.length, '‰∏™Êó•Êúü');
        }

        // ÂàáÊç¢ËΩ®ËøπÊó•Êúü
        function switchTrackingDate() {
            const selector = document.getElementById('dateSelector');
            const selectedDate = selector.value;
            
            if (!selectedDate || !currentMonitoringUser) {
                return;
            }
            
            currentTrackingDate = selectedDate;
            const trackingData = userDataMapping[currentMonitoringUser.id].trackingData;
            
            if (trackingData[selectedDate]) {
                loadTrackingMap(trackingData[selectedDate]);
            } else {
                console.warn('‚ö†Ô∏è ÈÄâÂÆöÊó•ÊúüÊó†ËΩ®ËøπÊï∞ÊçÆ:', selectedDate);
            }
        }

        // Âä†ËΩΩËΩ®ËøπÂú∞Âõæ
        function loadTrackingMap(dayData) {
            console.log('üó∫Ô∏è ÂºÄÂßãÂä†ËΩΩËΩ®ËøπÂú∞ÂõæÔºåÊï∞ÊçÆ:', dayData);
            
            const mapContainer = document.getElementById('monitoringMap');
            
            // ÂàùÂßãÂåñÂú∞ÂõæÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÂàùÂßãÂåñÔºâ
            if (!monitoringMap) {
                console.log('üó∫Ô∏è ÂàùÂßãÂåñÂú∞Âõæ...');
                try {
                    monitoringMap = L.map('monitoringMap').setView([26.7638, 106.046], 13); // ‰ΩøÁî®ÂÆûÈôÖÊï∞ÊçÆÁöÑ‰∏≠ÂøÉÁÇπ
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(monitoringMap);
                    
                    console.log('‚úÖ Âú∞ÂõæÂàùÂßãÂåñÊàêÂäü');
                } catch (error) {
                    console.error('‚ùå Âú∞ÂõæÂàùÂßãÂåñÂ§±Ë¥•:', error);
                    return;
                }
            }
            
            // Ê∏ÖÈô§Áé∞ÊúâËΩ®Ëøπ
            if (trackingLayer) {
                monitoringMap.removeLayer(trackingLayer);
                trackingLayer = null;
            }
            
            const path = dayData.path;
            console.log('üìç ËΩ®ËøπË∑ØÂæÑÊï∞ÊçÆ:', path);
            
            if (!path || path.length === 0) {
                console.warn('‚ö†Ô∏è ÂΩìÊó•Êó†ËΩ®ËøπÊï∞ÊçÆ');
                return;
            }
            
            // È™åËØÅË∑ØÂæÑÊï∞ÊçÆÊ†ºÂºè
            const validPath = path.filter(point => 
                point && 
                typeof point.lat === 'number' && 
                typeof point.lng === 'number' &&
                !isNaN(point.lat) && 
                !isNaN(point.lng)
            );
            
            if (validPath.length === 0) {
                console.error('‚ùå Ê≤°ÊúâÊúâÊïàÁöÑËΩ®ËøπÁÇπÊï∞ÊçÆ');
                return;
            }
            
            console.log('‚úÖ ÊúâÊïàËΩ®ËøπÁÇπÊï∞:', validPath.length);
            
            try {
                // ÂàõÂª∫Êñ∞ÁöÑÂõæÂ±ÇÁªÑ
                trackingLayer = L.layerGroup();
                
                // ËΩ¨Êç¢Ë∑ØÂæÑÊ†ºÂºè
                const latLngs = validPath.map(point => [point.lat, point.lng]);
                console.log('üìç ËΩ¨Êç¢ÂêéÁöÑÂùêÊ†á:', latLngs);
                
                // Ê∑ªÂä†ËΩ®ËøπÁ∫ø
                const polyline = L.polyline(latLngs, {
                    color: '#667eea',
                    weight: 4,
                    opacity: 0.8
                });
                trackingLayer.addLayer(polyline);
                
                // Ê∑ªÂä†Ëµ∑ÁÇπÊ†áËÆ∞
                if (validPath.length > 0) {
                    const startMarker = L.marker([validPath[0].lat, validPath[0].lng], {
                        icon: L.divIcon({
                            className: 'custom-marker start-marker',
                            html: 'üöÄ',
                            iconSize: [25, 25],
                            iconAnchor: [12, 12]
                        })
                    }).bindPopup(`Ëµ∑ÁÇπ<br>ÂùêÊ†á: ${validPath[0].lat.toFixed(4)}, ${validPath[0].lng.toFixed(4)}`);
                    trackingLayer.addLayer(startMarker);
                }
                
                // Ê∑ªÂä†ÁªàÁÇπÊ†áËÆ∞
                if (validPath.length > 1) {
                    const lastPoint = validPath[validPath.length - 1];
                    const endMarker = L.marker([lastPoint.lat, lastPoint.lng], {
                        icon: L.divIcon({
                            className: 'custom-marker end-marker',
                            html: 'üèÅ',
                            iconSize: [25, 25],
                            iconAnchor: [12, 12]
                        })
                    }).bindPopup(`ÁªàÁÇπ<br>ÂùêÊ†á: ${lastPoint.lat.toFixed(4)}, ${lastPoint.lng.toFixed(4)}`);
                    trackingLayer.addLayer(endMarker);
                }
                
                // Ê∑ªÂä†Âà∞Âú∞Âõæ
                trackingLayer.addTo(monitoringMap);
                
                // Ë∞ÉÊï¥Âú∞ÂõæËßÜÈáé‰ª•ÈÄÇÂ∫îËΩ®Ëøπ
                if (latLngs.length > 0) {
                    const bounds = polyline.getBounds();
                    monitoringMap.fitBounds(bounds, { padding: [20, 20] });
                    console.log('üó∫Ô∏è Âú∞ÂõæËßÜÈáéÂ∑≤Ë∞ÉÊï¥Âà∞ËΩ®ËøπËåÉÂõ¥');
                }
                
                // Êõ¥Êñ∞ËΩ®ËøπÁªüËÆ°
                updateTrackingStats(dayData);
                
                console.log('‚úÖ ËΩ®ËøπÂú∞ÂõæÂä†ËΩΩÂÆåÊàêÔºåË∑ØÂæÑÁÇπÊï∞:', validPath.length);
                
            } catch (error) {
                console.error('‚ùå Âú∞ÂõæÂä†ËΩΩÂ§±Ë¥•:', error);
            }
        }

        function updateTrackingStats(dayData) {
            const path = dayData.path || [];
            
            document.getElementById('trackPointCount').textContent = path.length;
            
            // ‰ΩøÁî®ÂÆûÈôÖÁöÑË∑ùÁ¶ªÊï∞ÊçÆ
            const distance = dayData.totalDistance || dayData.Distance || dayData.distance || 0;
            document.getElementById('totalDistance').textContent = distance + ' km';
            
            // ËÆ°ÁÆóÊ¥ªÂä®Êó∂Èó¥
            if (path.length > 1) {
                // Â∞ùËØïËß£ÊûêÊó∂Èó¥Êà≥
                let startTime, endTime;
                
                if (path[0].timestamp) {
                    startTime = new Date(path[0].timestamp);
                } else {
                    startTime = new Date(); // ÈªòËÆ§ÂΩìÂâçÊó∂Èó¥
                }
                
                if (path[path.length - 1].timestamp) {
                    endTime = new Date(path[path.length - 1].timestamp);
                } else {
                    endTime = new Date(startTime.getTime() + path.length * 60000); // ÈªòËÆ§ÊØè‰∏™ÁÇπÈó¥Èöî1ÂàÜÈíü
                }
                
                const duration = Math.round((endTime - startTime) / 60000); // ÂàÜÈíü
                document.getElementById('activityTime').textContent = duration > 0 ? duration + ' ÂàÜÈíü' : '1 ÂàÜÈíü';
            } else {
                document.getElementById('activityTime').textContent = '--';
            }
            
            document.getElementById('trackingStats').style.display = 'block';
        }

        // ÊòæÁ§∫ÁõëÊéßÊï∞ÊçÆ
        function showMonitoringData() {
            document.getElementById('monitoringDataContainer').style.display = 'block';
            document.getElementById('noDataMessage').style.display = 'none';
        }

        // ÈöêËóèÁõëÊéßÊï∞ÊçÆ
        function hideMonitoringData() {
            document.getElementById('monitoringDataContainer').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('selectedUserInfo').style.display = 'none';
            currentMonitoringUser = null;
            currentTrackingDate = null;
        }

        // Âà∑Êñ∞ÁîµÊ±†Êï∞ÊçÆ
        function refreshBatteryData() {
            if (!currentMonitoringUser) return;
            
            const refreshIcon = document.getElementById('batteryRefreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            setTimeout(() => {
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫Á¨¨‰∏Ä‰∏™Áî®Êà∑
                const isFirst = isFirstUser(currentMonitoringUser.id);
                
                // ÈáçÊñ∞ÁîüÊàêÊï∞ÊçÆÔºàÊ®°ÊãüÂÆûÊó∂Êõ¥Êñ∞Ôºâ
                let newBatteryData = generateUserBatteryData(currentMonitoringUser);
                
                // Â¶ÇÊûú‰∏çÊòØÁ¨¨‰∏Ä‰∏™Áî®Êà∑ÔºåÊâì‰π±Êï∞ÊçÆ
                if (!isFirst) {
                    newBatteryData = shuffleArray([...newBatteryData]);
                    console.log(`üîÄ Âà∑Êñ∞Êó∂Êâì‰π±‰∫ÜÁî®Êà∑ ${currentMonitoringUser.name} ÁöÑÁîµÊ±†Êï∞ÊçÆ`);
                }
                
                userDataMapping[currentMonitoringUser.id].batteryData = newBatteryData;
                loadBatteryChart(userDataMapping[currentMonitoringUser.id].batteryData);
                
                refreshIcon.style.animation = '';
                showSuccessMessage('ÁîµÊ±†Êï∞ÊçÆÂ∑≤Âà∑Êñ∞');
            }, 1000);
        }

        // Âà∑Êñ∞Âú∞ÂõæÊï∞ÊçÆ
        function refreshMapData() {
            if (!currentMonitoringUser || !currentTrackingDate) return;
            
            const refreshIcon = document.getElementById('mapRefreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            setTimeout(() => {
                const trackingData = userDataMapping[currentMonitoringUser.id].trackingData;
                if (trackingData[currentTrackingDate]) {
                    loadTrackingMap(trackingData[currentTrackingDate]);
                }
                
                refreshIcon.style.animation = '';
                showSuccessMessage('Âú∞ÂõæÊï∞ÊçÆÂ∑≤Âà∑Êñ∞');
            }, 1000);
        }

        // ËÆæÁΩÆÁõëÊéßÁªÑ‰ª∂
        function setupMonitoringComponents() {
            // ÁõëÂê¨Áî®Êà∑ÂàóË°®ÂèòÂåñÔºåÊõ¥Êñ∞ÈÄâÊã©Âô®
            const originalAddUser = addNewUser;
            const originalDeleteUser = deleteUser;
            
            // Âú®Áî®Êà∑Ê∑ªÂä†ÂêéÊõ¥Êñ∞ÁõëÊéßÈÄâÊã©Âô®
            window.addNewUser = function() {
                originalAddUser();
                setTimeout(() => {
                    loadUserSelector();
                }, 100);
            };
            
            // Âú®Áî®Êà∑Âà†Èô§ÂêéÊõ¥Êñ∞ÁõëÊéßÈÄâÊã©Âô®
            window.deleteUser = function(userId) {
                // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÁõëÊéßÁî®Êà∑ÔºåÊ∏ÖÁ©∫ÁõëÊéß
                if (currentMonitoringUser && currentMonitoringUser.id === userId) {
                    hideMonitoringData();
                }
                
                // Âà†Èô§Áî®Êà∑Êï∞ÊçÆÊò†Â∞Ñ
                delete userDataMapping[userId];
                
                originalDeleteUser(userId);
                setTimeout(() => {
                    loadUserSelector();
                }, 100);
            };
        }


        /* ---------- Êï∞ÊçÆÂàÜÊûêÈ°µÈù¢ÂäüËÉΩ ---------- */

        // ÂàùÂßãÂåñÂàÜÊûêÈ°µÈù¢
        function initializeAnalyticsPage() {
            loadAnalyticsUserSelector();
        }

        // Âä†ËΩΩÁî®Êà∑ÈÄâÊã©Âô®
        function loadAnalyticsUserSelector() {
            const selector = document.getElementById('analyticsUserSelect');
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            selector.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Áî®Êà∑</option>';
            
            // Ê∑ªÂä†Â∑≤ÂΩïÂÖ•ÁöÑÁî®Êà∑
            userList.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.device || 'Êó†ËÆæÂ§á'})`;
                selector.appendChild(option);
            });
            
            console.log('üìã ÂàÜÊûêÁî®Êà∑ÈÄâÊã©Âô®Â∑≤Êõ¥Êñ∞ÔºåÂÖ±', userList.length, '‰∏™Áî®Êà∑');
        }

        // ÂàáÊç¢ÂàÜÊûêÁî®Êà∑
        function switchAnalyticsUser() {
            const selector = document.getElementById('analyticsUserSelect');
            const userId = selector.value;
            
            if (!userId) {
                hideAnalyticsData();
                return;
            }
            
            const user = userList.find(u => u.id === userId);
            if (!user) {
                console.error('‚ùå ÂàÜÊûêÁî®Êà∑Êú™ÊâæÂà∞:', userId);
                return;
            }
            
            currentAnalyticsUser = user;
            displayAnalyticsUserInfo(user);
            loadUserAnalyticsData(user);
            showAnalyticsData();
            
            console.log('üîç ÂàáÊç¢Âà∞ÂàÜÊûêÁî®Êà∑:', user.name);
        }

        // ÊòæÁ§∫ÂàÜÊûêÁî®Êà∑‰ø°ÊÅØ
        function displayAnalyticsUserInfo(user) {
            document.getElementById('analyticsCurrentUserName').textContent = user.name;
            document.getElementById('analyticsCurrentUserRole').textContent = getRoleDisplayName(user.role);
            document.getElementById('analyticsCurrentUserDevice').textContent = user.device || 'Êú™ÂàÜÈÖç';
            
            document.getElementById('analyticsSelectedUserInfo').style.display = 'block';
        }

        // Âä†ËΩΩÁî®Êà∑ÂàÜÊûêÊï∞ÊçÆ
        function loadUserAnalyticsData(user) {
            // Á°Æ‰øùÁî®Êà∑Êï∞ÊçÆÊò†Â∞ÑÂ≠òÂú®
            if (!userDataMapping[user.id]) {
                // Ê£ÄÊü•ÂΩìÂâçÁî®Êà∑ÊòØÂê¶ÊòØÁ¨¨‰∏Ä‰∏™Áî®Êà∑
                const isFirstUser = userList.length > 0 && userList[0].id === user.id;
                
                let batteryData = generateUserBatteryData(user);
                let trackingData = generateUserTrackingData(user);
                
                // Â¶ÇÊûú‰∏çÊòØÁ¨¨‰∏Ä‰∏™Áî®Êà∑ÔºåÊâì‰π±Êï∞ÊçÆÈ°∫Â∫è
                if (!isFirstUser) {
                    batteryData = shuffleArray([...batteryData]); // ÂàõÂª∫ÂâØÊú¨Âπ∂Êâì‰π±
                    trackingData = shuffleTrackingData(trackingData); // Êâì‰π±ËΩ®ËøπÊï∞ÊçÆ
                    console.log(`üîÄ ÂàÜÊûêÁî®Êà∑ ${user.name} ÁöÑÊï∞ÊçÆÂ∑≤Êâì‰π±È°∫Â∫è`);
                } else {
                    console.log(`üìä ÂàÜÊûêÁî®Êà∑ ${user.name} ÊòØÁ¨¨‰∏Ä‰∏™Áî®Êà∑Ôºå‰øùÊåÅÂéüÂßãÊï∞ÊçÆÈ°∫Â∫è`);
                }
                
                userDataMapping[user.id] = {
                    batteryData: batteryData,
                    trackingData: trackingData
                };
            }
            
            // ÂàÜÊûêÁîµÊ±†Êï∞ÊçÆ
            analyzeBatteryData(userDataMapping[user.id].batteryData);
            
            // ÂàÜÊûêË∑ØÂæÑÊï∞ÊçÆ
            analyzePathData(userDataMapping[user.id].trackingData);
            
            // ÁîüÊàêÁªºÂêàËØÑ‰º∞
            generateEvaluationReport(user);
        }

        // ÂàÜÊûêÁîµÊ±†Êï∞ÊçÆ
        function analyzeBatteryData(batteryData) {
            if (!batteryData || batteryData.length === 0) {
                console.warn('‚ö†Ô∏è Êó†ÁîµÊ±†Êï∞ÊçÆËøõË°åÂàÜÊûê');
                return;
            }
            
            console.log('üîã ÂºÄÂßãÂàÜÊûêÁîµÊ±†Êï∞ÊçÆÔºåÂÖ±', batteryData.length, 'Êù°ËÆ∞ÂΩï');
            
            // ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆ
            const voltages = batteryData.map(d => d.voltage);
            const currents = batteryData.map(d => d.current);
            
            const avgVoltage = voltages.reduce((a, b) => a + b, 0) / voltages.length;
            const avgCurrent = currents.reduce((a, b) => a + b, 0) / currents.length;
            const maxVoltage = Math.max(...voltages);
            const minVoltage = Math.min(...voltages);
            
            // ËÆ°ÁÆóÁîµÊ±†ÂÅ•Â∫∑Â∫¶ (Âü∫‰∫éÁîµÂéãÁ®≥ÂÆöÊÄßÂíåËåÉÂõ¥)
            const voltageRange = maxVoltage - minVoltage;
            const voltageStability = 1 - (voltageRange / maxVoltage);
            const healthScore = Math.min(100, Math.max(0, (voltageStability * 100 + (avgVoltage / 8.4) * 100) / 2));
            
            // ËÆ°ÁÆó‰ΩøÁî®ÊïàÁéá (Âü∫‰∫éÁîµÊµÅÁ®≥ÂÆöÊÄß)
            const currentStdDev = calculateStandardDeviation(currents);
            const efficiencyScore = Math.min(100, Math.max(0, 100 - (currentStdDev * 200)));
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            document.getElementById('avgVoltage').textContent = avgVoltage.toFixed(2) + 'V';
            document.getElementById('avgCurrent').textContent = avgCurrent.toFixed(2) + 'A';
            document.getElementById('batteryHealth').textContent = healthScore.toFixed(0) + '%';
            document.getElementById('efficiency').textContent = efficiencyScore.toFixed(0) + '%';
            
            // Êõ¥Êñ∞Ë∂ãÂäøÊåáÁ§∫Âô®
            updateTrendIndicators(batteryData);
            
            // ÂàõÂª∫Ë∂ãÂäøÂõæË°®
            createBatteryTrendChart(batteryData);
            
            // ÁîüÊàêÂª∫ËÆÆ
            generateBatteryRecommendations(avgVoltage, avgCurrent, healthScore, efficiencyScore);
        }

        // ËÆ°ÁÆóÊ†áÂáÜÂ∑Æ
        function calculateStandardDeviation(values) {
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - avg, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
            return Math.sqrt(avgSquareDiff);
        }

        // Êõ¥Êñ∞Ë∂ãÂäøÊåáÁ§∫Âô®
        function updateTrendIndicators(batteryData) {
            if (batteryData.length < 10) return;
            
            const recent = batteryData.slice(-5);
            const previous = batteryData.slice(-10, -5);
            
            const recentAvgVoltage = recent.reduce((a, b) => a + b.voltage, 0) / recent.length;
            const previousAvgVoltage = previous.reduce((a, b) => a + b.voltage, 0) / previous.length;
            
            const voltageTrend = recentAvgVoltage > previousAvgVoltage ? 'up' : 
                                recentAvgVoltage < previousAvgVoltage ? 'down' : 'stable';
            
            const voltageTrendElement = document.getElementById('voltageTrend');
            voltageTrendElement.className = `stat-trend trend-${voltageTrend}`;
            voltageTrendElement.textContent = voltageTrend === 'up' ? '‚Üó ‰∏äÂçá' : 
                                            voltageTrend === 'down' ? '‚Üò ‰∏ãÈôç' : '‚Üí Á®≥ÂÆö';
        }

        // ÂàõÂª∫ÁîµÊ±†Ë∂ãÂäøÂõæË°®
        function createBatteryTrendChart(batteryData) {
            if (batteryTrendChart) {
                batteryTrendChart.destroy();
            }
            
            const canvas = document.getElementById('batteryTrendChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // ÂáÜÂ§áÊï∞ÊçÆ - Âè™ÊòæÁ§∫ÊúÄËøë24Â∞èÊó∂ÁöÑÊï∞ÊçÆ
            const recentData = batteryData;
            const labels = recentData.map((_, index) => `${index + 1}h`);
            const voltageData = recentData.map(d => d.voltage);
            const currentData = recentData.map(d => d.current);
            
            batteryTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ÁîµÂéãË∂ãÂäø',
                            data: voltageData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'ÁîµÊµÅË∂ãÂäø',
                            data: currentData,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'ÁîµÂéã (V)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ÁîµÊµÅ (A)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        // ÁîüÊàêÁîµÊ±†Âª∫ËÆÆ
        function generateBatteryRecommendations(avgVoltage, avgCurrent, healthScore, efficiencyScore) {
            // ÂÖÖÁîµÂª∫ËÆÆ
            let chargingAdvice = '';
            if (avgVoltage < 7.2) {
                chargingAdvice = 'ÁîµÂéãÂÅè‰ΩéÔºåÂª∫ËÆÆÂèäÊó∂ÂÖÖÁîµ„ÄÇÈÅøÂÖçÊ∑±Â∫¶ÊîæÁîµ‰ª•Âª∂ÈïøÁîµÊ±†ÂØøÂëΩ„ÄÇ';
            } else if (avgVoltage > 8.0) {
                chargingAdvice = 'ÁîµÂéãÊ≠£Â∏∏ÂÅèÈ´òÔºåÂª∫ËÆÆÈÄÇÂ∫¶‰ΩøÁî®ÂêéÂÜçÂÖÖÁîµÔºåÈÅøÂÖçËøáÂ∫¶ÂÖÖÁîµ„ÄÇ';
            } else {
                chargingAdvice = 'ÁîµÂéãÊ∞¥Âπ≥ËâØÂ•ΩÔºå‰øùÊåÅÂΩìÂâçÂÖÖÁîµ‰π†ÊÉØÂç≥ÂèØ„ÄÇ';
            }
            
            // ‰ΩøÁî®Âª∫ËÆÆ
            let usageAdvice = '';
            if (efficiencyScore < 60) {
                usageAdvice = '‰ΩøÁî®ÊïàÁéáÂÅè‰ΩéÔºåÂª∫ËÆÆÊ£ÄÊü•ËÆæÂ§áË¥üËΩΩÔºåÈÅøÂÖçË∂ÖËΩΩ‰ΩøÁî®„ÄÇ';
            } else if (efficiencyScore > 85) {
                usageAdvice = '‰ΩøÁî®ÊïàÁéáÂæàÈ´òÔºåÁªßÁª≠‰øùÊåÅËâØÂ•ΩÁöÑ‰ΩøÁî®‰π†ÊÉØ„ÄÇ';
            } else {
                usageAdvice = '‰ΩøÁî®ÊïàÁéáÊ≠£Â∏∏ÔºåÂèØÈÄÇÂΩì‰ºòÂåñ‰ΩøÁî®ÊñπÂºèÊèêÂçáÊïàÁéá„ÄÇ';
            }
            
            // Áª¥Êä§Âª∫ËÆÆ
            let maintenanceAdvice = '';
            if (healthScore < 70) {
                maintenanceAdvice = 'ÁîµÊ±†ÂÅ•Â∫∑Â∫¶ËæÉ‰ΩéÔºåÂª∫ËÆÆËøõË°å‰∏ì‰∏öÊ£ÄÊµãÂíåÁª¥Êä§„ÄÇ';
            } else if (healthScore > 90) {
                maintenanceAdvice = 'ÁîµÊ±†Áä∂ÊÄÅËâØÂ•ΩÔºåÁªßÁª≠ÂÆöÊúü‰øùÂÖªÂç≥ÂèØ„ÄÇ';
            } else {
                maintenanceAdvice = 'ÁîµÊ±†Áä∂ÊÄÅÊ≠£Â∏∏ÔºåÂª∫ËÆÆÂÆöÊúüÊ∏ÖÊ¥ÅÊé•Ëß¶ÁÇπ„ÄÇ';
            }
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            document.getElementById('chargingAdvice').textContent = chargingAdvice;
            document.getElementById('usageAdvice').textContent = usageAdvice;
            document.getElementById('maintenanceAdvice').textContent = maintenanceAdvice;
        }

        // ÂàÜÊûêË∑ØÂæÑÊï∞ÊçÆ
        function analyzePathData(trackingData) {
            if (!trackingData || Object.keys(trackingData).length === 0) {
                console.warn('‚ö†Ô∏è Êó†Ë∑ØÂæÑÊï∞ÊçÆËøõË°åÂàÜÊûê');
                return;
            }
            
            console.log('üó∫Ô∏è ÂºÄÂßãÂàÜÊûêË∑ØÂæÑÊï∞ÊçÆÔºåÂÖ±', Object.keys(trackingData).length, 'Â§©ËÆ∞ÂΩï');
            
            const period = parseInt(document.getElementById('pathAnalysisPeriod').value);
            const dates = Object.keys(trackingData).sort().slice(-period);
            
            let totalDistance = 0;
            let activeDays = 0;
            let allPoints = [];
            
            dates.forEach(date => {
                const dayData = trackingData[date];
                if (dayData && dayData.path && dayData.path.length > 0) {
                    totalDistance += dayData.totalDistance || 0;
                    activeDays++;
                    allPoints.push(...dayData.path);
                }
            });
            
            const avgDailyDistance = activeDays > 0 ? (totalDistance / activeDays) : 0;
            const coverageArea = calculateCoverageArea(allPoints);
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            document.getElementById('totalDistance').textContent = totalDistance.toFixed(1) + ' km';
            document.getElementById('activeDays').textContent = activeDays + ' Â§©';
            document.getElementById('avgDailyDistance').textContent = avgDailyDistance.toFixed(1) + ' km';
            document.getElementById('coverageArea').textContent = coverageArea.toFixed(2) + ' km¬≤';
            
            // ÂàõÂª∫Ë∑ØÂæÑÂàÜÊûêÂú∞Âõæ
            createPathAnalysisMap(allPoints, dates, trackingData);
            
            // ÂàÜÊûêË∑ØÂæÑÊ®°Âºè
            analyzePathPatterns(trackingData, dates);
        }

        // ËÆ°ÁÆóË¶ÜÁõñÈù¢ÁßØ
        function calculateCoverageArea(points) {
            if (points.length < 3) return 0;
            
            const lats = points.map(p => p.lat);
            const lngs = points.map(p => p.lng);
            
            const minLat = Math.min(...lats);
            const maxLat = Math.max(...lats);
            const minLng = Math.min(...lngs);
            const maxLng = Math.max(...lngs);
            
            // ÁÆÄÂåñËÆ°ÁÆóÔºöÁü©ÂΩ¢Èù¢ÁßØÔºàÂÆûÈôÖÂ∫îËØ•Áî®Âá∏ÂåÖÁÆóÊ≥ïÔºâ
            const latDiff = maxLat - minLat;
            const lngDiff = maxLng - minLng;
            
            // ËΩ¨Êç¢‰∏∫Â§ßÁ∫¶ÁöÑkm¬≤ÔºàÁ≤óÁï•ËÆ°ÁÆóÔºâ
            return latDiff * lngDiff * 111 * 111; // 1Â∫¶Á∫¶Á≠â‰∫é111km
        }

        // ÂàõÂª∫Ë∑ØÂæÑÂàÜÊûêÂú∞Âõæ
        function createPathAnalysisMap(allPoints, dates, trackingData) {
            if (!allPoints || allPoints.length === 0) return;
            
            // ÂàùÂßãÂåñÂú∞Âõæ
            if (!analyticsMap) {
                analyticsMap = L.map('pathAnalysisMap').setView([26.7638, 106.046], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(analyticsMap);
            }
            
            // Ê∏ÖÈô§Áé∞ÊúâÂõæÂ±Ç
            if (heatmapLayer) {
                analyticsMap.removeLayer(heatmapLayer);
            }
            if (coverageLayer) {
                analyticsMap.removeLayer(coverageLayer);
            }
            
            // ÂàõÂª∫Ë¶ÜÁõñÂå∫Âüü
            if (allPoints.length > 0) {
                const latlngs = allPoints.map(p => [p.lat, p.lng]);
                coverageLayer = L.polygon(latlngs, {
                    color: 'rgba(102, 126, 234, 0.3)',
                    fillColor: 'rgba(102, 126, 234, 0.1)',
                    fillOpacity: 0.3
                }).addTo(analyticsMap);
                
                // Ë∞ÉÊï¥ËßÜÈáé
                analyticsMap.fitBounds(coverageLayer.getBounds(), { padding: [20, 20] });
            }
            
            // ÁªòÂà∂ÊØèÂ§©ÁöÑË∑ØÂæÑ
            dates.forEach((date, index) => {
                const dayData = trackingData[date];
                if (dayData && dayData.path && dayData.path.length > 0) {
                    const path = dayData.path.map(p => [p.lat, p.lng]);
                    const color = `hsl(${(index * 137.5) % 360}, 70%, 50%)`; // ‰∏çÂêåÈ¢úËâ≤
                    
                    L.polyline(path, {
                        color: color,
                        weight: 3,
                        opacity: 0.7
                    }).addTo(analyticsMap);
                }
            });
        }

        // ÂàÜÊûêË∑ØÂæÑÊ®°Âºè
        function analyzePathPatterns(trackingData, dates) {
            // ÂàÜÊûêÂ∏∏Áî®Âå∫Âüü
            const frequentAreas = analyzeFrequentAreas(trackingData, dates);
            document.getElementById('frequentAreas').innerHTML = frequentAreas;
            
            // ÂàÜÊûêÊ¥ªÂä®Êó∂ÊÆµ
            const timePatterns = analyzeTimePatterns(trackingData, dates);
            document.getElementById('activeTimePatterns').innerHTML = timePatterns;
            
            // ÂàÜÊûêÈ™ëË°å‰π†ÊÉØ
            const ridingHabits = analyzeRidingHabits(trackingData, dates);
            document.getElementById('ridingHabits').innerHTML = ridingHabits;
        }

        // ÂàÜÊûêÂ∏∏Áî®Âå∫Âüü
        function analyzeFrequentAreas(trackingData, dates) {
            if (dates.length === 0) return 'ÊöÇÊó†Êï∞ÊçÆ';
            
            // ÁÆÄÂåñÂàÜÊûêÔºöÂü∫‰∫éÊ¥ªÂä®Â§©Êï∞ÁöÑÁôæÂàÜÊØî
            const activeRatio = (dates.length / 7) * 100;
            
            if (activeRatio > 80) {
                return 'üü¢ È´òÈ¢ëÊ¥ªÂä®Âå∫Âüü<br>ËØ•Áî®Êà∑Âú®Ê≠§Âå∫ÂüüÊ¥ªÂä®È¢ëÁπÅÔºåÂª∫ËÆÆ‰ºòÂåñÂÖÖÁîµËÆæÊñΩÂ∏ÉÂ±Ä';
            } else if (activeRatio > 50) {
                return 'üü° ‰∏≠È¢ëÊ¥ªÂä®Âå∫Âüü<br>Áî®Êà∑Âú®Ê≠§Âå∫ÂüüÊúâÂÆöÊúüÊ¥ªÂä®ÔºåÂèØËÄÉËôëÂ¢ûÂä†ÊúçÂä°ÁÇπ';
            } else {
                return 'üîµ ‰ΩéÈ¢ëÊ¥ªÂä®Âå∫Âüü<br>ÂÅ∂Â∞îÁªèËøáÂå∫ÂüüÔºåÂèØ‰Ωú‰∏∫Êâ©Â±ïÊúçÂä°ËåÉÂõ¥ÂèÇËÄÉ';
            }
        }

        // ÂàÜÊûêÊ¥ªÂä®Êó∂ÊÆµ
        function analyzeTimePatterns(trackingData, dates) {
            if (dates.length === 0) return 'ÊöÇÊó†Êï∞ÊçÆ';
            
            // Ê®°ÊãüÊó∂ÊÆµÂàÜÊûê
            const patterns = ['‰∏äÂçà 9-11ÁÇπ', '‰∏ãÂçà 2-4ÁÇπ', 'ÂÇçÊôö 6-8ÁÇπ'];
            const mainPattern = patterns[Math.floor(Math.random() * patterns.length)];
            
            return `‰∏ªË¶ÅÊ¥ªÂä®Êó∂ÊÆµÔºö<strong>${mainPattern}</strong><br>Âª∫ËÆÆÂú®Ê≠§Êó∂ÊÆµÂä†Âº∫ËÆæÂ§áÁõëÊéß`;
        }

        // ÂàÜÊûêÈ™ëË°å‰π†ÊÉØ
        function analyzeRidingHabits(trackingData, dates) {
            if (dates.length === 0) return 'ÊöÇÊó†Êï∞ÊçÆ';
            
            let totalDistance = 0;
            dates.forEach(date => {
                const dayData = trackingData[date];
                if (dayData) {
                    totalDistance += dayData.totalDistance || 0;
                }
            });
            
            const avgDaily = totalDistance / Math.max(dates.length, 1);
            
            if (avgDaily > 20) {
                return 'üö¥‚Äç‚ôÇÔ∏è <strong>ÈïøË∑ùÁ¶ªÈ™ëË°å</strong><br>Âπ≥ÂùáÊØèÊó•' + avgDaily.toFixed(1) + 'kmÔºåÂ±û‰∫éÈ´òÂº∫Â∫¶‰ΩøÁî®';
            } else if (avgDaily > 10) {
                return 'üö≤ <strong>‰∏≠Ë∑ùÁ¶ªÈ™ëË°å</strong><br>Âπ≥ÂùáÊØèÊó•' + avgDaily.toFixed(1) + 'kmÔºå‰ΩøÁî®È¢ëÁéáÈÄÇ‰∏≠';
            } else {
                return 'üõ¥ <strong>Áü≠Ë∑ùÁ¶ªÈ™ëË°å</strong><br>Âπ≥ÂùáÊØèÊó•' + avgDaily.toFixed(1) + 'kmÔºåÂ§ö‰∏∫Áü≠ÈÄîÂá∫Ë°å';
            }
        }

        // ÁîüÊàêÁªºÂêàËØÑ‰º∞Êä•Âëä
        function generateEvaluationReport(user) {
            const batteryData = userDataMapping[user.id].batteryData;
            const trackingData = userDataMapping[user.id].trackingData;
            
            // ËÆ°ÁÆóÂêÑÈ°πËØÑÂàÜ
            const batteryScore = calculateBatteryScore(batteryData);
            const frequencyScore = calculateFrequencyScore(trackingData);
            const pathScore = calculatePathScore(trackingData);
            const overallScore = Math.round((batteryScore + frequencyScore + pathScore) / 3);
            
            // Êõ¥Êñ∞ËØÑÂàÜÊòæÁ§∫
            updateScoreDisplay(batteryScore, frequencyScore, pathScore, overallScore);
            
            // ÁîüÊàêËØÑ‰º∞ÊñáÊú¨
            const evaluationText = generateEvaluationText(user, batteryScore, frequencyScore, pathScore, overallScore);
            document.getElementById('evaluationSummary').innerHTML = evaluationText;
        }

        // ËÆ°ÁÆóÁîµÊ±†ÁÆ°ÁêÜËØÑÂàÜ
        function calculateBatteryScore(batteryData) {
            if (!batteryData || batteryData.length === 0) return 0;
            
            const voltages = batteryData.map(d => d.voltage);
            const avgVoltage = voltages.reduce((a, b) => a + b, 0) / voltages.length;
            const voltageStability = 1 - (Math.max(...voltages) - Math.min(...voltages)) / Math.max(...voltages);
            
            return Math.min(100, Math.max(0, (avgVoltage / 8.4) * 50 + voltageStability * 50));
        }

        // ËÆ°ÁÆóÈ™ëË°åÈ¢ëÁéáËØÑÂàÜ
        function calculateFrequencyScore(trackingData) {
            if (!trackingData) return 0;
            
            const activeDays = Object.keys(trackingData).length;
            const maxDays = 7; // ÂÅáËÆæËØÑ‰º∞ÊúÄËøë7Â§©
            
            return Math.min(100, (activeDays / maxDays) * 100);
        }

        // ËÆ°ÁÆóË∑ØÂæÑÊïàÁéáËØÑÂàÜ
        function calculatePathScore(trackingData) {
            if (!trackingData) return 0;
            
            let totalDistance = 0;
            let validDays = 0;
            
            Object.values(trackingData).forEach(dayData => {
                if (dayData && dayData.totalDistance) {
                    totalDistance += dayData.totalDistance;
                    validDays++;
                }
            });
            
            if (validDays === 0) return 0;
            
            const avgDistance = totalDistance / validDays;
            return Math.min(100, (avgDistance / 30) * 100); // ÂÅáËÆæ30km/Â§©‰∏∫Êª°ÂàÜ
        }

        // Êõ¥Êñ∞ËØÑÂàÜÊòæÁ§∫
        function updateScoreDisplay(batteryScore, frequencyScore, pathScore, overallScore) {
            // Êõ¥Êñ∞ÊÄªÂàÜ
            document.getElementById('overallScore').querySelector('.score-value').textContent = overallScore;
            
            // Êõ¥Êñ∞ÂêÑÈ°πËØÑÂàÜ
            setTimeout(() => {
                updateScoreBar('batteryScore', 'batteryScoreNum', batteryScore);
                updateScoreBar('frequencyScore', 'frequencyScoreNum', frequencyScore);
                updateScoreBar('pathScore', 'pathScoreNum', pathScore);
            }, 500);
        }

        // Êõ¥Êñ∞Âçï‰∏™ËØÑÂàÜÊù°
        function updateScoreBar(barId, numId, score) {
            const bar = document.getElementById(barId);
            const num = document.getElementById(numId);
            
            if (bar && num) {
                bar.style.width = score + '%';
                num.textContent = Math.round(score);
                
                // Ê†πÊçÆÂàÜÊï∞ËÆæÁΩÆÈ¢úËâ≤
                if (score >= 80) {
                    bar.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
                } else if (score >= 60) {
                    bar.style.background = 'linear-gradient(90deg, #ffc107, #fd7e14)';
                } else {
                    bar.style.background = 'linear-gradient(90deg, #dc3545, #e74c3c)';
                }
            }
        }

        // ÁîüÊàêËØÑ‰º∞ÊñáÊú¨
        function generateEvaluationText(user, batteryScore, frequencyScore, pathScore, overallScore) {
            let text = `<h5>üéØ ${user.name} ÁöÑ‰ΩøÁî®ËØÑ‰º∞</h5>`;
            
            if (overallScore >= 80) {
                text += `<p><strong>ÁªºÂêàËØÑ‰ª∑Ôºö‰ºòÁßÄ</strong></p>`;
                text += `<p>ËØ•Áî®Êà∑Â±ïÁé∞Âá∫‰ºòÁßÄÁöÑËÆæÂ§á‰ΩøÁî®‰π†ÊÉØÔºåÁîµÊ±†ÁÆ°ÁêÜÂæóÂΩìÔºåÈ™ëË°åÈ¢ëÁéáÈÄÇ‰∏≠ÔºåË∑ØÂæÑËßÑÂàíÂêàÁêÜ„ÄÇÂª∫ËÆÆÁªßÁª≠‰øùÊåÅÂΩìÂâçÁöÑ‰ΩøÁî®Ê®°Âºè„ÄÇ</p>`;
            } else if (overallScore >= 60) {
                text += `<p><strong>ÁªºÂêàËØÑ‰ª∑ÔºöËâØÂ•Ω</strong></p>`;
                text += `<p>ËØ•Áî®Êà∑ÁöÑËÆæÂ§á‰ΩøÁî®ÊÉÖÂÜµÊÄª‰ΩìËâØÂ•ΩÔºå‰ΩÜÂú®Êüê‰∫õÊñπÈù¢ËøòÊúâÊèêÂçáÁ©∫Èó¥„ÄÇ`;
                
                if (batteryScore < 70) text += `Âª∫ËÆÆ‰ºòÂåñÁîµÊ±†ÂÖÖÊîæÁîµ‰π†ÊÉØÔºõ`;
                if (frequencyScore < 70) text += `ÂèØ‰ª•Â¢ûÂä†‰ΩøÁî®È¢ëÁéáÔºõ`;
                if (pathScore < 70) text += `Âª∫ËÆÆ‰ºòÂåñÈ™ëË°åË∑ØÂæÑËßÑÂàíÔºõ`;
                
                text += `</p>`;
            } else {
                text += `<p><strong>ÁªºÂêàËØÑ‰ª∑ÔºöÈúÄË¶ÅÊîπËøõ</strong></p>`;
                text += `<p>ËØ•Áî®Êà∑ÁöÑËÆæÂ§á‰ΩøÁî®Â≠òÂú®ËæÉÂ§ßÊîπËøõÁ©∫Èó¥„ÄÇÂª∫ËÆÆÔºö</p>`;
                text += `<ul>`;
                if (batteryScore < 60) text += `<li>ÊîπÂñÑÁîµÊ±†ÁÆ°ÁêÜ‰π†ÊÉØÔºåÈÅøÂÖçËøáÂ∫¶ÂÖÖÊîæÁîµ</li>`;
                if (frequencyScore < 60) text += `<li>Â¢ûÂä†ËÆæÂ§á‰ΩøÁî®È¢ëÁéáÔºåÊèêÈ´òËÆæÂ§áÂà©Áî®Áéá</li>`;
                if (pathScore < 60) text += `<li>‰ºòÂåñÂá∫Ë°åË∑ØÂæÑÔºåÊèêÈ´òÈ™ëË°åÊïàÁéá</li>`;
                text += `</ul>`;
            }
            
            text += `<p><small>ËØÑ‰º∞Âü∫‰∫éÊúÄËøëÁöÑ‰ΩøÁî®Êï∞ÊçÆÔºåÂª∫ËÆÆÂÆöÊúüÊü•Áúã‰ª•Ë∑üË∏™ÊîπËøõÊÉÖÂÜµ„ÄÇ</small></p>`;
            
            return text;
        }

        // ÂàáÊç¢ÁÉ≠ÂäõÂõæÊòæÁ§∫
        function toggleHeatmap() {
            const checkbox = document.getElementById('showHeatmap');
            if (!analyticsMap) return;
            
            if (checkbox.checked && heatmapLayer) {
                analyticsMap.addLayer(heatmapLayer);
            } else if (heatmapLayer) {
                analyticsMap.removeLayer(heatmapLayer);
            }
        }

        // ÂàáÊç¢Ë¶ÜÁõñÂå∫ÂüüÊòæÁ§∫
        function toggleCoverage() {
            const checkbox = document.getElementById('showCoverage');
            if (!analyticsMap) return;
            
            if (checkbox.checked && coverageLayer) {
                analyticsMap.addLayer(coverageLayer);
            } else if (coverageLayer) {
                analyticsMap.removeLayer(coverageLayer);
            }
        }

        // Êõ¥Êñ∞Ë∑ØÂæÑÂàÜÊûêÂë®Êúü
        function updatePathAnalysis() {
            if (currentAnalyticsUser) {
                analyzePathData(userDataMapping[currentAnalyticsUser.id].trackingData);
            }
        }

        // Âà∑Êñ∞ÂàÜÊûêÊï∞ÊçÆ
        function refreshAnalyticsData() {
            if (!currentAnalyticsUser) return;
            
            const refreshIcon = document.getElementById('analyticsRefreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            setTimeout(() => {
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫Á¨¨‰∏Ä‰∏™Áî®Êà∑
                const isFirst = isFirstUser(currentAnalyticsUser.id);
                
                // ÈáçÊñ∞ÁîüÊàêÊï∞ÊçÆ
                let newBatteryData = generateUserBatteryData(currentAnalyticsUser);
                let newTrackingData = generateUserTrackingData(currentAnalyticsUser);
                
                // Â¶ÇÊûú‰∏çÊòØÁ¨¨‰∏Ä‰∏™Áî®Êà∑ÔºåÊâì‰π±Êï∞ÊçÆ
                if (!isFirst) {
                    newBatteryData = shuffleArray([...newBatteryData]);
                    newTrackingData = shuffleTrackingData(newTrackingData);
                    console.log(`üîÄ ÂàÜÊûêÂà∑Êñ∞Êó∂Êâì‰π±‰∫ÜÁî®Êà∑ ${currentAnalyticsUser.name} ÁöÑÊï∞ÊçÆ`);
                }
                
                userDataMapping[currentAnalyticsUser.id] = {
                    batteryData: newBatteryData,
                    trackingData: newTrackingData
                };
                
                loadUserAnalyticsData(currentAnalyticsUser);
                refreshIcon.style.animation = '';
                showSuccessMessage('ÂàÜÊûêÊï∞ÊçÆÂ∑≤Âà∑Êñ∞');
            }, 1500);
        }

        // ÂØºÂá∫ÂàÜÊûêÊä•Âëä
        function exportAnalyticsReport() {
            if (!currentAnalyticsUser) {
                alert('ËØ∑ÂÖàÈÄâÊã©Áî®Êà∑');
                return;
            }
            
            const user = currentAnalyticsUser;
            const batteryData = userDataMapping[user.id].batteryData;
            const trackingData = userDataMapping[user.id].trackingData;
            
            // ÁîüÊàêÊä•ÂëäÂÜÖÂÆπ
            const reportContent = generateReportContent(user, batteryData, trackingData);
            
            // ÂàõÂª∫Âπ∂‰∏ãËΩΩÊñá‰ª∂
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${user.name}_Êï∞ÊçÆÂàÜÊûêÊä•Âëä_${new Date().toISOString().split('T')[0]}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage('ÂàÜÊûêÊä•ÂëäÂØºÂá∫ÊàêÂäü');
        }

        // ÁîüÊàêÊä•ÂëäÂÜÖÂÆπ
        function generateReportContent(user, batteryData, trackingData) {
            const date = new Date().toLocaleDateString('zh-CN');
            
            let content = `Áî®Êà∑Êï∞ÊçÆÂàÜÊûêÊä•Âëä\n`;
            content += `===============================\n\n`;
            content += `Áî®Êà∑ÂßìÂêç: ${user.name}\n`;
            content += `ËÆæÂ§áÁºñÂè∑: ${user.device || 'Êú™ÂàÜÈÖç'}\n`;
            content += `ÁîüÊàêÊó•Êúü: ${date}\n\n`;
            
            content += `ÁîµÊ±†ÂàÜÊûê\n`;
            content += `-----------\n`;
            if (batteryData && batteryData.length > 0) {
                const avgVoltage = batteryData.reduce((a, b) => a + b.voltage, 0) / batteryData.length;
                const avgCurrent = batteryData.reduce((a, b) => a + b.current, 0) / batteryData.length;
                content += `Âπ≥ÂùáÁîµÂéã: ${avgVoltage.toFixed(2)}V\n`;
                content += `Âπ≥ÂùáÁîµÊµÅ: ${avgCurrent.toFixed(2)}A\n`;
                content += `Êï∞ÊçÆÁÇπÊï∞: ${batteryData.length}Êù°\n\n`;
            }
            
            content += `Ë∑ØÂæÑÂàÜÊûê\n`;
            content += `-----------\n`;
            if (trackingData) {
                const dates = Object.keys(trackingData);
                const totalDistance = dates.reduce((sum, date) => {
                    return sum + (trackingData[date].totalDistance || 0);
                }, 0);
                content += `Ê¥ªÂä®Â§©Êï∞: ${dates.length}Â§©\n`;
                content += `ÊÄªË∑ùÁ¶ª: ${totalDistance.toFixed(1)}km\n`;
                content += `Âπ≥ÂùáÊó•Ë∑ùÁ¶ª: ${(totalDistance / Math.max(dates.length, 1)).toFixed(1)}km\n\n`;
            }
            
            content += `Âª∫ËÆÆ‰∫ãÈ°π\n`;
            content += `-----------\n`;
            content += `1. ÂÆöÊúüÊ£ÄÊü•ÁîµÊ±†Áä∂ÊÄÅ\n`;
            content += `2. ‰øùÊåÅÈÄÇÂ∫¶ÁöÑ‰ΩøÁî®È¢ëÁéá\n`;
            content += `3. ‰ºòÂåñÂá∫Ë°åË∑ØÂæÑËßÑÂàí\n`;
            content += `4. Ê≥®ÊÑèËÆæÂ§áÁª¥Êä§‰øùÂÖª\n\n`;
            
            content += `Êä•ÂëäÁªìÊùü\n`;
            content += `===============================`;
            
            return content;
        }

        // ÊòæÁ§∫ÂàÜÊûêÊï∞ÊçÆ
        function showAnalyticsData() {
            document.getElementById('analyticsDataContainer').style.display = 'block';
            document.getElementById('analyticsNoDataMessage').style.display = 'none';
        }

        // ÈöêËóèÂàÜÊûêÊï∞ÊçÆ
        function hideAnalyticsData() {
            document.getElementById('analyticsDataContainer').style.display = 'none';
            document.getElementById('analyticsNoDataMessage').style.display = 'block';
            document.getElementById('analyticsSelectedUserInfo').style.display = 'none';
            currentAnalyticsUser = null;
        }

        // // ‰øÆÊîπÂéüÊúâÁöÑshowPageÂáΩÊï∞ÔºåÊ∑ªÂä†ÂàÜÊûêÈ°µÈù¢ÂàùÂßãÂåñ
        // const originalShowPageAnalytics = showPage;
        // window.showPage = function(pageId) {
        //     originalShowPageAnalytics(pageId);
            
        //     // Â¶ÇÊûúÂàáÊç¢Âà∞ÂàÜÊûêÈ°µÈù¢ÔºåÂàùÂßãÂåñÂàÜÊûêÂäüËÉΩ
        //     if (pageId === 'analytics') {
        //         setTimeout(() => {
        //             initializeAnalyticsPage();
        //         }, 100);
        //     }
        // };

        
        /* ---------- Áî®Êà∑ÁÆ°ÁêÜÈ°µÈù¢ÂäüËÉΩ ---------- */
        // Âä†ËΩΩÁî®Êà∑ÂàóË°®
        function loadUserList() {
            const saved = localStorage.getItem('systemUserList');
            if (saved) {
                try {
                    userList = JSON.parse(saved);
                } catch (error) {
                    console.error('‚ùå Áî®Êà∑ÂàóË°®Âä†ËΩΩÂ§±Ë¥•:', error);
                    userList = [];
                }
            }
            filteredUserList = [...userList];
            renderUserList();
            updateUserStatistics();
        }

        // ‰øùÂ≠òÁî®Êà∑ÂàóË°®
        function saveUserList() {
            try {
                localStorage.setItem('systemUserList', JSON.stringify(userList));
                console.log('‚úÖ Áî®Êà∑ÂàóË°®Â∑≤‰øùÂ≠ò');
            } catch (error) {
                console.error('‚ùå Áî®Êà∑ÂàóË°®‰øùÂ≠òÂ§±Ë¥•:', error);
            }
        }

        // Ê∑ªÂä†Êñ∞Áî®Êà∑
        function addNewUser() {
            const nameInput = document.getElementById('newUserName');
            const roleSelect = document.getElementById('newUserRole');
            const deviceInput = document.getElementById('newUserDevice');
            const addBtn = document.querySelector('#addUserForm .btn-primary');
            const btnText = document.getElementById('addUserBtnText');
            const spinner = document.getElementById('addUserSpinner');

            const name = nameInput.value.trim();
            const role = roleSelect.value;
            const device = deviceInput.value.trim();

            // Ë°®ÂçïÈ™åËØÅ
            if (!name) {
                alert('ËØ∑ËæìÂÖ•Áî®Êà∑ÂßìÂêç');
                nameInput.focus();
                return;
            }

            if (name.length < 2) {
                alert('Áî®Êà∑ÂßìÂêçËá≥Â∞ëÈúÄË¶Å2‰∏™Â≠óÁ¨¶');
                nameInput.focus();
                return;
            }

            // Ê£ÄÊü•ËÆæÂ§áÊï∞ÈáèÈôêÂà∂
            if (userList.length >= adminSettings.maxDevices) {
                showCapacityWarning(`Êó†Ê≥ïÊ∑ªÂä†Áî®Êà∑ÔºöÂ∑≤ËææÂà∞ÊúÄÂ§ßËÆæÂ§áÊé•ÂÖ•Êï∞ÈáèÈôêÂà∂ (${adminSettings.maxDevices}Âè∞)`);
                return;
            }

            // Ê£ÄÊü•Áî®Êà∑ÂêçÊòØÂê¶ÈáçÂ§ç
            if (userList.some(user => user.name.toLowerCase() === name.toLowerCase())) {
                alert('ËØ•Áî®Êà∑ÂßìÂêçÂ∑≤Â≠òÂú®ÔºåËØ∑‰ΩøÁî®‰∏çÂêåÁöÑÂßìÂêç');
                nameInput.focus();
                return;
            }

            // Ê£ÄÊü•ËÆæÂ§áÁºñÂè∑ÊòØÂê¶ÈáçÂ§çÔºàÂ¶ÇÊûúÊèê‰æõ‰∫ÜËÆæÂ§áÁºñÂè∑Ôºâ
            if (device && userList.some(user => user.device && user.device.toLowerCase() === device.toLowerCase())) {
                alert('ËØ•ËÆæÂ§áÁºñÂè∑Â∑≤Ë¢´‰ΩøÁî®ÔºåËØ∑‰ΩøÁî®‰∏çÂêåÁöÑËÆæÂ§áÁºñÂè∑');
                deviceInput.focus();
                return;
            }

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            addBtn.disabled = true;
            btnText.textContent = 'Ê∑ªÂä†‰∏≠...';
            spinner.classList.remove('hidden');

            // Ê®°ÊãüÂºÇÊ≠•Êìç‰Ωú
            setTimeout(() => {
                try {
                    // ÂàõÂª∫Êñ∞Áî®Êà∑ÂØπË±°
                    const newUser = {
                        id: Date.now().toString(),
                        name: name,
                        role: role,
                        device: device || null,
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        lastLogin: null
                    };

                    // Ê∑ªÂä†Âà∞Áî®Êà∑ÂàóË°®
                    userList.push(newUser);
                    filteredUserList = [...userList];

                    // ‰øùÂ≠òÂà∞localStorage
                    saveUserList();

                    // Êõ¥Êñ∞ÁïåÈù¢
                    renderUserList();
                    initializeMonitoringPage();
                    updateUserStatistics();
                    updateDashboardDeviceStats();
                    clearUserForm();
                    hideCapacityWarning();

                    console.log('‚úÖ Áî®Êà∑Ê∑ªÂä†ÊàêÂäü:', newUser);
                    showSuccessMessage(`Áî®Êà∑ "${name}" Ê∑ªÂä†ÊàêÂäüÔºÅ`);

                } catch (error) {
                    console.error('‚ùå Ê∑ªÂä†Áî®Êà∑Â§±Ë¥•:', error);
                    alert('Ê∑ªÂä†Áî®Êà∑Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                } finally {
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    addBtn.disabled = false;
                    btnText.textContent = 'Ê∑ªÂä†Áî®Êà∑';
                    spinner.classList.add('hidden');
                }
            }, 800); // Ê®°ÊãüÁΩëÁªúÂª∂Ëøü
        }

        // Âà†Èô§Áî®Êà∑
        function deleteUser(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user) return;

            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Áî®Êà∑ "${user.name}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`)) {
                userList = userList.filter(u => u.id !== userId);
                filteredUserList = filteredUserList.filter(u => u.id !== userId);
                
                saveUserList();
                renderUserList();
                initializeMonitoringPage();
                updateUserStatistics(); 
                updateDashboardDeviceStats();// Ëøô‰ºöÂêåÊó∂Êõ¥Êñ∞‰ª™Ë°®Êùø
                hideCapacityWarning();
                
                console.log('‚úÖ Áî®Êà∑Âà†Èô§ÊàêÂäü:', user.name);
                showSuccessMessage(`Áî®Êà∑ "${user.name}" Â∑≤Âà†Èô§`);
            }
        }
        
        // ÁºñËæëÁî®Êà∑Áä∂ÊÄÅ
        function toggleUserStatus(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user) return;

            user.status = user.status === 'active' ? 'inactive' : 'active';
            saveUserList();
            renderUserList();
            updateDashboardDeviceStats();
            
            console.log(`‚úÖ Áî®Êà∑Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞: ${user.name} -> ${user.status}`);
        }

        // Ê∏≤ÊüìÁî®Êà∑ÂàóË°® ÔºàÂåÖÊã¨ÊúâÁî®Êà∑ÂàóË°®ÁöÑÈ°µÈù¢ÂàÜÂ∏É htmlÔºâ
        function renderUserList() {
            const container = document.getElementById('userListContainer');
            const emptyState = document.getElementById('emptyUserState');

            if (filteredUserList.length === 0) {
                // ‰øÆÂ§çÔºöÁõ¥Êé•ËÆæÁΩÆinnerHTMLËÄå‰∏çÊòØappendChild
                container.innerHTML = `
                    <div id="emptyUserState" class="text-center" style="color: #6c757d; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üë§</div>
                        <h4>ÊöÇÊó†Áî®Êà∑Êï∞ÊçÆ</h4>
                        <p>ËØ∑Ê∑ªÂä†Á¨¨‰∏Ä‰∏™Áî®Êà∑ÂºÄÂßã‰ΩøÁî®Á≥ªÁªü</p>
                    </div>
                `;
                return;
            }

            const listHTML = `
                <div class="user-list-table">
                    <div class="user-list-header" style="display: grid; grid-template-columns: 2fr 1fr 1.5fr 1fr 1fr 1.5fr; gap: 15px; padding: 12px 15px; background-color: #f8f9fa; border-radius: 6px; font-weight: 600; color: #495057; margin-bottom: 10px;">
                        <div>ÂßìÂêç</div>
                        <div>ËßíËâ≤</div>
                        <div>ËÆæÂ§áÁºñÂè∑</div>
                        <div>Áä∂ÊÄÅ</div>
                        <div>Ê≥®ÂÜåÊó∂Èó¥</div>
                        <div>Êìç‰Ωú</div>
                    </div>
                    ${filteredUserList.map(user => `
                        <div class="user-list-item" style="display: grid; grid-template-columns: 2fr 1fr 1.5fr 1fr 1fr 1.5fr; gap: 15px; padding: 15px; border: 1px solid #e9ecef; border-radius: 6px; margin-bottom: 8px; background-color: white; align-items: center;">
                            <div>
                                <strong style="color: #2c3e50;">${user.name}</strong>
                                <div style="font-size: 12px; color: #6c757d;">ID: ${user.id}</div>
                            </div>
                            <div>
                                <span class="role-badge role-${user.role}" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                    ${getRoleDisplayName(user.role)}
                                </span>
                            </div>
                            <div style="color: #6c757d;">
                                ${user.device || '<span style="color: #adb5bd;">Êú™ÂàÜÈÖç</span>'}
                            </div>
                            <div>
                                <button class="status-btn status-${user.status}" onclick="toggleUserStatus('${user.id}')" 
                                        style="padding: 4px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;">
                                    ${user.status === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
                                </button>
                            </div>
                            <div style="font-size: 12px; color: #6c757d;">
                                ${formatDate(user.createdAt)}
                            </div>
                            <div>
                                <button onclick="deleteUser('${user.id}')" class="btn-sm btn-danger" 
                                        style="padding: 6px 12px; background-color: #f8d7da; color: #c82333; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 5px;">
                                    Âà†Èô§
                                </button>
                                <button onclick="viewUserDetails('${user.id}')" class="btn-sm btn-info"
                                        style="padding: 6px 12px; background-color: #e2f0fb; color: #117a8b; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                    ËØ¶ÊÉÖ
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = listHTML;
        }

        // Áî®Êà∑ËßíËâ≤ÊòæÁ§∫ÂêçÁß∞
        function getRoleDisplayName(role) {
            const roleNames = {
                'user': 'ÊôÆÈÄöÁî®Êà∑',
                'operator': 'Êìç‰ΩúÂëò',
                'admin': 'ÁÆ°ÁêÜÂëò'
            };
            return roleNames[role] || role;
        }

        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Êõ¥Êñ∞Áî®Êà∑ÁªüËÆ°
        function updateUserStatistics() {
            const currentCount = userList.length;
            const maxDevices = adminSettings.maxDevices;
            const usagePercent = Math.round((currentCount / maxDevices) * 100);

            // Êõ¥Êñ∞Êï∞Â≠óÊòæÁ§∫
            document.getElementById('currentUserCount').textContent = currentCount;
            document.getElementById('maxUserDevices').textContent = maxDevices;

            // Êõ¥Êñ∞‰ΩøÁî®ÁéáËøõÂ∫¶Êù°
            const statusIndicator = document.getElementById('userStatusIndicator');
            const statusText = document.getElementById('userStatusText');

            // Ê†πÊçÆ‰ΩøÁî®ÁéáËÆæÁΩÆÈ¢úËâ≤ÂíåÁä∂ÊÄÅ
            if (usagePercent >= 90) {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'ÂÆπÈáèÂç≥Â∞ÜÊª°ËΩΩ';
                showCapacityWarning(`ËÆæÂ§áÂÆπÈáèÁ¥ßÂº†ÔºöÂ∑≤‰ΩøÁî® ${currentCount}/${maxDevices} Âè∞`);
            } else if (usagePercent >= 70) {
                statusIndicator.className = 'status-indicator status-warning';
                statusText.textContent = '‰ΩøÁî®ÁéáËæÉÈ´ò';
                hideCapacityWarning();
            } else {
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'Á≥ªÁªüÊ≠£Â∏∏';
                hideCapacityWarning();
            }

            // Êõ¥Êñ∞ÂÖ∂‰ªñÈ°µÈù¢ÁöÑÁªüËÆ°ÊòæÁ§∫
            const onlineDeviceCount = document.getElementById('onlineDeviceCount');
            if (onlineDeviceCount) {
                onlineDeviceCount.textContent = userList.filter(u => u.status === 'active').length;
            }
        }

        // ÊòæÁ§∫ÂÆπÈáèË≠¶Âëä
        function showCapacityWarning(message) {
            const warning = document.getElementById('capacityWarning');
            const warningMessage = document.getElementById('warningMessage');
            if (warning && warningMessage) {
                warningMessage.textContent = message;
                warning.classList.remove('hidden');
            }
        }

        // ÈöêËóèÂÆπÈáèË≠¶Âëä
        function hideCapacityWarning() {
            const warning = document.getElementById('capacityWarning');
            if (warning) {
                warning.classList.add('hidden');
            }
        }

        // Ê∏ÖÁ©∫Áî®Êà∑Ë°®Âçï
        function clearUserForm() {
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserRole').value = 'user';
            document.getElementById('newUserDevice').value = '';
        }

        // ËøáÊª§Áî®Êà∑ÂàóË°®
        function filterUserList() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredUserList = [...userList];
            } else {
                filteredUserList = userList.filter(user => 
                    user.name.toLowerCase().includes(searchTerm) ||
                    (user.device && user.device.toLowerCase().includes(searchTerm)) ||
                    getRoleDisplayName(user.role).toLowerCase().includes(searchTerm)
                );
            }
            
            renderUserList();
        }

        // Âà∑Êñ∞Áî®Êà∑ÂàóË°®
        function refreshUserList() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            setTimeout(() => {
                loadUserList();
                refreshIcon.style.animation = '';
                showSuccessMessage('Áî®Êà∑ÂàóË°®Â∑≤Âà∑Êñ∞');
            }, 500);
        }

        // Êü•ÁúãÁî®Êà∑ËØ¶ÊÉÖ
        function viewUserDetails(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user) return;

            const details = `
                Áî®Êà∑ËØ¶ÁªÜ‰ø°ÊÅØÔºö

                ÂßìÂêçÔºö${user.name}
                ËßíËâ≤Ôºö${getRoleDisplayName(user.role)}
                ËÆæÂ§áÁºñÂè∑Ôºö${user.device || 'Êú™ÂàÜÈÖç'}
                Áä∂ÊÄÅÔºö${user.status === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
                Ê≥®ÂÜåÊó∂Èó¥Ôºö${formatDate(user.createdAt)}
                Áî®Êà∑IDÔºö${user.id}
                    `;
            alert(details);
        }

        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
        function showSuccessMessage(message) {
            // ÂàõÂª∫‰∏¥Êó∂ÊèêÁ§∫ÂÖÉÁ¥†
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background-color: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 9999;
                font-weight: 500;
                animation: slideInRight 0.3s ease;
            `;
            toast.textContent = message;

            // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(toast);

            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }


        /* ---------- ÁÆ°ÁêÜÂëòËÆæÁΩÆÈ°µÈù¢ ---------- */

        // ‰øÆÊîπÁé∞ÊúâÁöÑsaveAdminSettingsÂáΩÊï∞ÔºåÊ∑ªÂä†Áî®Êà∑ÁªüËÆ°Êõ¥Êñ∞
        function saveAdminSettings() {
            const name = document.getElementById('adminName').value.trim();
            const avatar = document.getElementById('adminAvatar').value.trim().toUpperCase();
            const bio = document.getElementById('adminBio').value.trim();
            const maxDevices = parseInt(document.getElementById('deviceCount').textContent);
            const storageLimit = parseInt(document.getElementById('storageLimit').textContent);

            if (!name) {
                alert('ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÂêçÁß∞');
                return;
            }

            if (!avatar) {
                alert('ËØ∑ËæìÂÖ•Â§¥ÂÉèÂ≠óÊØç');
                return;
            }

            // Ê£ÄÊü•ËÆæÂ§áÊï∞ÈáèÊòØÂê¶Â∞è‰∫éÂΩìÂâçÁî®Êà∑Êï∞Èáè
            if (maxDevices < userList.length) {
                if (!confirm(`ÂΩìÂâçËÆæÁΩÆÁöÑÊúÄÂ§ßËÆæÂ§áÊï∞Èáè (${maxDevices}) Â∞è‰∫éÂ∑≤Ê≥®ÂÜåÁî®Êà∑Êï∞Èáè (${userList.length})„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºüËøôÂèØËÉΩ‰ºöÂΩ±ÂìçÁ≥ªÁªüÂäüËÉΩ„ÄÇ`)) {
                    return;
                }
            }

            // Êõ¥Êñ∞ËÆæÁΩÆ
            adminSettings = {
                name: name,
                avatar: avatar,
                bio: bio,
                maxDevices: maxDevices,
                storageLimit: storageLimit
            };

            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem('adminSettings', JSON.stringify(adminSettings));

            syncStorageLimitToPages();

            // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
            updateAdminDisplay();
            updateDeviceDisplays();
            updateUserStatistics(); // Ëøô‰ºöÂêåÊó∂Êõ¥Êñ∞‰ª™Ë°®Êùø

            showSuccessMessage('ËÆæÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ');
            console.log('ËÆæÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅÂ∑≤‰øÆÊîπËÆæÂ§áÂ≠òÂÇ®‰∏äÈôêÔºÅ');
        }

        // ‰øÆÊîπËÆæÂ§áÊï∞Èáè
        function changeDeviceCount(delta) {
            const currentCount = parseInt(document.getElementById('deviceCount').textContent);
            const newCount = Math.max(1, Math.min(20, currentCount + delta));
            
            document.getElementById('deviceCount').textContent = newCount;
            adminSettings.maxDevices = newCount;
        }

        // ‰øÆÊîπÂ≠òÂÇ®Êï∞Èáè‰∏äÈôê
        function changeStorageLimit(delta) {
            const currentLimit = parseInt(document.getElementById('storageLimit').textContent);
            const newLimit = Math.max(30, Math.min(100, currentLimit + delta));  // ÊúÄÂ§ß100 ÊúÄÂ∞è30
            
            document.getElementById('storageLimit').textContent = newLimit;
            adminSettings.storageLimit = newLimit;
            
            // // Á´ãÂç≥ÂêåÊ≠•Âà∞localStorageÔºå‰æõpageÂíåpage2‰ΩøÁî®
            // syncStorageLimitToPages();
        }

        // Â∞ÜÂ≠òÂÇ®Êï∞Èáè‰∏äÈôêÊõ¥Êñ∞Âà∞page‰∏≠
        function syncStorageLimitToPages() {
            const storageConfig = {
                maxBatteryDataPoints: adminSettings.storageLimit,
                maxLocationDataPoints: adminSettings.storageLimit,
                maxHistoryDays: 30, 
                lastUpdated: new Date().toISOString()
            };
            
            // ‰øùÂ≠òÈÖçÁΩÆ‰æõÂÖ∂‰ªñÈ°µÈù¢‰ΩøÁî®
            localStorage.setItem('storageConfig', JSON.stringify(storageConfig));
            
            console.log('Â≠òÂÇ®ÈÖçÁΩÆÂ∑≤Êõ¥Êñ∞:', storageConfig);
            
            // Á´ãÂç≥Ê∏ÖÁêÜÁé∞ÊúâÊï∞ÊçÆ‰ª•Á¨¶ÂêàÊñ∞ÁöÑÈôêÂà∂
            cleanupExistingData();
        }

        // Ê∏ÖÁêÜÁé∞ÊúâÊï∞ÊçÆ‰ª•Á¨¶ÂêàÊñ∞ÁöÑÂ≠òÂÇ®ÈôêÂà∂
        function cleanupExistingData() {
            try {
                // Ê∏ÖÁêÜÁîµÊ±†ÂéÜÂè≤Êï∞ÊçÆ
                const batteryData = localStorage.getItem('batteryHistoryData');
                if (batteryData) {
                    let parsedData = JSON.parse(batteryData);
                    
                    // Ê£ÄÊü•Êï∞ÊçÆÁªìÊûÑÊòØÂê¶Ê≠£Á°Æ
                    if (parsedData && parsedData.voltage && parsedData.current && parsedData.timestamps &&
                        Array.isArray(parsedData.voltage) && Array.isArray(parsedData.current) && Array.isArray(parsedData.timestamps)) {
                        
                        const voltageLength = parsedData.voltage.length;
                        const currentLength = parsedData.current.length;
                        const timestampsLength = parsedData.timestamps.length;
                        
                        // Ëé∑ÂèñÊúÄÂ§ßÈïøÂ∫¶‰Ωú‰∏∫Êï∞ÊçÆÁÇπÊï∞Èáè
                        const dataPointCount = Math.max(voltageLength, currentLength, timestampsLength);
                        
                        console.log(`üìä ÁîµÊ±†Êï∞ÊçÆÊ£ÄÊü•: voltage(${voltageLength}), current(${currentLength}), timestamps(${timestampsLength})`);
                        
                        if (dataPointCount > adminSettings.storageLimit) {
                            // ‰øùÁïôÊúÄÊñ∞ÁöÑÊï∞ÊçÆ - ÂØπÊØè‰∏™Êï∞ÁªÑÂàÜÂà´Â§ÑÁêÜ
                            const keepCount = adminSettings.storageLimit;
                            
                            parsedData.voltage = parsedData.voltage.slice(-keepCount);
                            parsedData.current = parsedData.current.slice(-keepCount);
                            parsedData.timestamps = parsedData.timestamps.slice(-keepCount);
                            
                            localStorage.setItem('batteryHistoryData', JSON.stringify(parsedData));
                            console.log(`üîã ÁîµÊ±†Êï∞ÊçÆÊ∏ÖÁêÜÂÆåÊàêÔºå‰øùÁïôÊúÄÊñ∞ ${keepCount} Êù°ÔºåÂà†Èô§‰∫Ü ${dataPointCount - keepCount} Êù°`);
                        } else {
                            console.log(`‚úÖ ÁîµÊ±†Êï∞ÊçÆÊ£ÄÊü•ÂÆåÊàêÔºåÂΩìÂâç ${dataPointCount} Êù°Êï∞ÊçÆÂú®ÈôêÂà∂ËåÉÂõ¥ÂÜÖ`);
                        }
                        
                    } else {
                        console.warn('‚ö†Ô∏è ÁîµÊ±†Êï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåË∑≥ËøáÊ∏ÖÁêÜ');
                    }
                } else {
                    console.log('üìä Êú™ÊâæÂà∞ÁîµÊ±†ÂéÜÂè≤Êï∞ÊçÆ');
                }

                // Ê∏ÖÁêÜ‰ΩçÁΩÆÊï∞ÊçÆ
                const mockData = localStorage.getItem('mockData');
                if (mockData) {
                    let parsedMockData = JSON.parse(mockData);
                    let totalPoints = 0;
                    
                    // ÊèêÂèñÊØè‰∏ÄÂ§©ÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ
                    Object.keys(parsedMockData).forEach(date => {
                        const dayData = parsedMockData[date];
                        if (dayData && dayData.path && Array.isArray(dayData.path)) {
                            const currentDateLength = dayData.path.length;

                            if (currentDateLength > adminSettings.storageLimit) {
                                const currentRemoveLength = currentDateLength - adminSettings.storageLimit;
                                parsedMockData[date].path = dayData.path.slice(-adminSettings.storageLimit);    // ÂàáÈô§ÊúÄÊñ∞ÁöÑstorageLimit‰∏™ Âπ∂‰∏îÂ≠òÂÇ®Âà∞ MockData
                                totalPoints += currentRemoveLength;

                                console.log(`${date}Ôºö‰ΩçÁΩÆËøáÂ§öÔºåÊ∏ÖÈô§${currentRemoveLength}‰∏™‰ΩçÁΩÆÁÇπ`)
                            }
                        }
                    });

                    // Â¶ÇÊûúÊúâÊ∏ÖÁêÜÊìç‰ΩúÔºåÊõ¥Êñ∞localStorage
                    if (totalPoints > 0) {
                        localStorage.setItem('mockData', JSON.stringify(parsedMockData));
                        console.log(`‰ΩçÁΩÆÊï∞ÊçÆÊ∏ÖÁêÜÂÆåÊàêÔºåÊÄªÂÖ±Âà†Èô§‰∫Ü ${totalPoints} ‰∏™‰ΩçÁΩÆÁÇπ`);
                    } else {
                        console.log('‰ΩçÁΩÆÊï∞ÊçÆÊ£ÄÊü•ÂÆåÊàêÔºåÊó†ÈúÄÊ∏ÖÁêÜ');
                    }
                }

            } catch (error) {
                console.error('‚ùå Êï∞ÊçÆÊ∏ÖÁêÜÂ§±Ë¥•:', error);
            }
        }

        // ‰øùÂ≠òÁÆ°ÁêÜÂëòËÆæÁΩÆ
        function saveAdminSettings() {
            const name = document.getElementById('adminName').value.trim();
            const avatar = document.getElementById('adminAvatar').value.trim().toUpperCase();
            const bio = document.getElementById('adminBio').value.trim();
            const maxDevices = parseInt(document.getElementById('deviceCount').textContent);
            const storageLimit = parseInt(document.getElementById('storageLimit').textContent);

            if (!name) {
                alert('ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÂêçÁß∞');
                return;
            }

            if (!avatar) {
                alert('ËØ∑ËæìÂÖ•Â§¥ÂÉèÂ≠óÊØç');
                return;
            }

            // Ê£ÄÊü•ËÆæÂ§áÊï∞ÈáèÊòØÂê¶Â∞è‰∫éÂΩìÂâçÁî®Êà∑Êï∞Èáè
            if (maxDevices < userList.length) {
                if (!confirm(`ÂΩìÂâçËÆæÁΩÆÁöÑÊúÄÂ§ßËÆæÂ§áÊï∞Èáè (${maxDevices}) Â∞è‰∫éÂ∑≤Ê≥®ÂÜåÁî®Êà∑Êï∞Èáè (${userList.length})„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºüËøôÂèØËÉΩ‰ºöÂΩ±ÂìçÁ≥ªÁªüÂäüËÉΩ„ÄÇ`)) {
                    return;
                }
            }

            // Êõ¥Êñ∞ËÆæÁΩÆ
            adminSettings = {
                name: name,
                avatar: avatar,
                bio: bio,
                maxDevices: maxDevices,
                storageLimit: storageLimit
            };

            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem('adminSettings', JSON.stringify(adminSettings));

            syncStorageLimitToPages();

            // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
            updateAdminDisplay();
            updateDeviceDisplays();
            updateUserStatistics(); // Êñ∞Â¢ûÔºöÊõ¥Êñ∞Áî®Êà∑ÁªüËÆ°

            showSuccessMessage('ËÆæÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ');
            console.log(`ËÆæÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅÂ∑≤‰øÆÊîπËÆæÂ§áÂ≠òÂÇ®‰∏äÈôêÔºÅ`);
        }

        // ÈáçÁΩÆÁÆ°ÁêÜÂëòËÆæÁΩÆ
        function resetAdminSettings() {
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ‰∏∫ÈªòËÆ§ÂÄºÂêóÔºü')) {
                adminSettings = {
                    name: 'ÁÆ°ÁêÜÂëò',
                    avatar: 'A',
                    bio: 'Á≥ªÁªüÁÆ°ÁêÜÂëòÔºåË¥üË¥£Êï¥‰ΩìÁ≥ªÁªüËøêÁª¥ÂíåÁÆ°ÁêÜÂ∑•‰Ωú„ÄÇ',
                    maxDevices: 5,
                    storageLimit: 30
                };

                try {
                    const keys = [
                        'adminSettings',
                        'storageConfig'
                    ];
                    keys.forEach(key => {
                        if (localStorage.getItem(key)) {
                            localStorage.removeItem(key);
                            console.log(`Â∑≤Ê∏ÖÈô§: ${key}`);
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Ê∏ÖÈô§Êú¨Âú∞Êï∞ÊçÆÂ§±Ë¥•:', error);
                }

                localStorage.setItem('adminSettings', JSON.stringify(adminSettings));
                
                loadAdminSettingsToForm();
                updateAdminDisplay();
                updateDeviceDisplays();
                syncStorageLimitToPages();

                console.log(`ËÆæÁΩÆÂ∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº`);
            }
        }

        // Âä†ËΩΩÁÆ°ÁêÜÂëòËÆæÁΩÆ
        function loadAdminSettings() {
            const saved = localStorage.getItem('adminSettings');
            if (saved) {
                adminSettings = JSON.parse(saved);
            }
            
            loadAdminSettingsToForm();
            updateAdminDisplay();
        }

        // Â∞ÜËÆæÁΩÆÂä†ËΩΩÂà∞Ë°®Âçï
        function loadAdminSettingsToForm() {
            document.getElementById('adminName').value = adminSettings.name;
            document.getElementById('adminAvatar').value = adminSettings.avatar;
            document.getElementById('adminBio').value = adminSettings.bio;
            document.getElementById('deviceCount').textContent = adminSettings.maxDevices;
            document.getElementById('storageLimit').textContent = adminSettings.storageLimit;
            document.getElementById('avatarPreview').textContent = adminSettings.avatar;
        }

        // Êõ¥Êñ∞ÁÆ°ÁêÜÂëòÊòæÁ§∫
        function updateAdminDisplay() {
            document.getElementById('displayUserName').textContent = adminSettings.name;
            document.getElementById('displayUserAvatar').textContent = adminSettings.avatar;
        }

        // Êõ¥Êñ∞ËÆæÂ§áÊï∞ÈáèÊòæÁ§∫
        function updateDeviceDisplays() {
            // Êõ¥Êñ∞ÂêÑ‰∏™È°µÈù¢ÁöÑËÆæÂ§áËÆ°Êï∞ÊòæÁ§∫
            const deviceCountDisplay = document.getElementById('deviceCountDisplay');
            const maxDeviceCount = document.getElementById('maxDeviceCount');
            
            if (deviceCountDisplay) deviceCountDisplay.textContent = adminSettings.maxDevices;
            if (maxDeviceCount) maxDeviceCount.textContent = adminSettings.maxDevices;
            
            // Êõ¥Êñ∞‰ª™Ë°®ÊùøËÆæÂ§áÁªüËÆ°
            updateDashboardDeviceStats();
        }

        const originalDeleteUser = deleteUser;
        window.deleteUser = function(userId) {
            // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÁõëÊéßÁî®Êà∑ÔºåÊ∏ÖÁ©∫ÁõëÊéß
            if (currentMonitoringUser && currentMonitoringUser.id === userId) {
                hideMonitoringData();
            }
            
            // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÂàÜÊûêÁî®Êà∑ÔºåÊ∏ÖÁ©∫ÂàÜÊûê
            if (currentAnalyticsUser && currentAnalyticsUser.id === userId) {
                hideAnalyticsData();
            }
            
            // Âà†Èô§Áî®Êà∑Êï∞ÊçÆÊò†Â∞Ñ
            delete userDataMapping[userId];
            
            // Ëé∑ÂèñË¢´Âà†Èô§Áî®Êà∑Âú®ÂàóË°®‰∏≠ÁöÑ‰ΩçÁΩÆ
            const deletedUserIndex = userList.findIndex(u => u.id === userId);
            const wasFirstUser = deletedUserIndex === 0;
            
            // ÊâßË°åÂéüÂßãÂà†Èô§ÈÄªËæë
            originalDeleteUser(userId);
            
            // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÁ¨¨‰∏Ä‰∏™Áî®Êà∑ÔºåÈúÄË¶ÅÈáçÊñ∞ÁîüÊàêÊñ∞ÁöÑÁ¨¨‰∏Ä‰∏™Áî®Êà∑ÁöÑÊï∞ÊçÆÔºà‰øùÊåÅÂéüÂßãÈ°∫Â∫èÔºâ
            if (wasFirstUser && userList.length > 0) {
                const newFirstUser = userList[0];
                if (userDataMapping[newFirstUser.id]) {
                    console.log(`üîÑ ÈáçÊñ∞ÁîüÊàêÊñ∞ÁöÑÁ¨¨‰∏Ä‰∏™Áî®Êà∑ ${newFirstUser.name} ÁöÑÂéüÂßãÊï∞ÊçÆ`);
                    
                    // ÈáçÊñ∞ÁîüÊàêÂéüÂßãÈ°∫Â∫èÁöÑÊï∞ÊçÆ
                    userDataMapping[newFirstUser.id] = {
                        batteryData: generateUserBatteryData(newFirstUser),
                        trackingData: generateUserTrackingData(newFirstUser)
                    };
                    
                    // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®ÁõëÊéßÊàñÂàÜÊûêËøô‰∏™Áî®Êà∑ÔºåÈúÄË¶ÅÂà∑Êñ∞ÊòæÁ§∫
                    if (currentMonitoringUser && currentMonitoringUser.id === newFirstUser.id) {
                        loadBatteryChart(userDataMapping[newFirstUser.id].batteryData);
                        loadDateSelector(userDataMapping[newFirstUser.id].trackingData);
                    }
                    
                    if (currentAnalyticsUser && currentAnalyticsUser.id === newFirstUser.id) {
                        loadUserAnalyticsData(newFirstUser);
                    }
                }
            }
            
            setTimeout(() => {
                loadUserSelector();
                loadAnalyticsUserSelector();
            }, 100);
        };

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ - Ê∑ªÂä†Â≠òÂÇ®ÈÖçÁΩÆÂêåÊ≠•
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminSettings();
            loadUserList(); 
            updateDeviceDisplays();
            updateUserStatistics();
            updateDashboardDeviceStats();

            initializeMonitoringPage();
            setupMonitoringComponents();
            initializeAnalyticsPage();
            syncStorageLimitToPages();
            console.log('ÊéßÂà∂Âè∞ÁïåÈù¢Âä†ËΩΩÂÆåÊàê');
        });

        const mapStyles = `
        <style>
        #monitoringMap {
            height: 500px !important;
            width: 100% !important;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .custom-marker {
            text-align: center;
            line-height: 25px;
            background: none !important;
            border: none !important;
        }

        .leaflet-popup-content {
            font-size: 12px;
            line-height: 1.4;
        }
        </style>
        `;

        // Â∞ÜÊ†∑ÂºèÊ∑ªÂä†Âà∞È°µÈù¢
        if (!document.querySelector('#map-styles')) {
            const styleElement = document.createElement('style');
            styleElement.id = 'map-styles';
            styleElement.innerHTML = mapStyles;
            document.head.appendChild(styleElement);
        }

        // Â§¥ÂÉèÂ≠óÊØçÂÆûÊó∂È¢ÑËßà
        document.getElementById('adminAvatar').addEventListener('input', function() {
            const value = this.value.toUpperCase();
            document.getElementById('avatarPreview').textContent = value || 'A';
        });

        // ËèúÂçïÈ°πÁÇπÂáª‰∫ã‰ª∂
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const pageId = this.dataset.page;
                if (pageId) {
                    showPage(pageId);
                }
            });
        });

        // ÂØºËà™Ê†èÈìæÊé•ÁÇπÂáª‰∫ã‰ª∂
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const pageId = this.dataset.page;
                if (pageId) {
                    showPage(pageId);
                }
            });
        });
    </script>
</body>
</html>