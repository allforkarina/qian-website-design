<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ§åˆ¶å° - Dashboard</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.6;
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }

        .navbar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            height: 100%;
        }

        .navbar-brand {
            font-size: 24px;
            font-weight: bold;
            text-decoration: none;
            color: white;
            display: flex;
            align-items: center;
        }

        .navbar-brand::before {
            margin-right: 10px;
            font-size: 28px;
        }

        .navbar-nav {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .user-info:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .user-info:hover .user-avatar {
            transform: scale(1.1);
        }

        .user-name {
            font-weight: 500;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-container {
            margin-top: 60px;
            min-height: calc(100vh - 60px);
            background-color: #f8f9fa;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            width: 250px;
            height: calc(100vh - 60px);
            background-color: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg, rgba(255, 113, 101, 0.9) 0%, rgba(255, 164, 78, 0.9) 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: subtle-glow 3s ease-in-out infinite alternate;
            pointer-events: none;
        }

        .sidebar-subtitle {
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .sidebar-title {
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .sidebar-subtitle {
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: block;
            padding: 12px 20px;
            color: #495057;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .menu-item:hover {
            background-color: #f8f9fa;
            border-left-color: #667eea;
            color: #667eea;
        }

        .menu-item.active {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
            color: #1976d2;
            font-weight: 500;
        }

        .menu-item::before {
            content: "";
            margin-right: 10px;
        }

        /* .menu-item[data-icon="dashboard"]::before { content: "ğŸ“Š"; }
        .menu-item[data-icon="analytics"]::before { content: "ğŸ“ˆ"; }
        .menu-item[data-icon="users"]::before { content: "ğŸ‘¥"; }
        .menu-item[data-icon="monitoring"]::before { content: "ğŸ–¥ï¸"; } */

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .content {
            margin-left: 250px;
            padding: 30px;
            min-height: calc(100vh - 60px);
        }

        .content-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 300;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: #6c757d;
            font-size: 16px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3åˆ—ç­‰å®½å¸ƒå±€ */
            gap: 25px; /* å¡ç‰‡é—´è· */
            margin-bottom: 30px;
            max-width: 1200px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1024px) {
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr); /* ä¸­ç­‰å±å¹•2åˆ— */
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr; /* å°å±å¹•å•åˆ— */
                gap: 15px;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .card-content {
            color: #6c757d;
        }

        /* ç›‘æ§é¡µé¢ç‰¹æ®Šæ ·å¼ */
        .user-selector-container {
            max-width: 600px;
        }
        
        .user-info-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #667eea;
        }
        
        .user-info-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .user-info-card p {
            margin: 5px 0;
            color: #6c757d;
        }
        
        .battery-stats-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .stat-label {
            display: block;
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .stat-value {
            display: block;
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .tracking-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
        }
        
        /* çŠ¶æ€å¾½ç« æ ·å¼ */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-badge.inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .battery-stats-summary,
            .tracking-stats {
                grid-template-columns: 1fr;
            }
        }

        /* æ•°æ®åˆ†ææ ·å¼ */
        .battery-analysis-summary,
        .path-analysis-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .analysis-stat-item {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .analysis-stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .analysis-stat-item .stat-label {
            display: block;
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .analysis-stat-item .stat-value {
            display: block;
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-trend {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .trend-up { background-color: #d4edda; color: #155724; }
        .trend-down { background-color: #f8d7da; color: #721c24; }
        .trend-stable { background-color: #fff3cd; color: #856404; }

        /* å»ºè®®å¡ç‰‡æ ·å¼ */
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 15px;
        }

        .recommendation-card {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .recommendation-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
        }

        .recommendation-icon {
            font-size: 24px;
            margin-right: 15px;
            margin-top: 3px;
        }

        .recommendation-content h5 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .recommendation-content p {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
            line-height: 1.5;
        }

        /* åœ°å›¾æ§åˆ¶æ ·å¼ */
        .map-controls {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-top: 1px solid #e9ecef;
        }

        .map-controls label {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #495057;
            cursor: pointer;
        }

        .map-controls input[type="checkbox"] {
            margin-right: 8px;
        }

        /* æ¨¡å¼åˆ†ææ ·å¼ */
        .patterns-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .pattern-card {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .pattern-card h5 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .pattern-card div {
            color: #6c757d;
            font-size: 14px;
            line-height: 1.6;
        }

        /* è¯„ä¼°æŠ¥å‘Šæ ·å¼ */
        .evaluation-report {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .report-section h4 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 18px;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .score-value {
            font-size: 32px;
            line-height: 1;
        }

        .score-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .score-breakdown {
            flex: 1;
        }

        .score-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .score-name {
            min-width: 80px;
            font-size: 14px;
            color: #495057;
        }

        .score-bar {
            flex: 1;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.8s ease;
        }

        .score-number {
            min-width: 30px;
            text-align: right;
            font-weight: 600;
            color: #2c3e50;
        }

        .evaluation-text {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.6;
            color: #495057;
            border-left: 4px solid #667eea;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
            .battery-analysis-summary,
            .path-analysis-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .evaluation-report {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .battery-analysis-summary,
            .path-analysis-summary,
            .recommendations-grid,
            .patterns-grid {
                grid-template-columns: 1fr;
            }
            
            .score-display {
                flex-direction: column;
                text-align: center;
            }
        }

        /* ç”¨æˆ·ç®¡ç†æ ·å¼ */
        .role-badge {
            display: inline-block;
        }
        .role-admin { background-color: #f8d7da; color: #c82333;}
        .role-user { background-color: #8699a3bf; color: #ddfff9;}

        .status-btn {
            transition: all 0.3s ease;
        }
        .status-active { background-color: #3b9c95; color: #fff;}
        .status-inactive { background-color: #b0bec5; color: #fff;}
        .status-btn:hover { opacity: 0.85; }

        .btn-sm {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-danger {
            background-color: #f8d7da;
            color: #c82333;
            margin-right: 5px;
        }
        .btn-info {
            background-color: #e2f0fb;
            color: #117a8b;
        }
        .btn-sm:hover { opacity: 0.85; }

        .user-list-item:hover {
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
            transform: translateY(-2px) scale(1.01);
            transition: all 0.3s ease;
        }

        /* ç®¡ç†å‘˜é¡µé¢æ ·å¼ */
        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-form {
            max-width: 600px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #fff;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            margin-right: 10px;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 10px 0;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
        }

        .device-counter {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .counter-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 6px;
            background-color: #667eea;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .counter-btn:hover {
            background-color: #5a67d8;
            transform: scale(1.1);
        }

        .counter-display {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            min-width: 60px;
            text-align: center;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .content {
                margin-left: 0;
                padding: 20px;
            }

            .navbar-nav {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
                background: none;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
            }
        }

        .mobile-menu-btn {
            display: none;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }

        /* éšè—ç±» */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="#" class="navbar-brand">æ§åˆ¶å°</a>
            
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard">æ¦‚è§ˆ</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="monitoring">ç›‘æ§</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="analytics">åˆ†æ</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="users">ç”¨æˆ·</a>
                </li>
            </ul>

            <div class="user-info" onclick="showAdminPanel()">
                <span class="user-name" id="displayUserName">ç®¡ç†å‘˜</span>
                <div class="user-avatar" id="displayUserAvatar">A</div>
            </div>

            <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
        </div>
    </nav>

    <div class="main-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">æ§åˆ¶é¢æ¿</div>
                <div class="sidebar-subtitle">ç³»ç»Ÿç®¡ç†ä¸­å¿ƒ</div>
            </div>
            
            <nav class="sidebar-menu">
                <a href="#" class="menu-item active" data-icon="dashboard" data-page="dashboard">ä»ªè¡¨æ¿</a>
                <a href="#" class="menu-item" data-icon="monitoring" data-page="monitoring">ç³»ç»Ÿç›‘æ§</a>
                <a href="#" class="menu-item" data-icon="analytics" data-page="analytics">æ•°æ®åˆ†æ</a>
                <a href="#" class="menu-item" data-icon="users" data-page="users">ç”¨æˆ·ç®¡ç†</a>
            </nav>
        </aside>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="content">
            <!-- ä»ªè¡¨æ¿é¡µé¢ -->
            <div id="dashboard-page" class="page-content">
                <div class="content-header">
                    <h1 class="page-title">æ¬¢è¿æ¥åˆ°æ§åˆ¶å°</h1>
                    <p class="page-subtitle">è¿™é‡Œæ˜¯æ‚¨çš„ç³»ç»Ÿç®¡ç†ä¸­å¿ƒï¼Œå¯ä»¥ç›‘æ§å’Œç®¡ç†æ‰€æœ‰åŠŸèƒ½æ¨¡å—</p>
                </div>

                <!-- ä»ªè¡¨æ¿å¡ç‰‡ -->
                <div class="dashboard-cards">

                    <div class="card">
                        <div class="card-header">
                            <!-- <span class="card-icon">ğŸ“ˆ</span> -->
                            <h3 class="card-title">è®¾å¤‡ç›‘æ§</h3>
                        </div>
                        <div class="card-content">
                            <p>å®æ—¶ç›‘æ§æ¥å…¥è®¾å¤‡çš„æ€§èƒ½å’Œä½¿ç”¨æƒ…å†µ</p>
                            <div style="margin-top: 15px;">
                                <span class="status-indicator status-online"></span>
                                <small>è®¾å¤‡æ­£å¸¸æ¥å…¥ä½¿ç”¨</small>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <!-- <span class="card-icon">ğŸ”§</span> -->
                            <h3 class="card-title">æ•°æ®åˆ†æ</h3>
                        </div>
                        <div class="card-content">
                            <p>åˆ†ææ¥å…¥è®¾å¤‡çš„ä½¿ç”¨æƒ…å†µå’Œæ€§èƒ½æ•°æ®</p>
                            <div style="margin-top: 15px;">
                                <span class="status-indicator status-online"></span>
                                <small>è®¾å¤‡æ•°æ®å¯ç”¨</small>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <!-- <span class="card-icon">ğŸ”</span> -->
                            <h3 class="card-title">è®¾å¤‡ç®¡ç†</h3>
                        </div>
                        <div class="card-content">
                            <p>ç®¡ç†å¯æ¥å…¥çš„è®¾å¤‡æ•°é‡å’Œè¿æ¥çŠ¶æ€</p>
                            <div style="margin-top: 15px;">
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #6c757d; font-size: 14px;">å½“å‰æ¥å…¥è®¾å¤‡:</span>
                                        <span style="font-weight: 600; color: #2c3e50;" id="currentConnectedDevices">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #6c757d; font-size: 14px;">å¯ç”¨è®¾å¤‡:</span>
                                        <span style="font-weight: 600; color: #28a745;" id="activeDeviceCount">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #6c757d; font-size: 14px;">æœ€å¤§å®¹é‡:</span>
                                        <span style="font-weight: 600; color: #667eea;" id="deviceCountDisplay">5</span>
                                    </div>
                                </div>
                                <div style="margin-top: 12px;">
                                    <span class="status-indicator" id="deviceStatusIndicator"></span>
                                    <small id="deviceStatusText">è®¾å¤‡çŠ¶æ€æ­£å¸¸</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                 <div class="card">
                    <div class="card-header">
                        <!-- <span class="card-icon">ğŸ“‹</span> -->
                        <h3 class="card-title">ç³»ç»ŸçŠ¶æ€</h3>
                    </div>
                    <div class="card-content">
                        <p>å½“å‰ç³»ç»Ÿè¿è¡ŒçŠ¶æ€è‰¯å¥½ï¼Œæ‰€æœ‰æ¨¡å—æ­£å¸¸å·¥ä½œã€‚</p>
                        <br>
                        <p>è®¾å¤‡ä¿¡æ¯ï¼š</p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>å½“å‰æ¥å…¥è®¾å¤‡æ•°é‡: <span id="registeredUserCount">0</span> äºº</li>
                            <li>å¯ç”¨è®¾å¤‡æ•°é‡: <span id="onlineDeviceCount">0</span> å°</li>
                            <li>æœ€å¤§å¯æ¥å…¥è®¾å¤‡: <span id="maxDeviceCount">5</span> å°</li>
                            <li>è®¾å¤‡ä½¿ç”¨ç‡: <span id="deviceUsageRate">0%</span></li>
                        </ul>
                        
                        <!-- è®¾å¤‡ä½¿ç”¨ç‡è¿›åº¦æ¡ -->
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 14px; color: #6c757d;">è®¾å¤‡å®¹é‡ä½¿ç”¨æƒ…å†µ</span>
                                <span style="font-size: 12px; color: #6c757d;" id="capacityRatio">0/5</span>
                            </div>
                            <div style="background-color: #e9ecef; border-radius: 6px; height: 12px; overflow: hidden;">
                                <div id="dashboardUsageBar" style="height: 100%; width: 0%; background-color: #28a745; border-radius: 6px; transition: all 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†å‘˜è®¾ç½®é¡µé¢ -->
            <div id="admin-page" class="page-content admin-panel">
                <div class="content-header">
                    <h1 class="page-title">ç®¡ç†å‘˜è®¾ç½®</h1>
                    <p class="page-subtitle">é…ç½®ç®¡ç†å‘˜ä¿¡æ¯å’Œç³»ç»Ÿå‚æ•°</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ä¸ªäººä¿¡æ¯è®¾ç½®</h3>
                    </div>
                    <div class="card-content">
                        <form class="admin-form" id="adminForm">
                            <div class="form-group">
                                <label class="form-label" for="adminName">ç®¡ç†å‘˜åç§°</label>
                                <input type="text" class="form-input" id="adminName" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜åç§°" value="ç®¡ç†å‘˜">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="adminAvatar">å¤´åƒå­—æ¯</label>
                                <input type="text" class="form-input" id="adminAvatar" placeholder="è¯·è¾“å…¥å¤´åƒæ˜¾ç¤ºå­—æ¯" maxlength="2" value="A">
                                <div class="avatar-preview" id="avatarPreview">A</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="adminBio">ä¸ªäººç®€ä»‹</label>
                                <textarea class="form-input form-textarea" id="adminBio" placeholder="è¯·è¾“å…¥ä¸ªäººç®€ä»‹">ç³»ç»Ÿç®¡ç†å‘˜ï¼Œè´Ÿè´£æ•´ä½“ç³»ç»Ÿè¿ç»´å’Œç®¡ç†å·¥ä½œã€‚</textarea>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- åœ¨è®¾å¤‡æ¥å…¥è®¾ç½®å¡ç‰‡ä¸­æ·»åŠ å­˜å‚¨è®¾ç½® -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">è®¾å¤‡æ¥å…¥è®¾ç½®</h3>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label">æœ€å¤§å¯æ¥å…¥è®¾å¤‡æ•°é‡</label>
                            <div class="device-counter">
                                <button type="button" class="counter-btn" onclick="changeDeviceCount(-1)">-</button>
                                <span class="counter-display" id="deviceCount">5</span>
                                <button type="button" class="counter-btn" onclick="changeDeviceCount(1)">+</button>
                            </div>
                            <small style="color: #9dd1ff; margin-top: 8px; display: block;">
                                è®¾å¤‡æ•°é‡èŒƒå›´: 1-20å°
                            </small>
                        </div>

                        <!-- æ–°å¢ï¼šå­˜å‚¨æ•°æ®ä¸Šé™è®¾ç½® -->
                        <div class="form-group" style="margin-top: 30px;">
                            <label class="form-label">æœ¬åœ°å­˜å‚¨æ•°æ®ä¸Šé™</label>
                            <div class="device-counter">
                                <button type="button" class="counter-btn" onclick="changeStorageLimit(-1)">-</button>
                                <span class="counter-display" id="storageLimit">30</span>
                                <button type="button" class="counter-btn" onclick="changeStorageLimit(1)">+</button>
                            </div>
                            <small style="color: #9dd1ff; margin-top: 8px; display: block;">
                                æ•°æ®æ¡æ•°èŒƒå›´: 500-5000æ¡ (å½±å“ç”µæ± æ•°æ®å’Œä½ç½®æ•°æ®å­˜å‚¨)
                            </small>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ä¿å­˜è®¾ç½®</h3>
                    </div>
                    <div class="card-content">
                        <button type="button" class="btn btn-primary" onclick="saveAdminSettings()">ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
                        <button type="button" class="btn btn-secondary" onclick="resetAdminSettings()">é‡ç½®ä¸ºé»˜è®¤</button>
                        <button type="button" class="btn btn-secondary" onclick="backToDashboard()">è¿”å›ä»ªè¡¨æ¿</button>
                    </div>
                </div>
            </div>

            <!-- å…¶ä»–é¡µé¢å†…å®¹ï¼ˆå ä½ï¼‰ -->
            <div id="analytics-page" class="page-content hidden">
                <div class="content-header">
                    <h1 class="page-title">æ•°æ®åˆ†æ</h1>
                    <p class="page-subtitle">æ·±åº¦åˆ†æç”¨æˆ·è®¾å¤‡ä½¿ç”¨æƒ…å†µå’Œéª‘è¡Œæ¨¡å¼</p>
                </div>

                <!-- ç”¨æˆ·é€‰æ‹©å™¨ -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">ğŸ‘¤</span>
                        <h3 class="card-title">ç”¨æˆ·é€‰æ‹©</h3>
                    </div>
                    <div class="card-content">
                        <div class="user-selector-container">
                            <label class="form-label" for="analyticsUserSelect">é€‰æ‹©è¦åˆ†æçš„ç”¨æˆ·ï¼š</label>
                            <select class="form-input" id="analyticsUserSelect" onchange="switchAnalyticsUser()" style="max-width: 300px;">
                                <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                            </select>
                            <div class="selected-user-info" id="analyticsSelectedUserInfo" style="margin-top: 15px; display: none;">
                                <div class="user-info-card">
                                    <h4 id="analyticsCurrentUserName">ç”¨æˆ·åç§°</h4>
                                    <p><strong>è§’è‰²ï¼š</strong><span id="analyticsCurrentUserRole">æ™®é€šç”¨æˆ·</span></p>
                                    <p><strong>è®¾å¤‡ç¼–å·ï¼š</strong><span id="analyticsCurrentUserDevice">æœªåˆ†é…</span></p>
                                    <p><strong>åˆ†æå‘¨æœŸï¼š</strong><span id="analyticsDateRange">æœ€è¿‘7å¤©</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åˆ†ææ•°æ®å®¹å™¨ -->
                <div id="analyticsDataContainer" style="display: none;">
                    <!-- ç”µæ± ä½¿ç”¨åˆ†æ -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-icon">ğŸ”‹</span>
                            <h3 class="card-title">ç”µæ± ä½¿ç”¨åˆ†æ</h3>
                            <div style="margin-left: auto;">
                                <button class="btn btn-secondary" onclick="refreshAnalyticsData()" style="padding: 8px 16px; font-size: 12px;">
                                    <span id="analyticsRefreshIcon">ğŸ”„</span> åˆ·æ–°åˆ†æ
                                </button>
                                <button class="btn btn-secondary" onclick="exportAnalyticsReport()" style="padding: 8px 16px; font-size: 12px; margin-left: 8px;">
                                    ğŸ“Š å¯¼å‡ºæŠ¥å‘Š
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <!-- ç”µæ± ç»Ÿè®¡æ¦‚è§ˆ -->
                            <div class="battery-analysis-summary">
                                <div class="analysis-stat-item">
                                    <span class="stat-label">å¹³å‡ç”µå‹</span>
                                    <span class="stat-value" id="avgVoltage">--V</span>
                                    <span class="stat-trend" id="voltageTrend"></span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">å¹³å‡ç”µæµ</span>
                                    <span class="stat-value" id="avgCurrent">--A</span>
                                    <span class="stat-trend" id="currentTrend"></span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">ç”µæ± å¥åº·åº¦</span>
                                    <span class="stat-value" id="batteryHealth">--</span>
                                    <span class="stat-trend" id="healthTrend"></span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">ä½¿ç”¨æ•ˆç‡</span>
                                    <span class="stat-value" id="efficiency">--%</span>
                                    <span class="stat-trend" id="efficiencyTrend"></span>
                                </div>
                            </div>

                            <!-- ç”µæ± è¶‹åŠ¿å›¾è¡¨ -->
                            <div class="chart-container" style="position: relative; height: 300px; margin: 20px 0;">
                                <canvas id="batteryTrendChart"></canvas>
                            </div>

                            <!-- ç”µæ± å»ºè®®å¡ç‰‡ -->
                            <div class="recommendations-section">
                                <h4 style="margin-bottom: 15px; color: #2c3e50;">ğŸ’¡ ä½¿ç”¨å»ºè®®</h4>
                                <div class="recommendations-grid">
                                    <div class="recommendation-card" id="chargingRecommendation">
                                        <div class="recommendation-icon">âš¡</div>
                                        <div class="recommendation-content">
                                            <h5>å……ç”µå»ºè®®</h5>
                                            <p id="chargingAdvice">åˆ†æä¸­...</p>
                                        </div>
                                    </div>
                                    <div class="recommendation-card" id="usageRecommendation">
                                        <div class="recommendation-icon">ğŸ”‹</div>
                                        <div class="recommendation-content">
                                            <h5>ä½¿ç”¨å»ºè®®</h5>
                                            <p id="usageAdvice">åˆ†æä¸­...</p>
                                        </div>
                                    </div>
                                    <div class="recommendation-card" id="maintenanceRecommendation">
                                        <div class="recommendation-icon">ğŸ”§</div>
                                        <div class="recommendation-content">
                                            <h5>ç»´æŠ¤å»ºè®®</h5>
                                            <p id="maintenanceAdvice">åˆ†æä¸­...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- éª‘è¡Œè·¯å¾„åˆ†æ -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-icon">ğŸ—ºï¸</span>
                            <h3 class="card-title">éª‘è¡Œè·¯å¾„åˆ†æ</h3>
                            <div style="margin-left: auto;">
                                <select id="pathAnalysisPeriod" class="form-input" onchange="updatePathAnalysis()" style="width: 120px; padding: 6px 10px;">
                                    <option value="7">æœ€è¿‘7å¤©</option>
                                    <option value="14">æœ€è¿‘14å¤©</option>
                                    <option value="30">æœ€è¿‘30å¤©</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-content">
                            <!-- è·¯å¾„ç»Ÿè®¡æ¦‚è§ˆ -->
                            <div class="path-analysis-summary">
                                <div class="analysis-stat-item">
                                    <span class="stat-label">æ€»éª‘è¡Œè·ç¦»</span>
                                    <span class="stat-value" id="totalDistance">-- km</span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">æ´»åŠ¨å¤©æ•°</span>
                                    <span class="stat-value" id="activeDays">-- å¤©</span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">å¹³å‡æ—¥è·ç¦»</span>
                                    <span class="stat-value" id="avgDailyDistance">-- km</span>
                                </div>
                                <div class="analysis-stat-item">
                                    <span class="stat-label">è¦†ç›–èŒƒå›´</span>
                                    <span class="stat-value" id="coverageArea">-- kmÂ²</span>
                                </div>
                            </div>

                            <!-- è·¯å¾„è¦†ç›–åœ°å›¾ -->
                            <div class="map-analysis-container">
                                <div id="pathAnalysisMap" style="height: 400px; border-radius: 8px; overflow: hidden; margin: 20px 0;"></div>
                                
                                <!-- è·¯å¾„çƒ­åŠ›å›¾æ§åˆ¶ -->
                                <div class="map-controls">
                                    <label>
                                        <input type="checkbox" id="showHeatmap" onchange="toggleHeatmap()" checked>
                                        æ˜¾ç¤ºæ´»åŠ¨çƒ­åŠ›å›¾
                                    </label>
                                    <label style="margin-left: 20px;">
                                        <input type="checkbox" id="showCoverage" onchange="toggleCoverage()" checked>
                                        æ˜¾ç¤ºè¦†ç›–åŒºåŸŸ
                                    </label>
                                </div>
                            </div>

                            <!-- è·¯å¾„æ¨¡å¼åˆ†æ -->
                            <div class="path-patterns-section">
                                <h4 style="margin: 20px 0 15px 0; color: #2c3e50;">ğŸ“ˆ è·¯å¾„æ¨¡å¼åˆ†æ</h4>
                                <div class="patterns-grid">
                                    <div class="pattern-card">
                                        <h5>ğŸ“ å¸¸ç”¨åŒºåŸŸ</h5>
                                        <div id="frequentAreas">åˆ†æä¸­...</div>
                                    </div>
                                    <div class="pattern-card">
                                        <h5>ğŸ•’ æ´»åŠ¨æ—¶æ®µ</h5>
                                        <div id="activeTimePatterns">åˆ†æä¸­...</div>
                                    </div>
                                    <div class="pattern-card">
                                        <h5>ğŸ“Š éª‘è¡Œä¹ æƒ¯</h5>
                                        <div id="ridingHabits">åˆ†æä¸­...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç»¼åˆè¯„ä¼°æŠ¥å‘Š -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-icon">ğŸ“‹</span>
                            <h3 class="card-title">ç»¼åˆè¯„ä¼°æŠ¥å‘Š</h3>
                        </div>
                        <div class="card-content">
                            <div class="evaluation-report">
                                <div class="report-section">
                                    <h4>ğŸ¯ ä½¿ç”¨è¯„åˆ†</h4>
                                    <div class="score-display">
                                        <div class="score-circle" id="overallScore">
                                            <span class="score-value">--</span>
                                            <span class="score-label">æ€»åˆ†</span>
                                        </div>
                                        <div class="score-breakdown">
                                            <div class="score-item">
                                                <span class="score-name">ç”µæ± ç®¡ç†</span>
                                                <div class="score-bar">
                                                    <div class="score-fill" id="batteryScore" style="width: 0%"></div>
                                                </div>
                                                <span class="score-number" id="batteryScoreNum">0</span>
                                            </div>
                                            <div class="score-item">
                                                <span class="score-name">éª‘è¡Œé¢‘ç‡</span>
                                                <div class="score-bar">
                                                    <div class="score-fill" id="frequencyScore" style="width: 0%"></div>
                                                </div>
                                                <span class="score-number" id="frequencyScoreNum">0</span>
                                            </div>
                                            <div class="score-item">
                                                <span class="score-name">è·¯å¾„æ•ˆç‡</span>
                                                <div class="score-bar">
                                                    <div class="score-fill" id="pathScore" style="width: 0%"></div>
                                                </div>
                                                <span class="score-number" id="pathScoreNum">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="report-section">
                                    <h4>ğŸ“ æ€»ç»“ä¸å»ºè®®</h4>
                                    <div id="evaluationSummary" class="evaluation-text">
                                        æ­£åœ¨ç”Ÿæˆç»¼åˆè¯„ä¼°æŠ¥å‘Š...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ— æ•°æ®æç¤º -->
                <div id="analyticsNoDataMessage" class="card" style="display: none;">
                    <div class="card-content" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
                        <h4>æš‚æ— åˆ†ææ•°æ®</h4>
                        <p style="color: #6c757d;">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·è¿›è¡Œæ•°æ®åˆ†æ</p>
                    </div>
                </div>
            </div>

            <!-- monitoringé¡µé¢å†…å®¹ -->
            <div id="monitoring-page" class="page-content hidden">
                <div class="content-header">
                    <h1 class="page-title">ç³»ç»Ÿç›‘æ§</h1>
                    <p class="page-subtitle">å®æ—¶ç›‘æ§ç”¨æˆ·è®¾å¤‡çŠ¶æ€å’Œè½¨è¿¹ä¿¡æ¯</p>
                </div>

                <!-- ç”¨æˆ·é€‰æ‹©å™¨ -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">ğŸ‘¤</span>
                        <h3 class="card-title">ç”¨æˆ·é€‰æ‹©</h3>
                    </div>
                    <div class="card-content">
                        <div class="user-selector-container">
                            <label class="form-label" for="monitoringUserSelect">é€‰æ‹©è¦ç›‘æ§çš„ç”¨æˆ·ï¼š</label>
                            <select class="form-input" id="monitoringUserSelect" onchange="switchMonitoringUser()" style="max-width: 300px;">
                                <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                            </select>
                            <div class="selected-user-info" id="selectedUserInfo" style="margin-top: 15px; display: none;">
                                <div class="user-info-card">
                                    <h4 id="currentUserName">ç”¨æˆ·åç§°</h4>
                                    <p><strong>è§’è‰²ï¼š</strong><span id="currentUserRole">æ™®é€šç”¨æˆ·</span></p>
                                    <p><strong>è®¾å¤‡ç¼–å·ï¼š</strong><span id="currentUserDevice">æœªåˆ†é…</span></p>
                                    <p><strong>çŠ¶æ€ï¼š</strong><span id="currentUserStatus" class="status-badge">å¯ç”¨</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç›‘æ§æ•°æ®å®¹å™¨ -->
                <div id="monitoringDataContainer" style="display: none;">
                    <!-- ç”µæ± ç›‘æ§å›¾è¡¨ -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ç”µæ± ç›‘æ§æ•°æ®</h3>
                            <div style="margin-left: auto;">
                                <button class="btn btn-secondary" onclick="refreshBatteryData()" style="padding: 8px 16px; font-size: 12px;">
                                    <span id="batteryRefreshIcon"></span> åˆ·æ–°æ•°æ®
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="battery-stats-summary">
                                <div class="stat-item">
                                    <span class="stat-label">å½“å‰ç”µå‹</span>
                                    <span class="stat-value" id="currentVoltage">--V</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">å½“å‰ç”µæµ</span>
                                    <span class="stat-value" id="currentCurrent">--A</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">æ•°æ®ç‚¹æ•°</span>
                                    <span class="stat-value" id="dataPointCount">0</span>
                                </div>
                            </div>
                            <div class="chart-container" style="position: relative; height: 400px; margin-top: 20px;">
                                <canvas id="monitoringBatteryChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- è½¨è¿¹ç›‘æ§åœ°å›¾ -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">è½¨è¿¹ç›‘æ§</h3>
                            <div style="margin-left: auto;">
                                <label for="dateSelector" style="margin-right: 10px; font-weight: 500;">é€‰æ‹©æ—¥æœŸï¼š</label>
                                <select id="dateSelector" class="form-input" onchange="switchTrackingDate()" style="width: 150px; padding: 6px 10px;">
                                    <option value="">é€‰æ‹©æ—¥æœŸ</option>
                                </select>
                                <button class="btn btn-secondary" onclick="refreshMapData()" style="padding: 8px 16px; font-size: 12px; margin-left: 10px;">
                                    <span id="mapRefreshIcon"></span> åˆ·æ–°åœ°å›¾
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="tracking-stats" id="trackingStats" style="margin-bottom: 15px; display: none;">
                                <div class="stat-item">
                                    <span class="stat-label">è½¨è¿¹ç‚¹æ•°</span>
                                    <span class="stat-value" id="trackPointCount">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">æ€»è·ç¦»</span>
                                    <span class="stat-value" id="totalDistance">0 km</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">æ´»åŠ¨æ—¶é—´</span>
                                    <span class="stat-value" id="activityTime">--</span>
                                </div>
                            </div>
                            <div id="monitoringMap" style="height: 500px; border-radius: 8px; overflow: hidden;"></div>
                            <div id="mapLoadingIndicator" style="display: none; text-align: center; padding: 20px; color: #6c757d;">
                                <div class="loading-spinner" style="margin: 0 auto 10px;"></div>
                                <p>æ­£åœ¨åŠ è½½åœ°å›¾æ•°æ®...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ— æ•°æ®æç¤º -->
                <div id="noDataMessage" class="card" style="display: none;">
                    <div class="card-content" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
                        <h4>æš‚æ— ç›‘æ§æ•°æ®</h4>
                        <p style="color: #6c757d;">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·æŸ¥çœ‹å…¶ç›‘æ§æ•°æ®</p>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·ç®¡ç†é¡µé¢ -->
            <div id="users-page" class="page-content hidden">
                <div class="content-header">
                    <h1 class="page-title">ç”¨æˆ·ç®¡ç†</h1>
                    <p class="page-subtitle">ç®¡ç†ç³»ç»Ÿç”¨æˆ·å’Œè®¾å¤‡æ¥å…¥</p>
                </div>

                <!-- ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ -->
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ç”¨æˆ·ç»Ÿè®¡</h3>
                        </div>
                        <div class="card-content">
                            <p>å½“å‰å·²æ³¨å†Œç”¨æˆ·: <strong id="currentUserCount">0</strong> äºº</p>
                            <p>æœ€å¤§å¯æ¥å…¥è®¾å¤‡: <strong id="maxUserDevices">5</strong> å°</p>
                            <div style="margin-top: 15px;">
                                <span class="status-indicator" id="userStatusIndicator"></span>
                                <small id="userStatusText">ç³»ç»Ÿæ­£å¸¸</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·å½•å…¥è¡¨å• -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">æ·»åŠ æ–°ç”¨æˆ·</h3>
                    </div>
                    <div class="card-content">
                        <form class="admin-form" id="addUserForm" style="max-width: 500px;">
                            <div class="form-group">
                                <label class="form-label" for="newUserName">ç”¨æˆ·å§“å</label>
                                <input type="text" class="form-input" id="newUserName" placeholder="è¯·è¾“å…¥ç”¨æˆ·å§“å" maxlength="20">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="newUserRole">ç”¨æˆ·è§’è‰²</label>
                                <select class="form-input" id="newUserRole">
                                    <option value="user">æ™®é€šç”¨æˆ·</option>
                                    <option value="admin">ç®¡ç†å‘˜</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="newUserDevice">è®¾å¤‡ç¼–å·</label>
                                <input type="text" class="form-input" id="newUserDevice" placeholder="è¯·è¾“å…¥è®¾å¤‡ç¼–å·ï¼ˆå¯é€‰ï¼‰" maxlength="20">
                            </div>

                            <div class="form-group">
                                <button type="button" class="btn btn-primary" onclick="addNewUser()">
                                    <span id="addUserBtnText">æ·»åŠ ç”¨æˆ·</span>
                                </button>             
                                <span id="addUserSpinner" class="loading-spinner hidden" style="margin-left: 10px;"></span>
                                <button type="button" class="btn btn-secondary" onclick="clearUserForm()">æ¸…ç©ºè¡¨å•</button>
                            </div>

                            <!-- å®¹é‡è­¦å‘Š -->
                            <div id="capacityWarning" class="hidden" style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px; margin-top: 15px; color: #856404;">
                                <strong>å®¹é‡è­¦å‘Š:</strong> 
                                <span id="warningMessage">å½“å‰ç”¨æˆ·æ•°é‡å·²æ¥è¿‘ä¸Šé™</span>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- ç”¨æˆ·åˆ—è¡¨ -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">å·²æ³¨å†Œç”¨æˆ·åˆ—è¡¨</h3>
                        <div style="margin-left: auto;">
                            <button class="btn btn-secondary" onclick="refreshUserList()" style="padding: 8px 16px; font-size: 12px; background-color: rgba(108,117,125,0.85); color: white; backdrop-filter: blur(10px);">
                                åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <!-- æœç´¢è¿‡æ»¤å™¨ -->
                        <div class="form-group" style="margin-bottom: 20px;"></div>
                            <input type="text" class="form-input" id="userSearchInput" placeholder="æœç´¢ç”¨æˆ·å§“åæˆ–è®¾å¤‡ç¼–å·..." style="max-width: 300px;" oninput="filterUserList()">
                        </div>

                        <!-- ç”¨æˆ·åˆ—è¡¨å®¹å™¨ -->
                        <div id="userListContainer">
                            <!-- <div id="emptyUserState" class="text-center" style="color: #6c757d; padding: 40px;"></div>
                                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘¤</div>
                                <h4>æš‚æ— ç”¨æˆ·æ•°æ®</h4>
                                <p>è¯·æ·»åŠ ç¬¬ä¸€ä¸ªç”¨æˆ·å¼€å§‹ä½¿ç”¨ç³»ç»Ÿ</p>
                            </div> -->
                        </div>
                    </div>
                </div>
            </div>


        </main>
    </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let adminSettings = {
            name: 'ç®¡ç†å‘˜',
            avatar: 'A',
            bio: 'ç³»ç»Ÿç®¡ç†å‘˜ï¼Œè´Ÿè´£æ•´ä½“ç³»ç»Ÿè¿ç»´å’Œç®¡ç†å·¥ä½œã€‚',
            maxDevices: 5,
            storageLimit: 30  // æ–°å¢ï¼šå­˜å‚¨æ•°æ®ä¸Šé™
        };

        // ç›‘æ§é¡µé¢å…¨å±€å˜é‡
        let monitoringBatteryChart = null;
        let monitoringMap = null;
        let currentMonitoringUser = null;
        let currentTrackingDate = null;
        let trackingLayer = null;
        let userDataMapping = {};   // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®æ˜ å°„ - ä¸ºæ¯ä¸ªç”¨æˆ·åˆ†é…ç‹¬ç«‹çš„æ•°æ®

        // æ•°æ®åˆ†æéƒ¨åˆ†
        let analyticsMap = null;
        let currentAnalyticsUser = null;
        let batteryTrendChart = null;
        let heatmapLayer = null;
        let coverageLayer = null;

        // ç”¨æˆ·ç®¡ç†å…¨å±€å˜é‡
        let userList = [];
        let filteredUserList = [];

        /* ---------- ä»ªè¡¨ç›˜è®¾ç½®ï¼ˆå¯¼èˆªä»ªï¼‰ ---------- */

        /* ---------- ä¸»é¡µé¢ä»ªè¡¨ç›˜å¡ç‰‡ ä»¥åŠé¡µé¢æ§åˆ¶å‡½æ•° ---------- */
        // åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º/éšè—ï¼ˆç§»åŠ¨ç«¯ï¼‰
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿
        function showAdminPanel() {
            showPage('admin');
        }

        // è¿”å›ä»ªè¡¨æ¿
        function backToDashboard() {
            showPage('dashboard');
        }

        // é¡µé¢åˆ‡æ¢å‡½æ•°
        function showPage(pageId) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('active');
            });

            // æ˜¾ç¤ºæŒ‡å®šé¡µé¢
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('active');
            }

            // æ›´æ–°èœå•çŠ¶æ€
            updateMenuState(pageId);
        }

        // æ›´æ–°èœå•çŠ¶æ€
        function updateMenuState(activePageId) {
            // æ›´æ–°ä¾§è¾¹æ èœå•
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === activePageId) {
                    item.classList.add('active');
                }
            });

            // æ›´æ–°é¡¶éƒ¨å¯¼èˆª
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === activePageId) {
                    link.classList.add('active');
                }
            });
        }

        // æ›´æ–°ä»ªè¡¨æ¿è®¾å¤‡ç»Ÿè®¡æ˜¾ç¤º
        function updateDashboardDeviceStats() {
            const totalUsers = userList.length;
            const activeUsers = userList.filter(u => u.status === 'active').length;
            const maxDevices = adminSettings.maxDevices;
            const usagePercent = Math.round((totalUsers / maxDevices) * 100);

            // æ›´æ–°è®¾å¤‡ç®¡ç†å¡ç‰‡
            const currentConnectedElement = document.getElementById('currentConnectedDevices');
            const activeDeviceElement = document.getElementById('activeDeviceCount');
            const deviceStatusIndicator = document.getElementById('deviceStatusIndicator');
            const deviceStatusText = document.getElementById('deviceStatusText');

            if (currentConnectedElement) currentConnectedElement.textContent = totalUsers;
            if (activeDeviceElement) activeDeviceElement.textContent = activeUsers;

            // æ›´æ–°è®¾å¤‡çŠ¶æ€æŒ‡ç¤ºå™¨
            if (deviceStatusIndicator && deviceStatusText) {
                if (usagePercent >= 90) {
                    deviceStatusIndicator.className = 'status-indicator status-offline';
                    deviceStatusText.textContent = 'è®¾å¤‡å®¹é‡å³å°†æ»¡è½½';
                } else if (usagePercent >= 70) {
                    deviceStatusIndicator.className = 'status-indicator status-warning';
                    deviceStatusText.textContent = 'è®¾å¤‡ä½¿ç”¨ç‡è¾ƒé«˜';
                } else {
                    deviceStatusIndicator.className = 'status-indicator status-online';
                    deviceStatusText.textContent = 'è®¾å¤‡çŠ¶æ€æ­£å¸¸';
                }
            }

            // æ›´æ–°ç³»ç»ŸçŠ¶æ€å¡ç‰‡
            const onlineDeviceCount = document.getElementById('onlineDeviceCount');
            const registeredUserCount = document.getElementById('registeredUserCount');
            const maxDeviceCount = document.getElementById('maxDeviceCount');
            const deviceUsageRate = document.getElementById('deviceUsageRate');
            const capacityRatio = document.getElementById('capacityRatio');
            const dashboardUsageBar = document.getElementById('dashboardUsageBar');

            if (onlineDeviceCount) onlineDeviceCount.textContent = activeUsers;
            if (registeredUserCount) registeredUserCount.textContent = totalUsers;
            if (maxDeviceCount) maxDeviceCount.textContent = maxDevices;
            if (deviceUsageRate) deviceUsageRate.textContent = usagePercent + '%';
            if (capacityRatio) capacityRatio.textContent = `${totalUsers}/${maxDevices}`;

            // æ›´æ–°ä½¿ç”¨ç‡è¿›åº¦æ¡
            if (dashboardUsageBar) {
                dashboardUsageBar.style.width = usagePercent + '%';
                
                // æ ¹æ®ä½¿ç”¨ç‡è®¾ç½®è¿›åº¦æ¡é¢œè‰²
                if (usagePercent >= 90) {
                    dashboardUsageBar.style.backgroundColor = '#dc3545'; // çº¢è‰²
                } else if (usagePercent >= 70) {
                    dashboardUsageBar.style.backgroundColor = '#ffc107'; // é»„è‰²
                } else {
                    dashboardUsageBar.style.backgroundColor = '#28a745'; // ç»¿è‰²
                }
            }

            // æ›´æ–°è®¾å¤‡è®¡æ•°æ˜¾ç¤º
            const deviceCountDisplay = document.getElementById('deviceCountDisplay');
            if (deviceCountDisplay) {
                deviceCountDisplay.textContent = maxDevices;
            }

            console.log(`ğŸ“Š ä»ªè¡¨æ¿è®¾å¤‡ç»Ÿè®¡å·²æ›´æ–°: ${totalUsers}/${maxDevices} (${usagePercent}%)`);
        }

        // æ•°ç»„æ‰“ä¹±å‡½æ•°ï¼ˆFisher-Yatesæ´—ç‰Œç®—æ³•ï¼‰
        function shuffleArray(array) {
            const shuffled = [...array]; // åˆ›å»ºå‰¯æœ¬
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // è·å–ç”¨æˆ·åœ¨åˆ—è¡¨ä¸­çš„åºå·ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºç¬¬ä¸€ä¸ªç”¨æˆ·ï¼‰
        function getUserIndex(userId) {
            return userList.findIndex(user => user.id === userId);
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºç¬¬ä¸€ä¸ªç”¨æˆ·çš„è¾…åŠ©å‡½æ•°
        function isFirstUser(userId) {
            if (userList.length === 0) return false;
            return userList[0].id === userId;
        }


        /* ---------- ç›‘æ§æ•°æ®é¡µé¢åŠŸèƒ½ ---------- */
        // åˆå§‹åŒ–ç›‘æ§é¡µé¢
        function initializeMonitoringPage() {
            loadUserSelector();
            setupMonitoringComponents();
        }

        // åŠ è½½ç”¨æˆ·é€‰æ‹©å™¨
        function loadUserSelector() {
            const selector = document.getElementById('monitoringUserSelect');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            selector.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
            
            // æ·»åŠ å·²å½•å…¥çš„ç”¨æˆ·
            userList.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.device || 'æ— è®¾å¤‡'})`;
                selector.appendChild(option);
            });
            
            console.log('ğŸ“‹ ç”¨æˆ·é€‰æ‹©å™¨å·²æ›´æ–°ï¼Œå…±', userList.length, 'ä¸ªç”¨æˆ·');
        }

        // åˆ‡æ¢ç›‘æ§ç”¨æˆ·
        function switchMonitoringUser() {
            const selector = document.getElementById('monitoringUserSelect');
            const userId = selector.value;
            
            if (!userId) {
                hideMonitoringData();
                return;
            }
            
            const user = userList.find(u => u.id === userId);
            if (!user) {
                console.error('âŒ ç”¨æˆ·æœªæ‰¾åˆ°:', userId);
                return;
            }
            
            currentMonitoringUser = user;
            displayUserInfo(user);
            loadUserMonitoringData(user);
            showMonitoringData();
            
            console.log('ğŸ‘¤ åˆ‡æ¢åˆ°ç”¨æˆ·:', user.name);
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function displayUserInfo(user) {
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentUserRole').textContent = getRoleDisplayName(user.role);
            document.getElementById('currentUserDevice').textContent = user.device || 'æœªåˆ†é…';
            
            const statusElement = document.getElementById('currentUserStatus');
            statusElement.textContent = user.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨';
            statusElement.className = `status-badge ${user.status}`;
            
            document.getElementById('selectedUserInfo').style.display = 'block';
        }

        // åŠ è½½ç”¨æˆ·ç›‘æ§æ•°æ®
        function loadUserMonitoringData(user) {
            // ä¸ºç”¨æˆ·åˆ†é…æˆ–è·å–ç°æœ‰æ•°æ®
            if (!userDataMapping[user.id]) {
                // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·
                const isFirstUser = userList.length > 0 && userList[0].id === user.id;
                
                let batteryData = generateUserBatteryData(user);
                let trackingData = generateUserTrackingData(user);
                
                // å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼Œæ‰“ä¹±æ•°æ®é¡ºåº
                if (!isFirstUser) {
                    batteryData = shuffleArray([...batteryData]); // åˆ›å»ºå‰¯æœ¬å¹¶æ‰“ä¹±
                    trackingData = shuffleTrackingData(trackingData); // æ‰“ä¹±è½¨è¿¹æ•°æ®
                    console.log(`ğŸ”€ ç”¨æˆ· ${user.name} çš„æ•°æ®å·²æ‰“ä¹±é¡ºåº`);
                } else {
                    console.log(`ğŸ“Š ç”¨æˆ· ${user.name} æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼Œä¿æŒåŸå§‹æ•°æ®é¡ºåº`);
                }
                
                userDataMapping[user.id] = {
                    batteryData: batteryData,
                    trackingData: trackingData
                };
                console.log('ğŸ”‹ ä¸ºç”¨æˆ·ç”Ÿæˆç›‘æ§æ•°æ®:', user.name);
            }

            // åŠ è½½ç”µæ± æ•°æ®
            loadBatteryChart(userDataMapping[user.id].batteryData);
            
            // åŠ è½½è½¨è¿¹æ•°æ®é€‰æ‹©å™¨
            loadDateSelector(userDataMapping[user.id].trackingData);
        }

        // è½¨è¿¹æ•°æ®æ‰“ä¹±å‡½æ•°
        function shuffleTrackingData(trackingData) {
            const shuffledData = {};
            
            // å¯¹æ¯ä¸€å¤©çš„æ•°æ®è¿›è¡Œå¤„ç†
            Object.keys(trackingData).forEach(date => {
                const dayData = trackingData[date];
                if (dayData && dayData.path && Array.isArray(dayData.path)) {
                    // æ‰“ä¹±å½“å¤©çš„è·¯å¾„ç‚¹é¡ºåº
                    const shuffledPath = shuffleArray([...dayData.path]);
                    
                    shuffledData[date] = {
                        ...dayData,
                        path: shuffledPath
                    };
                } else {
                    // å¦‚æœæ²¡æœ‰è·¯å¾„æ•°æ®ï¼Œç›´æ¥å¤åˆ¶
                    shuffledData[date] = { ...dayData };
                }
            });
            
            return shuffledData;
        }

        // ç”Ÿæˆç”¨æˆ·ç”µæ± æ•°æ® (åŸºäºç°æœ‰æ•°æ®çš„æ¨¡æ‹Ÿ)
        function generateUserBatteryData(user) {
            try {
                // å°è¯•ä»localStorageè·å–çœŸå®æ•°æ®
                const realBatteryData = localStorage.getItem('batteryHistoryData');
                let baseData = [];
                
                if (realBatteryData) {
                    const parsedData = JSON.parse(realBatteryData);
                    
                    // æ£€æŸ¥æ•°æ®ç»“æ„æ˜¯å¦åŒ…å«voltageå’Œcurrentæ•°ç»„
                    if (parsedData && parsedData.voltage && parsedData.current && 
                        Array.isArray(parsedData.voltage) && Array.isArray(parsedData.current)) {

                        const voltageArray = parsedData.voltage;
                        const currentArray = parsedData.current;
                        const dataLength = Math.min(voltageArray.length, currentArray.length);
                        
                        // å°†æ•°ç»„æ•°æ®è½¬æ¢ä¸ºå¯¹è±¡æ•°ç»„æ ¼å¼
                        for (let i = 0; i < dataLength; i++) {
                            baseData.push({
                                voltage: voltageArray[i],
                                current: currentArray[i],
                            });
                        }
                        
                        console.log(`ğŸ“Š ä»localStorageåŠ è½½äº† ${dataLength} æ¡ç”µæ± æ•°æ®`);
                    } 
                    else {
                        console.warn('âš ï¸ batteryHistoryDataæ•°æ®ç»“æ„ä¸æ­£ç¡®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                        baseData = generateMockBatteryData(30);
                    }
                } 
                else {
                    console.log('ğŸ“Š æœªæ‰¾åˆ°localStorageä¸­çš„ç”µæ± æ•°æ®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®');
                    baseData = generateMockBatteryData(30);
                }
                
                // å¦‚æœæ²¡æœ‰æ•°æ®æˆ–æ•°æ®ä¸è¶³ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                if (baseData.length === 0) {
                    baseData = generateMockBatteryData(window.maxBatteryDataPoints);
                }
                
                // ä¸ºæ¯ä¸ªç”¨æˆ·ç¨å¾®è°ƒæ•´æ•°æ®ï¼Œä½†ä¿æŒåˆç†èŒƒå›´
                const userVariation = (user.id.charCodeAt(user.id.length - 1) % 10) * 0.01 - 0.04; // 0-0.09çš„å˜åŒ–
                
                return baseData.map((item, index) => ({
                    timestamp: item.timestamp || new Date(Date.now() - (baseData.length - index) * 60000).toISOString(),
                    voltage: Math.max(7.4, Math.min(7.6, (item.voltage || 7.5) + userVariation)),
                    current: Math.max(0.35, Math.min(0.5, (item.current || 0.4) + userVariation * 0.5))
                }));
                
            } catch (error) {
                console.error('âŒ ç”Ÿæˆç”¨æˆ·ç”µæ± æ•°æ®å¤±è´¥:', error);
                console.error('âŒ è¯¦ç»†é”™è¯¯ä¿¡æ¯:', error.message);
                return generateMockBatteryData(20);
            }
        }

        // ç”Ÿæˆç”¨æˆ·è½¨è¿¹æ•°æ® (åŸºäºç°æœ‰æ•°æ®çš„æ¨¡æ‹Ÿ)
        function generateUserTrackingData(user) {
            try {
                // å°è¯•ä»localStorageè·å–çœŸå®æ•°æ®
                const realMockData = localStorage.getItem('mockData');
                let baseData = {};
                
                if (realMockData) {
                    const parsedData = JSON.parse(realMockData);
                    
                    // å¤„ç†å®é™…çš„æ•°æ®ç»“æ„
                    Object.keys(parsedData).forEach(date => {
                        const dayData = parsedData[date];
                        
                        // æ£€æŸ¥æ•°æ®ç»“æ„å¹¶è½¬æ¢pathæ ¼å¼
                        if (dayData && dayData.path && Array.isArray(dayData.path)) {
                            // è½¬æ¢pathæ•°ç»„æ ¼å¼ï¼šä» [[lat, lng], [lat, lng]] è½¬ä¸º [{lat, lng}, {lat, lng}]
                            const convertedPath = dayData.path.map((point, index) => {
                                if (Array.isArray(point) && point.length >= 2) {
                                    return {
                                        lat: point[0],
                                        lng: point[1],
                                        timestamp: new Date(Date.now() - (dayData.path.length - index) * 60000).toISOString()
                                    };
                                } else if (typeof point === 'object' && point.lat && point.lng) {
                                    return {
                                        lat: point.lat,
                                        lng: point.lng,
                                        timestamp: point.timestamp || new Date(Date.now() - (dayData.path.length - index) * 60000).toISOString()
                                    };
                                }
                                return null;
                            }).filter(point => point !== null);
                            
                            baseData[date] = {
                                path: convertedPath,
                                totalDistance: dayData.Distance || dayData.distance || Math.round(Math.random() * 50 + 10),
                                numTarget: dayData.numTarget || 0,
                                voltage: dayData.Voltage || dayData.voltage || 0,
                                current: dayData.Current || dayData.current || 0
                            };
                            
                            console.log(`ğŸ“… å¤„ç†æ—¥æœŸ ${date}:`, convertedPath.length, 'ä¸ªè½¨è¿¹ç‚¹');
                        }
                    });
                }
                
                // å¦‚æœæ²¡æœ‰çœŸå®æ•°æ®æˆ–å¤„ç†åæ²¡æœ‰æ•°æ®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                if (Object.keys(baseData).length === 0) {
                    console.log('ğŸ“ æœªæ‰¾åˆ°æœ‰æ•ˆè½¨è¿¹æ•°æ®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®');
                    baseData = generateMockTrackingData();
                }
                
                // ä¸ºæ¯ä¸ªç”¨æˆ·è°ƒæ•´è½¨è¿¹æ•°æ®ï¼ˆç¨å¾®åç§»åæ ‡ï¼‰
                const userOffset = {
                    lat: ((user.id.charCodeAt(0) % 10) - 5) * 0.001, // -0.005 åˆ° 0.005
                    lng: ((user.id.charCodeAt(1) % 10) - 5) * 0.001
                };
                
                const userData = {};
                Object.keys(baseData).forEach(date => {
                    if (baseData[date] && baseData[date].path) {
                        userData[date] = {
                            ...baseData[date],
                            path: baseData[date].path.map(point => ({
                                lat: point.lat + userOffset.lat,
                                lng: point.lng + userOffset.lng,
                                timestamp: point.timestamp || new Date().toISOString()
                            }))
                        };
                    }
                });
                
                console.log('ğŸ“Š ç”Ÿæˆç”¨æˆ·è½¨è¿¹æ•°æ®å®Œæˆï¼Œå…±', Object.keys(userData).length, 'ä¸ªæ—¥æœŸ');
                return userData;
                
            } catch (error) {
                console.error('âŒ ç”Ÿæˆç”¨æˆ·è½¨è¿¹æ•°æ®å¤±è´¥:', error);
                return generateMockTrackingData();
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿç”µæ± æ•°æ®
        function generateMockBatteryData(count) {
            const data = [];
            const now = new Date();
            
            for (let i = 0; i < count; i++) {
                const timestamp = new Date(now.getTime() - (count - i) * 60000);
                data.push({
                    timestamp: timestamp.toISOString(),
                    voltage: 3.3 + Math.random() * 0.8, // 3.3V - 4.1V
                    current: 0.2 + Math.random() * 0.6   // 0.2A - 0.8A
                });
            }
            
            return data;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿè½¨è¿¹æ•°æ®
        function generateMockTrackingData() {
            const data = {};
            const baseLocation = { lat: 39.9042, lng: 116.4074 }; // åŒ—äº¬å¤©å®‰é—¨
            
            // ç”Ÿæˆæœ€è¿‘7å¤©çš„æ•°æ®
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const path = [];
                for (let j = 0; j < 20; j++) {
                    path.push({
                        lat: baseLocation.lat + (Math.random() - 0.5) * 0.02,
                        lng: baseLocation.lng + (Math.random() - 0.5) * 0.02,
                        timestamp: new Date(date.getTime() + j * 60000).toISOString()
                    });
                }
                
                data[dateStr] = {
                    path: path,
                    totalDistance: Math.round(Math.random() * 50 + 10) // 10-60km
                };
            }
            
            return data;
        }

        // åŠ è½½ç”µæ± å›¾è¡¨
        function loadBatteryChart(batteryData) {
            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (monitoringBatteryChart) {
                monitoringBatteryChart.destroy();
                monitoringBatteryChart = null;
            }
            
            const canvas = document.getElementById('monitoringBatteryChart');
            if (!canvas) {
                console.error('âŒ æ‰¾ä¸åˆ°ç”µæ± å›¾è¡¨ç”»å¸ƒ');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // å‡†å¤‡æ•°æ®
            const labels = batteryData.map(item => 
                new Date(item.timestamp).toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                })
            );
            const voltageData = batteryData.map(item => item.voltage);
            const currentData = batteryData.map(item => item.current);
            
            // åˆ›å»ºå›¾è¡¨
            monitoringBatteryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ç”µå‹ (V)',
                            data: voltageData,
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            fill: true,
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'ç”µæµ (A)',
                            data: currentData,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            fill: true,
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#333333' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#666666' },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#4facfe' },
                            grid: { color: 'rgba(79,172,254,0.1)' },
                            title: { display: true, text: 'ç”µå‹ (V)', color: '#4facfe' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#ff6b6b' },
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'ç”µæµ (A)', color: '#ff6b6b' }
                        }
                    }
                }
            });
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateBatteryStats(batteryData);
            
            console.log('ğŸ“Š ç”µæ± ç›‘æ§å›¾è¡¨å·²åŠ è½½ï¼Œæ•°æ®ç‚¹æ•°:', batteryData.length);
        }

        // æ›´æ–°ç”µæ± ç»Ÿè®¡ä¿¡æ¯
        function updateBatteryStats(batteryData) {
            if (batteryData.length === 0) {
                document.getElementById('currentVoltage').textContent = '--V';
                document.getElementById('currentCurrent').textContent = '--A';
                document.getElementById('dataPointCount').textContent = '0';
                return;
            }
            
            const latest = batteryData[batteryData.length - 1];
            document.getElementById('currentVoltage').textContent = latest.voltage.toFixed(2) + 'V';
            document.getElementById('currentCurrent').textContent = latest.current.toFixed(2) + 'A';
            document.getElementById('dataPointCount').textContent = batteryData.length;
        }

        // åŠ è½½æ—¥æœŸé€‰æ‹©å™¨
        function loadDateSelector(trackingData) {
            const selector = document.getElementById('dateSelector');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            selector.innerHTML = '<option value="">é€‰æ‹©æ—¥æœŸ</option>';
            
            // æ·»åŠ å¯ç”¨æ—¥æœŸ
            const dates = Object.keys(trackingData).sort().reverse(); // æœ€æ–°æ—¥æœŸåœ¨å‰
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = new Date(date).toLocaleDateString('zh-CN');
                selector.appendChild(option);
            });
            
            // é»˜è®¤é€‰æ‹©æœ€æ–°æ—¥æœŸ
            if (dates.length > 0) {
                selector.value = dates[0];
                switchTrackingDate();
            }
            
            console.log('ğŸ“… æ—¥æœŸé€‰æ‹©å™¨å·²æ›´æ–°ï¼Œå…±', dates.length, 'ä¸ªæ—¥æœŸ');
        }

        // åˆ‡æ¢è½¨è¿¹æ—¥æœŸ
        function switchTrackingDate() {
            const selector = document.getElementById('dateSelector');
            const selectedDate = selector.value;
            
            if (!selectedDate || !currentMonitoringUser) {
                return;
            }
            
            currentTrackingDate = selectedDate;
            const trackingData = userDataMapping[currentMonitoringUser.id].trackingData;
            
            if (trackingData[selectedDate]) {
                loadTrackingMap(trackingData[selectedDate]);
            } else {
                console.warn('âš ï¸ é€‰å®šæ—¥æœŸæ— è½¨è¿¹æ•°æ®:', selectedDate);
            }
        }

        // åŠ è½½è½¨è¿¹åœ°å›¾
        function loadTrackingMap(dayData) {
            console.log('ğŸ—ºï¸ å¼€å§‹åŠ è½½è½¨è¿¹åœ°å›¾ï¼Œæ•°æ®:', dayData);
            
            const mapContainer = document.getElementById('monitoringMap');
            
            // åˆå§‹åŒ–åœ°å›¾ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰
            if (!monitoringMap) {
                console.log('ğŸ—ºï¸ åˆå§‹åŒ–åœ°å›¾...');
                try {
                    monitoringMap = L.map('monitoringMap').setView([26.7638, 106.046], 13); // ä½¿ç”¨å®é™…æ•°æ®çš„ä¸­å¿ƒç‚¹
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(monitoringMap);
                    
                    console.log('âœ… åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    console.error('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                    return;
                }
            }
            
            // æ¸…é™¤ç°æœ‰è½¨è¿¹
            if (trackingLayer) {
                monitoringMap.removeLayer(trackingLayer);
                trackingLayer = null;
            }
            
            const path = dayData.path;
            console.log('ğŸ“ è½¨è¿¹è·¯å¾„æ•°æ®:', path);
            
            if (!path || path.length === 0) {
                console.warn('âš ï¸ å½“æ—¥æ— è½¨è¿¹æ•°æ®');
                return;
            }
            
            // éªŒè¯è·¯å¾„æ•°æ®æ ¼å¼
            const validPath = path.filter(point => 
                point && 
                typeof point.lat === 'number' && 
                typeof point.lng === 'number' &&
                !isNaN(point.lat) && 
                !isNaN(point.lng)
            );
            
            if (validPath.length === 0) {
                console.error('âŒ æ²¡æœ‰æœ‰æ•ˆçš„è½¨è¿¹ç‚¹æ•°æ®');
                return;
            }
            
            console.log('âœ… æœ‰æ•ˆè½¨è¿¹ç‚¹æ•°:', validPath.length);
            
            try {
                // åˆ›å»ºæ–°çš„å›¾å±‚ç»„
                trackingLayer = L.layerGroup();
                
                // è½¬æ¢è·¯å¾„æ ¼å¼
                const latLngs = validPath.map(point => [point.lat, point.lng]);
                console.log('ğŸ“ è½¬æ¢åçš„åæ ‡:', latLngs);
                
                // æ·»åŠ è½¨è¿¹çº¿
                const polyline = L.polyline(latLngs, {
                    color: '#667eea',
                    weight: 4,
                    opacity: 0.8
                });
                trackingLayer.addLayer(polyline);
                
                // æ·»åŠ èµ·ç‚¹æ ‡è®°
                if (validPath.length > 0) {
                    const startMarker = L.marker([validPath[0].lat, validPath[0].lng], {
                        icon: L.divIcon({
                            className: 'custom-marker start-marker',
                            html: 'ğŸš€',
                            iconSize: [25, 25],
                            iconAnchor: [12, 12]
                        })
                    }).bindPopup(`èµ·ç‚¹<br>åæ ‡: ${validPath[0].lat.toFixed(4)}, ${validPath[0].lng.toFixed(4)}`);
                    trackingLayer.addLayer(startMarker);
                }
                
                // æ·»åŠ ç»ˆç‚¹æ ‡è®°
                if (validPath.length > 1) {
                    const lastPoint = validPath[validPath.length - 1];
                    const endMarker = L.marker([lastPoint.lat, lastPoint.lng], {
                        icon: L.divIcon({
                            className: 'custom-marker end-marker',
                            html: 'ğŸ',
                            iconSize: [25, 25],
                            iconAnchor: [12, 12]
                        })
                    }).bindPopup(`ç»ˆç‚¹<br>åæ ‡: ${lastPoint.lat.toFixed(4)}, ${lastPoint.lng.toFixed(4)}`);
                    trackingLayer.addLayer(endMarker);
                }
                
                // æ·»åŠ åˆ°åœ°å›¾
                trackingLayer.addTo(monitoringMap);
                
                // è°ƒæ•´åœ°å›¾è§†é‡ä»¥é€‚åº”è½¨è¿¹
                if (latLngs.length > 0) {
                    const bounds = polyline.getBounds();
                    monitoringMap.fitBounds(bounds, { padding: [20, 20] });
                    console.log('ğŸ—ºï¸ åœ°å›¾è§†é‡å·²è°ƒæ•´åˆ°è½¨è¿¹èŒƒå›´');
                }
                
                // æ›´æ–°è½¨è¿¹ç»Ÿè®¡
                updateTrackingStats(dayData);
                
                console.log('âœ… è½¨è¿¹åœ°å›¾åŠ è½½å®Œæˆï¼Œè·¯å¾„ç‚¹æ•°:', validPath.length);
                
            } catch (error) {
                console.error('âŒ åœ°å›¾åŠ è½½å¤±è´¥:', error);
            }
        }

        function updateTrackingStats(dayData) {
            const path = dayData.path || [];
            
            document.getElementById('trackPointCount').textContent = path.length;
            
            // ä½¿ç”¨å®é™…çš„è·ç¦»æ•°æ®
            const distance = dayData.totalDistance || dayData.Distance || dayData.distance || 0;
            document.getElementById('totalDistance').textContent = distance + ' km';
            
            // è®¡ç®—æ´»åŠ¨æ—¶é—´
            if (path.length > 1) {
                // å°è¯•è§£ææ—¶é—´æˆ³
                let startTime, endTime;
                
                if (path[0].timestamp) {
                    startTime = new Date(path[0].timestamp);
                } else {
                    startTime = new Date(); // é»˜è®¤å½“å‰æ—¶é—´
                }
                
                if (path[path.length - 1].timestamp) {
                    endTime = new Date(path[path.length - 1].timestamp);
                } else {
                    endTime = new Date(startTime.getTime() + path.length * 60000); // é»˜è®¤æ¯ä¸ªç‚¹é—´éš”1åˆ†é’Ÿ
                }
                
                const duration = Math.round((endTime - startTime) / 60000); // åˆ†é’Ÿ
                document.getElementById('activityTime').textContent = duration > 0 ? duration + ' åˆ†é’Ÿ' : '1 åˆ†é’Ÿ';
            } else {
                document.getElementById('activityTime').textContent = '--';
            }
            
            document.getElementById('trackingStats').style.display = 'block';
        }

        // æ˜¾ç¤ºç›‘æ§æ•°æ®
        function showMonitoringData() {
            document.getElementById('monitoringDataContainer').style.display = 'block';
            document.getElementById('noDataMessage').style.display = 'none';
        }

        // éšè—ç›‘æ§æ•°æ®
        function hideMonitoringData() {
            document.getElementById('monitoringDataContainer').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('selectedUserInfo').style.display = 'none';
            currentMonitoringUser = null;
            currentTrackingDate = null;
        }

        // åˆ·æ–°ç”µæ± æ•°æ®
        function refreshBatteryData() {
            if (!currentMonitoringUser) return;
            
            const refreshIcon = document.getElementById('batteryRefreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            setTimeout(() => {
                // æ£€æŸ¥æ˜¯å¦ä¸ºç¬¬ä¸€ä¸ªç”¨æˆ·
                const isFirst = isFirstUser(currentMonitoringUser.id);
                
                // é‡æ–°ç”Ÿæˆæ•°æ®ï¼ˆæ¨¡æ‹Ÿå®æ—¶æ›´æ–°ï¼‰
                let newBatteryData = generateUserBatteryData(currentMonitoringUser);
                
                // å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼Œæ‰“ä¹±æ•°æ®
                if (!isFirst) {
                    newBatteryData = shuffleArray([...newBatteryData]);
                    console.log(`ğŸ”€ åˆ·æ–°æ—¶æ‰“ä¹±äº†ç”¨æˆ· ${currentMonitoringUser.name} çš„ç”µæ± æ•°æ®`);
                }
                
                userDataMapping[currentMonitoringUser.id].batteryData = newBatteryData;
                loadBatteryChart(userDataMapping[currentMonitoringUser.id].batteryData);
                
                refreshIcon.style.animation = '';
                showSuccessMessage('ç”µæ± æ•°æ®å·²åˆ·æ–°');
            }, 1000);
        }

        // åˆ·æ–°åœ°å›¾æ•°æ®
        function refreshMapData() {
            if (!currentMonitoringUser || !currentTrackingDate) return;
            
            const refreshIcon = document.getElementById('mapRefreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            setTimeout(() => {
                const trackingData = userDataMapping[currentMonitoringUser.id].trackingData;
                if (trackingData[currentTrackingDate]) {
                    loadTrackingMap(trackingData[currentTrackingDate]);
                }
                
                refreshIcon.style.animation = '';
                showSuccessMessage('åœ°å›¾æ•°æ®å·²åˆ·æ–°');
            }, 1000);
        }

        // è®¾ç½®ç›‘æ§ç»„ä»¶
        function setupMonitoringComponents() {
            // ç›‘å¬ç”¨æˆ·åˆ—è¡¨å˜åŒ–ï¼Œæ›´æ–°é€‰æ‹©å™¨
            const originalAddUser = addNewUser;
            const originalDeleteUser = deleteUser;
            
            // åœ¨ç”¨æˆ·æ·»åŠ åæ›´æ–°ç›‘æ§é€‰æ‹©å™¨
            window.addNewUser = function() {
                originalAddUser();
                setTimeout(() => {
                    loadUserSelector();
                }, 100);
            };
            
            // åœ¨ç”¨æˆ·åˆ é™¤åæ›´æ–°ç›‘æ§é€‰æ‹©å™¨
            window.deleteUser = function(userId) {
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç›‘æ§ç”¨æˆ·ï¼Œæ¸…ç©ºç›‘æ§
                if (currentMonitoringUser && currentMonitoringUser.id === userId) {
                    hideMonitoringData();
                }
                
                // åˆ é™¤ç”¨æˆ·æ•°æ®æ˜ å°„
                delete userDataMapping[userId];
                
                originalDeleteUser(userId);
                setTimeout(() => {
                    loadUserSelector();
                }, 100);
            };
        }


        /* ---------- æ•°æ®åˆ†æé¡µé¢åŠŸèƒ½ ---------- */

        // åˆå§‹åŒ–åˆ†æé¡µé¢
        function initializeAnalyticsPage() {
            loadAnalyticsUserSelector();
        }

        // åŠ è½½ç”¨æˆ·é€‰æ‹©å™¨
        function loadAnalyticsUserSelector() {
            const selector = document.getElementById('analyticsUserSelect');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            selector.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
            
            // æ·»åŠ å·²å½•å…¥çš„ç”¨æˆ·
            userList.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.device || 'æ— è®¾å¤‡'})`;
                selector.appendChild(option);
            });
            
            console.log('ğŸ“‹ åˆ†æç”¨æˆ·é€‰æ‹©å™¨å·²æ›´æ–°ï¼Œå…±', userList.length, 'ä¸ªç”¨æˆ·');
        }

        // åˆ‡æ¢åˆ†æç”¨æˆ·
        function switchAnalyticsUser() {
            const selector = document.getElementById('analyticsUserSelect');
            const userId = selector.value;
            
            if (!userId) {
                hideAnalyticsData();
                return;
            }
            
            const user = userList.find(u => u.id === userId);
            if (!user) {
                console.error('âŒ åˆ†æç”¨æˆ·æœªæ‰¾åˆ°:', userId);
                return;
            }
            
            currentAnalyticsUser = user;
            displayAnalyticsUserInfo(user);
            loadUserAnalyticsData(user);
            showAnalyticsData();
            
            console.log('ğŸ” åˆ‡æ¢åˆ°åˆ†æç”¨æˆ·:', user.name);
        }

        // æ˜¾ç¤ºåˆ†æç”¨æˆ·ä¿¡æ¯
        function displayAnalyticsUserInfo(user) {
            document.getElementById('analyticsCurrentUserName').textContent = user.name;
            document.getElementById('analyticsCurrentUserRole').textContent = getRoleDisplayName(user.role);
            document.getElementById('analyticsCurrentUserDevice').textContent = user.device || 'æœªåˆ†é…';
            
            document.getElementById('analyticsSelectedUserInfo').style.display = 'block';
        }

        // åŠ è½½ç”¨æˆ·åˆ†ææ•°æ®
        function loadUserAnalyticsData(user) {
            // ç¡®ä¿ç”¨æˆ·æ•°æ®æ˜ å°„å­˜åœ¨
            if (!userDataMapping[user.id]) {
                // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·
                const isFirstUser = userList.length > 0 && userList[0].id === user.id;
                
                let batteryData = generateUserBatteryData(user);
                let trackingData = generateUserTrackingData(user);
                
                // å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼Œæ‰“ä¹±æ•°æ®é¡ºåº
                if (!isFirstUser) {
                    batteryData = shuffleArray([...batteryData]); // åˆ›å»ºå‰¯æœ¬å¹¶æ‰“ä¹±
                    trackingData = shuffleTrackingData(trackingData); // æ‰“ä¹±è½¨è¿¹æ•°æ®
                    console.log(`ğŸ”€ åˆ†æç”¨æˆ· ${user.name} çš„æ•°æ®å·²æ‰“ä¹±é¡ºåº`);
                } else {
                    console.log(`ğŸ“Š åˆ†æç”¨æˆ· ${user.name} æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼Œä¿æŒåŸå§‹æ•°æ®é¡ºåº`);
                }
                
                userDataMapping[user.id] = {
                    batteryData: batteryData,
                    trackingData: trackingData
                };
            }
            
            // åˆ†æç”µæ± æ•°æ®
            analyzeBatteryData(userDataMapping[user.id].batteryData);
            
            // åˆ†æè·¯å¾„æ•°æ®
            analyzePathData(userDataMapping[user.id].trackingData);
            
            // ç”Ÿæˆç»¼åˆè¯„ä¼°
            generateEvaluationReport(user);
        }

        // åˆ†æç”µæ± æ•°æ®
        function analyzeBatteryData(batteryData) {
            if (!batteryData || batteryData.length === 0) {
                console.warn('âš ï¸ æ— ç”µæ± æ•°æ®è¿›è¡Œåˆ†æ');
                return;
            }
            
            console.log('ğŸ”‹ å¼€å§‹åˆ†æç”µæ± æ•°æ®ï¼Œå…±', batteryData.length, 'æ¡è®°å½•');
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const voltages = batteryData.map(d => d.voltage);
            const currents = batteryData.map(d => d.current);
            
            const avgVoltage = voltages.reduce((a, b) => a + b, 0) / voltages.length;
            const avgCurrent = currents.reduce((a, b) => a + b, 0) / currents.length;
            const maxVoltage = Math.max(...voltages);
            const minVoltage = Math.min(...voltages);
            
            // è®¡ç®—ç”µæ± å¥åº·åº¦ (åŸºäºç”µå‹ç¨³å®šæ€§å’ŒèŒƒå›´)
            const voltageRange = maxVoltage - minVoltage;
            const voltageStability = 1 - (voltageRange / maxVoltage);
            const healthScore = Math.min(100, Math.max(0, (voltageStability * 100 + (avgVoltage / 8.4) * 100) / 2));
            
            // è®¡ç®—ä½¿ç”¨æ•ˆç‡ (åŸºäºç”µæµç¨³å®šæ€§)
            const currentStdDev = calculateStandardDeviation(currents);
            const efficiencyScore = Math.min(100, Math.max(0, 100 - (currentStdDev * 200)));
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('avgVoltage').textContent = avgVoltage.toFixed(2) + 'V';
            document.getElementById('avgCurrent').textContent = avgCurrent.toFixed(2) + 'A';
            document.getElementById('batteryHealth').textContent = healthScore.toFixed(0) + '%';
            document.getElementById('efficiency').textContent = efficiencyScore.toFixed(0) + '%';
            
            // æ›´æ–°è¶‹åŠ¿æŒ‡ç¤ºå™¨
            updateTrendIndicators(batteryData);
            
            // åˆ›å»ºè¶‹åŠ¿å›¾è¡¨
            createBatteryTrendChart(batteryData);
            
            // ç”Ÿæˆå»ºè®®
            generateBatteryRecommendations(avgVoltage, avgCurrent, healthScore, efficiencyScore);
        }

        // è®¡ç®—æ ‡å‡†å·®
        function calculateStandardDeviation(values) {
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - avg, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
            return Math.sqrt(avgSquareDiff);
        }

        // æ›´æ–°è¶‹åŠ¿æŒ‡ç¤ºå™¨
        function updateTrendIndicators(batteryData) {
            if (batteryData.length < 10) return;
            
            const recent = batteryData.slice(-5);
            const previous = batteryData.slice(-10, -5);
            
            const recentAvgVoltage = recent.reduce((a, b) => a + b.voltage, 0) / recent.length;
            const previousAvgVoltage = previous.reduce((a, b) => a + b.voltage, 0) / previous.length;
            
            const voltageTrend = recentAvgVoltage > previousAvgVoltage ? 'up' : 
                                recentAvgVoltage < previousAvgVoltage ? 'down' : 'stable';
            
            const voltageTrendElement = document.getElementById('voltageTrend');
            voltageTrendElement.className = `stat-trend trend-${voltageTrend}`;
            voltageTrendElement.textContent = voltageTrend === 'up' ? 'â†— ä¸Šå‡' : 
                                            voltageTrend === 'down' ? 'â†˜ ä¸‹é™' : 'â†’ ç¨³å®š';
        }

        // åˆ›å»ºç”µæ± è¶‹åŠ¿å›¾è¡¨
        function createBatteryTrendChart(batteryData) {
            if (batteryTrendChart) {
                batteryTrendChart.destroy();
            }
            
            const canvas = document.getElementById('batteryTrendChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // å‡†å¤‡æ•°æ® - åªæ˜¾ç¤ºæœ€è¿‘24å°æ—¶çš„æ•°æ®
            const recentData = batteryData;
            const labels = recentData.map((_, index) => `${index + 1}h`);
            const voltageData = recentData.map(d => d.voltage);
            const currentData = recentData.map(d => d.current);
            
            batteryTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ç”µå‹è¶‹åŠ¿',
                            data: voltageData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'ç”µæµè¶‹åŠ¿',
                            data: currentData,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'ç”µå‹ (V)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ç”µæµ (A)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        // ç”Ÿæˆç”µæ± å»ºè®®
        function generateBatteryRecommendations(avgVoltage, avgCurrent, healthScore, efficiencyScore) {
            // å……ç”µå»ºè®®
            let chargingAdvice = '';
            if (avgVoltage < 7.2) {
                chargingAdvice = 'ç”µå‹åä½ï¼Œå»ºè®®åŠæ—¶å……ç”µã€‚é¿å…æ·±åº¦æ”¾ç”µä»¥å»¶é•¿ç”µæ± å¯¿å‘½ã€‚';
            } else if (avgVoltage > 8.0) {
                chargingAdvice = 'ç”µå‹æ­£å¸¸åé«˜ï¼Œå»ºè®®é€‚åº¦ä½¿ç”¨åå†å……ç”µï¼Œé¿å…è¿‡åº¦å……ç”µã€‚';
            } else {
                chargingAdvice = 'ç”µå‹æ°´å¹³è‰¯å¥½ï¼Œä¿æŒå½“å‰å……ç”µä¹ æƒ¯å³å¯ã€‚';
            }
            
            // ä½¿ç”¨å»ºè®®
            let usageAdvice = '';
            if (efficiencyScore < 60) {
                usageAdvice = 'ä½¿ç”¨æ•ˆç‡åä½ï¼Œå»ºè®®æ£€æŸ¥è®¾å¤‡è´Ÿè½½ï¼Œé¿å…è¶…è½½ä½¿ç”¨ã€‚';
            } else if (efficiencyScore > 85) {
                usageAdvice = 'ä½¿ç”¨æ•ˆç‡å¾ˆé«˜ï¼Œç»§ç»­ä¿æŒè‰¯å¥½çš„ä½¿ç”¨ä¹ æƒ¯ã€‚';
            } else {
                usageAdvice = 'ä½¿ç”¨æ•ˆç‡æ­£å¸¸ï¼Œå¯é€‚å½“ä¼˜åŒ–ä½¿ç”¨æ–¹å¼æå‡æ•ˆç‡ã€‚';
            }
            
            // ç»´æŠ¤å»ºè®®
            let maintenanceAdvice = '';
            if (healthScore < 70) {
                maintenanceAdvice = 'ç”µæ± å¥åº·åº¦è¾ƒä½ï¼Œå»ºè®®è¿›è¡Œä¸“ä¸šæ£€æµ‹å’Œç»´æŠ¤ã€‚';
            } else if (healthScore > 90) {
                maintenanceAdvice = 'ç”µæ± çŠ¶æ€è‰¯å¥½ï¼Œç»§ç»­å®šæœŸä¿å…»å³å¯ã€‚';
            } else {
                maintenanceAdvice = 'ç”µæ± çŠ¶æ€æ­£å¸¸ï¼Œå»ºè®®å®šæœŸæ¸…æ´æ¥è§¦ç‚¹ã€‚';
            }
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('chargingAdvice').textContent = chargingAdvice;
            document.getElementById('usageAdvice').textContent = usageAdvice;
            document.getElementById('maintenanceAdvice').textContent = maintenanceAdvice;
        }

        // åˆ†æè·¯å¾„æ•°æ®
        function analyzePathData(trackingData) {
            if (!trackingData || Object.keys(trackingData).length === 0) {
                console.warn('âš ï¸ æ— è·¯å¾„æ•°æ®è¿›è¡Œåˆ†æ');
                return;
            }
            
            console.log('ğŸ—ºï¸ å¼€å§‹åˆ†æè·¯å¾„æ•°æ®ï¼Œå…±', Object.keys(trackingData).length, 'å¤©è®°å½•');
            
            const period = parseInt(document.getElementById('pathAnalysisPeriod').value);
            const dates = Object.keys(trackingData).sort().slice(-period);
            
            let totalDistance = 0;
            let activeDays = 0;
            let allPoints = [];
            
            dates.forEach(date => {
                const dayData = trackingData[date];
                if (dayData && dayData.path && dayData.path.length > 0) {
                    totalDistance += dayData.totalDistance || 0;
                    activeDays++;
                    allPoints.push(...dayData.path);
                }
            });
            
            const avgDailyDistance = activeDays > 0 ? (totalDistance / activeDays) : 0;
            const coverageArea = calculateCoverageArea(allPoints);
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalDistance').textContent = totalDistance.toFixed(1) + ' km';
            document.getElementById('activeDays').textContent = activeDays + ' å¤©';
            document.getElementById('avgDailyDistance').textContent = avgDailyDistance.toFixed(1) + ' km';
            document.getElementById('coverageArea').textContent = coverageArea.toFixed(2) + ' kmÂ²';
            
            // åˆ›å»ºè·¯å¾„åˆ†æåœ°å›¾
            createPathAnalysisMap(allPoints, dates, trackingData);
            
            // åˆ†æè·¯å¾„æ¨¡å¼
            analyzePathPatterns(trackingData, dates);
        }

        // è®¡ç®—è¦†ç›–é¢ç§¯
        function calculateCoverageArea(points) {
            if (points.length < 3) return 0;
            
            const lats = points.map(p => p.lat);
            const lngs = points.map(p => p.lng);
            
            const minLat = Math.min(...lats);
            const maxLat = Math.max(...lats);
            const minLng = Math.min(...lngs);
            const maxLng = Math.max(...lngs);
            
            // ç®€åŒ–è®¡ç®—ï¼šçŸ©å½¢é¢ç§¯ï¼ˆå®é™…åº”è¯¥ç”¨å‡¸åŒ…ç®—æ³•ï¼‰
            const latDiff = maxLat - minLat;
            const lngDiff = maxLng - minLng;
            
            // è½¬æ¢ä¸ºå¤§çº¦çš„kmÂ²ï¼ˆç²—ç•¥è®¡ç®—ï¼‰
            return latDiff * lngDiff * 111 * 111; // 1åº¦çº¦ç­‰äº111km
        }

        // åˆ›å»ºè·¯å¾„åˆ†æåœ°å›¾
        function createPathAnalysisMap(allPoints, dates, trackingData) {
            if (!allPoints || allPoints.length === 0) return;
            
            // åˆå§‹åŒ–åœ°å›¾
            if (!analyticsMap) {
                analyticsMap = L.map('pathAnalysisMap').setView([26.7638, 106.046], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(analyticsMap);
            }
            
            // æ¸…é™¤ç°æœ‰å›¾å±‚
            if (heatmapLayer) {
                analyticsMap.removeLayer(heatmapLayer);
            }
            if (coverageLayer) {
                analyticsMap.removeLayer(coverageLayer);
            }
            
            // åˆ›å»ºè¦†ç›–åŒºåŸŸ
            if (allPoints.length > 0) {
                const latlngs = allPoints.map(p => [p.lat, p.lng]);
                coverageLayer = L.polygon(latlngs, {
                    color: 'rgba(102, 126, 234, 0.3)',
                    fillColor: 'rgba(102, 126, 234, 0.1)',
                    fillOpacity: 0.3
                }).addTo(analyticsMap);
                
                // è°ƒæ•´è§†é‡
                analyticsMap.fitBounds(coverageLayer.getBounds(), { padding: [20, 20] });
            }
            
            // ç»˜åˆ¶æ¯å¤©çš„è·¯å¾„
            dates.forEach((date, index) => {
                const dayData = trackingData[date];
                if (dayData && dayData.path && dayData.path.length > 0) {
                    const path = dayData.path.map(p => [p.lat, p.lng]);
                    const color = `hsl(${(index * 137.5) % 360}, 70%, 50%)`; // ä¸åŒé¢œè‰²
                    
                    L.polyline(path, {
                        color: color,
                        weight: 3,
                        opacity: 0.7
                    }).addTo(analyticsMap);
                }
            });
        }

        // åˆ†æè·¯å¾„æ¨¡å¼
        function analyzePathPatterns(trackingData, dates) {
            // åˆ†æå¸¸ç”¨åŒºåŸŸ
            const frequentAreas = analyzeFrequentAreas(trackingData, dates);
            document.getElementById('frequentAreas').innerHTML = frequentAreas;
            
            // åˆ†ææ´»åŠ¨æ—¶æ®µ
            const timePatterns = analyzeTimePatterns(trackingData, dates);
            document.getElementById('activeTimePatterns').innerHTML = timePatterns;
            
            // åˆ†æéª‘è¡Œä¹ æƒ¯
            const ridingHabits = analyzeRidingHabits(trackingData, dates);
            document.getElementById('ridingHabits').innerHTML = ridingHabits;
        }

        // åˆ†æå¸¸ç”¨åŒºåŸŸ
        function analyzeFrequentAreas(trackingData, dates) {
            if (dates.length === 0) return 'æš‚æ— æ•°æ®';
            
            // ç®€åŒ–åˆ†æï¼šåŸºäºæ´»åŠ¨å¤©æ•°çš„ç™¾åˆ†æ¯”
            const activeRatio = (dates.length / 7) * 100;
            
            if (activeRatio > 80) {
                return 'ğŸŸ¢ é«˜é¢‘æ´»åŠ¨åŒºåŸŸ<br>è¯¥ç”¨æˆ·åœ¨æ­¤åŒºåŸŸæ´»åŠ¨é¢‘ç¹ï¼Œå»ºè®®ä¼˜åŒ–å……ç”µè®¾æ–½å¸ƒå±€';
            } else if (activeRatio > 50) {
                return 'ğŸŸ¡ ä¸­é¢‘æ´»åŠ¨åŒºåŸŸ<br>ç”¨æˆ·åœ¨æ­¤åŒºåŸŸæœ‰å®šæœŸæ´»åŠ¨ï¼Œå¯è€ƒè™‘å¢åŠ æœåŠ¡ç‚¹';
            } else {
                return 'ğŸ”µ ä½é¢‘æ´»åŠ¨åŒºåŸŸ<br>å¶å°”ç»è¿‡åŒºåŸŸï¼Œå¯ä½œä¸ºæ‰©å±•æœåŠ¡èŒƒå›´å‚è€ƒ';
            }
        }

        // åˆ†ææ´»åŠ¨æ—¶æ®µ
        function analyzeTimePatterns(trackingData, dates) {
            if (dates.length === 0) return 'æš‚æ— æ•°æ®';
            
            // æ¨¡æ‹Ÿæ—¶æ®µåˆ†æ
            const patterns = ['ä¸Šåˆ 9-11ç‚¹', 'ä¸‹åˆ 2-4ç‚¹', 'å‚æ™š 6-8ç‚¹'];
            const mainPattern = patterns[Math.floor(Math.random() * patterns.length)];
            
            return `ä¸»è¦æ´»åŠ¨æ—¶æ®µï¼š<strong>${mainPattern}</strong><br>å»ºè®®åœ¨æ­¤æ—¶æ®µåŠ å¼ºè®¾å¤‡ç›‘æ§`;
        }

        // åˆ†æéª‘è¡Œä¹ æƒ¯
        function analyzeRidingHabits(trackingData, dates) {
            if (dates.length === 0) return 'æš‚æ— æ•°æ®';
            
            let totalDistance = 0;
            dates.forEach(date => {
                const dayData = trackingData[date];
                if (dayData) {
                    totalDistance += dayData.totalDistance || 0;
                }
            });
            
            const avgDaily = totalDistance / Math.max(dates.length, 1);
            
            if (avgDaily > 20) {
                return 'ğŸš´â€â™‚ï¸ <strong>é•¿è·ç¦»éª‘è¡Œ</strong><br>å¹³å‡æ¯æ—¥' + avgDaily.toFixed(1) + 'kmï¼Œå±äºé«˜å¼ºåº¦ä½¿ç”¨';
            } else if (avgDaily > 10) {
                return 'ğŸš² <strong>ä¸­è·ç¦»éª‘è¡Œ</strong><br>å¹³å‡æ¯æ—¥' + avgDaily.toFixed(1) + 'kmï¼Œä½¿ç”¨é¢‘ç‡é€‚ä¸­';
            } else {
                return 'ğŸ›´ <strong>çŸ­è·ç¦»éª‘è¡Œ</strong><br>å¹³å‡æ¯æ—¥' + avgDaily.toFixed(1) + 'kmï¼Œå¤šä¸ºçŸ­é€”å‡ºè¡Œ';
            }
        }

        // ç”Ÿæˆç»¼åˆè¯„ä¼°æŠ¥å‘Š
        function generateEvaluationReport(user) {
            const batteryData = userDataMapping[user.id].batteryData;
            const trackingData = userDataMapping[user.id].trackingData;
            
            // è®¡ç®—å„é¡¹è¯„åˆ†
            const batteryScore = calculateBatteryScore(batteryData);
            const frequencyScore = calculateFrequencyScore(trackingData);
            const pathScore = calculatePathScore(trackingData);
            const overallScore = Math.round((batteryScore + frequencyScore + pathScore) / 3);
            
            // æ›´æ–°è¯„åˆ†æ˜¾ç¤º
            updateScoreDisplay(batteryScore, frequencyScore, pathScore, overallScore);
            
            // ç”Ÿæˆè¯„ä¼°æ–‡æœ¬
            const evaluationText = generateEvaluationText(user, batteryScore, frequencyScore, pathScore, overallScore);
            document.getElementById('evaluationSummary').innerHTML = evaluationText;
        }

        // è®¡ç®—ç”µæ± ç®¡ç†è¯„åˆ†
        function calculateBatteryScore(batteryData) {
            if (!batteryData || batteryData.length === 0) return 0;
            
            const voltages = batteryData.map(d => d.voltage);
            const avgVoltage = voltages.reduce((a, b) => a + b, 0) / voltages.length;
            const voltageStability = 1 - (Math.max(...voltages) - Math.min(...voltages)) / Math.max(...voltages);
            
            return Math.min(100, Math.max(0, (avgVoltage / 8.4) * 50 + voltageStability * 50));
        }

        // è®¡ç®—éª‘è¡Œé¢‘ç‡è¯„åˆ†
        function calculateFrequencyScore(trackingData) {
            if (!trackingData) return 0;
            
            const activeDays = Object.keys(trackingData).length;
            const maxDays = 7; // å‡è®¾è¯„ä¼°æœ€è¿‘7å¤©
            
            return Math.min(100, (activeDays / maxDays) * 100);
        }

        // è®¡ç®—è·¯å¾„æ•ˆç‡è¯„åˆ†
        function calculatePathScore(trackingData) {
            if (!trackingData) return 0;
            
            let totalDistance = 0;
            let validDays = 0;
            
            Object.values(trackingData).forEach(dayData => {
                if (dayData && dayData.totalDistance) {
                    totalDistance += dayData.totalDistance;
                    validDays++;
                }
            });
            
            if (validDays === 0) return 0;
            
            const avgDistance = totalDistance / validDays;
            return Math.min(100, (avgDistance / 30) * 100); // å‡è®¾30km/å¤©ä¸ºæ»¡åˆ†
        }

        // æ›´æ–°è¯„åˆ†æ˜¾ç¤º
        function updateScoreDisplay(batteryScore, frequencyScore, pathScore, overallScore) {
            // æ›´æ–°æ€»åˆ†
            document.getElementById('overallScore').querySelector('.score-value').textContent = overallScore;
            
            // æ›´æ–°å„é¡¹è¯„åˆ†
            setTimeout(() => {
                updateScoreBar('batteryScore', 'batteryScoreNum', batteryScore);
                updateScoreBar('frequencyScore', 'frequencyScoreNum', frequencyScore);
                updateScoreBar('pathScore', 'pathScoreNum', pathScore);
            }, 500);
        }

        // æ›´æ–°å•ä¸ªè¯„åˆ†æ¡
        function updateScoreBar(barId, numId, score) {
            const bar = document.getElementById(barId);
            const num = document.getElementById(numId);
            
            if (bar && num) {
                bar.style.width = score + '%';
                num.textContent = Math.round(score);
                
                // æ ¹æ®åˆ†æ•°è®¾ç½®é¢œè‰²
                if (score >= 80) {
                    bar.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
                } else if (score >= 60) {
                    bar.style.background = 'linear-gradient(90deg, #ffc107, #fd7e14)';
                } else {
                    bar.style.background = 'linear-gradient(90deg, #dc3545, #e74c3c)';
                }
            }
        }

        // ç”Ÿæˆè¯„ä¼°æ–‡æœ¬
        function generateEvaluationText(user, batteryScore, frequencyScore, pathScore, overallScore) {
            let text = `<h5>ğŸ¯ ${user.name} çš„ä½¿ç”¨è¯„ä¼°</h5>`;
            
            if (overallScore >= 80) {
                text += `<p><strong>ç»¼åˆè¯„ä»·ï¼šä¼˜ç§€</strong></p>`;
                text += `<p>è¯¥ç”¨æˆ·å±•ç°å‡ºä¼˜ç§€çš„è®¾å¤‡ä½¿ç”¨ä¹ æƒ¯ï¼Œç”µæ± ç®¡ç†å¾—å½“ï¼Œéª‘è¡Œé¢‘ç‡é€‚ä¸­ï¼Œè·¯å¾„è§„åˆ’åˆç†ã€‚å»ºè®®ç»§ç»­ä¿æŒå½“å‰çš„ä½¿ç”¨æ¨¡å¼ã€‚</p>`;
            } else if (overallScore >= 60) {
                text += `<p><strong>ç»¼åˆè¯„ä»·ï¼šè‰¯å¥½</strong></p>`;
                text += `<p>è¯¥ç”¨æˆ·çš„è®¾å¤‡ä½¿ç”¨æƒ…å†µæ€»ä½“è‰¯å¥½ï¼Œä½†åœ¨æŸäº›æ–¹é¢è¿˜æœ‰æå‡ç©ºé—´ã€‚`;
                
                if (batteryScore < 70) text += `å»ºè®®ä¼˜åŒ–ç”µæ± å……æ”¾ç”µä¹ æƒ¯ï¼›`;
                if (frequencyScore < 70) text += `å¯ä»¥å¢åŠ ä½¿ç”¨é¢‘ç‡ï¼›`;
                if (pathScore < 70) text += `å»ºè®®ä¼˜åŒ–éª‘è¡Œè·¯å¾„è§„åˆ’ï¼›`;
                
                text += `</p>`;
            } else {
                text += `<p><strong>ç»¼åˆè¯„ä»·ï¼šéœ€è¦æ”¹è¿›</strong></p>`;
                text += `<p>è¯¥ç”¨æˆ·çš„è®¾å¤‡ä½¿ç”¨å­˜åœ¨è¾ƒå¤§æ”¹è¿›ç©ºé—´ã€‚å»ºè®®ï¼š</p>`;
                text += `<ul>`;
                if (batteryScore < 60) text += `<li>æ”¹å–„ç”µæ± ç®¡ç†ä¹ æƒ¯ï¼Œé¿å…è¿‡åº¦å……æ”¾ç”µ</li>`;
                if (frequencyScore < 60) text += `<li>å¢åŠ è®¾å¤‡ä½¿ç”¨é¢‘ç‡ï¼Œæé«˜è®¾å¤‡åˆ©ç”¨ç‡</li>`;
                if (pathScore < 60) text += `<li>ä¼˜åŒ–å‡ºè¡Œè·¯å¾„ï¼Œæé«˜éª‘è¡Œæ•ˆç‡</li>`;
                text += `</ul>`;
            }
            
            text += `<p><small>è¯„ä¼°åŸºäºæœ€è¿‘çš„ä½¿ç”¨æ•°æ®ï¼Œå»ºè®®å®šæœŸæŸ¥çœ‹ä»¥è·Ÿè¸ªæ”¹è¿›æƒ…å†µã€‚</small></p>`;
            
            return text;
        }

        // åˆ‡æ¢çƒ­åŠ›å›¾æ˜¾ç¤º
        function toggleHeatmap() {
            const checkbox = document.getElementById('showHeatmap');
            if (!analyticsMap) return;
            
            if (checkbox.checked && heatmapLayer) {
                analyticsMap.addLayer(heatmapLayer);
            } else if (heatmapLayer) {
                analyticsMap.removeLayer(heatmapLayer);
            }
        }

        // åˆ‡æ¢è¦†ç›–åŒºåŸŸæ˜¾ç¤º
        function toggleCoverage() {
            const checkbox = document.getElementById('showCoverage');
            if (!analyticsMap) return;
            
            if (checkbox.checked && coverageLayer) {
                analyticsMap.addLayer(coverageLayer);
            } else if (coverageLayer) {
                analyticsMap.removeLayer(coverageLayer);
            }
        }

        // æ›´æ–°è·¯å¾„åˆ†æå‘¨æœŸ
        function updatePathAnalysis() {
            if (currentAnalyticsUser) {
                analyzePathData(userDataMapping[currentAnalyticsUser.id].trackingData);
            }
        }

        // åˆ·æ–°åˆ†ææ•°æ®
        function refreshAnalyticsData() {
            if (!currentAnalyticsUser) return;
            
            const refreshIcon = document.getElementById('analyticsRefreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            setTimeout(() => {
                // æ£€æŸ¥æ˜¯å¦ä¸ºç¬¬ä¸€ä¸ªç”¨æˆ·
                const isFirst = isFirstUser(currentAnalyticsUser.id);
                
                // é‡æ–°ç”Ÿæˆæ•°æ®
                let newBatteryData = generateUserBatteryData(currentAnalyticsUser);
                let newTrackingData = generateUserTrackingData(currentAnalyticsUser);
                
                // å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼Œæ‰“ä¹±æ•°æ®
                if (!isFirst) {
                    newBatteryData = shuffleArray([...newBatteryData]);
                    newTrackingData = shuffleTrackingData(newTrackingData);
                    console.log(`ğŸ”€ åˆ†æåˆ·æ–°æ—¶æ‰“ä¹±äº†ç”¨æˆ· ${currentAnalyticsUser.name} çš„æ•°æ®`);
                }
                
                userDataMapping[currentAnalyticsUser.id] = {
                    batteryData: newBatteryData,
                    trackingData: newTrackingData
                };
                
                loadUserAnalyticsData(currentAnalyticsUser);
                refreshIcon.style.animation = '';
                showSuccessMessage('åˆ†ææ•°æ®å·²åˆ·æ–°');
            }, 1500);
        }

        // å¯¼å‡ºåˆ†ææŠ¥å‘Š
        function exportAnalyticsReport() {
            if (!currentAnalyticsUser) {
                alert('è¯·å…ˆé€‰æ‹©ç”¨æˆ·');
                return;
            }
            
            const user = currentAnalyticsUser;
            const batteryData = userDataMapping[user.id].batteryData;
            const trackingData = userDataMapping[user.id].trackingData;
            
            // ç”ŸæˆæŠ¥å‘Šå†…å®¹
            const reportContent = generateReportContent(user, batteryData, trackingData);
            
            // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${user.name}_æ•°æ®åˆ†ææŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage('åˆ†ææŠ¥å‘Šå¯¼å‡ºæˆåŠŸ');
        }

        // ç”ŸæˆæŠ¥å‘Šå†…å®¹
        function generateReportContent(user, batteryData, trackingData) {
            const date = new Date().toLocaleDateString('zh-CN');
            
            let content = `ç”¨æˆ·æ•°æ®åˆ†ææŠ¥å‘Š\n`;
            content += `===============================\n\n`;
            content += `ç”¨æˆ·å§“å: ${user.name}\n`;
            content += `è®¾å¤‡ç¼–å·: ${user.device || 'æœªåˆ†é…'}\n`;
            content += `ç”Ÿæˆæ—¥æœŸ: ${date}\n\n`;
            
            content += `ç”µæ± åˆ†æ\n`;
            content += `-----------\n`;
            if (batteryData && batteryData.length > 0) {
                const avgVoltage = batteryData.reduce((a, b) => a + b.voltage, 0) / batteryData.length;
                const avgCurrent = batteryData.reduce((a, b) => a + b.current, 0) / batteryData.length;
                content += `å¹³å‡ç”µå‹: ${avgVoltage.toFixed(2)}V\n`;
                content += `å¹³å‡ç”µæµ: ${avgCurrent.toFixed(2)}A\n`;
                content += `æ•°æ®ç‚¹æ•°: ${batteryData.length}æ¡\n\n`;
            }
            
            content += `è·¯å¾„åˆ†æ\n`;
            content += `-----------\n`;
            if (trackingData) {
                const dates = Object.keys(trackingData);
                const totalDistance = dates.reduce((sum, date) => {
                    return sum + (trackingData[date].totalDistance || 0);
                }, 0);
                content += `æ´»åŠ¨å¤©æ•°: ${dates.length}å¤©\n`;
                content += `æ€»è·ç¦»: ${totalDistance.toFixed(1)}km\n`;
                content += `å¹³å‡æ—¥è·ç¦»: ${(totalDistance / Math.max(dates.length, 1)).toFixed(1)}km\n\n`;
            }
            
            content += `å»ºè®®äº‹é¡¹\n`;
            content += `-----------\n`;
            content += `1. å®šæœŸæ£€æŸ¥ç”µæ± çŠ¶æ€\n`;
            content += `2. ä¿æŒé€‚åº¦çš„ä½¿ç”¨é¢‘ç‡\n`;
            content += `3. ä¼˜åŒ–å‡ºè¡Œè·¯å¾„è§„åˆ’\n`;
            content += `4. æ³¨æ„è®¾å¤‡ç»´æŠ¤ä¿å…»\n\n`;
            
            content += `æŠ¥å‘Šç»“æŸ\n`;
            content += `===============================`;
            
            return content;
        }

        // æ˜¾ç¤ºåˆ†ææ•°æ®
        function showAnalyticsData() {
            document.getElementById('analyticsDataContainer').style.display = 'block';
            document.getElementById('analyticsNoDataMessage').style.display = 'none';
        }

        // éšè—åˆ†ææ•°æ®
        function hideAnalyticsData() {
            document.getElementById('analyticsDataContainer').style.display = 'none';
            document.getElementById('analyticsNoDataMessage').style.display = 'block';
            document.getElementById('analyticsSelectedUserInfo').style.display = 'none';
            currentAnalyticsUser = null;
        }

        // // ä¿®æ”¹åŸæœ‰çš„showPageå‡½æ•°ï¼Œæ·»åŠ åˆ†æé¡µé¢åˆå§‹åŒ–
        // const originalShowPageAnalytics = showPage;
        // window.showPage = function(pageId) {
        //     originalShowPageAnalytics(pageId);
            
        //     // å¦‚æœåˆ‡æ¢åˆ°åˆ†æé¡µé¢ï¼Œåˆå§‹åŒ–åˆ†æåŠŸèƒ½
        //     if (pageId === 'analytics') {
        //         setTimeout(() => {
        //             initializeAnalyticsPage();
        //         }, 100);
        //     }
        // };

        
        /* ---------- ç”¨æˆ·ç®¡ç†é¡µé¢åŠŸèƒ½ ---------- */
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        function loadUserList() {
            const saved = localStorage.getItem('systemUserList');
            if (saved) {
                try {
                    userList = JSON.parse(saved);
                } catch (error) {
                    console.error('âŒ ç”¨æˆ·åˆ—è¡¨åŠ è½½å¤±è´¥:', error);
                    userList = [];
                }
            }
            filteredUserList = [...userList];
            renderUserList();
            updateUserStatistics();
        }

        // ä¿å­˜ç”¨æˆ·åˆ—è¡¨
        function saveUserList() {
            try {
                localStorage.setItem('systemUserList', JSON.stringify(userList));
                console.log('âœ… ç”¨æˆ·åˆ—è¡¨å·²ä¿å­˜');
            } catch (error) {
                console.error('âŒ ç”¨æˆ·åˆ—è¡¨ä¿å­˜å¤±è´¥:', error);
            }
        }

        // æ·»åŠ æ–°ç”¨æˆ·
        function addNewUser() {
            const nameInput = document.getElementById('newUserName');
            const roleSelect = document.getElementById('newUserRole');
            const deviceInput = document.getElementById('newUserDevice');
            const addBtn = document.querySelector('#addUserForm .btn-primary');
            const btnText = document.getElementById('addUserBtnText');
            const spinner = document.getElementById('addUserSpinner');

            const name = nameInput.value.trim();
            const role = roleSelect.value;
            const device = deviceInput.value.trim();

            // è¡¨å•éªŒè¯
            if (!name) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å§“å');
                nameInput.focus();
                return;
            }

            if (name.length < 2) {
                alert('ç”¨æˆ·å§“åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
                nameInput.focus();
                return;
            }

            // æ£€æŸ¥è®¾å¤‡æ•°é‡é™åˆ¶
            if (userList.length >= adminSettings.maxDevices) {
                showCapacityWarning(`æ— æ³•æ·»åŠ ç”¨æˆ·ï¼šå·²è¾¾åˆ°æœ€å¤§è®¾å¤‡æ¥å…¥æ•°é‡é™åˆ¶ (${adminSettings.maxDevices}å°)`);
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦é‡å¤
            if (userList.some(user => user.name.toLowerCase() === name.toLowerCase())) {
                alert('è¯¥ç”¨æˆ·å§“åå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„å§“å');
                nameInput.focus();
                return;
            }

            // æ£€æŸ¥è®¾å¤‡ç¼–å·æ˜¯å¦é‡å¤ï¼ˆå¦‚æœæä¾›äº†è®¾å¤‡ç¼–å·ï¼‰
            if (device && userList.some(user => user.device && user.device.toLowerCase() === device.toLowerCase())) {
                alert('è¯¥è®¾å¤‡ç¼–å·å·²è¢«ä½¿ç”¨ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„è®¾å¤‡ç¼–å·');
                deviceInput.focus();
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            addBtn.disabled = true;
            btnText.textContent = 'æ·»åŠ ä¸­...';
            spinner.classList.remove('hidden');

            // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
            setTimeout(() => {
                try {
                    // åˆ›å»ºæ–°ç”¨æˆ·å¯¹è±¡
                    const newUser = {
                        id: Date.now().toString(),
                        name: name,
                        role: role,
                        device: device || null,
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        lastLogin: null
                    };

                    // æ·»åŠ åˆ°ç”¨æˆ·åˆ—è¡¨
                    userList.push(newUser);
                    filteredUserList = [...userList];

                    // ä¿å­˜åˆ°localStorage
                    saveUserList();

                    // æ›´æ–°ç•Œé¢
                    renderUserList();
                    initializeMonitoringPage();
                    updateUserStatistics();
                    updateDashboardDeviceStats();
                    clearUserForm();
                    hideCapacityWarning();

                    console.log('âœ… ç”¨æˆ·æ·»åŠ æˆåŠŸ:', newUser);
                    showSuccessMessage(`ç”¨æˆ· "${name}" æ·»åŠ æˆåŠŸï¼`);

                } catch (error) {
                    console.error('âŒ æ·»åŠ ç”¨æˆ·å¤±è´¥:', error);
                    alert('æ·»åŠ ç”¨æˆ·å¤±è´¥ï¼Œè¯·é‡è¯•');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    addBtn.disabled = false;
                    btnText.textContent = 'æ·»åŠ ç”¨æˆ·';
                    spinner.classList.add('hidden');
                }
            }, 800); // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        }

        // åˆ é™¤ç”¨æˆ·
        function deleteUser(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user) return;

            if (confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${user.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                userList = userList.filter(u => u.id !== userId);
                filteredUserList = filteredUserList.filter(u => u.id !== userId);
                
                saveUserList();
                renderUserList();
                initializeMonitoringPage();
                updateUserStatistics(); 
                updateDashboardDeviceStats();// è¿™ä¼šåŒæ—¶æ›´æ–°ä»ªè¡¨æ¿
                hideCapacityWarning();
                
                console.log('âœ… ç”¨æˆ·åˆ é™¤æˆåŠŸ:', user.name);
                showSuccessMessage(`ç”¨æˆ· "${user.name}" å·²åˆ é™¤`);
            }
        }
        
        // ç¼–è¾‘ç”¨æˆ·çŠ¶æ€
        function toggleUserStatus(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user) return;

            user.status = user.status === 'active' ? 'inactive' : 'active';
            saveUserList();
            renderUserList();
            updateDashboardDeviceStats();
            
            console.log(`âœ… ç”¨æˆ·çŠ¶æ€å·²æ›´æ–°: ${user.name} -> ${user.status}`);
        }

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨ ï¼ˆåŒ…æ‹¬æœ‰ç”¨æˆ·åˆ—è¡¨çš„é¡µé¢åˆ†å¸ƒ htmlï¼‰
        function renderUserList() {
            const container = document.getElementById('userListContainer');
            const emptyState = document.getElementById('emptyUserState');

            if (filteredUserList.length === 0) {
                // ä¿®å¤ï¼šç›´æ¥è®¾ç½®innerHTMLè€Œä¸æ˜¯appendChild
                container.innerHTML = `
                    <div id="emptyUserState" class="text-center" style="color: #6c757d; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ‘¤</div>
                        <h4>æš‚æ— ç”¨æˆ·æ•°æ®</h4>
                        <p>è¯·æ·»åŠ ç¬¬ä¸€ä¸ªç”¨æˆ·å¼€å§‹ä½¿ç”¨ç³»ç»Ÿ</p>
                    </div>
                `;
                return;
            }

            const listHTML = `
                <div class="user-list-table">
                    <div class="user-list-header" style="display: grid; grid-template-columns: 2fr 1fr 1.5fr 1fr 1fr 1.5fr; gap: 15px; padding: 12px 15px; background-color: #f8f9fa; border-radius: 6px; font-weight: 600; color: #495057; margin-bottom: 10px;">
                        <div>å§“å</div>
                        <div>è§’è‰²</div>
                        <div>è®¾å¤‡ç¼–å·</div>
                        <div>çŠ¶æ€</div>
                        <div>æ³¨å†Œæ—¶é—´</div>
                        <div>æ“ä½œ</div>
                    </div>
                    ${filteredUserList.map(user => `
                        <div class="user-list-item" style="display: grid; grid-template-columns: 2fr 1fr 1.5fr 1fr 1fr 1.5fr; gap: 15px; padding: 15px; border: 1px solid #e9ecef; border-radius: 6px; margin-bottom: 8px; background-color: white; align-items: center;">
                            <div>
                                <strong style="color: #2c3e50;">${user.name}</strong>
                                <div style="font-size: 12px; color: #6c757d;">ID: ${user.id}</div>
                            </div>
                            <div>
                                <span class="role-badge role-${user.role}" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                    ${getRoleDisplayName(user.role)}
                                </span>
                            </div>
                            <div style="color: #6c757d;">
                                ${user.device || '<span style="color: #adb5bd;">æœªåˆ†é…</span>'}
                            </div>
                            <div>
                                <button class="status-btn status-${user.status}" onclick="toggleUserStatus('${user.id}')" 
                                        style="padding: 4px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;">
                                    ${user.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}
                                </button>
                            </div>
                            <div style="font-size: 12px; color: #6c757d;">
                                ${formatDate(user.createdAt)}
                            </div>
                            <div>
                                <button onclick="deleteUser('${user.id}')" class="btn-sm btn-danger" 
                                        style="padding: 6px 12px; background-color: #f8d7da; color: #c82333; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 5px;">
                                    åˆ é™¤
                                </button>
                                <button onclick="viewUserDetails('${user.id}')" class="btn-sm btn-info"
                                        style="padding: 6px 12px; background-color: #e2f0fb; color: #117a8b; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                    è¯¦æƒ…
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = listHTML;
        }

        // ç”¨æˆ·è§’è‰²æ˜¾ç¤ºåç§°
        function getRoleDisplayName(role) {
            const roleNames = {
                'user': 'æ™®é€šç”¨æˆ·',
                'operator': 'æ“ä½œå‘˜',
                'admin': 'ç®¡ç†å‘˜'
            };
            return roleNames[role] || role;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
        function updateUserStatistics() {
            const currentCount = userList.length;
            const maxDevices = adminSettings.maxDevices;
            const usagePercent = Math.round((currentCount / maxDevices) * 100);

            // æ›´æ–°æ•°å­—æ˜¾ç¤º
            document.getElementById('currentUserCount').textContent = currentCount;
            document.getElementById('maxUserDevices').textContent = maxDevices;

            // æ›´æ–°ä½¿ç”¨ç‡è¿›åº¦æ¡
            const statusIndicator = document.getElementById('userStatusIndicator');
            const statusText = document.getElementById('userStatusText');

            // æ ¹æ®ä½¿ç”¨ç‡è®¾ç½®é¢œè‰²å’ŒçŠ¶æ€
            if (usagePercent >= 90) {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'å®¹é‡å³å°†æ»¡è½½';
                showCapacityWarning(`è®¾å¤‡å®¹é‡ç´§å¼ ï¼šå·²ä½¿ç”¨ ${currentCount}/${maxDevices} å°`);
            } else if (usagePercent >= 70) {
                statusIndicator.className = 'status-indicator status-warning';
                statusText.textContent = 'ä½¿ç”¨ç‡è¾ƒé«˜';
                hideCapacityWarning();
            } else {
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'ç³»ç»Ÿæ­£å¸¸';
                hideCapacityWarning();
            }

            // æ›´æ–°å…¶ä»–é¡µé¢çš„ç»Ÿè®¡æ˜¾ç¤º
            const onlineDeviceCount = document.getElementById('onlineDeviceCount');
            if (onlineDeviceCount) {
                onlineDeviceCount.textContent = userList.filter(u => u.status === 'active').length;
            }
        }

        // æ˜¾ç¤ºå®¹é‡è­¦å‘Š
        function showCapacityWarning(message) {
            const warning = document.getElementById('capacityWarning');
            const warningMessage = document.getElementById('warningMessage');
            if (warning && warningMessage) {
                warningMessage.textContent = message;
                warning.classList.remove('hidden');
            }
        }

        // éšè—å®¹é‡è­¦å‘Š
        function hideCapacityWarning() {
            const warning = document.getElementById('capacityWarning');
            if (warning) {
                warning.classList.add('hidden');
            }
        }

        // æ¸…ç©ºç”¨æˆ·è¡¨å•
        function clearUserForm() {
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserRole').value = 'user';
            document.getElementById('newUserDevice').value = '';
        }

        // è¿‡æ»¤ç”¨æˆ·åˆ—è¡¨
        function filterUserList() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredUserList = [...userList];
            } else {
                filteredUserList = userList.filter(user => 
                    user.name.toLowerCase().includes(searchTerm) ||
                    (user.device && user.device.toLowerCase().includes(searchTerm)) ||
                    getRoleDisplayName(user.role).toLowerCase().includes(searchTerm)
                );
            }
            
            renderUserList();
        }

        // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
        function refreshUserList() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            setTimeout(() => {
                loadUserList();
                refreshIcon.style.animation = '';
                showSuccessMessage('ç”¨æˆ·åˆ—è¡¨å·²åˆ·æ–°');
            }, 500);
        }

        // æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
        function viewUserDetails(userId) {
            const user = userList.find(u => u.id === userId);
            if (!user) return;

            const details = `
                ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ï¼š

                å§“åï¼š${user.name}
                è§’è‰²ï¼š${getRoleDisplayName(user.role)}
                è®¾å¤‡ç¼–å·ï¼š${user.device || 'æœªåˆ†é…'}
                çŠ¶æ€ï¼š${user.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}
                æ³¨å†Œæ—¶é—´ï¼š${formatDate(user.createdAt)}
                ç”¨æˆ·IDï¼š${user.id}
                    `;
            alert(details);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            // åˆ›å»ºä¸´æ—¶æç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background-color: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 9999;
                font-weight: 500;
                animation: slideInRight 0.3s ease;
            `;
            toast.textContent = message;

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(toast);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }


        /* ---------- ç®¡ç†å‘˜è®¾ç½®é¡µé¢ ---------- */

        // ä¿®æ”¹ç°æœ‰çš„saveAdminSettingså‡½æ•°ï¼Œæ·»åŠ ç”¨æˆ·ç»Ÿè®¡æ›´æ–°
        function saveAdminSettings() {
            const name = document.getElementById('adminName').value.trim();
            const avatar = document.getElementById('adminAvatar').value.trim().toUpperCase();
            const bio = document.getElementById('adminBio').value.trim();
            const maxDevices = parseInt(document.getElementById('deviceCount').textContent);
            const storageLimit = parseInt(document.getElementById('storageLimit').textContent);

            if (!name) {
                alert('è¯·è¾“å…¥ç®¡ç†å‘˜åç§°');
                return;
            }

            if (!avatar) {
                alert('è¯·è¾“å…¥å¤´åƒå­—æ¯');
                return;
            }

            // æ£€æŸ¥è®¾å¤‡æ•°é‡æ˜¯å¦å°äºå½“å‰ç”¨æˆ·æ•°é‡
            if (maxDevices < userList.length) {
                if (!confirm(`å½“å‰è®¾ç½®çš„æœ€å¤§è®¾å¤‡æ•°é‡ (${maxDevices}) å°äºå·²æ³¨å†Œç”¨æˆ·æ•°é‡ (${userList.length})ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿè¿™å¯èƒ½ä¼šå½±å“ç³»ç»ŸåŠŸèƒ½ã€‚`)) {
                    return;
                }
            }

            // æ›´æ–°è®¾ç½®
            adminSettings = {
                name: name,
                avatar: avatar,
                bio: bio,
                maxDevices: maxDevices,
                storageLimit: storageLimit
            };

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('adminSettings', JSON.stringify(adminSettings));

            syncStorageLimitToPages();

            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
            updateAdminDisplay();
            updateDeviceDisplays();
            updateUserStatistics(); // è¿™ä¼šåŒæ—¶æ›´æ–°ä»ªè¡¨æ¿

            showSuccessMessage('è®¾ç½®ä¿å­˜æˆåŠŸï¼');
            console.log('è®¾ç½®ä¿å­˜æˆåŠŸï¼å·²ä¿®æ”¹è®¾å¤‡å­˜å‚¨ä¸Šé™ï¼');
        }

        // ä¿®æ”¹è®¾å¤‡æ•°é‡
        function changeDeviceCount(delta) {
            const currentCount = parseInt(document.getElementById('deviceCount').textContent);
            const newCount = Math.max(1, Math.min(20, currentCount + delta));
            
            document.getElementById('deviceCount').textContent = newCount;
            adminSettings.maxDevices = newCount;
        }

        // ä¿®æ”¹å­˜å‚¨æ•°é‡ä¸Šé™
        function changeStorageLimit(delta) {
            const currentLimit = parseInt(document.getElementById('storageLimit').textContent);
            const newLimit = Math.max(30, Math.min(100, currentLimit + delta));  // æœ€å¤§100 æœ€å°30
            
            document.getElementById('storageLimit').textContent = newLimit;
            adminSettings.storageLimit = newLimit;
            
            // // ç«‹å³åŒæ­¥åˆ°localStorageï¼Œä¾›pageå’Œpage2ä½¿ç”¨
            // syncStorageLimitToPages();
        }

        // å°†å­˜å‚¨æ•°é‡ä¸Šé™æ›´æ–°åˆ°pageä¸­
        function syncStorageLimitToPages() {
            const storageConfig = {
                maxBatteryDataPoints: adminSettings.storageLimit,
                maxLocationDataPoints: adminSettings.storageLimit,
                maxHistoryDays: 30, 
                lastUpdated: new Date().toISOString()
            };
            
            // ä¿å­˜é…ç½®ä¾›å…¶ä»–é¡µé¢ä½¿ç”¨
            localStorage.setItem('storageConfig', JSON.stringify(storageConfig));
            
            console.log('å­˜å‚¨é…ç½®å·²æ›´æ–°:', storageConfig);
            
            // ç«‹å³æ¸…ç†ç°æœ‰æ•°æ®ä»¥ç¬¦åˆæ–°çš„é™åˆ¶
            cleanupExistingData();
        }

        // æ¸…ç†ç°æœ‰æ•°æ®ä»¥ç¬¦åˆæ–°çš„å­˜å‚¨é™åˆ¶
        function cleanupExistingData() {
            try {
                // æ¸…ç†ç”µæ± å†å²æ•°æ®
                const batteryData = localStorage.getItem('batteryHistoryData');
                if (batteryData) {
                    let parsedData = JSON.parse(batteryData);
                    
                    // æ£€æŸ¥æ•°æ®ç»“æ„æ˜¯å¦æ­£ç¡®
                    if (parsedData && parsedData.voltage && parsedData.current && parsedData.timestamps &&
                        Array.isArray(parsedData.voltage) && Array.isArray(parsedData.current) && Array.isArray(parsedData.timestamps)) {
                        
                        const voltageLength = parsedData.voltage.length;
                        const currentLength = parsedData.current.length;
                        const timestampsLength = parsedData.timestamps.length;
                        
                        // è·å–æœ€å¤§é•¿åº¦ä½œä¸ºæ•°æ®ç‚¹æ•°é‡
                        const dataPointCount = Math.max(voltageLength, currentLength, timestampsLength);
                        
                        console.log(`ğŸ“Š ç”µæ± æ•°æ®æ£€æŸ¥: voltage(${voltageLength}), current(${currentLength}), timestamps(${timestampsLength})`);
                        
                        if (dataPointCount > adminSettings.storageLimit) {
                            // ä¿ç•™æœ€æ–°çš„æ•°æ® - å¯¹æ¯ä¸ªæ•°ç»„åˆ†åˆ«å¤„ç†
                            const keepCount = adminSettings.storageLimit;
                            
                            parsedData.voltage = parsedData.voltage.slice(-keepCount);
                            parsedData.current = parsedData.current.slice(-keepCount);
                            parsedData.timestamps = parsedData.timestamps.slice(-keepCount);
                            
                            localStorage.setItem('batteryHistoryData', JSON.stringify(parsedData));
                            console.log(`ğŸ”‹ ç”µæ± æ•°æ®æ¸…ç†å®Œæˆï¼Œä¿ç•™æœ€æ–° ${keepCount} æ¡ï¼Œåˆ é™¤äº† ${dataPointCount - keepCount} æ¡`);
                        } else {
                            console.log(`âœ… ç”µæ± æ•°æ®æ£€æŸ¥å®Œæˆï¼Œå½“å‰ ${dataPointCount} æ¡æ•°æ®åœ¨é™åˆ¶èŒƒå›´å†…`);
                        }
                        
                    } else {
                        console.warn('âš ï¸ ç”µæ± æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè·³è¿‡æ¸…ç†');
                    }
                } else {
                    console.log('ğŸ“Š æœªæ‰¾åˆ°ç”µæ± å†å²æ•°æ®');
                }

                // æ¸…ç†ä½ç½®æ•°æ®
                const mockData = localStorage.getItem('mockData');
                if (mockData) {
                    let parsedMockData = JSON.parse(mockData);
                    let totalPoints = 0;
                    
                    // æå–æ¯ä¸€å¤©çš„ä½ç½®ä¿¡æ¯
                    Object.keys(parsedMockData).forEach(date => {
                        const dayData = parsedMockData[date];
                        if (dayData && dayData.path && Array.isArray(dayData.path)) {
                            const currentDateLength = dayData.path.length;

                            if (currentDateLength > adminSettings.storageLimit) {
                                const currentRemoveLength = currentDateLength - adminSettings.storageLimit;
                                parsedMockData[date].path = dayData.path.slice(-adminSettings.storageLimit);    // åˆ‡é™¤æœ€æ–°çš„storageLimitä¸ª å¹¶ä¸”å­˜å‚¨åˆ° MockData
                                totalPoints += currentRemoveLength;

                                console.log(`${date}ï¼šä½ç½®è¿‡å¤šï¼Œæ¸…é™¤${currentRemoveLength}ä¸ªä½ç½®ç‚¹`)
                            }
                        }
                    });

                    // å¦‚æœæœ‰æ¸…ç†æ“ä½œï¼Œæ›´æ–°localStorage
                    if (totalPoints > 0) {
                        localStorage.setItem('mockData', JSON.stringify(parsedMockData));
                        console.log(`ä½ç½®æ•°æ®æ¸…ç†å®Œæˆï¼Œæ€»å…±åˆ é™¤äº† ${totalPoints} ä¸ªä½ç½®ç‚¹`);
                    } else {
                        console.log('ä½ç½®æ•°æ®æ£€æŸ¥å®Œæˆï¼Œæ— éœ€æ¸…ç†');
                    }
                }

            } catch (error) {
                console.error('âŒ æ•°æ®æ¸…ç†å¤±è´¥:', error);
            }
        }

        // ä¿å­˜ç®¡ç†å‘˜è®¾ç½®
        function saveAdminSettings() {
            const name = document.getElementById('adminName').value.trim();
            const avatar = document.getElementById('adminAvatar').value.trim().toUpperCase();
            const bio = document.getElementById('adminBio').value.trim();
            const maxDevices = parseInt(document.getElementById('deviceCount').textContent);
            const storageLimit = parseInt(document.getElementById('storageLimit').textContent);

            if (!name) {
                alert('è¯·è¾“å…¥ç®¡ç†å‘˜åç§°');
                return;
            }

            if (!avatar) {
                alert('è¯·è¾“å…¥å¤´åƒå­—æ¯');
                return;
            }

            // æ£€æŸ¥è®¾å¤‡æ•°é‡æ˜¯å¦å°äºå½“å‰ç”¨æˆ·æ•°é‡
            if (maxDevices < userList.length) {
                if (!confirm(`å½“å‰è®¾ç½®çš„æœ€å¤§è®¾å¤‡æ•°é‡ (${maxDevices}) å°äºå·²æ³¨å†Œç”¨æˆ·æ•°é‡ (${userList.length})ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿè¿™å¯èƒ½ä¼šå½±å“ç³»ç»ŸåŠŸèƒ½ã€‚`)) {
                    return;
                }
            }

            // æ›´æ–°è®¾ç½®
            adminSettings = {
                name: name,
                avatar: avatar,
                bio: bio,
                maxDevices: maxDevices,
                storageLimit: storageLimit
            };

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('adminSettings', JSON.stringify(adminSettings));

            syncStorageLimitToPages();

            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
            updateAdminDisplay();
            updateDeviceDisplays();
            updateUserStatistics(); // æ–°å¢ï¼šæ›´æ–°ç”¨æˆ·ç»Ÿè®¡

            showSuccessMessage('è®¾ç½®ä¿å­˜æˆåŠŸï¼');
            console.log(`è®¾ç½®ä¿å­˜æˆåŠŸï¼å·²ä¿®æ”¹è®¾å¤‡å­˜å‚¨ä¸Šé™ï¼`);
        }

        // é‡ç½®ç®¡ç†å‘˜è®¾ç½®
        function resetAdminSettings() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿ')) {
                adminSettings = {
                    name: 'ç®¡ç†å‘˜',
                    avatar: 'A',
                    bio: 'ç³»ç»Ÿç®¡ç†å‘˜ï¼Œè´Ÿè´£æ•´ä½“ç³»ç»Ÿè¿ç»´å’Œç®¡ç†å·¥ä½œã€‚',
                    maxDevices: 5,
                    storageLimit: 30
                };

                try {
                    const keys = [
                        'adminSettings',
                        'storageConfig'
                    ];
                    keys.forEach(key => {
                        if (localStorage.getItem(key)) {
                            localStorage.removeItem(key);
                            console.log(`å·²æ¸…é™¤: ${key}`);
                        }
                    });
                } catch (error) {
                    console.error('âŒ æ¸…é™¤æœ¬åœ°æ•°æ®å¤±è´¥:', error);
                }

                localStorage.setItem('adminSettings', JSON.stringify(adminSettings));
                
                loadAdminSettingsToForm();
                updateAdminDisplay();
                updateDeviceDisplays();
                syncStorageLimitToPages();

                console.log(`è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼`);
            }
        }

        // åŠ è½½ç®¡ç†å‘˜è®¾ç½®
        function loadAdminSettings() {
            const saved = localStorage.getItem('adminSettings');
            if (saved) {
                adminSettings = JSON.parse(saved);
            }
            
            loadAdminSettingsToForm();
            updateAdminDisplay();
        }

        // å°†è®¾ç½®åŠ è½½åˆ°è¡¨å•
        function loadAdminSettingsToForm() {
            document.getElementById('adminName').value = adminSettings.name;
            document.getElementById('adminAvatar').value = adminSettings.avatar;
            document.getElementById('adminBio').value = adminSettings.bio;
            document.getElementById('deviceCount').textContent = adminSettings.maxDevices;
            document.getElementById('storageLimit').textContent = adminSettings.storageLimit;
            document.getElementById('avatarPreview').textContent = adminSettings.avatar;
        }

        // æ›´æ–°ç®¡ç†å‘˜æ˜¾ç¤º
        function updateAdminDisplay() {
            document.getElementById('displayUserName').textContent = adminSettings.name;
            document.getElementById('displayUserAvatar').textContent = adminSettings.avatar;
        }

        // æ›´æ–°è®¾å¤‡æ•°é‡æ˜¾ç¤º
        function updateDeviceDisplays() {
            // æ›´æ–°å„ä¸ªé¡µé¢çš„è®¾å¤‡è®¡æ•°æ˜¾ç¤º
            const deviceCountDisplay = document.getElementById('deviceCountDisplay');
            const maxDeviceCount = document.getElementById('maxDeviceCount');
            
            if (deviceCountDisplay) deviceCountDisplay.textContent = adminSettings.maxDevices;
            if (maxDeviceCount) maxDeviceCount.textContent = adminSettings.maxDevices;
            
            // æ›´æ–°ä»ªè¡¨æ¿è®¾å¤‡ç»Ÿè®¡
            updateDashboardDeviceStats();
        }

        const originalDeleteUser = deleteUser;
        window.deleteUser = function(userId) {
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç›‘æ§ç”¨æˆ·ï¼Œæ¸…ç©ºç›‘æ§
            if (currentMonitoringUser && currentMonitoringUser.id === userId) {
                hideMonitoringData();
            }
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰åˆ†æç”¨æˆ·ï¼Œæ¸…ç©ºåˆ†æ
            if (currentAnalyticsUser && currentAnalyticsUser.id === userId) {
                hideAnalyticsData();
            }
            
            // åˆ é™¤ç”¨æˆ·æ•°æ®æ˜ å°„
            delete userDataMapping[userId];
            
            // è·å–è¢«åˆ é™¤ç”¨æˆ·åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®
            const deletedUserIndex = userList.findIndex(u => u.id === userId);
            const wasFirstUser = deletedUserIndex === 0;
            
            // æ‰§è¡ŒåŸå§‹åˆ é™¤é€»è¾‘
            originalDeleteUser(userId);
            
            // å¦‚æœåˆ é™¤çš„æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆæ–°çš„ç¬¬ä¸€ä¸ªç”¨æˆ·çš„æ•°æ®ï¼ˆä¿æŒåŸå§‹é¡ºåºï¼‰
            if (wasFirstUser && userList.length > 0) {
                const newFirstUser = userList[0];
                if (userDataMapping[newFirstUser.id]) {
                    console.log(`ğŸ”„ é‡æ–°ç”Ÿæˆæ–°çš„ç¬¬ä¸€ä¸ªç”¨æˆ· ${newFirstUser.name} çš„åŸå§‹æ•°æ®`);
                    
                    // é‡æ–°ç”ŸæˆåŸå§‹é¡ºåºçš„æ•°æ®
                    userDataMapping[newFirstUser.id] = {
                        batteryData: generateUserBatteryData(newFirstUser),
                        trackingData: generateUserTrackingData(newFirstUser)
                    };
                    
                    // å¦‚æœå½“å‰æ­£åœ¨ç›‘æ§æˆ–åˆ†æè¿™ä¸ªç”¨æˆ·ï¼Œéœ€è¦åˆ·æ–°æ˜¾ç¤º
                    if (currentMonitoringUser && currentMonitoringUser.id === newFirstUser.id) {
                        loadBatteryChart(userDataMapping[newFirstUser.id].batteryData);
                        loadDateSelector(userDataMapping[newFirstUser.id].trackingData);
                    }
                    
                    if (currentAnalyticsUser && currentAnalyticsUser.id === newFirstUser.id) {
                        loadUserAnalyticsData(newFirstUser);
                    }
                }
            }
            
            setTimeout(() => {
                loadUserSelector();
                loadAnalyticsUserSelector();
            }, 100);
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– - æ·»åŠ å­˜å‚¨é…ç½®åŒæ­¥
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminSettings();
            loadUserList(); 
            updateDeviceDisplays();
            updateUserStatistics();
            updateDashboardDeviceStats();

            initializeMonitoringPage();
            setupMonitoringComponents();
            initializeAnalyticsPage();
            syncStorageLimitToPages();
            console.log('æ§åˆ¶å°ç•Œé¢åŠ è½½å®Œæˆ');
        });

        const mapStyles = `
        <style>
        #monitoringMap {
            height: 500px !important;
            width: 100% !important;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .custom-marker {
            text-align: center;
            line-height: 25px;
            background: none !important;
            border: none !important;
        }

        .leaflet-popup-content {
            font-size: 12px;
            line-height: 1.4;
        }
        </style>
        `;

        // å°†æ ·å¼æ·»åŠ åˆ°é¡µé¢
        if (!document.querySelector('#map-styles')) {
            const styleElement = document.createElement('style');
            styleElement.id = 'map-styles';
            styleElement.innerHTML = mapStyles;
            document.head.appendChild(styleElement);
        }

        // å¤´åƒå­—æ¯å®æ—¶é¢„è§ˆ
        document.getElementById('adminAvatar').addEventListener('input', function() {
            const value = this.value.toUpperCase();
            document.getElementById('avatarPreview').textContent = value || 'A';
        });

        // èœå•é¡¹ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const pageId = this.dataset.page;
                if (pageId) {
                    showPage(pageId);
                }
            });
        });

        // å¯¼èˆªæ é“¾æ¥ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const pageId = this.dataset.page;
                if (pageId) {
                    showPage(pageId);
                }
            });
        });
    </script>
</body>
</html>